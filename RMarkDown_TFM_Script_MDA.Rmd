--- 
title: '`r params$title`'
author: '`r params$name`'
date: '`r format(Sys.Date(),"%e de %B, %Y")`'
output:
  pdf_document:
    latex_engine: xelatex
    keep_tex: false
    number_sections: true
    toc: true
    toc_depth: 4
  html_document:
    toc: true
    toc_depth: 4
    toc_float: true
  word_document:
    toc: true
    toc_depth: '4'
subtitle: '`r params$subtitle`'
params:
  name: "Montserrat Domingo Ayllón"
  title: "ATR analysis"
  subtitle: "TFM"
lang: es
geometry: margin=2cm
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, comment = NULL, cache=TRUE, warning=FALSE, message=FALSE, error = TRUE, collapse = TRUE)
```

\newpage

```{r packs, eval = FALSE, include=FALSE, warning=FALSE}
# Se cargan las librerías y los paquetes necesarios para el desarrollo del análisis estadístico.
if(!(require(readxl, dplyr, DataExplorer, GGally, SmartEDA, gridExtra, kableExtra, ggplot2, tidyr, car, e1071, 
             agricolae, emmeans, lmtest, lmPerm, rcompanion, permuco, rstatix, 
             openxlsx, moments, shiny, Rtsne, devtools, MVN, heplots, effectsize,
             compositions, MASS, caret, multiROC,multipleROC,RVAideMemoire,nnet))){
             install.packages('readxl, dplyr, DataExplorer, GGally,SmartEDA, gridExtra, kableExtra, ggplot2, 
                              tidyr, car, e1071, agricolae, emmeans, lmtest, lmPerm, 
                              rcompanion,  permuco, rstatix, openxlsx, moments, 
                              shiny, Rtsne, devtools, MVN, heplots, effectsize,
                              compositions, MASS, caret, multiROC,multipleROC,
                              RVAideMemoire,nnet',
                              type = 'source',
                              options(repos = list(CRAN="http://cran.rstudio.com/")))
  }
library(readxl)
library(dplyr)
library(DataExplorer)
library(GGally)
library(SmartEDA)
library(gridExtra)
library(kableExtra)
library(ggplot2)
library(tidyr)
library(car)
library(e1071)
library(agricolae)
library(emmeans)
library(lmtest)
library(lmPerm)
library(rcompanion)
library(permuco)
library(rstatix)
library(openxlsx)
library(moments)
library(shiny)
library(Rtsne)
library(devtools)
library(MVN)
library(heplots)
library(effectsize)
library(compositions)
library(MASS)
library(caret)
library(multiROC)
library(multipleROC)
library(RVAideMemoire)
library(nnet)
```

# Variables Demográficas y clínicas

```{r frag1, echo=FALSE}
# Lectura de los datos 
library("readxl")
library("dplyr")
demo_atr <- read_excel("D:/Masters/MasterBioInformaticaBioEstadistica/TFM/Scripts_ATR/Tables_allpoints/clinics/demographics_ATR.xlsx")
clinical_vars <- read_excel("D:/Masters/MasterBioInformaticaBioEstadistica/TFM/Scripts_ATR/Tables_allpoints/clinics/variables_cliniques_complet.xlsx", sheet = 4)

Group<-c(rep(1,24), rep(2,31))
demo_atr<-cbind(demo_atr[1], Group, demo_atr[2:10])

clinical_vars_gc <- clinical_vars %>%
  as_tibble() %>%
  dplyr::filter(CODI %in% demo_atr$codi)

demo_atr_gc <- demo_atr %>%
  as_tibble() %>%
  dplyr::filter(codi %in% clinical_vars$CODI)

clinical_vars_gc <- cbind(clinical_vars_gc, demo_atr_gc[,2:6])

clinical_vars_gc[,c(1:17)][clinical_vars_gc[,c(1:17)]=='NaN'] = NA
clinical_vars_gc[,c(7:13)]<-as.numeric(unlist(clinical_vars_gc[,c(7:13)]))

demo_atr<-as.data.frame(demo_atr)
demo_atr[,c(2:11)][demo_atr[,c(2:11)]=='NaN'] = NA
demo_atr[,c(7:11)]<-as.numeric(unlist(demo_atr[,c(7:11)]))
```

## Cálculo de medias y desviaciones estándard por subgrupos para variables demográficas y clínicas

```{r frag2.1, echo=FALSE}
library(tidyr)
library(dplyr)
AvgSdDemo <- demo_atr %>%
  as_tibble() %>%
  group_by(Subgroup) %>%
  dplyr::summarise(AvgAgeY = mean(`Age(years)`, na.rm=TRUE),
                   SdAgeY = sd(`Age(years)`, na.rm=TRUE),
                   AvgEducY = mean(Years_education, na.rm=TRUE),
                   SdEducY = sd(Years_education, na.rm=TRUE))
AvgSdDemo<-as.data.frame(AvgSdDemo)
AvgSdDemo[,2:5]<-round(AvgSdDemo[,2:5],2)

AvgSdClinVarsPhdHD <- clinical_vars_gc %>%
  as_tibble() %>%
  group_by(Subgroup) %>%
  dplyr::summarise(AvgCAG = mean(CAG, na.rm=TRUE),
                   SdCAG = sd(CAG, na.rm=TRUE),
                   AvgCAP = mean(CAP_BIS, na.rm=TRUE),
                   SdCAP = sd(CAP_BIS, na.rm=TRUE),
                   AvgCR = mean(Cognitive_reserve, na.rm=TRUE),
                   SdCR = sd(Cognitive_reserve, na.rm=TRUE),
                   AvgAOO = mean(Age_onset_Langbehn, na.rm=TRUE),
                   SdAOO = sd(Age_onset_Langbehn, na.rm=TRUE),
                   AvgUHDRSm = mean(`UHDRS-motor score`, na.rm=TRUE),
                   SdUHDRSm = sd(`UHDRS-motor score`, na.rm=TRUE),
                   AvgUHDRSc = mean(`UHDRS-cognitive score`,na.rm=TRUE),
                   SdUHDRSc = sd(`UHDRS-cognitive score`,na.rm=TRUE),
                   AvgUHDRSf = mean(`UHDRS-functional score`, na.rm=TRUE),
                   SdUHDRSf = sd(`UHDRS-functional score`, na.rm=TRUE))
AvgSdClinVarsPhdHD<-as.data.frame(AvgSdClinVarsPhdHD)
AvgSdClinVarsPhdHD[,2:15]<-round(AvgSdClinVarsPhdHD[,2:15],2)
```

```{r frag2.2, echo=FALSE}
AgeY<-paste(AvgSdDemo$AvgAgeY,AvgSdDemo$SdAgeY,sep="+/-")
EducY<-paste(AvgSdDemo$AvgEducY,AvgSdDemo$SdEducY,sep="+/-")
AgeY_EducY<-cbind(AvgSdDemo$Subgroup,AgeY,EducY)
AgeY_EducY<-as.data.frame(AgeY_EducY)
AgeY_EducY$V1 = factor(AvgSdDemo$Subgroup,
                       levels=c('1','2','3'),
                       labels=c('Control', 'PreHD', 'HD'))
colnames(AgeY_EducY)<-c('Subgrupo','Edad', 'Años educativos')

library(kableExtra)
kableExtra::kable(AgeY_EducY, caption = 'Edad y Años de escolarización (mean +/- sd)', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r frag2.3, echo=FALSE}
CAG<-paste(AvgSdClinVarsPhdHD$AvgCAG,AvgSdClinVarsPhdHD$SdCAG,sep="+/-")
CAP<-paste(AvgSdClinVarsPhdHD$AvgCAP,AvgSdClinVarsPhdHD$SdCAP,sep="+/-")
CR<-paste(AvgSdClinVarsPhdHD$AvgCR,AvgSdClinVarsPhdHD$SdCR,sep="+/-")
AOO<-paste(AvgSdClinVarsPhdHD$AvgAOO,AvgSdClinVarsPhdHD$SdAOO,sep="+/-")
UHDRSm<-paste(AvgSdClinVarsPhdHD$AvgUHDRSm,AvgSdClinVarsPhdHD$SdUHDRSm,sep="+/-")
UHDRSc<-paste(AvgSdClinVarsPhdHD$AvgUHDRSc,AvgSdClinVarsPhdHD$SdUHDRSc,sep="+/-")
UHDRSf<-paste(AvgSdClinVarsPhdHD$AvgUHDRSf,AvgSdClinVarsPhdHD$SdUHDRSf,sep="+/-")
ClinVarsPhdHD<-cbind(AvgSdClinVarsPhdHD$Subgroup,CAG,CAP,CR,AOO,UHDRSm,UHDRSc,UHDRSf)
ClinVarsPhdHD<-as.data.frame(ClinVarsPhdHD)
ClinVarsPhdHD$V1= factor(ClinVarsPhdHD$V1,
                         levels=c('2','3'),
                         labels=c('PreHD', 'HD'))
colnames(ClinVarsPhdHD)<-c('Subgrupo','CAG','CAP','Cognitive Reserve','Age of Onset','UHDRS-motor','UHDRS-cognitive','UHDRS-functional')

kableExtra::kable(ClinVarsPhdHD, caption = 'Variables clínicas (mean +/- sd) en PreHD y HD', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 7, latex_options='hold_position')
```

## Cálculo de medias y desviaciones estándard global en _gene_ carriers para variables demográficas y clínicas

```{r frag3.1, echo=FALSE}
AvgSdClinVarsGC <- clinical_vars_gc %>%
  as_tibble() %>%
  dplyr::summarise(AvgAgeY = mean(`Age(years)`, na.rm=TRUE),
                   SdAgeY = sd(`Age(years)`, na.rm=TRUE),
                   AvgEducY = mean(Years_education, na.rm=TRUE),
                   SdEducY = sd(Years_education, na.rm=TRUE),
                   AvgCAG = mean(CAG, na.rm=TRUE),
                   SdCAG = sd(CAG, na.rm=TRUE),
                   AvgCAP = mean(CAP_BIS, na.rm=TRUE),
                   SdCAP = sd(CAP_BIS, na.rm=TRUE),
                   AvgAOO = mean(Age_onset_Langbehn, na.rm=TRUE),
                   SdAOO = sd(Age_onset_Langbehn, na.rm=TRUE),
                   AvgCR = mean(Cognitive_reserve, na.rm=TRUE),
                   SdCR = sd(Cognitive_reserve, na.rm=TRUE),
                   AvgUHDRSm = mean(`UHDRS-motor score`, na.rm=TRUE),
                   SdUHDRSm = sd(`UHDRS-motor score`, na.rm=TRUE),
                   AvgUHDRSc = mean(`UHDRS-cognitive score`,na.rm=TRUE),
                   SdUHDRSc = sd(`UHDRS-cognitive score`,na.rm=TRUE),
                   AvgUHDRSf = mean(`UHDRS-functional score`, na.rm=TRUE),
                   SdUHDRSf = sd(`UHDRS-functional score`, na.rm=TRUE))
AvgSdClinVarsGC<-as.data.frame(AvgSdClinVarsGC)
AvgSdClinVarsGC[,1:18]<-round(AvgSdClinVarsGC[,1:18],2)
```

```{r frag3.2, echo=FALSE}
Age<-paste(AvgSdClinVarsGC$AvgAgeY,AvgSdClinVarsGC$SdAgeY,sep="+/-")
Educ<-paste(AvgSdClinVarsGC$AvgEducY,AvgSdClinVarsGC$SdEducY,sep="+/-")
CAG<-paste(AvgSdClinVarsGC$AvgCAG,AvgSdClinVarsGC$SdCAG,sep="+/-")
CAP<-paste(AvgSdClinVarsGC$AvgCAP,AvgSdClinVarsGC$SdCAP,sep="+/-")
AOO<-paste(AvgSdClinVarsGC$AvgAOO,AvgSdClinVarsGC$SdAOO,sep="+/-")
CR<-paste(AvgSdClinVarsGC$AvgCR,AvgSdClinVarsGC$SdCR,sep="+/-")
UHDRSm<-paste(AvgSdClinVarsGC$AvgUHDRSm,AvgSdClinVarsGC$SdUHDRSm,sep="+/-")
UHDRSc<-paste(AvgSdClinVarsGC$AvgUHDRSc,AvgSdClinVarsGC$SdUHDRSc,sep="+/-")
UHDRSf<-paste(AvgSdClinVarsGC$AvgUHDRSf,AvgSdClinVarsGC$SdUHDRSf,sep="+/-")
ClinVarsGC<-cbind(Age,Educ,CAG,CAP,AOO,CR,UHDRSm,UHDRSc,UHDRSf)
ClinVarsGC<-as.data.frame(ClinVarsGC)
colnames(ClinVarsGC)<-c('Edad','Educación','CAG','CAP','Age of Onset','Cognitive Reserve','UHDRS-motor','UHDRS-cognitive','UHDRS-functional')

kableExtra::kable(ClinVarsGC, caption = 'Variables demográficas y clínicas (mean +/- sd) en gene carriers', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 6, latex_options='hold_position')
```

## Cálculo de medias y desviaciones estándard en preHD y HD para PBA-Enroll, Stroop-interferences y TMT(B-A) Direct

```{r frag4.1, echo=FALSE}
pba_enroll <- read_excel("D:/Masters/MasterBioInformaticaBioEstadistica/TFM/Scripts_ATR/Tables_allpoints/clinics/variables_cliniques_complet.xlsx", sheet = 1)
pba_enroll_gc <- pba_enroll %>%
  as_tibble() %>%
  dplyr::filter(CODI %in% demo_atr$codi)
pba_enroll_gc<-as.data.frame(pba_enroll_gc)
pba_enroll_gc[,c(2:6)][pba_enroll_gc[,c(2:6)]=='NaN'] = NA
pba_enroll_gc[,c(2:6)]<-as.numeric(unlist(pba_enroll_gc[,c(2:6)]))
pba_enroll_gc<-cbind(pba_enroll_gc[1], clinical_vars_gc[14], pba_enroll_gc[,2:6])
PBAenroll<- pba_enroll_gc %>%
  as_tibble() %>%
  group_by(Subgroup) %>%
  dplyr::summarise(AvgPBAdepression = mean(DEPRESION_COMP, na.rm=TRUE),
                   SdPBAdepression = sd(DEPRESION_COMP, na.rm=TRUE),
                   AvgPBAirritability = mean(IRRITABILIDAD_COMP, na.rm=TRUE),
                   SdPBAirritability = sd(IRRITABILIDAD_COMP, na.rm=TRUE),
                   AvgPBApsychosis = mean(PSICOSIS_COMP, na.rm=TRUE),
                   SdPBApsychosis = sd(PSICOSIS_COMP, na.rm=TRUE),
                   AvgPBAapathy = mean(APATIA_COMP, na.rm=TRUE),
                   SdPBAapathy = sd(APATIA_COMP, na.rm=TRUE),
                   AvgPBAdysexecutive = mean(DISEJECUTIVO_COMP, na.rm=TRUE),
                   SdPBAdysexecutive = sd(DISEJECUTIVO_COMP, na.rm=TRUE))
PBAenroll<-as.data.frame(PBAenroll)
PBAenroll[,2:11]<-round(PBAenroll[,2:11],2)

executive_fn<-cbind(clinical_vars_gc[,c(1,14,10,11)])
FnExec<-executive_fn %>%
  as_tibble() %>%
  group_by(Subgroup) %>%
  dplyr::summarise(AvgStroop = mean(`Stroop-interferencias`, na.rm=TRUE),
                   SdStroop = sd(`Stroop-interferencias`, na.rm=TRUE),
                   AvgTMTdirect = mean(`TMT_direct_(B-A)`, na.rm=TRUE),
                   SdTMTdirect = sd(`TMT_direct_(B-A)`, na.rm=TRUE))
FnExec<-as.data.frame(FnExec)
FnExec[,2:5]<-round(FnExec[,2:5],2)
```

```{r frag4.2, echo=FALSE}
Depression<-paste(PBAenroll$AvgPBAdepression,PBAenroll$SdPBAdepression,sep="+/-")
Irritability<-paste(PBAenroll$AvgPBAirritability,PBAenroll$SdPBAirritability,sep="+/-")
Psychosis<-paste(PBAenroll$AvgPBApsychosis,PBAenroll$SdPBApsychosis,sep="+/-")
Apathy<-paste(PBAenroll$AvgPBAapathy,PBAenroll$SdPBAapathy,sep="+/-")
Dysexecutive<-paste(PBAenroll$AvgPBAdysexecutive,PBAenroll$SdPBAdysexecutive,sep="+/-")
PBA<-cbind(PBAenroll$Subgroup,Depression,Irritability,Psychosis,Apathy,Dysexecutive)
PBA<-as.data.frame(PBA)
PBA$V1= factor(PBA$V1,levels=c('2','3'),labels=c('PreHD', 'HD'))
colnames(PBA)<-c('Subgrupo','Depression', 'Irritability','Psychosis','Apathy','Dysexecutive')

kableExtra::kable(PBA, caption = 'Variables psiquiátricas PBA-Enroll (mean +/- sd) en PreHD y HD', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r frag4.3, echo=FALSE}
Stroop<-paste(FnExec$AvgStroop,FnExec$SdStroop,sep="+/-")
TMTdirect<-paste(FnExec$AvgTMTdirect,FnExec$SdTMTdirect,sep="+/-")
Exec<-cbind(FnExec$Subgroup,Stroop,TMTdirect)
Exec<-as.data.frame(Exec)
Exec$V1= factor(Exec$V1,levels=c('2','3'),labels=c('PreHD', 'HD'))
colnames(Exec)<-c('Subgrupo','Stroop', 'TMTdirect')

kableExtra::kable(Exec, caption = 'Variables de función ejecutiva (mean +/- sd) en PreHD y HD', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

## Cálculo de medias y desviaciones estándard global para GC para PBA-Enroll, Stroop-interferences y TMT(B-A) Direct

```{r frag5.1, echo=FALSE}
PBAenrollGC<-pba_enroll_gc %>%
  as_tibble() %>%
  dplyr::summarise(AvgPBAdepression = mean(DEPRESION_COMP, na.rm=TRUE),
                   SdPBAdepression = sd(DEPRESION_COMP, na.rm=TRUE),
                   AvgPBAirritability = mean(IRRITABILIDAD_COMP, na.rm=TRUE),
                   SdPBAirritability = sd(IRRITABILIDAD_COMP, na.rm=TRUE),
                   AvgPBApsychosis = mean(PSICOSIS_COMP, na.rm=TRUE),
                   SdPBApsychosis = sd(PSICOSIS_COMP, na.rm=TRUE),
                   AvgPBAapathy = mean(APATIA_COMP, na.rm=TRUE),
                   SdPBAapathy = sd(APATIA_COMP, na.rm=TRUE),
                   AvgPBAdysexecutive = mean(DISEJECUTIVO_COMP, na.rm=TRUE),
                   SdPBAdysexecutive = sd(DISEJECUTIVO_COMP, na.rm=TRUE))
PBAenrollGC<-as.data.frame(PBAenrollGC)
PBAenrollGC[,1:10]<-round(PBAenrollGC[,1:10],2)

FnExecGC<-executive_fn %>%
  as_tibble() %>%
  dplyr::summarise(AvgStroop = mean(`Stroop-interferencias`, na.rm=TRUE),
                   SdStroop = sd(`Stroop-interferencias`, na.rm=TRUE),
                   AvgTMTdirect = mean(`TMT_direct_(B-A)`, na.rm=TRUE),
                   SdTMTdirect = sd(`TMT_direct_(B-A)`, na.rm=TRUE))
FnExecGC<-as.data.frame(FnExecGC)
FnExecGC[,1:4]<-round(FnExecGC[,1:4],2)
```

```{r frag5.2, echo=FALSE}
Depression<-paste(PBAenrollGC$AvgPBAdepression,PBAenrollGC$SdPBAdepression,sep="+/-")
Irritability<-paste(PBAenrollGC$AvgPBAirritability,PBAenrollGC$SdPBAirritability,sep="+/-")
Psychosis<-paste(PBAenrollGC$AvgPBApsychosis,PBAenrollGC$SdPBApsychosis,sep="+/-")
Apathy<-paste(PBAenrollGC$AvgPBAapathy,PBAenrollGC$SdPBAapathy,sep="+/-")
Dysexecutive<-paste(PBAenrollGC$AvgPBAdysexecutive,PBAenrollGC$SdPBAdysexecutive,sep="+/-")
PBA<-cbind(Depression,Irritability,Psychosis,Apathy,Dysexecutive)
PBA<-as.data.frame(PBA)
colnames(PBA)<-c('Depression','Irritability','Psychosis','Apathy','Dysexecutive')

kableExtra::kable(PBA, caption = 'Variables psiquiátricas PBA-Enroll (mean +/- sd) en gene carriers', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r frag5.3, echo=FALSE}
Stroop<-paste(FnExecGC$AvgStroop,FnExecGC$SdStroop,sep="+/-")
TMTdirect<-paste(FnExecGC$AvgTMTdirect,FnExecGC$SdTMTdirect,sep="+/-")
Exec<-cbind(Stroop,TMTdirect)
Exec<-as.data.frame(Exec)
colnames(Exec)<-c('Stroop', 'TMTdirect')

kableExtra::kable(Exec, caption = 'Variables de función ejecutiva (mean +/- sd) en gene carriers', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

## T-test para variables numéricas CT-GC, CT-preHD y CT-HD

Se genera dos t-tests para comprobar si existen **diferencias entre controles y gene carriers en relación a la edad (en años) y a los años de escolarización**. Consulta del siguiente recurso web: [ANOVA in R](https://statsandr.com/blog/anova-in-r/#tukey-hsd-test).

```{r frag6.0, echo=FALSE}
# Determinar si las variables numéricas son normales mediante el shapiro.test 
norm_age<-stats::shapiro.test(demo_atr$`Age(years)`)
norm_ye<-stats::shapiro.test(demo_atr$Years_education)
```

```{r frag6.1, echo=FALSE}
# Diferencias entre CT y GC para edad y años de educación
demo_atr$Group<-as.factor(demo_atr$Group)
demo_atr$Subgroup<-as.factor(demo_atr$Subgroup)
demo_atr$Gender<-as.factor(demo_atr$Gender)

YE_CT_GC<-t.test(demo_atr$Years_education~demo_atr$Group)
resultsYE_CT_GC<-cbind(YE_CT_GC[1], YE_CT_GC[2], YE_CT_GC[3], 
                       YE_CT_GC$estimate[1], YE_CT_GC$estimate[2])

AGE_CT_GC<-t.test(demo_atr$`Age(years)`~demo_atr$Group)
resultsAGE_CT_GC<-cbind(AGE_CT_GC[1], AGE_CT_GC[2], AGE_CT_GC[3], 
                        AGE_CT_GC$estimate[1], AGE_CT_GC$estimate[2])

resultsYE_AGE_CT_GC<-rbind(resultsYE_CT_GC, resultsAGE_CT_GC)
colnames(resultsYE_AGE_CT_GC)<-c('T-Statistic', 'df', 'p.value', 'estimate_CT', 'estimate_GC')
Variable<-c('Years_Education', 'Age')
resultsYE_AGE_CT_GC<-cbind(Variable,resultsYE_AGE_CT_GC)
resultsYE_AGE_CT_GC_DF<-as.data.frame(resultsYE_AGE_CT_GC)
row.names(resultsYE_AGE_CT_GC_DF) <- NULL

kableExtra::kable(resultsYE_AGE_CT_GC_DF, caption = 'T-test controles vs gene carriers', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Como se observa en la tabla, no existen diferencias significativas entre controles y gene carriers en cuanto a la edad (en años) y a los años de escolarización. 

Se genera dos anovas para comprobar si existen **diferencias entre los 3 subgrupos en relación a la edad (en años) y a los años de escolarización**; posteriormente, se ejecutan los **post-hoc tests**. En este contexto, se pueden utilizar dos métodos: 

- La función `anova_test` del paquete `rstatix` y posteriormente ejecutar los t-tests por pares; 
- La función `aov` del paquete `stats` y posteriormente ejecutar los post-hoc Tukey tests ya sea con la función `HSD.test` del paquete `agricolae` o la función `TukeyHSD` del paquete `stats`.

Se han generado todas las posibilidades. A continuación se muestran los resultados de la combinación `anova_test`-`t.test`.

```{r frag6.2, echo=FALSE}
# Diferencias entre subgrupos para edad y años de educación
library(rstatix)
library(stats)
AOV_3G_AGE<-anova_test(demo_atr, `Age(years)`~Subgroup)
AOV_3G_AGE_DF<-as.data.frame(AOV_3G_AGE)
AOV_3G_YE<-anova_test(demo_atr, Years_education~Subgroup)
AOV_3G_YE_DF<-as.data.frame(AOV_3G_YE)
AOV_3G_AGE_YE_DF<-rbind(AOV_3G_AGE_DF,AOV_3G_YE_DF)
Variables<-c('3G - Age', '3G - Years of education')
AOV_3G_AGE_YE_DF<-cbind(Variables, AOV_3G_AGE_YE_DF)

kableExtra::kable(AOV_3G_AGE_YE_DF, caption = 'ANOVA para edad y años de escolarización con la función anova test', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r frag6.3, echo=FALSE}
# Diferencias entre CT-pHD
demo_atr_CT_PHD<-demo_atr[demo_atr$Subgroup!=3,]
tt_ct_phd_ye<-t.test(demo_atr_CT_PHD$Years_education~demo_atr_CT_PHD$Subgroup)
resultsTt_CtPhd_ye<-cbind(tt_ct_phd_ye$statistic, tt_ct_phd_ye$parameter, tt_ct_phd_ye$p.value)
colnames(resultsTt_CtPhd_ye)<-c('statistic', 'df', 'p-value')
rownames(resultsTt_CtPhd_ye)<-c('CTvsPHD_YearsEducation')
tt_ct_phd_age<-t.test(demo_atr_CT_PHD$`Age(years)`~demo_atr_CT_PHD$Subgroup)
resultsTt_CtPhd_age<-cbind(tt_ct_phd_age$statistic, tt_ct_phd_age$parameter, tt_ct_phd_age$p.value)
colnames(resultsTt_CtPhd_age)<-c('statistic', 'df', 'p-value')
rownames(resultsTt_CtPhd_age)<-c('CTvsPHD_Age')

# Diferencias entre CT-HD
demo_atr_CT_HD<-demo_atr[demo_atr$Subgroup!=2,]
tt_ct_hd_ye<-t.test(demo_atr_CT_HD$Years_education~demo_atr_CT_HD$Subgroup)
resultsTt_CtHd_ye<-cbind(tt_ct_hd_ye$statistic, tt_ct_hd_ye$parameter, tt_ct_hd_ye$p.value)
colnames(resultsTt_CtHd_ye)<-c('statistic', 'df', 'p-value')
rownames(resultsTt_CtHd_ye)<-c('CTvsHD_YearsEducation')
tt_ct_hd_age<-t.test(demo_atr_CT_HD$`Age(years)`~demo_atr_CT_HD$Subgroup)
resultsTt_CtHd_age<-cbind(tt_ct_hd_age$statistic, tt_ct_hd_age$parameter, tt_ct_hd_age$p.value)
colnames(resultsTt_CtHd_age)<-c('statistic', 'df', 'p-value')
rownames(resultsTt_CtHd_age)<-c('CTvsHD_Age')

# Diferencias entre pHD-HD
demo_atr_PHD_HD<-demo_atr[demo_atr$Subgroup!=1,]
tt_phd_hd_ye<-t.test(demo_atr_PHD_HD$Years_education~demo_atr_PHD_HD$Subgroup)
resultsTt_PhdHd_ye<-cbind(tt_phd_hd_ye$statistic, tt_phd_hd_ye$parameter, tt_phd_hd_ye$p.value)
colnames(resultsTt_PhdHd_ye)<-c('statistic', 'df', 'p-value')
rownames(resultsTt_PhdHd_ye)<-c('PHDvsHD_YearsEducation')
tt_phd_hd_age<-t.test(demo_atr_PHD_HD$`Age(years)`~demo_atr_PHD_HD$Subgroup)
resultsTt_PhdHd_age<-cbind(tt_phd_hd_age$statistic, tt_phd_hd_age$parameter, tt_phd_hd_age$p.value)
colnames(resultsTt_PhdHd_age)<-c('statistic', 'df', 'p-value')
rownames(resultsTt_PhdHd_age)<-c('PHDvsHD_Age')

ResultsTtest_YE_AGE<-rbind(resultsTt_CtPhd_age,resultsTt_CtHd_age,
                           resultsTt_PhdHd_age,resultsTt_CtPhd_ye,
                           resultsTt_CtHd_ye, resultsTt_PhdHd_ye)
colnames(ResultsTtest_YE_AGE)<-c('statistic', 'df', 'p-value')
Vars<-c('CT vs PHD','CT vs HD','PHD vs HD',
        'CT vs PHD','CT vs HD','PHD vs HD')
ResultsTtest_YE_AGE<-cbind(Vars,ResultsTtest_YE_AGE)
ResultsTtest_YE_AGE_DF<-as.data.frame(ResultsTtest_YE_AGE)
row.names(ResultsTtest_YE_AGE_DF) <- NULL

kableExtra::kable(ResultsTtest_YE_AGE_DF, caption = 'T-test para edad y años de escolarización con la función t test', 
                  booktabs = TRUE) %>%
  pack_rows(index=c('Age'=3, 'Years of Education'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Con este método, el ANOVA muestra diferencias significativas en la edad para la variable subgrupo, pero no así para los años de escolarización. Respecto al t-test, las diferencias de edad se objetivan entre preHD y HD en relación a una edad mayor en los HD respecto a los preHD. A pesar de no ser significativo en el ANOVA, también se ha generado el t-test de los años de escolarización por el hecho de ser exhaustivo y éste muestra diferencias en los años de educación entre preHD y HD (tal vez por ser los HD mayores pueden presentar menor tasa de estudios medios y/o universitarios). De todas formas, este resultado de años de escolarización no se tendrá en cuenta dado que el ANOVA no ha sido significativo. 

A continuación se muestran los resultados de la combinación `aov`-`HSDtest`/`TukeyHSD`.

```{r frag6.4, echo=FALSE}
aov_age<-aov(`Age(years)`~Subgroup, data=demo_atr)
sum_aov_age<-summary(aov(`Age(years)`~Subgroup, data=demo_atr))
sum_aov_age_df<-as.data.frame(sum_aov_age[[1]])
sum_aov_age_df[,1:5]<-round(sum_aov_age_df[,1:5],2)

aov_ye<-aov(Years_education~Subgroup, data=demo_atr)
sum_aov_ye<-summary(aov(Years_education~Subgroup, data=demo_atr))
sum_aov_ye_df<-as.data.frame(sum_aov_ye[[1]])
sum_aov_ye_df[,1:5]<-round(sum_aov_ye_df[,1:5],2)

sum_aov_age_ye_df<-rbind(sum_aov_age_df,sum_aov_ye_df)
name<-rep(c('Subgroup', 'Residuals'),2)
sum_aov_age_ye_df<-cbind(name,sum_aov_age_ye_df)
rownames(sum_aov_age_ye_df)<-NULL

kableExtra::kable(sum_aov_age_ye_df, caption = 'ANOVA para edad y años de escolarización con la función aov', 
                  booktabs = TRUE) %>%
  pack_rows(index=c('Age'=2, 'Years of Education'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r frag6.5, echo=FALSE}
library(agricolae)
posthoc_age<-HSD.test(aov_age,"Subgroup")
posthoc_ye<-HSD.test(aov_ye,"Subgroup")
groups_age_ye<-cbind(posthoc_age$groups,posthoc_ye$groups)
groups_age_ye[c(1,3)]<-round(groups_age_ye[c(1,3)],2)

library(rstatix)
posthoc_tukey_age<-tukey_hsd(aov_age,"Subgroup")
posthoc_tukey_ye<-tukey_hsd(aov_ye,"Subgroup")
posthoc_tukey_age2<-TukeyHSD(aov_age,"Subgroup")
posthoc_tukey_ye2<-TukeyHSD(aov_ye,"Subgroup")
tukey_age_df<-as.data.frame(posthoc_tukey_age2$Subgroup[,c(1,4)])
tukey_age_df[1:2]<-round(tukey_age_df[1:2],3)
tukey_ye_df<-as.data.frame(posthoc_tukey_ye2$Subgroup[,c(1,4)])
tukey_ye_df[1:2]<-round(tukey_ye_df[1:2],3)
tukey_age_ye_df<-cbind(tukey_age_df,tukey_ye_df)

comparison<-c('PreHD vs Controles (2-1)','HD vs Controles (3-1)','HD vs PreHD (3-2)')
AgeOrder<-c('HD','Control','preHD')
YEOrder<-c('preHD','Control','HD')
groups_tukey_age<-cbind(AgeOrder,groups_age_ye[1:2],comparison,tukey_age_df)
rownames(groups_tukey_age)<-NULL
groups_tukey_ye<-cbind(YEOrder,groups_age_ye[3:4],comparison,tukey_ye_df)
rownames(groups_tukey_ye)<-NULL

colnames(groups_tukey_age)<-c('','Media','Grupos','Comparación','Diferencia de medias','p-valor ajustado')
colnames(groups_tukey_ye)<-c('','Media','Grupos','Comparación','Diferencia de medias','p-valor ajustado')
groups_tukey_age_ye<-rbind(groups_tukey_age,groups_tukey_ye)

kableExtra::kable(groups_tukey_age_ye, caption = 'HSD Tukey test para edad y años de escolarización con las funciones HSD test y TukeyHSD', booktabs = TRUE) %>%
  pack_rows(index=c('Age'=3, 'Years of Education'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Al igual que con el método anterior, el ANOVA muestra diferencias significativas en la edad para la variable subgrupo, pero no así para los años de escolarización. Rsspecto a los post-hoc Tukey tests, las diferencias de edad también se objetivan entre preHD y HD en relación a una edad mayor en los HD respecto a los preHD, y, a diferencia de los t-tests anteriores, no muestran diferencias entre grupos en los años de educación. 

## T-test para variables numéricas pHD-HD

Se generan t-tests para cada variable numérica para determinar la existencia o la ausencia de **diferencias entre preHD y HD en relación a edad (en años), años de escolarización, edad de inicio de la enfermedad, CAG, CAP, reserva cognitiva, UHDRS funcional, UHDRS motor, UHDRS cognitivo, Stroop-interference y TMT-direct**. 

```{r frag7, echo=FALSE}
# Diferencias entre pHD y HD
YE_pHD_HD<-t.test(clinical_vars_gc$Years_education~clinical_vars_gc$Subgroup)
resultsYE<-cbind(YE_pHD_HD[1], YE_pHD_HD[2], YE_pHD_HD[3], 
                 YE_pHD_HD$estimate[1], YE_pHD_HD$estimate[2])
               
AGE_pHD_HD<-t.test(clinical_vars_gc$`Age(years)`~clinical_vars_gc$Subgroup)
resultsAGE<-cbind(AGE_pHD_HD[1], AGE_pHD_HD[2], AGE_pHD_HD[3], 
                  AGE_pHD_HD$estimate[1], AGE_pHD_HD$estimate[2])

AOO_pHD_HD<-t.test(clinical_vars_gc$Age_onset_Langbehn~clinical_vars_gc$Subgroup)
resultsAOO<-cbind(AOO_pHD_HD[1], AOO_pHD_HD[2], AOO_pHD_HD[3], 
                  AOO_pHD_HD$estimate[1], AOO_pHD_HD$estimate[2])

CAP_pHD_HD<-t.test(clinical_vars_gc$CAP_BIS~clinical_vars_gc$Subgroup)
resultsCAP<-cbind(CAP_pHD_HD[1], CAP_pHD_HD[2], CAP_pHD_HD[3], 
                  CAP_pHD_HD$estimate[1], CAP_pHD_HD$estimate[2])

CAG_pHD_HD<-t.test(clinical_vars_gc$CAG~clinical_vars_gc$Subgroup)
resultsCAG<-cbind(CAG_pHD_HD[1], CAG_pHD_HD[2], CAG_pHD_HD[3], 
                  CAG_pHD_HD$estimate[1], CAG_pHD_HD$estimate[2])

CR_pHD_HD<-t.test(clinical_vars_gc$Cognitive_reserve~clinical_vars_gc$Subgroup)
resultsCR<-cbind(CR_pHD_HD[1], CR_pHD_HD[2], CR_pHD_HD[3], 
                 CR_pHD_HD$estimate[1], CR_pHD_HD$estimate[2])

Uf_pHD_HD<-t.test(clinical_vars_gc$`UHDRS-functional score`~clinical_vars_gc$Subgroup, na.action = na.omit)
resultsUf<-cbind(Uf_pHD_HD[1], Uf_pHD_HD[2], Uf_pHD_HD[3], 
                 Uf_pHD_HD$estimate[1], Uf_pHD_HD$estimate[2])

Um_pHD_HD<-t.test(clinical_vars_gc$`UHDRS-motor score`~clinical_vars_gc$Subgroup, na.action = na.omit)
resultsUm<-cbind(Um_pHD_HD[1], Um_pHD_HD[2], Um_pHD_HD[3], 
                 Um_pHD_HD$estimate[1], Um_pHD_HD$estimate[2])

Uc_pHD_HD<-t.test(clinical_vars_gc$`UHDRS-cognitive score`~clinical_vars_gc$Subgroup, na.action = na.omit)
resultsUc<-cbind(Uc_pHD_HD[1], Uc_pHD_HD[2], Uc_pHD_HD[3], 
                 Uc_pHD_HD$estimate[1], Uc_pHD_HD$estimate[2])

Stroop_pHD_HD<-t.test(clinical_vars_gc$`Stroop-interferencias`~clinical_vars_gc$Subgroup, na.action = na.omit)
resultsStroop<-cbind(Stroop_pHD_HD[1], Stroop_pHD_HD[2], Stroop_pHD_HD[3], 
                     Stroop_pHD_HD$estimate[1], Stroop_pHD_HD$estimate[2])

TMTd_pHD_HD<-t.test(clinical_vars_gc$`TMT_direct_(B-A)`~clinical_vars_gc$Subgroup, na.action = na.omit)
resultsTMTd<-cbind(TMTd_pHD_HD[1], TMTd_pHD_HD[2], TMTd_pHD_HD[3], 
                   TMTd_pHD_HD$estimate[1], TMTd_pHD_HD$estimate[2])


resultsPHD_HD<-rbind(resultsAGE, resultsYE,resultsCAG, resultsCAP, resultsAOO, resultsUm, 
                     resultsUf, resultsUc, resultsCR, resultsStroop, resultsTMTd)
colnames(resultsPHD_HD)<-c('Statistic', 'df', 'p.value', 'estimate_pHD', 'estimate_HD')
Variables<-c('Age', 'Years of Education', 'CAG','CAP', 'Age of onset',  'UHDRS-motor',
             'UHDRS-functional', 'UHDRS-cognitive', 'Cognitive reserve', 'Stroop interference', 
             'TMTdirect')

resultsPHD_HD<-cbind(Variables, resultsPHD_HD)
resultsPHD_HD_DF<-as.data.frame(resultsPHD_HD)
rownames(resultsPHD_HD_DF)<-NULL

kableExtra::kable(resultsPHD_HD_DF, caption = 'T-tests preHD vs HD para diferentes variables numéricas', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Existen diferencias entre pHD y HD en las siguientes variables: 

- Edad (los HD son más mayores);
- Años de educación (más años en pHD);
- CAP (mayor en HD debido a que tienen más edad);
- UHDRS-motor score (mayor en HD);
- Reserva cognitiva (mayor en pHD);
- UHDRS-functional score (mayor en pHD);
- UHDRS-cognitive score (mayor en pHD);
- Stroop-interferences (mayor en pHD);
- TMT direct (mayor en HD).

No existen diferencias entre pHD y HD en las siguientes variables: age-of-onset, CAG.

## Wilcoxon Mann Whitney test para variables ordinales

Se generan **tests de Wilcoxon** para determinar **diferencias entre preHD y HD en las variables psiquiátricas PBA-Enroll** (ordinales).

```{r frag8, echo=FALSE}
library(rstatix)
WT_Enroll_Depression<-wilcox.test(pba_enroll_gc$DEPRESION_COMP~pba_enroll_gc$Subgroup, 
                                  alternative = "two.sided", na.action = na.omit)
Results_Depression<-cbind(WT_Enroll_Depression[1], WT_Enroll_Depression[3])
WT_Enroll_Irritability<-wilcox.test(pba_enroll_gc$IRRITABILIDAD_COMP~pba_enroll_gc$Subgroup,
                                    alternative = "two.sided", na.action = na.omit)
Results_Irritability<-cbind(WT_Enroll_Irritability[1], WT_Enroll_Irritability[3])
WT_Enroll_Psychosis<-wilcox.test(pba_enroll_gc$PSICOSIS_COMP~pba_enroll_gc$Subgroup,
                                 alternative = "two.sided", na.action = na.omit)
Results_Psychosis<-cbind(WT_Enroll_Psychosis[1], WT_Enroll_Psychosis[3])
WT_Enroll_Apathy<-wilcox.test(pba_enroll_gc$APATIA_COMP~pba_enroll_gc$Subgroup,
                              alternative = "two.sided", na.action = na.omit)
Results_Apathy<-cbind(WT_Enroll_Apathy[1], WT_Enroll_Apathy[3])
WT_Enroll_Dysexecutive<-wilcox.test(pba_enroll_gc$DISEJECUTIVO_COMP~pba_enroll_gc$Subgroup,
                                    alternative = "two.sided", na.action = na.omit)
Results_Dysexecutive<-cbind(WT_Enroll_Dysexecutive[1], WT_Enroll_Dysexecutive[3])

Results_PBA_ENROLL<-rbind(Results_Depression,Results_Irritability,Results_Psychosis,
                          Results_Apathy,Results_Dysexecutive)
colnames(Results_PBA_ENROLL)<-c('statistic','p-value')
Variables<-c('Depression','Irritability', 'Psychosis', 'Apathy', 'Dysexecutive')
Results_PBA_ENROLL<-cbind(Variables,Results_PBA_ENROLL)
Results_PBA_ENROLL_DF<-as.data.frame(Results_PBA_ENROLL)
rownames(Results_PBA_ENROLL_DF)<-NULL

kableExtra::kable(Results_PBA_ENROLL_DF, caption = 'Wilcoxon Tests entre preHD y HD en Variables psiquiátricas PBA-Enroll', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

No existen diferencias entre pHD y HD en relación a los valores de PBA-ENROLL, aunque cabe mencionar que tanto apatía como disexecutivo presentan p-valores menores a 0.10.

## Chi-square/Fisher test para variable nominal (gender)

El **test Chi-square** se utiliza para determinar la **diferencia entre controles y _gene carriers_** mediante una de las dos funciones siguientes: `chisq_test` del paquete `rstatix` o `chisq.test` del paquete `stats`.  

Para determinar la **diferencia entre los 3 subgrupos** o las **diferencias pareadas entre subgrupos**, se pueden utilizar el **test Chi-square** con una de las dos funciones especificadas anteriormente o el **test de Fisher** con la función `fisher.test` del paquete `stats`. 

Dado que el subgrupo de preHD (presintomáticos) sólo tiene un varón, R especfica que la aproximación de Chi-square puede ser incorrecta en las comparaciones de los 3 subgrupos a la vez y en las comparaciones controles-PreHD y PreHD-HD. 

```{r frag9.1, echo=FALSE}
nCt<-table(demo_atr[demo_atr$Subgroup==1,]$Gender)
nPHD<-table(demo_atr[demo_atr$Subgroup==2,]$Gender)
nHD<-table(demo_atr[demo_atr$Subgroup==3,]$Gender)
n<-rbind(nCt, nPHD, nHD)
n<-as.data.frame(n)
colnames(n)<-c('Hombres', 'Mujeres')
rownames(n)<-c('Controles', 'PreHD', 'HD')

# Diferencias entre CT-GC
demo_atr$Gender<-as.factor(demo_atr$Gender)
demo_atr$Subgroup<-as.factor(demo_atr$Subgroup)
demo_atr$Group<-as.factor(demo_atr$Group)
library(rstatix)
chitCTvsGC<-chisq_test(demo_atr$Group, demo_atr$Gender)
library(stats)
Gender_CT_GC<-chisq.test(demo_atr$Group, demo_atr$Gender)
ResultsGender_CT_GC<-cbind(Gender_CT_GC[1], Gender_CT_GC[2], Gender_CT_GC[3])

# Diferencias entre CT-pHD-HD
library(rstatix)
chitCTvsPHDvsHD<-chisq_test(demo_atr$Subgroup, demo_atr$Gender)
library(stats)
Gender_3G_fisher<-fisher.test(demo_atr$Subgroup, demo_atr$Gender)
ResultsGender_3G_fisher<-cbind(Gender_3G_fisher[1])
Gender_3G_chi<-chisq.test(demo_atr$Subgroup, demo_atr$Gender)
ResultsGender_3G_chi<-cbind(Gender_3G_chi[1], Gender_3G_chi[2], Gender_3G_chi[3])

# Diferencias entre CT-pHD
demo_atr_CT_PHD<-demo_atr[demo_atr$Subgroup!=3,]
Gender_CTvsPHD_fisher<-fisher.test(demo_atr_CT_PHD$Subgroup, demo_atr_CT_PHD$Gender)
ResultsGender_CTvsPHD_fisher<-cbind(Gender_CTvsPHD_fisher[1])
Gender_CTvsPHD_chi<-chisq.test(demo_atr_CT_PHD$Subgroup, demo_atr_CT_PHD$Gender)
ResultsGender_CTvsPHD_chi<-cbind(Gender_CTvsPHD_chi[1], Gender_CTvsPHD_chi[2],
                                 Gender_CTvsPHD_chi[3])

# Diferencias entre CT-HD
demo_atr_CT_HD<-demo_atr[demo_atr$Subgroup!=2,]
Gender_CTvsHD_fisher<-fisher.test(demo_atr_CT_HD$Subgroup, demo_atr_CT_HD$Gender)
ResultsGender_CTvsHD_fisher<-cbind(Gender_CTvsHD_fisher[1])
Gender_CTvsHD_chi<-chisq.test(demo_atr_CT_HD$Subgroup, demo_atr_CT_HD$Gender)
ResultsGender_CTvsHD_chi<-cbind(Gender_CTvsHD_chi[1], Gender_CTvsHD_chi[2],
                                Gender_CTvsHD_chi[3])

# Diferencias entre pHD-HD
demo_atr_PHD_HD<-demo_atr[demo_atr$Subgroup!=1,]
Gender_PHDvsHD_fisher<-fisher.test(demo_atr_PHD_HD$Subgroup, demo_atr_PHD_HD$Gender)
ResultsGender_PHDvsHD_fisher<-cbind(Gender_PHDvsHD_fisher[1])
Gender_PHDvsHD_chi<-chisq.test(demo_atr_PHD_HD$Subgroup, demo_atr_PHD_HD$Gender)
ResultsGender_PHDvsHD_chi<-cbind(Gender_PHDvsHD_chi[1], Gender_PHDvsHD_chi[2],
                                 Gender_PHDvsHD_chi[3])

# Diferencias entre pHD-HD: En este caso, chi-square es incorrecto por tener n bajas cada subgrupo 
clinical_vars_gc$Gender<-as.factor(clinical_vars_gc$Gender)
clinical_vars_gc$Subgroup<-as.factor(clinical_vars_gc$Subgroup)
fisherPhdVsHd<-fisher.test(clinical_vars_gc$Subgroup, clinical_vars_gc$Gender)


Results_Gender_chi<-rbind(ResultsGender_CT_GC,ResultsGender_3G_chi,
                          ResultsGender_CTvsPHD_chi, ResultsGender_CTvsHD_chi,
                          ResultsGender_PHDvsHD_chi)
colnames(Results_Gender_chi)<-c('statistic','df','p-value')
Variables<-c('Controls vs Gene Carriers','3 Subgroups','Controls vs preHD','Controls vs HD','PreHD vs HD')
Results_Gender_chi<-cbind(Variables,Results_Gender_chi)
Results_Gender_chi_DF<-as.data.frame(Results_Gender_chi)
rownames(Results_Gender_chi_DF)<-NULL


Results_Gender_fisher<-rbind(ResultsGender_3G_fisher,ResultsGender_CTvsPHD_fisher,
                             ResultsGender_CTvsHD_fisher,ResultsGender_PHDvsHD_fisher)
colnames(Results_Gender_fisher)<-c('p-value')
Variables<-c('3 Subgroups','Controls vs preHD','Controls vs HD','PreHD vs HD')
Results_Gender_fisher<-cbind(Variables,Results_Gender_fisher)
Results_Gender__fisher_DF<-as.data.frame(Results_Gender_fisher)
rownames(Results_Gender__fisher_DF)<-NULL
```

```{r frag9.2, echo=FALSE}
kableExtra::kable(n, caption = 'Número de hombres y mujeres por subgrupo', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r frag9.3, echo=FALSE}
kableExtra::kable(Results_Gender_chi_DF, caption = 'Chi-square test para género', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r frag9.4, echo=FALSE}
kableExtra::kable(Results_Gender__fisher_DF, caption = 'Fisher test para género', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

No existen diferencias de género entre controles y *gene carriers*, pero sí existen diferencias de género entre los tres subgrupos. 

Al realizar la comparativa dos a dos, se evidencia que no existen diferencias de género entre preHD y HD y entre controles y HD, pero sí existen diferencias de género entre controles y preHD.

\newpage

# ATR Average: RATR y LATR por separado

## Creación de DATAFRAMES

Se cargan los datos. 

Se recodifica la variable _age_ a factor mediante la información encontrada en la web siguiente [Etiquetar y recodificar variables en R](https://rpubs.com/dsulmont/475705). 

Se han generado dos edades factorizadas, una con 7 niveles (división de 5 en 5 años) y otra con 3 niveles (división de 10 en 10 años); la razón de ello es debido a la ausencia de sujetos en la combinación de algunos de los niveles de edad procedentes de la edad factorizada con 7 niveles con las variables de género y/o subgrupo, hecho que impide la comparación estadística por pares (ver apartado ANOVA permutacional - pairwise permutational test en *along-the-tract*).

```{r ATRavg1}
# Lectura de los datos 
library("readxl")

# Valores medios de cada una de las métricas de RM en cada sujeto
iron_avg <- read_excel("D:/Masters/MasterBioInformaticaBioEstadistica/TFM/Scripts_ATR/Tables_allpoints/mean_iron_dif/mean_iron.xlsx")
diff_avg <- read_excel("D:/Masters/MasterBioInformaticaBioEstadistica/TFM/Scripts_ATR/Tables_allpoints/mean_iron_dif/mean_diffusion.xlsx")
ATR_avg<-cbind(iron_avg[,c(1,2,13,5)], diff_avg[,c(43:46,11:14)])

# Datos demográficos: código, grupo, subgrupo, género y edad
demographics <- read_excel('D:/Masters/MasterBioInformaticaBioEstadistica/TFM/INFO_CLÍNICA/demos_bis.xlsx')
demographics$Group = factor(demographics$Group,
                            levels=c('1','2'), labels=c('Control', 'Carriers'))
demographics$Subgroup = factor(demographics$Subgroup,
                               levels=c('1','2','3'), 
                               labels=c('Control', 'PreHD', 'HD'))
demographics$Gender = factor(demographics$Gender,
                             levels=c('1','2'), labels=c('Male', 'Female'))

#Factorización de la edad en 7 niveles (de 5 en 5 años)
agef<-c()
agef[demographics$`Age(years)`>60]<-7 # 8 individuos
agef[demographics$`Age(years)`>55 & demographics$`Age(years)`<=60]<-6 # 3 individuos
agef[demographics$`Age(years)`>50 & demographics$`Age(years)`<=55]<-5 # 4 individuos
agef[demographics$`Age(years)`>45 & demographics$`Age(years)`<=50]<-4 # 15 individuos
agef[demographics$`Age(years)`>40 & demographics$`Age(years)`<=45]<-3 # 7 individuos
agef[demographics$`Age(years)`>35 & demographics$`Age(years)`<=40]<-2 # 9 individuos
agef[demographics$`Age(years)`<=35]<-1 # 9 individuos
agef<-as.factor(agef)

#Factorización de la edad en 3 niveles (de 10 en 10 años)
agef2<-c()
agef2[demographics$`Age(years)`>50]<-3 # 15 individuos
agef2[demographics$`Age(years)`>40 & demographics$`Age(years)`<=50]<-2 # 22 individuos
agef2[demographics$`Age(years)`<=40]<-1 # 18 individuos
agef2<-as.factor(agef2)

# Generación del dataframe
ATR_avg_demo<-cbind(demographics, agef, agef2, ATR_avg[,-c(1,2)])

# Summary statistics del dataframe
sumATR_avg_demo<-summary(ATR_avg_demo[,-c(1,5,6)])
kable(list(sumATR_avg_demo[,1:4], sumATR_avg_demo[,c(5,7:10)],sumATR_avg_demo[,c(6,11:14)]), 
      caption='Summary statistics', booktabs=TRUE)
```

\newpage

## Automated Exploratory Data Analysis 

```{r ATRavgEDA.1, eval=FALSE}
library(DataExplorer)
library(dplyr)
ATR_avg_demo<-ATR_avg_demo[,-c(1,5,6)]
ATR_avg_demo %>%
    create_report(
        output_file = paste("Report"),
        report_title = "EDA Report - Both ATR",
        y = "Subgroup"
    )
```

Se generan los diferentes plots que se consideran necesarios con las funciones del paquete `DataExplorer`.

```{r ATRavgEDA.2.1, echo=FALSE}
library(DataExplorer)
ATR_avg_demo<-ATR_avg_demo[,-c(1,5,6)]
# La estructura del dataframe
DataExplorer::plot_str(ATR_avg_demo)
# Barplots de cada variable categórica
DataExplorer::plot_bar(ATR_avg_demo)
# Barplots de cada variable categórica en función del subgrupo
DataExplorer::plot_bar(ATR_avg_demo, by="Subgroup")
# QQ-plots de cada variable numérica en función del subgrupo
RATRAvg_demo<-ATR_avg_demo[,c(1:5,7:10)]
DataExplorer::plot_qq(RATRAvg_demo, by="Subgroup")
LATRAvg_demo<-ATR_avg_demo[,c(1:4,6,11:14)]
DataExplorer::plot_qq(LATRAvg_demo, by="Subgroup")
# Plots de densidad de las variables numéricas (global)
DataExplorer::plot_density(ATR_avg_demo)
```

```{r ATRavgEDA.2.2, echo=FALSE}
library(gridExtra)
library(grid)
library(ggplot2)
library(lattice)
# Plots de densidad de las variables numéricas en función del subgrupo
plotriron<-ggplot(ATR_avg_demo, aes(x = rhatr_Iron, color = Subgroup)) + geom_density(linewidth = 0.75)
plotliron<-ggplot(ATR_avg_demo, aes(x = lhatr_Iron, color = Subgroup)) + geom_density(linewidth = 0.75)
plotrad<-ggplot(ATR_avg_demo, aes(x = rhatr_AD, color = Subgroup)) + geom_density(linewidth = 0.75)
plotlad<-ggplot(ATR_avg_demo, aes(x = lhatr_AD, color = Subgroup)) + geom_density(linewidth = 0.75)
plotrmd<-ggplot(ATR_avg_demo, aes(x = rhatr_MD, color = Subgroup)) + geom_density(linewidth = 0.75)
plotlmd<-ggplot(ATR_avg_demo, aes(x = lhatr_MD, color = Subgroup)) + geom_density(linewidth = 0.75)
plotrrd<-ggplot(ATR_avg_demo, aes(x = rhatr_RD, color = Subgroup)) + geom_density(linewidth = 0.75)
plotlrd<-ggplot(ATR_avg_demo, aes(x = lhatr_RD, color = Subgroup)) + geom_density(linewidth = 0.75)
plotrfa<-ggplot(ATR_avg_demo, aes(x = rhatr_FA, color = Subgroup)) + geom_density(linewidth = 0.75)
plotlfa<-ggplot(ATR_avg_demo, aes(x = lhatr_FA, color = Subgroup)) + geom_density(linewidth = 0.75)

grid.arrange(plotriron,plotliron,plotrad,plotlad,plotrmd,plotlmd,plotrrd,plotlrd,plotrfa,plotlfa, ncol=2)
#grid.arrange(plotriron,plotliron, ncol=2)
#grid.arrange(plotrad,plotlad, ncol=2)
#grid.arrange(plotrmd,plotlmd, ncol=2)
#grid.arrange(plotrrd,plotlrd, ncol=2)
#grid.arrange(plotrfa,plotlfa, ncol=2)
```

Con los gráficos qq-plot y los density plots, se observa que los pacientes HD tienen mayores valores de difusividad axial, media y radial y menores valores de hierro y de anisotropía fraccional, y, los sujetos presintomáticos tienen mayores valores de anisotropía fraccional y una tendencia a mayores valores de hierro. 

```{r ATRavgEDA.2.3.1, echo=FALSE}
library(DataExplorer)
# Boxplots de las variables numéricas en función del subgrupo
par(mfrow=c(5,2))
DataExplorer::plot_boxplot(ATR_avg_demo, by="Subgroup")
# Boxplots de las variables numéricas en función de la edad factorizada
DataExplorer::plot_boxplot(ATR_avg_demo, by="agef2")
# Boxplots de las variables numéricas en función del género
DataExplorer::plot_boxplot(ATR_avg_demo, by="Gender")
# Plot de correlaciones entre todas las variables de interés
#ATR_avg_demo<-ATR_avg_demo[,-c(1)]
#plot_correlation(ATR_avg_demo, geom_text_args = list(size=1.5))
```

Los boxplots sirven para determinar si existen diferencias etnre las variables de RM y los niveles de las variables categóricas (subgrupo, género y edad factorizada).

```{r ATRavgEDA.2.3.2, echo=FALSE}
library(DataExplorer)
set.seed(123)
# Plot de componentes principales entre todas las variables de interés
ATR_avg_demo<-ATR_avg_demo[,-c(1)]
DataExplorer::plot_prcomp(ATR_avg_demo)
# Plot de componentes principales entre todas las variables de interés (sin subgroup)
ATR_avg_demo<-ATR_avg_demo[,-c(1)]
DataExplorer::plot_prcomp(ATR_avg_demo)
```

El gráfico del PCA muestra 3 componentes principales, los dos primeros parecen diferenciar los 3 subgrupos y el tercer componente describe las covariables demográficas (género y edad factorizada). 

Se genera un plot para cada ATR con la función `ggpairs` del paquete `GGally`.

```{r ATRavgEDA.2.4}
ATR_avg_demo<-cbind(demographics, agef, agef2, ATR_avg[,-c(1,2)])
ATR_avg_demo<-ATR_avg_demo[,-c(1,5,6)]
library(GGally)
RATRAvg_demo<-ATR_avg_demo[,c(1:5,7:10)]
RATRAvg_demo %>%
  ggpairs(mapping = aes(color=ATR_avg_demo$Subgroup, alpha=0.5))
```

```{r ATRavgEDA.2.5}
library(GGally)
LATRAvg_demo<-ATR_avg_demo[,c(1:4,6,11:14)]
LATRAvg_demo %>%
  ggpairs(mapping = aes(color=ATR_avg_demo$Subgroup, alpha=0.5))
```

Se genera una tabla mediante la función `ExpCatStat` del paquete `SmartEDA` para determinar la importancia de las variables en función de su información. Esta función combina resultados de la ponderación de la evidencia, el valor de la información y las estadísticas resumidas. Remarcar que el IV value depende del número de bins que modifica el valor informativo de las variables.

```{r ATRavgEDA.3, echo=FALSE}
library(SmartEDA)
ATR_avg_demo<-ATR_avg_demo[,-c(1)]
ResExpCatSat<-ExpCatStat(data=ATR_avg_demo, Target = 'Subgroup', Pclass='Control', bin=15, result='Stat', plot=TRUE)
kableExtra::kable(ResExpCatSat, caption = 'Asociaciones y Poder predictivo de las variables respecto a Subgrupo', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

La tabla muestra el grado de asociación y el poder predictivo de cada variable (métricas de RM, género y edad factorizada) con respecto a la variable diana (en este caso, subgrupo). La función `ExpCatStat`del paquete `SmartEDA` combina los resultados del peso de la evidencia, el valor informativo y el resumen estadístico de cada variable categórica introducida. Para las variables numéricas, la función las discretiza y, en función del número de bins, los resultados pueden variar.  

```{r ATRavg1.1, echo=FALSE}
# Generación del dataframe
ATR_avg_demo<-cbind(demographics, agef, agef2, ATR_avg[,-c(1,2)])
```

\newpage

## Estadística descriptiva gráfica

Para determinar el **comportamiento de los datos (normales o no normales)**, se procede a la visualización gráfica de los datos así como a la determinación de medidas estadísticas. 

### BARPLOTS

Se procede a la visualización de los datos mediante barplots (la altura del barplot es la media de la medida y se añade un errorbar que es la media +/- desviación estándard) que da una idea de las posibles diferencias entre subgrupos.

Se consulta la siguiente referencia: [ggplot2 barplots : Quick start guide - R software and data visualization](http://www.sthda.com/english/wiki/ggplot2-barplots-quick-start-guide-r-software-and-data-visualization).

```{r ATRavg2, echo=FALSE}
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
 return(data_sum)
}

RATR_Iron <- data_summary(ATR_avg_demo, varname="rhatr_Iron", 
                          groupnames=c("Subgroup"))
RATR_AD <- data_summary(ATR_avg_demo, varname="rhatr_AD",
                        groupnames=c("Subgroup"))
RATR_RD <- data_summary(ATR_avg_demo, varname="rhatr_RD",
                        groupnames=c("Subgroup"))
RATR_MD <- data_summary(ATR_avg_demo, varname="rhatr_MD",
                        groupnames=c("Subgroup"))
RATR_FA <- data_summary(ATR_avg_demo, varname="rhatr_FA",
                        groupnames=c("Subgroup"))
LATR_Iron <- data_summary(ATR_avg_demo, varname="lhatr_Iron", 
                          groupnames=c("Subgroup"))
LATR_AD <- data_summary(ATR_avg_demo, varname="lhatr_AD",
                        groupnames=c("Subgroup"))
LATR_RD <- data_summary(ATR_avg_demo, varname="lhatr_RD",
                        groupnames=c("Subgroup"))
LATR_MD <- data_summary(ATR_avg_demo, varname="lhatr_MD",
                        groupnames=c("Subgroup"))
LATR_FA <- data_summary(ATR_avg_demo, varname="lhatr_FA",
                        groupnames=c("Subgroup"))
```

#### IRON

```{r ATRavg3, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
library("ggplot2")
barplot_RATR_IRON <- ggplot(RATR_Iron, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of Iron Average in RATR", x="Subgroup", y = "Iron")+
   theme_classic() 
barplot_RATR_IRON

barplot_LATR_IRON <- ggplot(LATR_Iron, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of Iron Average in LATR", x="Subgroup", y = "Iron")+
   theme_classic() 
barplot_LATR_IRON

#grid.arrange(barplot_RATR_IRON,barplot_LATR_IRON,ncol=2)
#grid.arrange(plotriron,plotliron,barplot_RATR_IRON,barplot_LATR_IRON, ncol=2)
```

\newpage

#### AD

```{r ATRavg4, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_RATR_AD <- ggplot(RATR_AD, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of AD Average in RATR", x="Subgroup", y = "AD")+
   theme_classic() 
barplot_RATR_AD 

barplot_LATR_AD <- ggplot(LATR_AD, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of AD Average in LATR", x="Subgroup", y = "AD")+
   theme_classic() 
barplot_LATR_AD

#grid.arrange(barplot_RATR_AD,barplot_LATR_AD,ncol=2)
#grid.arrange(plotrad,plotlad,barplot_RATR_AD,barplot_LATR_AD, ncol=2)
```

\newpage

#### MD

```{r ATRavg5, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_RATR_MD <- ggplot(RATR_MD, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of MD Average in RATR", x="Subgroup", y = "MD")+
   theme_classic() 
barplot_RATR_MD

barplot_LATR_MD <- ggplot(LATR_MD, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of MD Average in LATR", x="Subgroup", y = "MD")+
   theme_classic() 
barplot_LATR_MD

#grid.arrange(barplot_RATR_MD,barplot_LATR_MD,ncol=2)
#grid.arrange(plotrmd,plotlmd, barplot_RATR_MD,barplot_LATR_MD, ncol=2)
```

\newpage

#### RD

```{r ATRavg6, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_RATR_RD <- ggplot(RATR_RD, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of RD Average in RATR", x="Subgroup", y = "RD")+
   theme_classic() 
barplot_RATR_RD

barplot_LATR_RD <- ggplot(LATR_RD, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of RD Average in LATR", x="Subgroup", y = "RD")+
   theme_classic() 
barplot_LATR_RD 

#grid.arrange(barplot_RATR_RD,barplot_LATR_RD,ncol=2)
#grid.arrange(plotrrd,plotlrd,barplot_RATR_RD,barplot_LATR_RD, ncol=2)
```

\newpage

#### FA

```{r ATRavg7, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_RATR_FA <- ggplot(RATR_FA, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of FA Average in RATR", x="Subgroup", y = "FA")+
   theme_classic() 
barplot_RATR_FA 

barplot_LATR_FA <- ggplot(LATR_FA, aes(x=Subgroup, y=mean)) + 
  geom_bar(stat="identity", position=position_dodge(), 
           fill=c('red', 'green', 'blue')) + 
  theme(legend.position = "right") + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2,
                 position=position_dodge(.9)) + theme_minimal() + 
  labs(title="Plot of FA Average in LATR", x="Subgroup", y = "FA")+
   theme_classic() 
barplot_LATR_FA

#grid.arrange(barplot_RATR_FA,barplot_LATR_FA,ncol=2)
#grid.arrange(plotrfa,plotlfa, barplot_RATR_FA,barplot_LATR_FA,ncol=2)
```

\newpage

### HISTOGRAMAS y QQ-PLOTS

Para obtener una idea de la **normalidad de los datos y de la presencia/ausencia de outliers**, para cada métrica de RM, se genera un histograma, un plot y cuatro qq-plots (un qqplot sin distinción entre subgrupos y un qqplot para cada subgrupo).

Para valorar posibles **diferencias en variabilidad de las métricas de RM en los niveles de los diferentes factores de interés** subgrupo, género y edad_factorizada, también se generan plots de las métricas de RM para cada subgrupo, género y grupo de edad (tanto para la edad factorizada de 7 niveles como la edad factorizada de 3 niveles).

#### IRON - RATR

```{r ATRavg8.1, echo=FALSE, fig.align='center'}
library(car)
par(mfrow = c(1,2))
hist(ATR_avg_demo$rhatr_Iron, xlab='Average Iron in RATR', main='Histogram of RATR Average Iron',cex.main=1)
plot(ATR_avg_demo$rhatr_Iron, ylab='Average Iron in RATR')
```

```{r ATRavg8.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
library(car)
qqPlot(ATR_avg_demo$rhatr_Iron, ylab='Average Iron in RATR')
```

```{r ATRavg8.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$rhatr_Iron, ylab='Average Iron in RATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$rhatr_Iron, ylab='Average Iron in RATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$rhatr_Iron, ylab='Average Iron in RATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$rhatr_Iron~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average Iron in RATR')
plot(ATR_avg_demo$rhatr_Iron~ATR_avg_demo$Gender, xlab='Gender', ylab='Average Iron in RATR')
plot(ATR_avg_demo$rhatr_Iron~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average Iron in RATR')
plot(ATR_avg_demo$rhatr_Iron~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average Iron in RATR')
```

\newpage

#### IRON - LATR

```{r ATRavg9.1, echo=FALSE,fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$lhatr_Iron, xlab='Average Iron in LATR', main='Histogram of LATR Average Iron',cex.main=1)
plot(ATR_avg_demo$lhatr_Iron, ylab='Average Iron in LATR')
```

```{r ATRavg9.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$lhatr_Iron, ylab='Average Iron in LATR')
```

```{r ATRavg9.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$lhatr_Iron, ylab='Average Iron in LATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$lhatr_Iron, ylab='Average Iron in LATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$lhatr_Iron, ylab='Average Iron in LATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$lhatr_Iron~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average Iron in LATR')
plot(ATR_avg_demo$lhatr_Iron~ATR_avg_demo$Gender, xlab='Gender', ylab='Average Iron in LATR')
plot(ATR_avg_demo$lhatr_Iron~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average Iron in LATR')
plot(ATR_avg_demo$lhatr_Iron~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average Iron in LATR')
```

\newpage

#### AD - RATR

```{r ATRavg10.1, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$rhatr_AD, xlab='Average AD in RATR', main='Histogram of RATR Average AD',cex.main=1)
plot(ATR_avg_demo$rhatr_AD, ylab='Average AD in RATR')
```

```{r ATRavg10.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$rhatr_AD, ylab='Average AD in RATR')
```

```{r ATRavg10.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$rhatr_AD, ylab='Average AD in RATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$rhatr_AD, ylab='Average AD in RATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$rhatr_AD, ylab='Average AD in RATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$rhatr_AD~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average AD in RATR')
plot(ATR_avg_demo$rhatr_AD~ATR_avg_demo$Gender, xlab='Gender', ylab='Average AD in RATR')
plot(ATR_avg_demo$rhatr_AD~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average AD in RATR')
plot(ATR_avg_demo$rhatr_AD~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average AD in RATR')
```

\newpage

#### AD - LATR

```{r ATRavg11.1, echo=FALSE,fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$lhatr_AD, xlab='Average AD in LATR', main='Histogram of LATR Average AD',cex.main=1)
plot(ATR_avg_demo$lhatr_AD, ylab='Average AD in LATR')
```

```{r ATRavg11.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$lhatr_AD, ylab='Average AD in LATR')
```

```{r ATRavg11.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$lhatr_AD, ylab='Average AD in LATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$lhatr_AD, ylab='Average AD in LATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$lhatr_AD, ylab='Average AD in LATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$lhatr_AD~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average AD in LATR')
plot(ATR_avg_demo$lhatr_AD~ATR_avg_demo$Gender, xlab='Gender', ylab='Average AD in LATR')
plot(ATR_avg_demo$lhatr_AD~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average AD in LATR')
plot(ATR_avg_demo$lhatr_AD~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average AD in LATR')
```

\newpage

#### MD - RATR

```{r ATRavg12.1, echo=FALSE,fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$rhatr_MD, xlab='Average MD in RATR', main='Histogram of RATR Average MD',cex.main=1)
plot(ATR_avg_demo$rhatr_MD, ylab='Average MD in RATR')
```

```{r ATRavg12.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$rhatr_MD, ylab='Average MD in RATR')
```

```{r ATRavg12.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$rhatr_MD, ylab='Average MD in RATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$rhatr_MD, ylab='Average MD in RATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$rhatr_MD, ylab='Average MD in RATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$rhatr_MD~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average MD in RATR')
plot(ATR_avg_demo$rhatr_MD~ATR_avg_demo$Gender, xlab='Gender', ylab='Average MD in RATR')
plot(ATR_avg_demo$rhatr_MD~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average MD in RATR')
plot(ATR_avg_demo$rhatr_MD~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average MD in RATR')
```

\newpage

#### MD - LATR

```{r ATRavg13.1, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$lhatr_MD, xlab='Average MD in LATR', main='Histogram of LATR Average MD',cex.main=1)
plot(ATR_avg_demo$lhatr_MD, ylab='Average MD in LATR')
```

```{r ATRavg13.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$lhatr_MD, ylab='Average MD in LATR')
```

```{r ATRavg13.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$lhatr_MD, ylab='Average MD in LATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$lhatr_MD, ylab='Average MD in LATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$lhatr_MD, ylab='Average MD in LATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$lhatr_MD~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average MD in LATR')
plot(ATR_avg_demo$lhatr_MD~ATR_avg_demo$Gender, xlab='Gender', ylab='Average MD in LATR')
plot(ATR_avg_demo$lhatr_MD~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average MD in LATR')
plot(ATR_avg_demo$lhatr_MD~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average MD in LATR')
```

\newpage

#### RD - RATR

```{r ATRavg14.1, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$rhatr_RD, xlab='Average RD in RATR', main='Histogram of RATR Average RD',cex.main=1)
plot(ATR_avg_demo$rhatr_RD, ylab='Average RD in RATR')
```

```{r ATRavg14.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$rhatr_RD, ylab='Average RD in RATR')
```

```{r ATRavg14.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$rhatr_RD, ylab='Average RD in RATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$rhatr_RD, ylab='Average RD in RATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$rhatr_RD, ylab='Average RD in RATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$rhatr_RD~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average RD in RATR')
plot(ATR_avg_demo$rhatr_RD~ATR_avg_demo$Gender, xlab='Gender', ylab='Average RD in RATR')
plot(ATR_avg_demo$rhatr_RD~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average RD in RATR')
plot(ATR_avg_demo$rhatr_RD~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average RD in RATR')
```

\newpage

#### RD - LATR

```{r ATRavg15.1, echo=FALSE,fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$lhatr_RD, xlab='Average RD in LATR', main='Histogram of LATR Average RD',cex.main=1)
plot(ATR_avg_demo$lhatr_RD, ylab='Average RD in LATR')
```

```{r ATRavg15.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$lhatr_RD, ylab='Average RD in LATR')
```

```{r ATRavg15.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$lhatr_RD, ylab='Average RD in LATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$lhatr_RD, ylab='Average RD in LATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$lhatr_RD, ylab='Average RD in LATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$lhatr_RD~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average RD in LATR')
plot(ATR_avg_demo$lhatr_RD~ATR_avg_demo$Gender, xlab='Gender', ylab='Average RD in LATR')
plot(ATR_avg_demo$lhatr_RD~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average RD in LATR')
plot(ATR_avg_demo$lhatr_RD~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average RD in LATR')
```

\newpage

#### FA - RATR

```{r ATRavg16.1, echo=FALSE,fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$rhatr_FA, xlab='Average FA in RATR', main='Histogram of RATR Average FA',cex.main=1)
plot(ATR_avg_demo$rhatr_FA, ylab='Average FA in RATR')
```

```{r ATRavg16.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$rhatr_FA, ylab='Average FA in RATR')
```

```{r ATRavg16.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$rhatr_FA, ylab='Average FA in RATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$rhatr_FA, ylab='Average FA in RATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$rhatr_FA, ylab='Average FA in RATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$rhatr_FA~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average FA in RATR')
plot(ATR_avg_demo$rhatr_FA~ATR_avg_demo$Gender, xlab='Gender', ylab='Average FA in RATR')
plot(ATR_avg_demo$rhatr_FA~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average FA in RATR')
plot(ATR_avg_demo$rhatr_FA~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average FA in RATR')
```

\newpage

#### FA - LATR

```{r ATRavg17.1, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_avg_demo$lhatr_FA, xlab='Average FA in LATR', main='Histogram of LATR Average FA',cex.main=1)
plot(ATR_avg_demo$lhatr_FA, ylab='Average FA in LATR')
```

```{r ATRavg17.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
qqPlot(ATR_avg_demo$lhatr_FA, ylab='Average FA in LATR')
```

```{r ATRavg17.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_avg_demo, Subgroup=='Control')$lhatr_FA, ylab='Average FA in LATR in Controls')
qqPlot(subset(ATR_avg_demo, Subgroup=='PreHD')$lhatr_FA, ylab='Average FA in LATR in PreHD')
qqPlot(subset(ATR_avg_demo, Subgroup=='HD')$lhatr_FA, ylab='Average FA in LATR in HD')
par(mfrow = c(2,2))
plot(ATR_avg_demo$lhatr_FA~ATR_avg_demo$Subgroup, xlab='Subgroup', ylab='Average FA in LATR')
plot(ATR_avg_demo$lhatr_FA~ATR_avg_demo$Gender, xlab='Gender', ylab='Average FA in LATR')
plot(ATR_avg_demo$lhatr_FA~ATR_avg_demo$agef, xlab='Factorized Age - 7 levels', ylab='Average FA in LATR')
plot(ATR_avg_demo$lhatr_FA~ATR_avg_demo$agef2, xlab='Factorized Age - 3 levels', ylab='Average FA in LATR')
```

**Con estos gráficos, globalmente se observa que los sujetos más atípicos para preHD son los índices 6 y 11 y para HD son los índices 9 y 17. Sin embargo, es importante remarcar que los posibles sujetos outliers varían de métrica a métrica, hecho que dificultaría generar muestras homogéneas en los modelos estadísticos de las diferentes métricas, fenómeno que conceptualmente no me agrada. Además es una muestra con pocos sujetos y eliminar sujetos reduciría potencia estadística.**

\newpage

### PLOT de CORRELACIONES

Previamente, a generar los diferentes modelos estadísticos, se genera un plot de correlaciones entre todas las variables. 

```{r ATRavg18,echo=FALSE,fig.align='center'}
library(DataExplorer)
plot_correlation(ATR_avg_demo[,-c(1,5,6)], geom_text_args = list(size=2))
```

En este plot, se objetivan los siguientes fenómenos:

- Las métricas AD, RD y MD están altamente correlacionadas tanto en el mismo hemisferio como con las métricas del hemisferio contralateral;
- Las métricas de FA entre ambos hemisferios están altamente correlacionadas;
- Las métricas de hierro entre ambos hemisferios están altamente correlacionadas;
- El subgrupo preHD se correlaciona con las métricas de hierro y FA (tanto del hemisferio derecho como del hemisferio izquierdo), con el género femenino y con los grupos de edad 1 (de los 3 niveles) y 1 y 3 (de los 7 niveles);
- El subgrupo HD se correlaciona con las métricas AD, RD y MD (de ambos hemisferios), con los grupos de edad 2 (de los 3 niveles) y 4 y 7 (de los 7 niveles);
- El género femenino se correlaciona con las métricas de hierro y FA (de ambos hemisferios), con el grupo *carriers*, el subgrupo PreHD, y con los grupos de edad 2 (de los 3 niveles) y 3 y 6 (de los 7 niveles);
- El género masculino se correlaciona con las métricas de AD, RD y MD (de ambos hemisferios), con el grupo y el subgrupo Control, y con los grupos de edad 1 (de los 3 niveles) y 2 y 5 (de los 7 niveles);
- El subgrupo de edad 3 (de los 3 niveles) se correlaciona con hierro del hemisferio izquierdo, AD, RD y MD de ambos hemisferios, con el grupo y el subgrupo Control; 
- El subgrupo de edad 1 (de los 3 niveles) se correlaciona con hierro del hemisferio derecho, FA de ambos hemisferios, con los subgrupos Control y preHD y con el género masculino.

Habiendo expuesto lo anterior, se objetiva que tanto género como edad son covariables o factores confusores en la relación entre las métricas y los subgrupos, por tanto dichas variables se van a introducir en los modelos para controlar su efecto. Se utilizará la edad factorizada de 3 niveles dado que presenta una `n` por nivel más comparable entre niveles.

\newpage

## Estadística descriptiva matemática

### Media, mediana, desviación estándar, kurtosis y skewness

Se procede a determinar la **media**, la **mediana**, la **desviación estándar**, la **kurtosis** y el **skewness** (estas dos últimas medidas pueden calcularse mediante tres librerías `e1071`, `moments` y `agricolae` y se ha consultado la siguiente web para su interpretación [Skewness and Kurtosis in Statistics](https://www.r-bloggers.com/2020/11/skewness-and-kurtosis-in-statistics/)).

En función de los valores de *skewnness*, una distribución puede ser:

- **Simétrica**, con valores de *skewnness* entre -0.5 y 0.5, con la media y la mediana siendo similares entre sí;
- **Asimétrica positiva** (*right-skewed* o *right-tailed*), cuyo histograma muestra una cola derecha más larga concentrándose la mayoría de las observaciones en la cola izquierda y con una media mayor que la mediana. 
- **Asimétrica negativa** (*left-skewed* o *left-tailed*), cuyo histograma muestra una cola izquierda más larga concentrándose la mayoría de las observaciones en la cola derecha y con una mediana mayor que la media.

La asimetría se gradará en función de los valores de *skewnness* como moderada con valores entre 0.5 y 1 o -0.5 y -1 y como alta/severa con valores mayores a 1 o inferiores a -1. 

En función de los valores de *kurtosis*, una distribución puede ser:

- **Mesokúrtica**, en el caso de la distribución normal, con valores de kurtosis próximos a 3;
- **Leptokúrtica** (*kurtosis* positiva con valores mayores de 3), con una distribución concentrada de valores generando colas gruesas y pico afilado; 
- **Platikúrtica** (*kurtosis* negativa con valores menores de 3), con una distribución que muestra un pico más bajo y ancho y colas más delgadas. 

```{r ATRavg19.1, echo=FALSE}
# Media, mediana, varianza, desviación estándar, Kurtosis, Skewness 
#IRON - RATR
library(e1071)
IronR<-rbind(mean(ATR_avg_demo$rhatr_Iron), median(ATR_avg_demo$rhatr_Iron),
             sd(ATR_avg_demo$rhatr_Iron),
             e1071::skewness(ATR_avg_demo$rhatr_Iron, type = 3),
             e1071::kurtosis(ATR_avg_demo$rhatr_Iron, type = 3))
IronR<-round(IronR,5)

#IRON - LATR
IronL<-rbind(mean(ATR_avg_demo$lhatr_Iron),median(ATR_avg_demo$lhatr_Iron),
             sd(ATR_avg_demo$lhatr_Iron),
             e1071::skewness(ATR_avg_demo$lhatr_Iron, type = 3),
             e1071::kurtosis(ATR_avg_demo$lhatr_Iron, type = 3))
IronL<-round(IronL,5)

#AD - RATR
adR<-rbind(mean(ATR_avg_demo$rhatr_AD),median(ATR_avg_demo$rhatr_AD),
           sd(ATR_avg_demo$rhatr_AD),
           e1071::skewness(ATR_avg_demo$rhatr_AD, type = 3),
           e1071::kurtosis(ATR_avg_demo$rhatr_AD, type = 3))
adR<-round(adR,5)

#AD - LATR
adL<-rbind(mean(ATR_avg_demo$lhatr_AD),median(ATR_avg_demo$lhatr_AD),
           sd(ATR_avg_demo$lhatr_AD),
           e1071::skewness(ATR_avg_demo$lhatr_AD, type = 3),
           e1071::kurtosis(ATR_avg_demo$lhatr_AD, type = 3))
adL<-round(adL,5)

#MD - RATR
mdR<-rbind(mean(ATR_avg_demo$rhatr_MD),median(ATR_avg_demo$rhatr_MD),
           sd(ATR_avg_demo$rhatr_MD),
           e1071::skewness(ATR_avg_demo$rhatr_MD, type = 3),
           e1071::kurtosis(ATR_avg_demo$rhatr_MD, type = 3))
mdR<-round(mdR,5)

#MD - LATR
mdL<-rbind(mean(ATR_avg_demo$lhatr_MD),median(ATR_avg_demo$lhatr_MD),
           sd(ATR_avg_demo$lhatr_MD),
           e1071::skewness(ATR_avg_demo$lhatr_MD, type = 3),
           e1071::kurtosis(ATR_avg_demo$lhatr_MD, type = 3))
mdL<-round(mdL,5)

#RD - RATR
rdR<-rbind(mean(ATR_avg_demo$rhatr_RD),median(ATR_avg_demo$rhatr_RD),
           sd(ATR_avg_demo$rhatr_RD),
           e1071::skewness(ATR_avg_demo$rhatr_RD, type = 3),
           e1071::kurtosis(ATR_avg_demo$rhatr_RD, type = 3))
rdR<-round(rdR,5)

#RD - LATR
rdL<-rbind(mean(ATR_avg_demo$lhatr_RD),median(ATR_avg_demo$lhatr_RD),
           sd(ATR_avg_demo$lhatr_RD),
           e1071::skewness(ATR_avg_demo$lhatr_RD, type = 3),
           e1071::kurtosis(ATR_avg_demo$lhatr_RD, type = 3))
rdL<-round(rdL,5)

#FA - RATR
faR<-rbind(mean(ATR_avg_demo$rhatr_FA),median(ATR_avg_demo$rhatr_FA),
           sd(ATR_avg_demo$rhatr_FA),
           e1071::skewness(ATR_avg_demo$rhatr_FA, type = 3),
           e1071::kurtosis(ATR_avg_demo$rhatr_FA, type = 3))
faR<-round(faR,5)

#FA - LATR
faL<-rbind(mean(ATR_avg_demo$lhatr_FA),median(ATR_avg_demo$lhatr_FA),
           sd(ATR_avg_demo$lhatr_FA),
           e1071::skewness(ATR_avg_demo$lhatr_FA, type = 3),
           e1071::kurtosis(ATR_avg_demo$lhatr_FA, type = 3))
faL<-round(faL,5)

Variables<-c('Mean','Median','Standard Deviation','Skewness','Kurtosis')

MeasuresATR<-cbind(Variables,IronR,IronL,adR,adL,mdR,mdL,rdR,rdL,faR,faL)
MeasuresATR_Df<-as.data.frame(MeasuresATR)
colnames(MeasuresATR_Df)<-c('Variables',rep(c('RATR','LATR'),5))
```

```{r ATRavg19.2, echo=FALSE}
kableExtra::kable(MeasuresATR_Df, caption = 'Media, mediana, desviación estándar, skewness y kurtosis', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Iron' = 2, 'AD' = 2, 'MD' = 2, 'RD' = 2, 'FA' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Los valores de **hierro en el ATR derecho** presentan una asimetría marcada/severa positiva con valores de _skewness_ mayores de 1 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$rhatr_Iron, type = 3),2)`) y son leptokúrticos (*kurtosis* positiva con valores superiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$rhatr_Iron, type = 3),2)`). 

Los valores de **hierro en el ATR izquierdo** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$lhatr_Iron, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$lhatr_Iron, type = 3),2)`). 

Los valores de **difusividad axial en el ATR derecho** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$rhatr_AD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$rhatr_AD, type = 3),2)`). 

Los valores de **difusividad axial en el ATR izquierdo** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$lhatr_AD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$lhatr_AD, type = 3),2)`). 

Los valores de **difusividad media en el ATR derecho** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$rhatr_MD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$rhatr_MD, type = 3),2)`). 

Los valores de **difusividad media en el ATR izquierdo** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$lhatr_MD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$lhatr_MD, type = 3),2)`). 

Los valores de **difusividad radial en el ATR derecho** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$rhatr_RD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$rhatr_RD, type = 3),2)`). 

Los valores de **difusividad radial en el ATR derecho** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$lhatr_RD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$lhatr_RD, type = 3),2)`). 

Los valores de **anisotropía fraccional en el ATR derecho** presentan una simetría con valores de _skewness_ entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$rhatr_FA, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$rhatr_FA, type = 3),2)`). 

Los valores de **anisotropía fraccional en el ATR izquierdo** presentan una asimetría moderada negativa con valores de _skewness_ entre -0.5 y -1.0 (exactamente valor de `r round(e1071::skewness(ATR_avg_demo$lhatr_FA, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_avg_demo$lhatr_FA, type = 3),2)`). 

### Normalidad Univariante - Homocedasticidad de cada métrica para cada factor

Se procede a **valorar la normalidad** de los valores de las diferentes métricas de RM **y la homocedasticidad** de dichas métricas en los niveles de las variables categóricas de intéres (subgrupo, edad_factorizada, género).

La normalidad se puede obtener de una de las dos funciones siguientes: `shapiro.test` del paquete `stats` o `shapiro_test` del paquete `rstatix`. Los resultados son coincidentes. 

La homocedasticidad se obtiene de la función `fligner.test` del paquete `stats`. 

```{r ATRavg20.1, echo=FALSE}
library(stats)
# IRON - RATR
normalidad_IronR<-rbind(stats::shapiro.test(ATR_avg_demo$rhatr_Iron)[[1]][[1]],
                        stats::shapiro.test(ATR_avg_demo$rhatr_Iron)[[2]][[1]])
homo_subgrupos_IronR<-rbind(fligner.test(rhatr_Iron~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                            fligner.test(rhatr_Iron~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                            fligner.test(rhatr_Iron~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_IronR<-rbind(fligner.test(rhatr_Iron~agef, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(rhatr_Iron~agef, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(rhatr_Iron~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_IronR<-rbind(fligner.test(rhatr_Iron~agef2, data=ATR_avg_demo)[[1]][[1]],
                        fligner.test(rhatr_Iron~agef2, data=ATR_avg_demo)[[2]][[1]],
                        fligner.test(rhatr_Iron~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_IronR<-rbind(fligner.test(rhatr_Iron~Gender, data=ATR_avg_demo)[[1]][[1]],
                        fligner.test(rhatr_Iron~Gender, data=ATR_avg_demo)[[2]][[1]],
                        fligner.test(rhatr_Iron~Gender, data=ATR_avg_demo)[[3]][[1]])

# IRON - LATR
normalidad_IronL<-rbind(stats::shapiro.test(ATR_avg_demo$lhatr_Iron)[[1]][[1]],
                        stats::shapiro.test(ATR_avg_demo$lhatr_Iron)[[2]][[1]])
homo_subgrupos_IronL<-rbind(fligner.test(lhatr_Iron~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                            fligner.test(lhatr_Iron~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                            fligner.test(lhatr_Iron~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_IronL<-rbind(fligner.test(lhatr_Iron~agef, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(lhatr_Iron~agef, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(lhatr_Iron~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_IronL<-rbind(fligner.test(lhatr_Iron~agef2, data=ATR_avg_demo)[[1]][[1]],
                        fligner.test(lhatr_Iron~agef2, data=ATR_avg_demo)[[2]][[1]],
                        fligner.test(lhatr_Iron~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_IronL<-rbind(fligner.test(lhatr_Iron~Gender, data=ATR_avg_demo)[[1]][[1]],
                        fligner.test(lhatr_Iron~Gender, data=ATR_avg_demo)[[2]][[1]],
                        fligner.test(lhatr_Iron~Gender, data=ATR_avg_demo)[[3]][[1]])

# AD - RATR
normalidad_adR<-rbind(stats::shapiro.test(ATR_avg_demo$rhatr_AD)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$rhatr_AD)[[2]][[1]])
homo_subgrupos_adR<-rbind(fligner.test(rhatr_AD~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(rhatr_AD~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(rhatr_AD~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_adR<-rbind(fligner.test(rhatr_AD~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(rhatr_AD~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(rhatr_AD~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_adR<-rbind(fligner.test(rhatr_AD~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(rhatr_AD~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(rhatr_AD~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_adR<-rbind(fligner.test(rhatr_AD~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(rhatr_AD~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(rhatr_AD~Gender, data=ATR_avg_demo)[[3]][[1]])

# AD - LATR
normalidad_adL<-rbind(stats::shapiro.test(ATR_avg_demo$lhatr_AD)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$lhatr_AD)[[2]][[1]])
homo_subgrupos_adL<-rbind(fligner.test(lhatr_AD~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(lhatr_AD~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(lhatr_AD~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_adL<-rbind(fligner.test(lhatr_AD~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(lhatr_AD~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(lhatr_AD~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_adL<-rbind(fligner.test(lhatr_AD~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(lhatr_AD~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(lhatr_AD~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_adL<-rbind(fligner.test(lhatr_AD~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(lhatr_AD~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(lhatr_AD~Gender, data=ATR_avg_demo)[[3]][[1]])

# MD - RATR
normalidad_mdR<-rbind(stats::shapiro.test(ATR_avg_demo$rhatr_MD)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$rhatr_MD)[[2]][[1]])
homo_subgrupos_mdR<-rbind(fligner.test(rhatr_MD~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(rhatr_MD~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(rhatr_MD~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_mdR<-rbind(fligner.test(rhatr_MD~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(rhatr_MD~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(rhatr_MD~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_mdR<-rbind(fligner.test(rhatr_MD~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(rhatr_MD~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(rhatr_MD~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_mdR<-rbind(fligner.test(rhatr_MD~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(rhatr_MD~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(rhatr_MD~Gender, data=ATR_avg_demo)[[3]][[1]])

# MD - LATR
normalidad_mdL<-rbind(stats::shapiro.test(ATR_avg_demo$lhatr_MD)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$lhatr_MD)[[2]][[1]])
homo_subgrupos_mdL<-rbind(fligner.test(lhatr_MD~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(lhatr_MD~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(lhatr_MD~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_mdL<-rbind(fligner.test(lhatr_MD~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(lhatr_MD~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(lhatr_MD~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_mdL<-rbind(fligner.test(lhatr_MD~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(lhatr_MD~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(lhatr_MD~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_mdL<-rbind(fligner.test(lhatr_MD~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(lhatr_MD~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(lhatr_MD~Gender, data=ATR_avg_demo)[[3]][[1]])

# RD - RATR
normalidad_rdR<-rbind(stats::shapiro.test(ATR_avg_demo$rhatr_RD)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$rhatr_RD)[[2]][[1]])
homo_subgrupos_rdR<-rbind(fligner.test(rhatr_RD~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(rhatr_RD~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(rhatr_RD~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_rdR<-rbind(fligner.test(rhatr_RD~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(rhatr_RD~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(rhatr_RD~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_rdR<-rbind(fligner.test(rhatr_RD~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(rhatr_RD~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(rhatr_RD~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_rdR<-rbind(fligner.test(rhatr_RD~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(rhatr_RD~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(rhatr_RD~Gender, data=ATR_avg_demo)[[3]][[1]])

# RD - LATR
normalidad_rdL<-rbind(stats::shapiro.test(ATR_avg_demo$lhatr_RD)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$lhatr_RD)[[2]][[1]])
homo_subgrupos_rdL<-rbind(fligner.test(lhatr_RD~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(lhatr_RD~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(lhatr_RD~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_rdL<-rbind(fligner.test(lhatr_RD~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(lhatr_RD~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(lhatr_RD~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_rdL<-rbind(fligner.test(lhatr_RD~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(lhatr_RD~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(lhatr_RD~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_rdL<-rbind(fligner.test(lhatr_RD~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(lhatr_RD~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(lhatr_RD~Gender, data=ATR_avg_demo)[[3]][[1]])

# FA- RATR
normalidad_faR<-rbind(stats::shapiro.test(ATR_avg_demo$rhatr_FA)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$rhatr_FA)[[2]][[1]])
homo_subgrupos_faR<-rbind(fligner.test(rhatr_FA~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(rhatr_FA~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(rhatr_FA~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_faR<-rbind(fligner.test(rhatr_FA~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(rhatr_FA~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(rhatr_FA~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_faR<-rbind(fligner.test(rhatr_FA~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(rhatr_FA~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(rhatr_FA~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_faR<-rbind(fligner.test(rhatr_FA~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(rhatr_FA~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(rhatr_FA~Gender, data=ATR_avg_demo)[[3]][[1]])

# FA - LATR
normalidad_faL<-rbind(stats::shapiro.test(ATR_avg_demo$lhatr_FA)[[1]][[1]],
                      stats::shapiro.test(ATR_avg_demo$lhatr_FA)[[2]][[1]])
homo_subgrupos_faL<-rbind(fligner.test(lhatr_FA~Subgroup, data=ATR_avg_demo)[[1]][[1]],
                          fligner.test(lhatr_FA~Subgroup, data=ATR_avg_demo)[[2]][[1]],
                          fligner.test(lhatr_FA~Subgroup, data=ATR_avg_demo)[[3]][[1]])
homo_agef_faL<-rbind(fligner.test(lhatr_FA~agef, data=ATR_avg_demo)[[1]][[1]],
                     fligner.test(lhatr_FA~agef, data=ATR_avg_demo)[[2]][[1]],
                     fligner.test(lhatr_FA~agef, data=ATR_avg_demo)[[3]][[1]])
homo_agef2_faL<-rbind(fligner.test(lhatr_FA~agef2, data=ATR_avg_demo)[[1]][[1]],
                      fligner.test(lhatr_FA~agef2, data=ATR_avg_demo)[[2]][[1]],
                      fligner.test(lhatr_FA~agef2, data=ATR_avg_demo)[[3]][[1]])
homo_gender_faL<-rbind(fligner.test(lhatr_FA~Gender, data=ATR_avg_demo)[[1]][[1]],
                       fligner.test(lhatr_FA~Gender, data=ATR_avg_demo)[[2]][[1]],
                       fligner.test(lhatr_FA~Gender, data=ATR_avg_demo)[[3]][[1]])

normalidad<-cbind(normalidad_IronR, normalidad_IronL,
                  normalidad_adR, normalidad_adL,
                  normalidad_mdR, normalidad_mdL,
                  normalidad_rdR, normalidad_rdL,
                  normalidad_faR, normalidad_faL)
normalidad<-round(normalidad,4)
normalidad_df<-as.data.frame(normalidad)
rownames(normalidad_df)<-c('W-Statistic','p-value')
colnames(normalidad_df)<-c(rep(c('RATR','LATR'),5))

homocedasticidad_subgrupo<-cbind(homo_subgrupos_IronR, homo_subgrupos_IronL,
                                 homo_subgrupos_adR, homo_subgrupos_adL,
                                 homo_subgrupos_mdR, homo_subgrupos_mdL,
                                 homo_subgrupos_rdR, homo_subgrupos_rdL,
                                 homo_subgrupos_faR, homo_subgrupos_faL)
homocedasticidad_subgrupo<-round(homocedasticidad_subgrupo,4)
homocedasticidad_subgrupo_df<-as.data.frame(homocedasticidad_subgrupo)
rownames(homocedasticidad_subgrupo_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_subgrupo_df)<-c(rep(c('RATR','LATR'),5))

homocedasticidad_genero<-cbind(homo_gender_IronR, homo_gender_IronL, 
                               homo_gender_adR, homo_gender_adL, 
                               homo_gender_mdR, homo_gender_mdL, 
                               homo_gender_rdR, homo_gender_rdL,
                               homo_gender_faR, homo_gender_faL)
homocedasticidad_genero<-round(homocedasticidad_genero,4)
homocedasticidad_genero_df<-as.data.frame(homocedasticidad_genero)
rownames(homocedasticidad_genero_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_genero_df)<-c(rep(c('RATR','LATR'),5))

homocedasticidad_agef<-cbind(homo_agef_IronR, homo_agef_IronL,
                             homo_agef_adR, homo_agef_adL,
                             homo_agef_mdR, homo_agef_mdL,
                             homo_agef_rdR, homo_agef_rdL,
                             homo_agef_faR, homo_agef_faL)
homocedasticidad_agef<-round(homocedasticidad_agef,4)
homocedasticidad_agef_df<-as.data.frame(homocedasticidad_agef)
rownames(homocedasticidad_agef_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_agef_df)<-c(rep(c('RATR','LATR'),5))

homocedasticidad_agef2<-cbind(homo_agef2_IronR, homo_agef2_IronL,
                              homo_agef2_adR, homo_agef2_adL,
                              homo_agef2_mdR, homo_agef2_mdL,
                              homo_agef2_rdR, homo_agef2_rdL,
                              homo_agef2_faR, homo_agef2_faL)
homocedasticidad_agef2<-round(homocedasticidad_agef2,4)
homocedasticidad_agef2_df<-as.data.frame(homocedasticidad_agef2)
rownames(homocedasticidad_agef2_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_agef2_df)<-c(rep(c('RATR','LATR'),5))
```

```{r ATRavg20.2, echo=FALSE}
kableExtra::kable(normalidad_df, caption = 'Valoración de la normalidad de las métricas de RM con la función shapiro test', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Iron' = 2, 'AD' = 2, 'MD' = 2, 'RD' = 2, 'FA' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.3, echo=FALSE}
kableExtra::kable(homocedasticidad_subgrupo_df, caption = 'Valoración de la homocedasticidad de las métricas de RM para la variable subgrupo', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Iron' = 2, 'AD' = 2, 'MD' = 2, 'RD' = 2, 'FA' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.4, echo=FALSE}
kableExtra::kable(homocedasticidad_agef_df, caption = 'Valoración de la homocedasticidad de las métricas de RM para la variable edad factorizada con 7 niveles', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Iron' = 2, 'AD' = 2, 'MD' = 2, 'RD' = 2, 'FA' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.5, echo=FALSE}
kableExtra::kable(homocedasticidad_agef2_df, caption = 'Valoración de la homocedasticidad de las métricas de RM para la variable edad factorizada con 3 niveles', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Iron' = 2, 'AD' = 2, 'MD' = 2, 'RD' = 2, 'FA' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.6, echo=FALSE}
kableExtra::kable(homocedasticidad_genero_df, caption = 'Valoración de la homocedasticidad de las métricas de RM para la variable género', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Iron' = 2, 'AD' = 2, 'MD' = 2, 'RD' = 2, 'FA' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Los valores de **hierro en el ATR derecho** no son normales, pero presentan homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

Los valores de **hierro en el ATR izquierdo** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

Los valores de **difusividad axial en el ATR derecho** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas edad_factorizada y género, pero con heterocedasticidad de varianza entre subgrupos (p valor de `r round(fligner.test(rhatr_AD~Subgroup, data=ATR_avg_demo)[[3]],3)`). Posteriormente, en la generación del modelo, se valorará el comportamiento de los residuos para decidir sobre la eliminación de outliers. 

Los valores de **difusividad axial en el ATR izquierdo** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

Los valores de **difusividad media en el ATR derecho** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

Los valores de **difusividad media en el ATR izquierdo** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

Los valores de **difusividad radial en el ATR derecho** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas subgrupo y edad_factorizada, pero con heterocedasticidad de varianza entre géneros (p valor de `r round(fligner.test(rhatr_RD~Gender, data=ATR_avg_demo)[[3]],3)`). Posteriormente, en la generación del modelo, se valorará el comportamiento de los residuos para decidir sobre la eliminación de outliers. 

Los valores de **difusividad radial en el ATR izquierdo** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas subgrupo y edad_factorizada, pero con heterocedasticidad de varianza entre géneros (p valor de `r round(fligner.test(lhatr_RD~Gender, data=ATR_avg_demo)[[3]],3)`). Posteriormente, en la generación del modelo, se valorará el comportamiento de los residuos para decidir sobre la eliminación de outliers. 

Los valores de **anisotropía fraccional en el ATR derecho** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

Los valores de **anisotropía fraccional en el ATR izquierdo** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

**Por tanto, de todas las métricas, la variable _rhatr-iron_ es la única sin distribución normal, las variables _rhatr-RD_ y _lhatr-RD_ presentan heterocedasticidad para género, y la variable _rhatr-AD_ presenta heterocedasticidad para subgrupo.** 

Se intentará trabajar con todos los sujetos en los diferentes modelos porque mi interés es tener muestras homogéneas entre las diferentes métricas. En el caso que no se cumplan los criterios para aplicar métodos paramétricos, se procederá a generar métodos no paramétricos. De todas formas, se generarán ambos métodos para todas las métricas dado que también es de mi interés que los métodos sean homogéneos entre todas las métricas. 

### Normalidad multivariante

Se consultan las siguientes fuentes de información: [Package ‘MVN’](https://cran.r-project.org/web/packages/MVN/MVN.pdf), [Testing for Multivariate Normality](https://www.r-bloggers.com/2015/02/testing-for-multivariate-normality/), [How to Perform Multivariate Normality Tests in R](https://statisticalpoint.com/multivariate-normality-test-r/).

La función `mvn` del paquete `MVN` genera tests de normalidad multivariante. Dicha función tiene diferentes argumentos, de los cuales detallo los que he utilizado: 

- `data`: especificar el dataframe o la matriz numérica; 
- `mvnTest`: existen diferentes posibilidades; yo he elegido el test de Royston de normalidad multivariante. Este test calcula ya sea el estadístico W del Shapiro-Wilk para muestras platikúrticas o el Shapiro-Francia para muestras leptokúrticas; 
- `covariance`: para las opciones de `mardia` o `royston` en mvnTest; TRUE para normalizar la matriz de covarianza por `n` o FALSE para normalizarla por `n-1`; 
- `desc`: TRUE para calcular los estadísticos descriptivos;
- `univariateTest`: se selecciona el test de normalidad univariada de interés; 
- `univariatePlot`: se seleccionan los plots de normalidad univariada;
- `multivariatePlot`: se selecciona los plots de normalidad multivariada;
- `multivariateOutlierMethod`: se selecciona uno de los dos métodos de detección de oultiers multivariados ('quan' es el método cuantil por defecto, 'adj' es el método cuantil ajustado), ambos métodos basados en la distancia de Mahalanobis; 
- `showOutliers`: TRUE para mostrar los outliers multivariados;
- `showNewData`: TRUE para mostrar los datos sin outliers.

El output es una lista con los siguientes argumentos: 

- `multivariateNormality`: dataframe especificando el estadístico de normalidad multivariante y su p-valor;
- `univariateNormality`: dataframe con el estadístico de normalidad univariante y su p-valor para cada métrica de RM;
- `Descriptives`: dataframe con los diferentes estadísticos descriptivos (media, mediana, desviación estándar, mínimo, máximo, cuartil 25, cuartil 75, skew y kurtosis); 
- `multivariateOutliers`: dataframe con la distancia de Mahalanobis para cada outlier;
- `newData`: un dataframe con los nuevos datos habiendo eliminado los outliers. 

Se va testear la normalidad multivariante en 3 supuestos:

- Las 5 métricas de RM conjuntamente;
- Las 3 métricas de RM (AD, RD, MD) que parecen correlacionarse con el subgrupo HD;
- Las 2 métricas de RM (iron, FA) que parecen correlacionarse con el subgrupo preHD.

**Resultados para el RATR:**

```{r ATRavg20.7.1, fig.width=5, fig.height=4, fig.align='center'}
# Para las 5 métricas de RM conjuntamente
library(MVN)
par(mfrow = c(1, 2))
#RATR_avg<-ATR_avg_demo[,c(3,8, 10:13)]
RATR_avg<-ATR_avg_demo[,c('Subgroup','rhatr_Iron','rhatr_AD','rhatr_RD',
                          'rhatr_MD','rhatr_FA')]

# Valoración de la normalidad multivariante con todos los sujetos
RATR_mvn<-mvn(RATR_avg[-1], mvnTest = 'royston', covariance = TRUE, desc = TRUE, 
              univariateTest = 'SW', univariatePlot = 'qq', 
              multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
              showOutliers = TRUE, showNewData = TRUE)
index<-rownames(RATR_mvn$newData)
RATR_avg_WoOut<-RATR_avg[c(index),]
table(RATR_avg$Subgroup)
table(RATR_avg_WoOut$Subgroup)
```

```{r ATRavg20.7.1.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación de los dos outliers
# más extremos
par(mfrow = c(1, 2))
print(RATR_mvn$multivariateOutliers,max = 6)
newRATR_avg<-RATR_avg[-c(34,51),]
RATR_avg[c(34,51),]
newRATR_mvn<-mvn(newRATR_avg[-1], mvnTest = 'royston', covariance = TRUE, 
                 desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq', 
                 multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
                 showOutliers = TRUE, showNewData = TRUE)
RATR_avg_demo_WoOut<-ATR_avg_demo[-c(34,51),-c(9,14:17)]
#RATR_avg_demo_WoOut<-ATR_avg_demo[-c(34,51),-c('lhatr_Iron','lhatr_AD','lhatr_RD',
#                                               'lhatr_MD','lhatr_FA')]
RATR_avg_demo<-ATR_avg_demo[,-c(9,14:17)]
```

```{r ATRavg20.7.2, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
RATRmultiNorm<-rbind(RATR_mvn$multivariateNormality, newRATR_mvn$multivariateNormality)
rownames(RATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
RATRuniNorm<-cbind(RATR_mvn$univariateNormality, newRATR_mvn$univariateNormality)
rownames(RATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
RATRuniDes<-rbind(RATR_mvn$Descriptives, newRATR_mvn$Descriptives)
Variables<-rep(rownames(RATR_mvn$Descriptives),2)
RATRuniDes<-cbind(Variables, RATRuniDes)
rownames(RATRuniDes)<-NULL
```

```{r ATRavg20.7.3, echo=FALSE}
kableExtra::kable(RATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers para el ATR derecho habiendo considerado las 5 métricas conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.7.4, echo=FALSE}
kableExtra::kable(RATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las 5 métricas de ATR derecho', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.7.5, echo=FALSE}
kableExtra::kable(RATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las 5 métricas de ATR derecho', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=5, 'With elimination of outliers'=5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las 5 métricas conjuntamente**, se observa que no existe normalidad multivariante ni normalidad univariante para el hierro. Si se eliminan todos los outliers detectados por la función `mvn`, se elimina un tercio de los pacientes, un sujeto preHD y un sujeto control. Considero no correcto eliminar un tercio de los HD (pacientes sintomáticos), por lo que decido eliminar exclusivamente los dos sujetos (un HD y un preHD) con la mayor distancia de Mahalanobis, y, con ello, se consigue una normalidad multivariante y una normalidad univariante para todas las métricas (previamente a la eliminación de los outliers, el hierro no presentaba normalidad).

```{r ATRavg20.7.6, fig.width=5, fig.height=4, fig.align='center'}
# Para las 3 métricas de RM correlacionadas con HD: AD, RD, MD
library(MVN)
par(mfrow = c(1, 2))
#RATR_avg<-ATR_avg_demo[,c(3,8, 10:13)]
RATR_avg<-ATR_avg_demo[,c('Subgroup','rhatr_Iron','rhatr_AD','rhatr_RD',
                          'rhatr_MD','rhatr_FA')]

# Valoración de la normalidad multivariante con todos los sujetos
RATR_mvn<-mvn(RATR_avg[-c(1,2,6)], mvnTest = 'royston', covariance = TRUE, desc = TRUE, 
              univariateTest = 'SW', univariatePlot = 'qq', 
              multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
              showOutliers = TRUE, showNewData = TRUE)
index<-rownames(RATR_mvn$newData)
RATR_avg_WoOut<-RATR_avg[c(index),]
table(RATR_avg$Subgroup)
table(RATR_avg_WoOut$Subgroup)
```

```{r ATRavg20.7.6.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación del outlier más
# extremo
par(mfrow = c(1, 2))
print(RATR_mvn$multivariateOutliers,max = 6)
newRATR_avg<-RATR_avg[-c(34),]
RATR_avg[c(34),]
newRATR_mvn<-mvn(newRATR_avg[-c(1,2,6)], mvnTest = 'royston', covariance = TRUE, 
                 desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq', 
                 multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
                 showOutliers = TRUE, showNewData = TRUE)
RATR_avg_demo_WoOut_ADRDMD<-ATR_avg_demo[-c(34),-c(8,9,13:17)]
#RATR_avg_demo_WoOut_ADRDMD<-ATR_avg_demo[-c(34),-c('rhatr_Iron','lhatr_Iron','rhatr_FA','lhatr_AD',
#                                                   'lhatr_RD','lhatr_MD','lhatr_FA')]
RATR_avg_demo_ADRDMD<-ATR_avg_demo[,-c(8,9,13:17)]
```

```{r ATRavg20.7.7, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
RATRmultiNorm<-rbind(RATR_mvn$multivariateNormality, newRATR_mvn$multivariateNormality)
rownames(RATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
RATRuniNorm<-cbind(RATR_mvn$univariateNormality, newRATR_mvn$univariateNormality)
rownames(RATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
RATRuniDes<-rbind(RATR_mvn$Descriptives, newRATR_mvn$Descriptives)
Variables<-rep(rownames(RATR_mvn$Descriptives),2)
RATRuniDes<-cbind(Variables, RATRuniDes)
rownames(RATRuniDes)<-NULL
```

```{r ATRavg20.7.8, echo=FALSE}
kableExtra::kable(RATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers para el ATR derecho habiendo considerado las métricas AD, RD, MD conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.7.9, echo=FALSE}
kableExtra::kable(RATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las métricas AD, RD, MD del ATR derecho', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.7.10, echo=FALSE}
kableExtra::kable(RATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las métricas AD, RD, MD del ATR derecho', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=3, 'With elimination of outliers'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las métricas AD, RD y MD conjuntamente**, se observa que existe normalidad multivariante con todos los sujetos y, si se eliminan todos los outliers detectados por la función `mvn`, se eliminan 4 pacientes. 
Para generar una similitud con el análisis anterior (considerando las 5 métricas del ATR derecho), se procede a eliminar el outlier con mayor distancia de Mahalanobis (sujeto 34, un HD), y, con ello, se mantiene la normalidad multivariante y la normalidad univariante para todas las métricas.

```{r ATRavg20.7.11, fig.width=5, fig.height=4, fig.align='center'}
# Para las 2 métricas de RM correlacionadas con preHD: Iron,FA
library(MVN)
par(mfrow = c(1, 2))
#RATR_avg<-ATR_avg_demo[,c(3,8, 10:13)]
RATR_avg<-ATR_avg_demo[,c('Subgroup','rhatr_Iron','rhatr_AD','rhatr_RD',
                          'rhatr_MD','rhatr_FA')]

# Valoración de la normalidad multivariante con todos los sujetos
RATR_mvn<-mvn(RATR_avg[-c(1,3:5)], mvnTest = 'royston', covariance = TRUE, desc = TRUE, 
              univariateTest = 'SW', univariatePlot = 'qq', 
              multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
              showOutliers = TRUE, showNewData = TRUE)
index<-rownames(RATR_mvn$newData)
RATR_avg_WoOut<-RATR_avg[c(index),]
table(RATR_avg$Subgroup)
table(RATR_avg_WoOut$Subgroup)
```

```{r ATRavg20.7.11.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación del outlier más
# extremo
par(mfrow = c(1, 2))
print(RATR_mvn$multivariateOutliers,max = 6)
newRATR_avg<-RATR_avg[-c(51),]
RATR_avg[c(51),]
newRATR_mvn<-mvn(newRATR_avg[-c(1,3:5)], mvnTest = 'royston', covariance = TRUE, 
                 desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq', 
                 multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
                 showOutliers = TRUE, showNewData = TRUE)
RATR_avg_demo_WoOut_IronFA<-ATR_avg_demo[-c(51),-c(9:12,14:17)]
#RATR_avg_demo_WoOut_IronFA<-ATR_avg_demo[-c(51),-c('rhatr_AD','rhatr_RD',
#                                                   'rhatr_MD','lhatr_Iron',
#                                                   'lhatr_AD','lhatr_RD',
#                                                   'lhatr_MD','lhatr_FA')]
RATR_avg_demo_IronFA<-ATR_avg_demo[,-c(9:12,14:17)]
```

```{r ATRavg20.7.12, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
RATRmultiNorm<-rbind(RATR_mvn$multivariateNormality, newRATR_mvn$multivariateNormality)
rownames(RATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
RATRuniNorm<-cbind(RATR_mvn$univariateNormality, newRATR_mvn$univariateNormality)
rownames(RATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
RATRuniDes<-rbind(RATR_mvn$Descriptives, newRATR_mvn$Descriptives)
Variables<-rep(rownames(RATR_mvn$Descriptives),2)
RATRuniDes<-cbind(Variables, RATRuniDes)
rownames(RATRuniDes)<-NULL
```

```{r ATRavg20.7.13, echo=FALSE}
kableExtra::kable(RATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers para el ATR derecho habiendo considerado las métricas Iron y FA conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.7.14, echo=FALSE}
kableExtra::kable(RATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las métricas Iron y FA del ATR derecho', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.7.15, echo=FALSE}
kableExtra::kable(RATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las métricas Iron y FA del ATR derecho', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=2, 'With elimination of outliers'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las métricas iron y FA conjuntamente**, se observa que no existe normalidad multivariante ni normalidad univariante para el hierro. Si se eliminaran todos los outliers detectados por la función `mvn`, se eliminarían 4 controles, 5 preHD y 4 HD. 
Para generar una similitud con los dos análisis anteriores, se procede a eliminar el outlier con mayor distancia de Mahalanobis (sujeto 51, un preHD), y, con ello, se consigue la normalidad multivariante y la normalidad univariante para ambas métricas.

**Resultados para el LATR:**

```{r ATRavg20.8.1, fig.width=5, fig.height=4, fig.align='center'}
library(MVN)
par(mfrow = c(1, 2))
# Para las 5 métricas de RM conjuntamente
#LATR_avg<-ATR_avg_demo[,c(3,9, 14:17)]
LATR_avg<-ATR_avg_demo[,c('Subgroup','lhatr_Iron','lhatr_AD','lhatr_RD',
                          'lhatr_MD','lhatr_FA')]

# Valoración de la normalidad multivariante con todos los sujetos
LATR_mvn<-mvn(LATR_avg[-1], mvnTest = 'royston', covariance = TRUE, desc = TRUE, 
              univariateTest = 'SW', univariatePlot = 'qq', 
              multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
              showOutliers = TRUE, showNewData = TRUE)
index<-rownames(LATR_mvn$newData)
LATR_avg_WoOut<-LATR_avg[c(index),]
table(LATR_avg$Subgroup)
table(LATR_avg_WoOut$Subgroup)
```

```{r ATRavg20.8.1.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación del outlier más
# extremo
par(mfrow = c(1, 2))
print(LATR_mvn$multivariateOutliers,max = 6)
newLATR_avg<-LATR_avg[-c(34),]
LATR_avg[c(34),]
newLATR_mvn<-mvn(newLATR_avg[-1], mvnTest = 'royston', covariance = TRUE, 
                 desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq', 
                 multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
                 showOutliers = TRUE, showNewData = TRUE)
LATR_avg_demo_WoOut<-ATR_avg_demo[-c(34),-c(8, 10:13)]
#LATR_avg_demo_WoOut<-ATR_avg_demo[-c(34),-c('rhatr_Iron','rhatr_AD','rhatr_RD',
#                                            'rhatr_MD','rhatr_FA')]
LATR_avg_demo<-ATR_avg_demo[,-c(8, 10:13)]
```

```{r ATRavg20.8.2, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
LATRmultiNorm<-rbind(LATR_mvn$multivariateNormality, newLATR_mvn$multivariateNormality)
rownames(LATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
LATRuniNorm<-cbind(LATR_mvn$univariateNormality, newLATR_mvn$univariateNormality)
rownames(LATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
LATRuniDes<-rbind(LATR_mvn$Descriptives, newLATR_mvn$Descriptives)
Variables<-rep(rownames(LATR_mvn$Descriptives),2)
LATRuniDes<-cbind(Variables, LATRuniDes)
rownames(LATRuniDes)<-NULL
```

```{r ATRavg20.8.3, echo=FALSE}
kableExtra::kable(LATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers para ATR izquierdo habiendo considerado las 5 métricas conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.8.4, echo=FALSE}
kableExtra::kable(LATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las 5 métricas de ATR izquierdo', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.8.5, echo=FALSE}
kableExtra::kable(LATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las 5 métricas de ATR izquierdo', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=5, 'With elimination of outliers'=5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el caso del ATR izquierdo, **considerando las 5 métricas conjuntamente**, se observa que existe normalidad multivariante sin eliminación de outliers. En el caso que se eliminaran todos los outliers definidos por la distancia de Mahalanobis, se eliminarían 3 controles, un preHD y 5 HD, con una mayor eliminación relativa de pacientes sintomáticos, considerando no correcto eliminar los outliers. 
Para generar una similitud con el ATR derecho, se elimina el outlier con mayor distancia de Mahalanobis (sujeto 34, un HD, siendo el mismo sujeto eliminado también en el ATR derecho), y, con ello, se mantiene la normalidad multivariante y la normalidad univariante para todas las métricas.

```{r ATRavg20.8.6, fig.width=5, fig.height=4, fig.align='center'}
library(MVN)
par(mfrow = c(1, 2))
# Para las 3 métricas de RM correlacionadas con HD: AD, RD, MD
#LATR_avg<-ATR_avg_demo[,c(3,9, 14:17)]
LATR_avg<-ATR_avg_demo[,c('Subgroup','lhatr_Iron','lhatr_AD','lhatr_RD',
                          'lhatr_MD','lhatr_FA')]

# Valoración de la normalidad multivariante con todos los sujetos
LATR_mvn<-mvn(LATR_avg[-c(1,2,6)], mvnTest = 'royston', covariance = TRUE, desc = TRUE, 
              univariateTest = 'SW', univariatePlot = 'qq', 
              multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
              showOutliers = TRUE, showNewData = TRUE)
index<-rownames(LATR_mvn$newData)
LATR_avg_WoOut<-LATR_avg[c(index),]
table(LATR_avg$Subgroup)
table(LATR_avg_WoOut$Subgroup)
```

```{r ATRavg20.8.6.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación del outlier más
# extremo
par(mfrow = c(1, 2))
print(LATR_mvn$multivariateOutliers,max = 6)
newLATR_avg<-LATR_avg[-c(34),]
LATR_avg[c(34),]
newLATR_mvn<-mvn(newLATR_avg[-c(1,2,6)], mvnTest = 'royston', covariance = TRUE, 
                 desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq', 
                 multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
                 showOutliers = TRUE, showNewData = TRUE)
LATR_avg_demo_WoOut_ADRDMD<-ATR_avg_demo[-c(34),-c(8:13,17)]
#LATR_avg_demo_WoOut_ADRDMD<-ATR_avg_demo[-c(34),-c('rhatr_Iron','lhatr_Iron',
#                                                   'rhatr_AD','rhatr_RD',
#                                                   'rhatr_MD','rhatr_FA','lhatr_FA')]
LATR_avg_demo_ADRDMD<-ATR_avg_demo[,-c(8:13,17)]
```

```{r ATRavg20.8.7, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
LATRmultiNorm<-rbind(LATR_mvn$multivariateNormality, newLATR_mvn$multivariateNormality)
rownames(LATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
LATRuniNorm<-cbind(LATR_mvn$univariateNormality, newLATR_mvn$univariateNormality)
rownames(LATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
LATRuniDes<-rbind(LATR_mvn$Descriptives, newLATR_mvn$Descriptives)
Variables<-rep(rownames(LATR_mvn$Descriptives),2)
LATRuniDes<-cbind(Variables, LATRuniDes)
rownames(LATRuniDes)<-NULL
```

```{r ATRavg20.8.8, echo=FALSE}
kableExtra::kable(LATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers para ATR izquierdo habiendo considerado las métricas AD, RD y MD conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.8.9, echo=FALSE}
kableExtra::kable(LATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las métricas AD, RD y MD del ATR izquierdo', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.8.10, echo=FALSE}
kableExtra::kable(LATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las métricas AD, RD y MD del ATR izquierdo', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=3, 'With elimination of outliers'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las métricas AD, RD y MD conjuntamente**, se observa que existe normalidad multivariante y univariante para las 3 métricas sin eliminación de outliers. En el caso que se eliminaran todos los outliers definidos por la distancia de Mahalanobis, se eliminarían 3 controles y 5 HD, con una mayor eliminación relativa de pacientes sintomáticos, considerando no correcto eliminar los outliers. 
Para generar una similitud con los análisis previos, se elimina el outlier con mayor distancia de Mahalanobis (sujeto 34, un HD), y, con ello, se mantiene la normalidad multivariante y la normalidad univariante para todas las métricas.

```{r ATRavg20.8.11, fig.width=5, fig.height=4, fig.align='center'}
library(MVN)
par(mfrow = c(1, 2))
# Para las 2 métricas de RM correlacionadas con preHD: Iron y FA
#LATR_avg<-ATR_avg_demo[,c(3,9, 14:17)]
LATR_avg<-ATR_avg_demo[,c('Subgroup','lhatr_Iron','lhatr_AD','lhatr_RD',
                          'lhatr_MD','lhatr_FA')]

# Valoración de la normalidad multivariante con todos los sujetos
LATR_mvn<-mvn(LATR_avg[-c(1,3:5)], mvnTest = 'royston', covariance = TRUE, desc = TRUE, 
              univariateTest = 'SW', univariatePlot = 'qq', 
              multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
              showOutliers = TRUE, showNewData = TRUE)
index<-rownames(LATR_mvn$newData)
LATR_avg_WoOut<-LATR_avg[c(index),]
table(LATR_avg$Subgroup)
table(LATR_avg_WoOut$Subgroup)
```

```{r ATRavg20.8.11.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación del outlier más
# extremo
par(mfrow = c(1, 2))
print(LATR_mvn$multivariateOutliers,max = 6)
newLATR_avg<-LATR_avg[-c(18),]
LATR_avg[c(18),]
newLATR_mvn<-mvn(newLATR_avg[-c(1,3:5)], mvnTest = 'royston', covariance = TRUE, 
                 desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq', 
                 multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
                 showOutliers = TRUE, showNewData = TRUE)
LATR_avg_demo_WoOut_IronFA<-ATR_avg_demo[-c(18),-c(8,10:16)]
#LATR_avg_demo_WoOut_IronFA<-ATR_avg_demo[-c(18),-c('rhatr_Iron','rhatr_AD','rhatr_RD',
#                                                   'rhatr_MD','rhatr_FA','lhatr_AD',
#                                                   'lhatr_RD','lhatr_MD')]
LATR_avg_demo_IronFA<-ATR_avg_demo[,-c(8,10:16)]
```

```{r ATRavg20.8.12, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
LATRmultiNorm<-rbind(LATR_mvn$multivariateNormality, newLATR_mvn$multivariateNormality)
rownames(LATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
LATRuniNorm<-cbind(LATR_mvn$univariateNormality, newLATR_mvn$univariateNormality)
rownames(LATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
LATRuniDes<-rbind(LATR_mvn$Descriptives, newLATR_mvn$Descriptives)
Variables<-rep(rownames(LATR_mvn$Descriptives),2)
LATRuniDes<-cbind(Variables, LATRuniDes)
rownames(LATRuniDes)<-NULL
```

```{r ATRavg20.8.13, echo=FALSE}
kableExtra::kable(LATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers para ATR izquierdo habiendo considerado las métricas Iron y FA conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.8.14, echo=FALSE}
kableExtra::kable(LATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las métricas Iron y FA del ATR izquierdo', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.8.15, echo=FALSE}
kableExtra::kable(LATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las métricas Iron y FA del ATR izquierdo', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=2, 'With elimination of outliers'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las métricas Iron y FA conjuntamente**, se observa que existe normalidad multivariante y univariante para las 2 métricas sin eliminación de outliers. En el caso que se eliminaran todos los outliers definidos por la distancia de Mahalanobis, se eliminarían 2 controles, un preHD y 4 HD. 
Para generar una similitud con los análisis previos, se elimina el outlier con mayor distancia de Mahalanobis (sujeto 18, un control), y, con ello, se mantiene la normalidad multivariante y la normalidad univariante para ambas métricas.

### Homocedasticidad de la matriz de varianza-covarianza

Se consultan las siguientes fuentes de información: [Homogeneidad de la covarianza](https://statologos.com/homogeneidad-de-la-covarianza/), [Box’s M Test: Definition](https://www.statisticshowto.com/boxs-m-test/), [boxM {heplots}](https://search.r-project.org/CRAN/refmans/heplots/html/boxM.html).

El **test de homogeneidad de las matrices de covarianza o suposición de homocedasticidad** es una suposición que debe cumplirse en el análisis multivariante, y, consiste en que múltiples grupos en un diseño experimental o test estadístico tengan matrices de covarianza iguales, es decir, las matrices de covarianza poblacional para las variables dependientes de cada grupo deben ser iguales. 

Las variables pueden no ser homocedásticas por dos razones principales:

- Una variable puede ser no normal;
- Una variable puede tener una relación con la transformación de otra variable.

El **test M de Box** (o test de Box para la equivalencia de matrices de covarianza que utiliza la distribución F) es un test paramétrico que se utiliza para comparar la variación en muestras multivariadas, es decir, determina si dos o más matrices de covarianza son iguales (homogéneas).

Un **inconveniente** de dicho test es su extremada sensibilidad a las desviaciones de la normalidad, es decir, los datos deben tener una distribución normal multivariada. Además, tiene muy poca potencia para tamaños de muestra pequeños (resultados no significativos en el contexto de muestras pequeñas no indican necesariamente que las matrices de covarianza sean iguales) y es demasiado sensible para muestras de gran tamaño (resultados falsamente significativos en muestras de gran tamaño, por lo que en este contexto se recomienda un alfa más pequeño).

La **hipótesis nula** p-valor superior a 0.05 es que las matrices de covarianza observadas para las variables dependientes son iguales en todos los grupos: un estadístico M de Box no significativo indica que las matrices de covarianza son iguales. 

La **hipótesis alternativa** con p-valor inferior a 0.05 indica que las matrices de covarianza son significativamente diferentes. El incumplimiento de la suposición de homogeneidad de las matrices de covarianza no siempre significa que no se puede ejecutar un análisis estadístico. En MANOVA, aparecen `n` desiguales a medida que disminuyen los tamaños de muestra, violando la suposición de homogeneidad de covarianza; en estos casos, se debe utilizar la traza de Pillai por ser más robusta que otros tests como la traza de Hotelling o la Lambda de Wilks. 

Como se hizo en el caso de los tests de homocedasticidad univariante, se procede a calcular la homocedasticidad multivariante (para las 5 métricas, para las métricas AD-RD-MD y para las métricas Iron-FA) mediante los test M de Box para las variables independientes de subgrupo, género y edad factorizada, con los dataframes sin y con la eliminación de outliers.

**Resultados para el RATR:**

```{r ATRavg20.9.1, echo=FALSE}
library(heplots)
# Para las 5 métricas, sin eliminación de outliers
RATR_MBox_SG5<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup,
                   data=RATR_avg_demo, cov=TRUE)
RATR_MBox_G5<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Gender,
                   data=RATR_avg_demo, cov=TRUE)
RATR_MBox_AGE5<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~agef2,
                     data=RATR_avg_demo, cov=TRUE)
# Para las 5 métricas, con eliminación de outliers
RATR_MBoxWoOut_SG5<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup,
                         data=RATR_avg_demo_WoOut, cov=TRUE)
RATR_MBoxWoOut_G5<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Gender,
                        data=RATR_avg_demo_WoOut, cov=TRUE)
RATR_MBoxWoOut_AGE5<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~agef2,
                          data=RATR_avg_demo_WoOut, cov=TRUE)

# Para las 3 métricas AD-RD-MD, sin eliminación de outliers
RATR_MBox_SG3<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup,
                    data=RATR_avg_demo_ADRDMD, cov=TRUE)
RATR_MBox_G3<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Gender,
                   data=RATR_avg_demo_ADRDMD, cov=TRUE)
RATR_MBox_AGE3<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~agef2,
                     data=RATR_avg_demo_ADRDMD, cov=TRUE)
# Para las 3 métricas AD-RD-MD, con eliminación de outliers
RATR_MBoxWoOut_SG3<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup,
                         data=RATR_avg_demo_WoOut_ADRDMD, cov=TRUE)
RATR_MBoxWoOut_G3<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Gender,
                        data=RATR_avg_demo_WoOut_ADRDMD, cov=TRUE)
RATR_MBoxWoOut_AGE3<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~agef2,
                          data=RATR_avg_demo_WoOut_ADRDMD, cov=TRUE)

# Para las 2 métricas Iron-FA, sin eliminación de outliers
RATR_MBox_SG2<-boxM(cbind(rhatr_Iron,rhatr_FA)~Subgroup, 
                    data=RATR_avg_demo_IronFA, cov=TRUE)
RATR_MBox_G2<-boxM(cbind(rhatr_Iron,rhatr_FA)~Gender,
                   data=RATR_avg_demo_IronFA, cov=TRUE)
RATR_MBox_AGE2<-boxM(cbind(rhatr_Iron,rhatr_FA)~agef2,
                     data=RATR_avg_demo_IronFA, cov=TRUE)
# Para las 2 métricas Iron-FA, con eliminación de outliers
RATR_MBoxWoOut_SG2<-boxM(cbind(rhatr_Iron,rhatr_FA)~Subgroup,
                         data=RATR_avg_demo_WoOut_IronFA, cov=TRUE)
RATR_MBoxWoOut_G2<-boxM(cbind(rhatr_Iron,rhatr_FA)~Gender,
                        data=RATR_avg_demo_WoOut_IronFA, cov=TRUE)
RATR_MBoxWoOut_AGE2<-boxM(cbind(rhatr_Iron,rhatr_FA)~agef2,
                          data=RATR_avg_demo_WoOut_IronFA, cov=TRUE)
```

```{r ATRavg20.9.2, echo=FALSE}
Subgroup5<-round(c(RATR_MBox_SG5[[1]][[1]],RATR_MBox_SG5[[2]][[1]],RATR_MBox_SG5[[3]][[1]]),3)
Gender5<-round(c(RATR_MBox_G5[[1]][[1]],RATR_MBox_G5[[2]][[1]],RATR_MBox_G5[[3]][[1]]),3)
Age5<-round(c(RATR_MBox_AGE5[[1]][[1]],RATR_MBox_AGE5[[2]][[1]],RATR_MBox_AGE5[[3]][[1]]),3)

Subgroup3<-round(c(RATR_MBox_SG3[[1]][[1]],RATR_MBox_SG3[[2]][[1]],RATR_MBox_SG3[[3]][[1]]),3)
Gender3<-round(c(RATR_MBox_G3[[1]][[1]],RATR_MBox_G3[[2]][[1]],RATR_MBox_G3[[3]][[1]]),3)
Age3<-round(c(RATR_MBox_AGE3[[1]][[1]],RATR_MBox_AGE3[[2]][[1]],RATR_MBox_AGE3[[3]][[1]]),3)

Subgroup2<-round(c(RATR_MBox_SG2[[1]][[1]],RATR_MBox_SG2[[2]][[1]],RATR_MBox_SG2[[3]][[1]]),3)
Gender2<-round(c(RATR_MBox_G2[[1]][[1]],RATR_MBox_G2[[2]][[1]],RATR_MBox_G2[[3]][[1]]),3)
Age2<-round(c(RATR_MBox_AGE2[[1]][[1]],RATR_MBox_AGE2[[2]][[1]],RATR_MBox_AGE2[[3]][[1]]),3)

Variables<-c('Chi-square','Df','P-value')
RATR_HomoCov<-cbind(Variables,Subgroup5,Gender5,Age5,Subgroup3,Gender3,Age3,Subgroup2,Gender2,Age2)
RATR_HomoCov<-as.data.frame(RATR_HomoCov)
colnames(RATR_HomoCov)<-c('Variables',rep(c('Subgroup','Gender','Age'),3))

Subgroup5Wo<-round(c(RATR_MBoxWoOut_SG5[[1]][[1]],RATR_MBoxWoOut_SG5[[2]][[1]],RATR_MBoxWoOut_SG5[[3]][[1]]),3)
Gender5Wo<-round(c(RATR_MBoxWoOut_G5[[1]][[1]],RATR_MBoxWoOut_G5[[2]][[1]],RATR_MBoxWoOut_G5[[3]][[1]]),3)
Age5Wo<-round(c(RATR_MBoxWoOut_AGE5[[1]][[1]],RATR_MBoxWoOut_AGE5[[2]][[1]],RATR_MBoxWoOut_AGE5[[3]][[1]]),3)

Subgroup3Wo<-round(c(RATR_MBoxWoOut_SG3[[1]][[1]],RATR_MBoxWoOut_SG3[[2]][[1]],RATR_MBoxWoOut_SG3[[3]][[1]]),3)
Gender3Wo<-round(c(RATR_MBoxWoOut_G3[[1]][[1]],RATR_MBoxWoOut_G3[[2]][[1]],RATR_MBoxWoOut_G3[[3]][[1]]),3)
Age3Wo<-round(c(RATR_MBoxWoOut_AGE3[[1]][[1]],RATR_MBoxWoOut_AGE3[[2]][[1]],RATR_MBoxWoOut_AGE3[[3]][[1]]),3)

Subgroup2Wo<-round(c(RATR_MBoxWoOut_SG2[[1]][[1]],RATR_MBoxWoOut_SG2[[2]][[1]],RATR_MBoxWoOut_SG2[[3]][[1]]),3)
Gender2Wo<-round(c(RATR_MBoxWoOut_G2[[1]][[1]],RATR_MBoxWoOut_G2[[2]][[1]],RATR_MBoxWoOut_G2[[3]][[1]]),3)
Age2Wo<-round(c(RATR_MBoxWoOut_AGE2[[1]][[1]],RATR_MBoxWoOut_AGE2[[2]][[1]],RATR_MBoxWoOut_AGE2[[3]][[1]]),3)

RATR_HomoCovWo<-cbind(Variables,Subgroup5Wo,Gender5Wo,Age5Wo,Subgroup3Wo,Gender3Wo,Age3Wo,Subgroup2Wo,Gender2Wo,Age2Wo)
RATR_HomoCovWo<-as.data.frame(RATR_HomoCovWo)
colnames(RATR_HomoCovWo)<-c('Variables',rep(c('Subgroup','Gender','Age'),3))
```

```{r ATRavg20.9.3, echo=FALSE, eval=FALSE}
kableExtra::kable(RATR_HomoCov, caption = 'Homocedasticidad de las matrices de covarianza del ATR derecho, SIN eliminación de outliers', booktabs = TRUE) %>%
  add_header_above(header=c(' '=1, 'For 5 metrics' = 3, 'For diffusivity metrics' = 3, 'For iron-FA metrics' = 3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.9.4, echo=FALSE, eval=FALSE}
kableExtra::kable(RATR_HomoCovWo, caption = 'Homocedasticidad de las matrices de covarianza del ATR derecho, CON eliminación de outliers', booktabs = TRUE) %>%
  add_header_above(header=c(' '=1, 'For 5 metrics' = 3, 'For diffusivity metrics' = 3, 'For iron-FA metrics' = 3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.9.4.1, echo=FALSE}
RATR_HomoCovGlobal<-rbind(RATR_HomoCov,RATR_HomoCovWo)
kableExtra::kable(RATR_HomoCovGlobal, caption = 'Homocedasticidad de las matrices de covarianza del ATR derecho', booktabs = TRUE) %>%
  add_header_above(header=c(' '=1, 'For 5 metrics' = 3, 'For diffusivity metrics' = 3, 'For iron-FA metrics' = 3)) %>%
  pack_rows(index=c('Without elimination of outliers'=3, 'With elimination of outliers'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Sin eliminación de outliers**, se objetiva una falta de homocedasticidad multivariante para subgrupo en los casos de las 5 métricas conjuntamente y de las métricas AD-RD-MD, y, una falta de homocedasticidad multivariante para género en el caso de las métricas AD-RD-MD.

**Con eliminación de outliers**, se objetiva una falta de homocedasticidad multivariante para género en el caso de las métricas AD-RD-MD.

**Resultados para el LATR:**

```{r ATRavg20.9.5, echo=FALSE}
library(heplots)
# Para las 5 métricas, sin eliminación de outliers
LATR_MBox_SG5<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Subgroup,
                   data=LATR_avg_demo, cov=TRUE)
LATR_MBox_G5<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Gender,
                   data=LATR_avg_demo, cov=TRUE)
LATR_MBox_AGE5<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~agef2,
                     data=LATR_avg_demo, cov=TRUE)
# Para las 5 métricas, con eliminación de outliers
LATR_MBoxWoOut_SG5<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Subgroup,
                         data=LATR_avg_demo_WoOut, cov=TRUE)
LATR_MBoxWoOut_G5<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Gender,
                        data=LATR_avg_demo_WoOut, cov=TRUE)
LATR_MBoxWoOut_AGE5<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~agef2,
                          data=LATR_avg_demo_WoOut, cov=TRUE)

# Para las 3 métricas AD-RD-MD, sin eliminación de outliers
LATR_MBox_SG3<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup,
                    data=LATR_avg_demo_ADRDMD, cov=TRUE)
LATR_MBox_G3<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Gender,
                   data=LATR_avg_demo_ADRDMD, cov=TRUE)
LATR_MBox_AGE3<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~agef2,
                     data=LATR_avg_demo_ADRDMD, cov=TRUE)
# Para las 3 métricas AD-RD-MD, con eliminación de outliers
LATR_MBoxWoOut_SG3<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup,
                         data=LATR_avg_demo_WoOut_ADRDMD, cov=TRUE)
LATR_MBoxWoOut_G3<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Gender,
                        data=LATR_avg_demo_WoOut_ADRDMD, cov=TRUE)
LATR_MBoxWoOut_AGE3<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~agef2,
                          data=LATR_avg_demo_WoOut_ADRDMD, cov=TRUE)

# Para las 2 métricas Iron-FA, sin eliminación de outliers
LATR_MBox_SG2<-boxM(cbind(lhatr_Iron,lhatr_FA)~Subgroup, 
                    data=LATR_avg_demo_IronFA, cov=TRUE)
LATR_MBox_G2<-boxM(cbind(lhatr_Iron,lhatr_FA)~Gender,
                   data=LATR_avg_demo_IronFA, cov=TRUE)
LATR_MBox_AGE2<-boxM(cbind(lhatr_Iron,lhatr_FA)~agef2,
                     data=LATR_avg_demo_IronFA, cov=TRUE)
# Para las 2 métricas Iron-FA, con eliminación de outliers
LATR_MBoxWoOut_SG2<-boxM(cbind(lhatr_Iron,lhatr_FA)~Subgroup,
                         data=LATR_avg_demo_WoOut_IronFA, cov=TRUE)
LATR_MBoxWoOut_G2<-boxM(cbind(lhatr_Iron,lhatr_FA)~Gender,
                        data=LATR_avg_demo_WoOut_IronFA, cov=TRUE)
LATR_MBoxWoOut_AGE2<-boxM(cbind(lhatr_Iron,lhatr_FA)~agef2,
                          data=LATR_avg_demo_WoOut_IronFA, cov=TRUE)
```

```{r ATRavg20.9.6, echo=FALSE}
Subgroup5<-round(c(LATR_MBox_SG5[[1]][[1]],LATR_MBox_SG5[[2]][[1]],LATR_MBox_SG5[[3]][[1]]),3)
Gender5<-round(c(LATR_MBox_G5[[1]][[1]],LATR_MBox_G5[[2]][[1]],LATR_MBox_G5[[3]][[1]]),3)
Age5<-round(c(LATR_MBox_AGE5[[1]][[1]],LATR_MBox_AGE5[[2]][[1]],LATR_MBox_AGE5[[3]][[1]]),3)

Subgroup3<-round(c(LATR_MBox_SG3[[1]][[1]],LATR_MBox_SG3[[2]][[1]],LATR_MBox_SG3[[3]][[1]]),3)
Gender3<-round(c(LATR_MBox_G3[[1]][[1]],LATR_MBox_G3[[2]][[1]],LATR_MBox_G3[[3]][[1]]),3)
Age3<-round(c(LATR_MBox_AGE3[[1]][[1]],LATR_MBox_AGE3[[2]][[1]],LATR_MBox_AGE3[[3]][[1]]),3)

Subgroup2<-round(c(LATR_MBox_SG2[[1]][[1]],LATR_MBox_SG2[[2]][[1]],LATR_MBox_SG2[[3]][[1]]),3)
Gender2<-round(c(LATR_MBox_G2[[1]][[1]],LATR_MBox_G2[[2]][[1]],LATR_MBox_G2[[3]][[1]]),3)
Age2<-round(c(LATR_MBox_AGE2[[1]][[1]],LATR_MBox_AGE2[[2]][[1]],LATR_MBox_AGE2[[3]][[1]]),3)

Variables<-c('Chi-square','Df','P-value')
LATR_HomoCov<-cbind(Variables,Subgroup5,Gender5,Age5,Subgroup3,Gender3,Age3,Subgroup2,Gender2,Age2)
LATR_HomoCov<-as.data.frame(LATR_HomoCov)
colnames(LATR_HomoCov)<-c('Variables',rep(c('Subgroup','Gender','Age'),3))

Subgroup5Wo<-round(c(LATR_MBoxWoOut_SG5[[1]][[1]],LATR_MBoxWoOut_SG5[[2]][[1]],LATR_MBoxWoOut_SG5[[3]][[1]]),3)
Gender5Wo<-round(c(LATR_MBoxWoOut_G5[[1]][[1]],LATR_MBoxWoOut_G5[[2]][[1]],LATR_MBoxWoOut_G5[[3]][[1]]),3)
Age5Wo<-round(c(LATR_MBoxWoOut_AGE5[[1]][[1]],LATR_MBoxWoOut_AGE5[[2]][[1]],LATR_MBoxWoOut_AGE5[[3]][[1]]),3)

Subgroup3Wo<-round(c(LATR_MBoxWoOut_SG3[[1]][[1]],LATR_MBoxWoOut_SG3[[2]][[1]],LATR_MBoxWoOut_SG3[[3]][[1]]),3)
Gender3Wo<-round(c(LATR_MBoxWoOut_G3[[1]][[1]],LATR_MBoxWoOut_G3[[2]][[1]],LATR_MBoxWoOut_G3[[3]][[1]]),3)
Age3Wo<-round(c(LATR_MBoxWoOut_AGE3[[1]][[1]],LATR_MBoxWoOut_AGE3[[2]][[1]],LATR_MBoxWoOut_AGE3[[3]][[1]]),3)

Subgroup2Wo<-round(c(LATR_MBoxWoOut_SG2[[1]][[1]],LATR_MBoxWoOut_SG2[[2]][[1]],LATR_MBoxWoOut_SG2[[3]][[1]]),3)
Gender2Wo<-round(c(LATR_MBoxWoOut_G2[[1]][[1]],LATR_MBoxWoOut_G2[[2]][[1]],LATR_MBoxWoOut_G2[[3]][[1]]),3)
Age2Wo<-round(c(LATR_MBoxWoOut_AGE2[[1]][[1]],LATR_MBoxWoOut_AGE2[[2]][[1]],LATR_MBoxWoOut_AGE2[[3]][[1]]),3)

LATR_HomoCovWo<-cbind(Variables,Subgroup5Wo,Gender5Wo,Age5Wo,Subgroup3Wo,Gender3Wo,Age3Wo,Subgroup2Wo,Gender2Wo,Age2Wo)
LATR_HomoCovWo<-as.data.frame(LATR_HomoCovWo)
colnames(LATR_HomoCovWo)<-c('Variables',rep(c('Subgroup','Gender','Age'),3))
```

```{r ATRavg20.9.7, echo=FALSE, eval=FALSE}
kableExtra::kable(LATR_HomoCov, caption = 'Homocedasticidad de las matrices de covarianza del ATR izquierdo, SIN eliminación de outliers', booktabs = TRUE) %>%
  add_header_above(header=c(' '=1, 'For 5 metrics' = 3, 'For diffusivity metrics' = 3, 'For iron-FA metrics' = 3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.9.8, echo=FALSE, eval=FALSE}
kableExtra::kable(RATR_HomoCovWo, caption = 'Homocedasticidad de las matrices de covarianza del ATR izquierdo, CON eliminación de outliers', booktabs = TRUE) %>%
  add_header_above(header=c(' '=1, 'For 5 metrics' = 3, 'For diffusivity metrics' = 3, 'For iron-FA metrics' = 3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg20.9.8.1, echo=FALSE}
LATR_HomoCovGlobal<-rbind(LATR_HomoCov,LATR_HomoCovWo)
kableExtra::kable(LATR_HomoCovGlobal, caption = 'Homocedasticidad de las matrices de covarianza del ATR izquierdo', booktabs = TRUE) %>%
  add_header_above(header=c(' '=1, 'For 5 metrics' = 3, 'For diffusivity metrics' = 3, 'For iron-FA metrics' = 3)) %>%
  pack_rows(index=c('Without elimination of outliers'=3, 'With elimination of outliers'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Sin eliminación de outliers**, se objetiva una falta de homocedasticidad multivariante para edad factorizada en el caso de las 5 métricas conjuntamente y para género en el caso de las métricas AD-RD-MD.

**Con eliminación de outliers**, se objetiva una falta de homocedasticidad multivariante para género en el caso de las métricas AD-RD-MD.

\newpage

# ANÁLISIS del average: RATR y LATR por separado

## MANOVA

Se consultan las siguientes fuentes de información: [14. ANOVA / MANOVA](https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/anova-manova/), [MANOVA in R – How To Implement and Interpret One-Way MANOVA](https://www.r-bloggers.com/2022/01/manova-in-r-how-to-implement-and-interpret-one-way-manova/).

MANOVA (*Multivariate ANOVA* o *Multivariate ANalysis Of VAriance*, análisis multivariante de la varianz) es una extensión del ANOVA, pero MANOVA incluye al menos dos variables dependientes para analizar diferencias de las matrices de covarianzas procedentes de las variables dependientes entre múltiples grupos (factores). 

MANOVA en R utiliza por defecto el **test de Pillai**, que es el de mayor poder estadístico, para los cálculos, aunque se pueden utilizar otros tests (lambda de Wilk, raíz mayor de Roy o test de Hotelling-Lawley), y, luego se convierte en un estadístico F para determinar la significancia de las diferencias de medias grupales. 

El ANOVA suele sufrir de errores de tipo I que se producen con la realización de múltiples ANOVA para cada variable dependiente. En cambio, MANOVA determina la exsitencia de diferencias de grupo basándose en la información combinada de múltiples variables dependientes. Debido a que MANOVA utiliza más de una variable dependiente, las hipótesis nula y alternativa cambian ligeramente:

- **H0**: Los vectores medios de grupo son los mismos para todos los grupos o no difieren significativamente;
- **H1**: Al menos uno de los vectores medios del grupo es diferente del resto.

MANOVA es una técnica paramétrica que implica ciertos **supuestos** sobre los parámetros de la población de la que se toman las muestras y dichas suposiciones son más restrictivas que en el caso del ANOVA:

- **Normalidad multivariada**: cada combinación de variables independientes o dependientes debe tener una distribución normal multivariada. Los errores también deben ajustarse a la **normalidad multivariada** (es decir, se distribuyen normalmente en todas las dimensiones);
- Toda la **matriz de varianza-covarianza es homogénea/homocedástica** (es decir, las varianzas de todas las variables y las covarianzas entre todos los pares de variables son iguales en todos los grupos);
- **Sin multicolinealidad**: las variables dependientes no deben tener correlaciones muy altas.
- **Sin valores atípicos**: no debería haber valores atípicos en las variables dependientes.
- **Linealidad**: las variables dependientes deben tener una relación lineal con cada grupo (factor) de la variable independiente.
- **Independencia de las observaciones**: las unidades son intercambiables entre sí.

De todas ellas, la multicolinealidad es el supuesto que no se cumple entre las métricas de difusión, con una alta correlación entre AD-RD-MD y entre FA-RD. 

```{r ATRavg21.0.1}
# Correlación entre las métricas del ATR derecho
cor(RATR_avg_demo[,8:12])
# Correlación entre las métricas del ATR izquierdo
cor(LATR_avg_demo[,8:12])
```

Para aplicar MANOVA en R, se debe cumplir una **condición crítica**: el número de observaciones (filas) por grupo de la variable independiente debe ser mayor al número de variables dependientes. 

Si el MANOVA es significativo, se puede medir el **tamaño del efecto** mediante la métrica `Eta cuadrado parcial`, la cual mide el efecto que tiene la variable independiente sobre las variables dependientes: si el valor es 0,14 o mayor, se puede afirmar que el tamaño del efecto es grande. 

Para ejecutar MANOVA, se utiliza la función `manova` del paquete `stats`. Se utilizan los dataframes con eliminación de outliers dado que son los que presentan normalidad multivariante. Se generan MANOVAs para las 5 métricas conjuntas, para las 3 métricas de difusividad (AD, RD, MD) y para las métricas de hierro y anistropía fraccional. El primer modelo generado consiste en las 3 variables independientes en interacción y los modelos subsiguientes con simplificación de las interacciones y/o del número de factores en función de los resultados del primer modelo. 

Como se verá a continuación, algunos de los modelos especifican que los residuos son rango-deficientes y se ha de especificar el argumento `tol=0` para poder ver el resultado/resumen del modelo. El problema de especificar tolerancia 0 es que los resultados pueden ser inexactos, con lo que transformar las respuestas/variables dependientes para eliminar la alta correlación es mejor opción. Además, cuando los residuos son rango-deficientes, no se permite calcular el *effect size*.

En nuestro caso, las variables con mayor correlación son las difusividades media, axial y radial (las 3 métricas con la misma unidad de medida $mm^2/s$, con valores muy próximos a cero dado que los valores se hallan en el rango de $10^{-4}-10^{-5}$). Se han intenado varias transformaciones (logarítmica con la función `log`, isométrica log-ratio con la función `ilr`, log-ratio centrada con la función `clr`, arcsine con la función `asin(sqrt)`, raíz cuadrada con la función `sqrt`), ya sea de las tres variables dependientes altamente correlacionadas o de las cinco conjuntamente. Finalmente, se opta por generar una transformación logarítmica de las variables de difusividad por estar muy correlacionadas y medirse en la misma unidad; además, dicha transformación es la que obtiene unos coeficientes de discriminantes lineales menos dispares entre las 5 métricas.  

Se consultan las webs siguientes: [manova: Multivariate Analysis of Variance](https://www.rdocumentation.org/packages/stats/versions/3.6.2/topics/manova), [Error in summary.manova - residuals have rank order deficiency](https://stackoverflow.com/questions/39412865/error-in-summary-manova-residuals-have-rank-order-deficiency), [clr: Centred Log-Ratio (clr) transformation](https://rdrr.io/cran/rgr/man/clr.html), [Isometric log ratio transform](https://search.r-project.org/CRAN/refmans/compositions/html/ilr.html), [How to perform isometric log-ratio transformation](https://stats.stackexchange.com/questions/259208/how-to-perform-isometric-log-ratio-transformation).

### RATR

```{r ATRavg21.0.2}
# Para las 5 métricas conjuntamente - Sin transformación de variables
# Generar los MANOVAS
RATR_manova5_1<-manova(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup*Gender*agef2, 
                       data=RATR_avg_demo_WoOut)
summary(RATR_manova5_1)
summary(RATR_manova5_1,tol=0)
RATR_manova5_2<-manova(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup+Gender+agef2, 
                       data=RATR_avg_demo_WoOut)
summary(RATR_manova5_2)
RATR_manova5_3<-manova(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup, 
                       data=RATR_avg_demo_WoOut)
summary(RATR_manova5_3)

# Generar effect size
library(effectsize)
RATR_SizeMan5_2<-effectsize::eta_squared(RATR_manova5_2);RATR_SizeMan5_2
RATR_SizeMan5_3<-effectsize::eta_squared(RATR_manova5_3);RATR_SizeMan5_3
```

En el caso de las **5 métricas conjuntas sin transformación logarítmica**, se objetiva que subgrupo es el único factor casi significativo con un p valor de `r round(summary(RATR_manova5_3)[[4]][1,6],3)`, con un tamaño de efecto de 0.16.

```{r ATRavg21.0.2.bis, fig.width=5, fig.height=4, fig.align='center'}
# Para las 5 métricas conjuntamente - Con transformación logarítmica de las métricas de difusividad
# Primero transformación de las variables
RATR_avg_demo_WoOut_log<-cbind(RATR_avg_demo_WoOut[,1:8],log(cbind(RATR_avg_demo_WoOut[,9:11])),
                               RATR_avg_demo_WoOut[,12])
colnames(RATR_avg_demo_WoOut_log)<-colnames(RATR_avg_demo_WoOut)

# Comprobar normalidad multivariante
par(mfrow = c(1, 2))
RATR_mvnlog5<-mvn(RATR_avg_demo_WoOut_log[-c(1:7)], mvnTest = 'royston', covariance = TRUE,
                  desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq',
                  multivariatePlot = 'qq', multivariateOutlierMethod = 'quan',
                  showOutliers = TRUE, showNewData = TRUE)
RATR_mvnlog5$multivariateNormality
RATR_mvnlog5$univariateNormality

# Comprobar homocedasticidad de la matriz de covarianzas
RATR_MBox_SG5log<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup,
                       data=RATR_avg_demo_WoOut_log, cov=TRUE);RATR_MBox_SG5log
RATR_MBox_G5log<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Gender,
                      data=RATR_avg_demo_WoOut_log, cov=TRUE);RATR_MBox_G5log
RATR_MBox_AGE5log<-boxM(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~agef2,
                        data=RATR_avg_demo_WoOut_log, cov=TRUE);RATR_MBox_AGE5log

# Generar los MANOVAS
RATR_manova5_1log<-manova(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup*Gender*agef2, 
                          data=RATR_avg_demo_WoOut_log)
summary(RATR_manova5_1log)
RATR_manova5_2log<-manova(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup+Gender+agef2, 
                          data=RATR_avg_demo_WoOut_log)
summary(RATR_manova5_2log)
RATR_manova5_3log<-manova(cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA)~Subgroup, 
                          data=RATR_avg_demo_WoOut_log)
summary(RATR_manova5_3log)

# Generar effect size
library(effectsize)
RATR_SizeMan5_2log<-effectsize::eta_squared(RATR_manova5_2log);RATR_SizeMan5_2log
RATR_SizeMan5_3log<-effectsize::eta_squared(RATR_manova5_3log);RATR_SizeMan5_3log
```

En el caso de las **5 métricas conjuntas con transformación logarítmica de las 3 variables de difusividad**, se objetiva que subgrupo es el único factor significativo (p-valor de `r round(summary(RATR_manova5_3log)[[4]][1,6],3)`). con un tamaño de efecto de 0.17. Dicha transformación no condiciona una pérdida de la normalidad multivariante ni de la homocedasticidad de la matriz de covarianzas. 

```{r ATRavg21.0.3}
# Para las 3 métricas AD-RD-MD - Sin transformación de variables
# Generar los MANOVAS
RATR_manova3_1<-manova(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup*Gender*agef2, 
                       data=RATR_avg_demo_WoOut_ADRDMD)
summary(RATR_manova3_1)
summary(RATR_manova3_1,tol=0)
RATR_manova3_2<-manova(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup+Gender+agef2, 
                       data=RATR_avg_demo_WoOut_ADRDMD)
summary(RATR_manova3_2)
summary(RATR_manova3_2,tol=0)
RATR_manova3_3<-manova(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup, 
                       data=RATR_avg_demo_WoOut_ADRDMD)
summary(RATR_manova3_3)
summary(RATR_manova3_3,tol=0)

# Generar effect size
RATR_SizeMan3_2<-effectsize::eta_squared(RATR_manova3_2);RATR_SizeMan3_2
RATR_SizeMan3_3<-effectsize::eta_squared(RATR_manova3_3);RATR_SizeMan3_3
```

En el caso de las **3 métricas AD-RD-MD sin transformación logarítmica**, se objetiva que subgrupo es el único factor significativo; debido a que los residuos son rango deficientes, no se permite obtener el *effect size*. 

```{r ATRavg21.0.3.bis, fig.width=5, fig.height=4, fig.align='center'}
# Para las 3 métricas AD-RD-MD - Con transformación logarítmica de las métricas 
# Primero transformación de las variables
RATR_avg_demo_WoOut_ADRDMD_log<-cbind(RATR_avg_demo_WoOut_ADRDMD[,1:7],
                                      log(cbind(RATR_avg_demo_WoOut_ADRDMD[,8:10])))

# Comprobar normalidad multivariante
par(mfrow = c(1, 2))
RATR_mvnlog3<-mvn(RATR_avg_demo_WoOut_ADRDMD_log[-c(1:7)], mvnTest = 'royston',
                  covariance = TRUE, desc = TRUE, univariateTest = 'SW',
                  univariatePlot = 'qq', multivariatePlot = 'qq',
                  multivariateOutlierMethod = 'quan', showOutliers = TRUE,
                  showNewData = TRUE)
RATR_mvnlog3$multivariateNormality
RATR_mvnlog3$univariateNormality

# Comprobar homocedasticidad de la matriz de covarianzas
RATR_MBox_SG3log<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup,
                       data=RATR_avg_demo_WoOut_ADRDMD_log, cov=TRUE);RATR_MBox_SG3log
RATR_MBox_G3log<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Gender,
                      data=RATR_avg_demo_WoOut_ADRDMD_log, cov=TRUE);RATR_MBox_G3log
RATR_MBox_AGE3log<-boxM(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~agef2,
                        data=RATR_avg_demo_WoOut_ADRDMD_log, cov=TRUE);RATR_MBox_AGE3log

# Generar los MANOVAS
RATR_manova3_1log<-manova(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup*Gender*agef2, 
                          data=RATR_avg_demo_WoOut_ADRDMD_log)
summary(RATR_manova3_1log)
RATR_manova3_2log<-manova(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup+Gender+agef2, 
                          data=RATR_avg_demo_WoOut_ADRDMD_log)
summary(RATR_manova3_2log)
RATR_manova3_3log<-manova(cbind(rhatr_AD,rhatr_RD,rhatr_MD)~Subgroup, 
                          data=RATR_avg_demo_WoOut_ADRDMD_log)
summary(RATR_manova3_3log)

# Generar effect size
RATR_SizeMan3_2log<-effectsize::eta_squared(RATR_manova3_2log);RATR_SizeMan3_2log
RATR_SizeMan3_3log<-effectsize::eta_squared(RATR_manova3_3log);RATR_SizeMan3_3log
```

En el caso de las **3 métricas AD-RD-MD con transformación logarítmica**, se objetiva que subgrupo es el único factor significativo, con un *effect size* de 0.16. Cabe destacar que la normalidad multivariante se mantiene, pero se pierde la homocedasticidad de la matriz de covarianzas para subgrupo, hecho que puede sesgar el test de MANOVA.

```{r ATRavg21.0.3.2, echo=FALSE, eval=FALSE}
RATRmultiNormLog<-rbind(RATR_mvnlog5$multivariateNormality, RATR_mvnlog3$multivariateNormality)
rownames(RATRmultiNormLog)<-c('Log Transformation of Diffusivity metrics for the 5-metric of right ATR', 'Log Transformation of Diffusivity metrics for the 3-metric of right ATR')

kableExtra::kable(RATRmultiNormLog, caption = 'Multivariate normality assessment for log transformation of diffusivity metrics in 5-metric and 3-metric models of RIGHT ATR', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg21.0.3.3, echo=FALSE, eval=FALSE}
Subgroup5log<-round(c(RATR_MBox_SG5log[[1]][[1]],RATR_MBox_SG5log[[2]][[1]],RATR_MBox_SG5log[[3]][[1]]),3)
Gender5log<-round(c(RATR_MBox_G5log[[1]][[1]],RATR_MBox_G5log[[2]][[1]],RATR_MBox_G5log[[3]][[1]]),3)
Age5log<-round(c(RATR_MBox_AGE5log[[1]][[1]],RATR_MBox_AGE5log[[2]][[1]],RATR_MBox_AGE5log[[3]][[1]]),3)

Subgroup3log<-round(c(RATR_MBox_SG3log[[1]][[1]],RATR_MBox_SG3log[[2]][[1]],RATR_MBox_SG3log[[3]][[1]]),3)
Gender3log<-round(c(RATR_MBox_G3log[[1]][[1]],RATR_MBox_G3log[[2]][[1]],RATR_MBox_G3log[[3]][[1]]),3)
Age3log<-round(c(RATR_MBox_AGE3log[[1]][[1]],RATR_MBox_AGE3log[[2]][[1]],RATR_MBox_AGE3log[[3]][[1]]),3)

Variables<-c('Chi-square','Df','P-value')
RATR_HomoCov5log<-cbind(Variables,Subgroup5log,Gender5log,Age5log)
RATR_HomoCov3log<-cbind(Variables,Subgroup3log,Gender3log,Age3log)
RATR_HomoCovlog<-rbind(RATR_HomoCov5log,RATR_HomoCov3log)
RATR_HomoCovlog<-as.data.frame(RATR_HomoCovlog)
colnames(RATR_HomoCovlog)<-c('Variables','Subgroup','Gender','Age')

kableExtra::kable(RATR_HomoCovlog, caption = 'Covariance Matrix Homoscedasticity for log transformation of diffusivity metrics in 5-metric and 3-metric models of RIGHT ATR', booktabs = TRUE) %>%
  pack_rows(index=c('For 5 metrics'=3, 'For 3 diffusivity metrics (AD-RD-MD)'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg21.0.4}
# Para las 2 métricas Iron-FA
# Generar los MANOVAS
RATR_manova2_1<-manova(cbind(rhatr_Iron,rhatr_FA)~Subgroup*Gender*agef2, 
                       data=RATR_avg_demo_WoOut_IronFA)
summary(RATR_manova2_1)
RATR_manova2_2<-manova(cbind(rhatr_Iron,rhatr_FA)~Subgroup+Gender+agef2, 
                       data=RATR_avg_demo_WoOut_IronFA)
summary(RATR_manova2_2)
RATR_manova2_3<-manova(cbind(rhatr_Iron,rhatr_FA)~Subgroup, 
                       data=RATR_avg_demo_WoOut_IronFA)
summary(RATR_manova2_3)
```

En el caso de las **2 métricas Iron-FA**, ningún factor es significativo, por lo que no se calcula el *effect size*.

### LATR

```{r ATRavg21.0.5}
# Para las 5 métricas conjuntamente
# Generar los MANOVAS
LATR_manova5_1<-manova(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Subgroup*Gender*agef2, 
                       data=LATR_avg_demo_WoOut)
summary(LATR_manova5_1)
LATR_manova5_2<-manova(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Subgroup+Gender+agef2, 
                       data=LATR_avg_demo_WoOut)
summary(LATR_manova5_2)
LATR_manova5_3<-manova(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Subgroup,
                       data=LATR_avg_demo_WoOut)
summary(LATR_manova5_3)

# Generar effect size
LATR_SizeMan5_2<-effectsize::eta_squared(RATR_manova5_2);LATR_SizeMan5_2
LATR_SizeMan5_3<-effectsize::eta_squared(RATR_manova5_3);LATR_SizeMan5_3
```

En el caso de las **5 métricas conjuntas**, se objetiva que subgrupo es el único factor significativo. con un tamaño de efecto de 0.16.

```{r ATRavg21.0.6}
# Para las 3 métricas AD-RD-MD - Sin transformación de variables
# Generar los MANOVAS
LATR_manova3_1<-manova(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup*Gender*agef2, 
                       data=LATR_avg_demo_WoOut_ADRDMD)
summary(LATR_manova3_1)
summary(LATR_manova3_1,tol=0)
LATR_manova3_2<-manova(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup+Gender+agef2, 
                       data=LATR_avg_demo_WoOut_ADRDMD)
summary(LATR_manova3_2)
summary(LATR_manova3_2,tol=0)
LATR_manova3_3<-manova(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup, 
                       data=LATR_avg_demo_WoOut_ADRDMD)
summary(LATR_manova3_3)
summary(LATR_manova3_3,tol=0)

# Generar effect size
LATR_SizeMan3_2<-effectsize::eta_squared(LATR_manova3_2);LATR_SizeMan3_2
LATR_SizeMan3_3<-effectsize::eta_squared(LATR_manova3_3);LATR_SizeMan3_3
```

En el caso de las **3 métricas AD-RD-MD sin transformación logarítmica**, se objetiva que subgrupo es el único factor significativo; debido a que los residuos son rango deficientes, no se permite obtener el *effect size*. 

```{r ATRavg21.0.6.bis, fig.width=5, fig.height=4, fig.align='center'}
# Para las 3 métricas AD-RD-MD - Con transformación logarítmica de las métricas 
# Primero transformación de las variables
LATR_avg_demo_WoOut_ADRDMD_log<-cbind(LATR_avg_demo_WoOut_ADRDMD[,1:7],
                                      log(cbind(LATR_avg_demo_WoOut_ADRDMD[,8:10])))

# Comprobar normalidad multivariante
par(mfrow = c(1, 2))
LATR_mvnlog3<-mvn(LATR_avg_demo_WoOut_ADRDMD_log[-c(1:7)], mvnTest = 'royston',
                  covariance = TRUE, desc = TRUE, univariateTest = 'SW',
                  univariatePlot = 'qq', multivariatePlot = 'qq',
                  multivariateOutlierMethod = 'quan', showOutliers = TRUE, showNewData = TRUE)
LATR_mvnlog3$multivariateNormality
LATR_mvnlog3$univariateNormality

# Comprobar homocedasticidad de la matriz de covarianzas
LATR_MBox_SG3log<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup,
                       data=LATR_avg_demo_WoOut_ADRDMD_log, cov=TRUE);LATR_MBox_SG3log
LATR_MBox_G3log<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Gender,
                      data=LATR_avg_demo_WoOut_ADRDMD_log, cov=TRUE);LATR_MBox_G3log
LATR_MBox_AGE3log<-boxM(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~agef2,
                        data=LATR_avg_demo_WoOut_ADRDMD_log, cov=TRUE);LATR_MBox_AGE3log

# Generar los MANOVAS
LATR_manova3_1log<-manova(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup*Gender*agef2, 
                          data=LATR_avg_demo_WoOut_ADRDMD_log)
summary(LATR_manova3_1log)
LATR_manova3_2log<-manova(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup+Gender+agef2, 
                          data=LATR_avg_demo_WoOut_ADRDMD_log)
summary(LATR_manova3_2log)
LATR_manova3_3log<-manova(cbind(lhatr_AD,lhatr_RD,lhatr_MD)~Subgroup, 
                          data=LATR_avg_demo_WoOut_ADRDMD_log)
summary(LATR_manova3_3log)

# Generar effect size
LATR_SizeMan3_2log<-effectsize::eta_squared(LATR_manova3_2log);LATR_SizeMan3_2log
LATR_SizeMan3_3log<-effectsize::eta_squared(LATR_manova3_3log);LATR_SizeMan3_3log
```

En el caso de las **3 métricas AD-RD-MD con transformación logarítmica**, se objetiva que subgrupo es el único factor significativo, con un *effect size* de 0.16. Cabe destacar que la normalidad multivariante se mantiene, pero se pierde la homocedasticidad de la matriz de covarianzas para subgrupo y edad factorizada, hecho que puede sesgar el test de MANOVA.

```{r ATRavg21.0.7}
# Para las 2 métricas Iron-FA
# Generar los MANOVAS
LATR_manova2_1<-manova(cbind(lhatr_Iron,lhatr_FA)~Subgroup*Gender*agef2, 
                       data=LATR_avg_demo_WoOut_IronFA)
summary(LATR_manova2_1)
LATR_manova2_2<-manova(cbind(lhatr_Iron,lhatr_FA)~Subgroup+Gender:agef2, 
                       data=LATR_avg_demo_WoOut_IronFA)
summary(LATR_manova2_2)
LATR_manova2_3<-manova(cbind(lhatr_Iron,lhatr_FA)~Subgroup, 
                       data=LATR_avg_demo_WoOut_IronFA)
summary(LATR_manova2_3)

# Generar effect size
LATR_SizeMan2_2<-effectsize::eta_squared(LATR_manova2_2);LATR_SizeMan2_2
```

En el caso de las **2 métricas Iron-FA**, la interacción género-edad factorizada es significativa, con un tamaño de efecto del 0.18. 

```{r ATRavg21.0.11.Bis, echo=FALSE, eval=FALSE}
# Resumen de los modelos MANOVA
kable(list(summary(RATR_manova5_1,tol=0)$stats,summary(RATR_manova5_2)$stats,summary(RATR_manova5_3)$stats),
      caption='5-metrics MANOVA without logarithmic transformation for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(RATR_manova5_1log)$stats,summary(RATR_manova5_2log)$stats,summary(RATR_manova5_3log)$stats),
      caption='5-metrics MANOVA with logarithmic transformation for Right ATR', booktabs=TRUE)%>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(RATR_manova3_1,tol=0)$stats,summary(RATR_manova3_2,tol=0)$stats,summary(RATR_manova3_3, tol=0)$stats),
      caption='3-metrics MANOVA without logarithmic transformation for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(RATR_manova3_1log)$stats,summary(RATR_manova3_2log)$stats,summary(RATR_manova3_3log)$stats),
      caption='3-metrics MANOVA with logarithmic transformation for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(RATR_manova2_1)$stats,summary(RATR_manova2_2)$stats,summary(RATR_manova2_3)$stats),
      caption='2-metrics MANOVA without logarithmic transformation for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(LATR_manova5_1)$stats,summary(LATR_manova5_2)$stats,summary(LATR_manova5_3)$stats),
      caption='5-metrics MANOVA without logarithmic transformation for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(LATR_manova3_1,tol=0)$stats,summary(LATR_manova3_2,tol=0)$stats,summary(LATR_manova3_3,tol=0)$stats),
      caption='3-metrics MANOVA without logarithmic transformation for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(LATR_manova3_1log)$stats,summary(LATR_manova3_2log)$stats,summary(LATR_manova3_3log)$stats),
      caption='3-metrics MANOVA with logarithmic transformation for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(LATR_manova2_1)$stats,summary(LATR_manova2_2)$stats,summary(LATR_manova2_3)$stats),
      caption='2-metrics MANOVA without logarithmic transformation for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### Comparaciones pareadas

Se genera un **Análisis Discriminante Lineal (LDA)**, el cual tiene como objetivo encontrar qué combinación lineal de variables individuales dependientes (*features*) conduce a la máxima separabilidad de subgrupos e interpretar esta combinación lineal. Se utiliza la función `lda` del paquete `MASS`.

Se van a analizar aquellos MANOVA que han detectado el subgrupo como factor significativo y se van a utilizar los dataframes con transformaciones logarítmicas dado que sin dichas transformaciones la función `lda` expone que las variables de difusividad media, radial y axial son constantes (probablemente debido a sus valores muy próximos a cero), como se verá a continuación. En el caso del ATR izquierdo para las 5 métricas, se realiza la transformación logarítmica de las 3 métricas de difusividad y se comprueba la normalidad multivariante como la homocedasticidad de la matriz de covarianzas, dado que no se había ejecutado en el MANOVA anterior (no se ejecutó porque los residuos no eran rango-deficientes). 

Dos de las premisas del LDA es que los *features* de cada subgrupo o clase sigan una distribución normal y que las matrices de covariznas sean iguales, por tanto, se van a utilizar los dataframes reducidos (con la eliminación de outliers). 

Los pasos son: generación de los datasets de entrenamiento y de testeo, generación del modelo LDA con el dataset de entrenamiento, predicción de las clases o de las probabilidades posteriores del dataset de testeo, y evaluación del modelo mediante curvas ROC, matriz de confusión o coeficiente kappa. 

La interpretación del coefficiente kappa es la siguiente según Fleiss et al. 2003 ([KAPPA COEFFICIENT INTERPRETATION](https://www.datanovia.com/en/blog/kappa-coefficient-interpretation/)):

- Valores mayores de 0.75 tienen un excelente acuerdo;
- Valores menores de 0.40 tienen un pobre acuerdo;
- Valores entre 0.40 y 0.75 tiene un acuerdo de débil a bueno.

Según McHugh 2012: 

| Value of K | Level of agreement | % of data that are reliable |
|:-----------|-------------------:|----------------------------:|
| 0 - 0.20   | None               |   0 - 4%                    |
| 0.21 - 0.39| Minimal            |   4 - 15%                   |    
| 0.40 - 0.59| Weak               |   15 - 35%                  |  
| 0.60 - 0.79| Moderate           |   35 - 63%                  |  
| 0.80 - 0.90| Strong             |   64 - 81%                  |  
| Above 0.90 | Almost Perfect     |   82 - 100%                 |  

**Resultados para el RATR**

```{r ATRavg21.0.8, fig.align='center'}
library(caret)
library(MASS)
library(pROC)
library(multiROC)
# Para las 5 métricas

# Primero, división del dataframe sin transformación logarítmica en los datasets 
# de entrenamiento y testeo
set.seed(123456)
train_index<-createDataPartition(RATR_avg_demo_WoOut$Subgroup, p=0.8, list=FALSE)
train<-RATR_avg_demo_WoOut[train_index,]
test<-RATR_avg_demo_WoOut[-train_index,]

# Segundo, se genera el modelo LDA
RATR_LDA5model<-lda(Subgroup~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
                    data=train)

# Se repiten el primer y segundo paso con el dataframe con transformación logarítmica
set.seed(123456)

train_index<-createDataPartition(RATR_avg_demo_WoOut_log$Subgroup, p=0.8, list=FALSE)
train<-RATR_avg_demo_WoOut_log[train_index,]
test<-RATR_avg_demo_WoOut_log[-train_index,]

RATR_LDAlog5model<-lda(Subgroup~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
                       data=train)
print(RATR_LDAlog5model)

# Se genera el plot
##Define colors for each subgroup
subgroup_colors <- c("Control" = "red", "PreHD" = "green", "HD" = "blue")
## Plot the model with custom colors for species
plot(RATR_LDAlog5model, col = subgroup_colors, 
     main="Visualization of 5log-LDA model of the right ATR")
legend('bottomright',inset=0.05, bty='n', cex=0.5, legend=c('Control','PreHD','HD'),
       fill=c('red','green','blue'))

# Se predicen las clases
predClas_RATRLDA5<-predict(RATR_LDAlog5model, newdata = test, type='class')
test_subgroup<-as.character(test$Subgroup)
test_subgroup<-factor(test_subgroup, levels = levels(predClas_RATRLDA5$class))
table(predClas_RATRLDA5$class, test_subgroup)

RATR_LDA5log_DF<-data.frame(
  predicted_class=predClas_RATRLDA5$class,
  subgroup=test[,'Subgroup'],
  lda=predClas_RATRLDA5$x
)
str(RATR_LDA5log_DF)
ggplot(RATR_LDA5log_DF) +
  geom_text(aes(x=lda.LD1,y=lda.LD2,label=subgroup, color = predicted_class)) +
  theme_classic() + ggtitle('LDA results for 5log-LDA model of the right ATR')

# Evaluación del modelo

## Accuracy
accuracyRATR_LDAlog5<-sum(diag(table(predClas_RATRLDA5$class, test$Subgroup)))/nrow(test)
accuracyRATR_LDAlog5

## Confusion Matrix
confMX_RATR_LDA5log<-confusionMatrix(predClas_RATRLDA5$class, test$Subgroup)
confMX_RATR_LDA5log

## ROC curves one vs the rest by multiROC package 
Control_pred_RATRLDA5log<- predClas_RATRLDA5$posterior[,'Control']
PreHD_pred_RATRLDA5log<- predClas_RATRLDA5$posterior[,'PreHD']
HD_pred_RATRLDA5log<- predClas_RATRLDA5$posterior[,'HD']
Control_true<-ifelse(test$Subgroup=='Control',1,0)
PreHD_true<-ifelse(test$Subgroup=='PreHD',1,0)
HD_true<-ifelse(test$Subgroup=='HD',1,0)
DF_ROC_RATRLDA5log<-cbind(Control_true,PreHD_true,HD_true,Control_pred_RATRLDA5log,
                          PreHD_pred_RATRLDA5log,HD_pred_RATRLDA5log)
multiROC_RATR_LDA5log<-multi_roc(DF_ROC_RATRLDA5log)
multiROC_RATR_LDA5log_DF<-plot_roc_data(multiROC_RATR_LDA5log)
ggplot(multiROC_RATR_LDA5log_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "5-LDA model of RATR ROC curve: One vs Rest",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       mean(multiROC_RATR_LDA5log_DF$AUC[multiROC_RATR_LDA5log_DF$Group=='Control'])),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_RATR_LDA5log_DF$AUC[multiROC_RATR_LDA5log_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_RATR_LDA5log_DF$AUC[multiROC_RATR_LDA5log_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_RATR_LDA5log_DF$AUC[multiROC_RATR_LDA5log_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_RATR_LDA5log_DF$AUC[multiROC_RATR_LDA5log_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)

## Kappa coefficient
library(irr)
kappa_RATR_LDA5log<-kappam.fleiss(data.frame(predClas_RATRLDA5$class,test$Subgroup))
kappa_RATR_LDA5log
```

```{r ATRavg21.0.9,fig.align='center'}
library(MASS)
# Para las 3 métricas

# Primero, división del dataframe sin transformación logarítmica en los datasets 
# de entrenamiento y testeo
set.seed(123456)
train_index<-createDataPartition(RATR_avg_demo_WoOut_ADRDMD$Subgroup, p=0.8, list=FALSE)
train<-RATR_avg_demo_WoOut_ADRDMD[train_index,]
test<-RATR_avg_demo_WoOut_ADRDMD[-train_index]

# Segundo, se genera el modelo LDA
RATR_LDA3model<-lda(Subgroup~cbind(rhatr_AD,rhatr_RD,rhatr_MD), data=train)

# Se repiten el primer y segundo paso con el dataframe con transformación logarítmica
set.seed(123456)

train_index<-createDataPartition(RATR_avg_demo_WoOut_ADRDMD_log$Subgroup, p=0.8, list=FALSE)
train<-RATR_avg_demo_WoOut_ADRDMD_log[train_index,]
test<-RATR_avg_demo_WoOut_ADRDMD_log[-train_index,]

RATR_LDAlog3model<-lda(Subgroup~cbind(rhatr_AD,rhatr_RD,rhatr_MD), data=train)
print(RATR_LDAlog3model)

# Se genera el plot
##Define colors for each subgroup
subgroup_colors <- c("Control" = "red", "PreHD" = "green", "HD" = "blue")
## Plot the model with custom colors for species
plot(RATR_LDAlog3model, col = subgroup_colors, 
     main="Visualization of 3log-LDA model of the right ATR")
legend('bottomright',inset=0.05, bty='n', cex=0.5, legend=c('Control','PreHD','HD'),
       fill=c('red','green','blue'))

# Se predicen las clases
predClas_RATRLDA3<-predict(RATR_LDAlog3model, newdata = test, type='class')
test_subgroup<-as.character(test$Subgroup)
test_subgroup<-factor(test_subgroup, levels = levels(predClas_RATRLDA3$class))
table(predClas_RATRLDA3$class, test_subgroup)

RATR_LDA3log_DF<-data.frame(
  predicted_class=predClas_RATRLDA3$class,
  subgroup=test[,'Subgroup'],
  lda=predClas_RATRLDA3$x
)
str(RATR_LDA3log_DF)
ggplot(RATR_LDA3log_DF) +
  geom_text(aes(x=lda.LD1,y=lda.LD2,label=subgroup, color = predicted_class)) +
  theme_classic() + ggtitle('LDA results for 3log-LDA model of the right ATR')

# Evaluación del modelo

## Accuracy
accuracyRATR_LDAlog3<-sum(diag(table(predClas_RATRLDA3$class, test$Subgroup)))/nrow(test)
accuracyRATR_LDAlog3

## Confusion Matrix
confMX_RATR_LDA3log<-confusionMatrix(predClas_RATRLDA3$class, test$Subgroup)
confMX_RATR_LDA3log

## ROC curves one vs the rest by multiROC package 
Control_pred_RATRLDA3log<- predClas_RATRLDA3$posterior[,'Control']
PreHD_pred_RATRLDA3log<- predClas_RATRLDA3$posterior[,'PreHD']
HD_pred_RATRLDA3log<- predClas_RATRLDA3$posterior[,'HD']
Control_true<-ifelse(test$Subgroup=='Control',1,0)
PreHD_true<-ifelse(test$Subgroup=='PreHD',1,0)
HD_true<-ifelse(test$Subgroup=='HD',1,0)
DF_ROC_RATRLDA3log<-cbind(Control_true,PreHD_true,HD_true,Control_pred_RATRLDA3log,
                          PreHD_pred_RATRLDA3log,HD_pred_RATRLDA3log)
multiROC_RATR_LDA3log<-multi_roc(DF_ROC_RATRLDA3log)
multiROC_RATR_LDA3log_DF<-plot_roc_data(multiROC_RATR_LDA3log)
ggplot(multiROC_RATR_LDA3log_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "3-LDA model of RATR ROC curve: One vs Rest",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       mean(multiROC_RATR_LDA3log_DF$AUC[multiROC_RATR_LDA3log_DF$Group=='Control'])),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_RATR_LDA3log_DF$AUC[multiROC_RATR_LDA3log_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_RATR_LDA3log_DF$AUC[multiROC_RATR_LDA3log_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_RATR_LDA3log_DF$AUC[multiROC_RATR_LDA3log_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_RATR_LDA3log_DF$AUC[multiROC_RATR_LDA3log_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)

## Kappa coefficient
library(irr)
kappa_RATR_LDA3log<-kappam.fleiss(data.frame(predClas_RATRLDA3$class,test$Subgroup))
kappa_RATR_LDA3log
```

**Resultados para el LATR**

```{r ATRavg21.0.10.1, fig.align='center'}
library(MASS)
# Para las 5 métricas

# Primero, división del dataframe sin transformación logarítmica en los datasets 
# de entrenamiento y testeo
set.seed(123456)
train_index<-createDataPartition(LATR_avg_demo_WoOut$Subgroup, p=0.8, list=FALSE)
train<-LATR_avg_demo_WoOut[train_index,]
test<-LATR_avg_demo_WoOut[-train_index]

# Segundo, se genera el modelo LDA
LATR_LDA5model<-lda(Subgroup~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA),
                    data=train)

# Segundo, con el dataframe con transformación logarítmica
## Primero transformación de las variables
LATR_avg_demo_WoOut_log<-cbind(LATR_avg_demo_WoOut[,1:8],log(cbind(LATR_avg_demo_WoOut[,9:11])),
                               LATR_avg_demo_WoOut[,12])
colnames(LATR_avg_demo_WoOut_log)<-colnames(LATR_avg_demo_WoOut)
## Comprobar normalidad multivariante
par(mfrow = c(1, 2))
LATR_mvnlog5<-mvn(LATR_avg_demo_WoOut_log[-c(1:7)], mvnTest = 'royston', covariance = TRUE,
                  desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq',
                  multivariatePlot = 'qq', multivariateOutlierMethod = 'quan',
                  showOutliers = TRUE, showNewData = TRUE)
LATR_mvnlog5$multivariateNormality
LATR_mvnlog5$univariateNormality
## Comprobar homocedasticidad de la matriz de covarianzas
LATR_MBox_SG5log<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Subgroup,
                       data=LATR_avg_demo_WoOut_log, cov=TRUE);LATR_MBox_SG5log
LATR_MBox_G5log<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~Gender,
                      data=LATR_avg_demo_WoOut_log, cov=TRUE);LATR_MBox_G5log
LATR_MBox_AGE5log<-boxM(cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA)~agef2,
                        data=LATR_avg_demo_WoOut_log, cov=TRUE);LATR_MBox_AGE5log
```

```{r ATRavg21.0.10.2, echo=FALSE, eval=FALSE}
LATRmultiNormLog<-rbind(LATR_mvnlog5$multivariateNormality, LATR_mvnlog3$multivariateNormality)
rownames(LATRmultiNormLog)<-c('Log Transformation of Diffusivity metrics for the 5-metric of left ATR', 'Log Transformation of Diffusivity metrics for the 3-metric of left ATR')

kableExtra::kable(LATRmultiNormLog, caption = 'Multivariate normality assessment for log transformation of diffusivity metrics in 5-metric and 3-metric models of LEFT ATR', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg21.0.10.3, echo=FALSE, eval=FALSE}
Subgroup5log<-round(c(LATR_MBox_SG5log[[1]][[1]],LATR_MBox_SG5log[[2]][[1]],LATR_MBox_SG5log[[3]][[1]]),3)
Gender5log<-round(c(LATR_MBox_G5log[[1]][[1]],LATR_MBox_G5log[[2]][[1]],LATR_MBox_G5log[[3]][[1]]),3)
Age5log<-round(c(LATR_MBox_AGE5log[[1]][[1]],LATR_MBox_AGE5log[[2]][[1]],LATR_MBox_AGE5log[[3]][[1]]),3)

Subgroup3log<-round(c(LATR_MBox_SG3log[[1]][[1]],LATR_MBox_SG3log[[2]][[1]],LATR_MBox_SG3log[[3]][[1]]),3)
Gender3log<-round(c(LATR_MBox_G3log[[1]][[1]],LATR_MBox_G3log[[2]][[1]],LATR_MBox_G3log[[3]][[1]]),3)
Age3log<-round(c(LATR_MBox_AGE3log[[1]][[1]],LATR_MBox_AGE3log[[2]][[1]],LATR_MBox_AGE3log[[3]][[1]]),3)

Variables<-c('Chi-square','Df','P-value')
LATR_HomoCov5log<-cbind(Variables,Subgroup5log,Gender5log,Age5log)
LATR_HomoCov3log<-cbind(Variables,Subgroup3log,Gender3log,Age3log)
LATR_HomoCovlog<-rbind(LATR_HomoCov5log,LATR_HomoCov3log)
LATR_HomoCovlog<-as.data.frame(LATR_HomoCovlog)
colnames(LATR_HomoCovlog)<-c('Variables','Subgroup','Gender','Age')

kableExtra::kable(LATR_HomoCovlog, caption = 'Covariance Matrix Homoscedasticity for log transformation of diffusivity metrics in 5-metric and 3-metric models of LEFT ATR', booktabs = TRUE) %>%
  pack_rows(index=c('For 5 metrics'=3, 'For diffusivity metrics (AD-RD-MD)'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg21.0.10.4, echo=FALSE, eval=FALSE}
HomoCovlog<-rbind(RATR_HomoCovlog,LATR_HomoCovlog)
kableExtra::kable(HomoCovlog, caption = 'Covariance Matrix Homoscedasticity for log transformation of diffusivity metrics in 5-metric and 3-metric models', booktabs = TRUE) %>%
  pack_rows(index=c('RATR'=6,'LATR'=6)) %>%
  pack_rows(index=c(rep(c('For 5 metrics'=3, 'For diffusivity metrics (AD-RD-MD)'=3),2))) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Con la transformación logarítmica, se mantiene la normalidad multivariante, pero se pierde la homocedasticidad de la matriz de covarianzas para los factores subgrupo y edad factorizada, hecho que podría sesgar los resultados en la ejecución de un MANOVA (no se ha ejecutado dado que en el paso anterior el modelo no generaba residuos rango-deficientes). 

```{r ATRavg21.0.10.bis, fig.align='center'}
# Se repiten el primer y segundo paso con el dataframe con transformación logarítmica
set.seed(123456)

train_index<-createDataPartition(LATR_avg_demo_WoOut_log$Subgroup, p=0.8, list=FALSE)
train<-LATR_avg_demo_WoOut_log[train_index,]
test<-LATR_avg_demo_WoOut_log[-train_index,]

LATR_LDAlog5model<-lda(Subgroup~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA),
                       data=train)
print(LATR_LDAlog5model)

# Se genera el plot
##Define colors for each subgroup
subgroup_colors <- c("Control" = "red", "PreHD" = "green", "HD" = "blue")
## Plot the model with custom colors for species
plot(LATR_LDAlog5model, col = subgroup_colors, 
     main="Visualization of 5log-LDA model of the left ATR")
legend('bottomright',inset=0.05, bty='n', cex=0.5, legend=c('Control','PreHD','HD'),
       fill=c('red','green','blue'))

# Se predicen las clases
predClas_LATRLDA5<-predict(LATR_LDAlog5model, newdata = test, type='class')
test_subgroup<-as.character(test$Subgroup)
test_subgroup<-factor(test_subgroup, levels = levels(predClas_LATRLDA5$class))
table(predClas_LATRLDA5$class, test_subgroup)

LATR_LDA5log_DF<-data.frame(
  predicted_class=predClas_LATRLDA5$class,
  subgroup=test[,'Subgroup'],
  lda=predClas_LATRLDA5$x
)
str(LATR_LDA5log_DF)
ggplot(LATR_LDA5log_DF) +
  geom_text(aes(x=lda.LD1,y=lda.LD2,label=subgroup, color = predicted_class)) +
  theme_classic() + ggtitle('LDA results for 5log-LDA model of the left ATR')

# Evaluación del modelo
## Accuracy
accuracyLATR_LDAlog5<-sum(diag(table(predClas_LATRLDA5$class, test$Subgroup)))/nrow(test)
accuracyLATR_LDAlog5

## Confusion Matrix
confMX_LATR_LDA5log<-confusionMatrix(predClas_LATRLDA5$class, test$Subgroup)
confMX_LATR_LDA5log

## ROC curves one vs the rest by multiROC package 
Control_pred_LATRLDA5log<- predClas_LATRLDA5$posterior[,'Control']
PreHD_pred_LATRLDA5log<- predClas_LATRLDA5$posterior[,'PreHD']
HD_pred_LATRLDA5log<- predClas_LATRLDA5$posterior[,'HD']
Control_true<-ifelse(test$Subgroup=='Control',1,0)
PreHD_true<-ifelse(test$Subgroup=='PreHD',1,0)
HD_true<-ifelse(test$Subgroup=='HD',1,0)
DF_ROC_LATRLDA5log<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LATRLDA5log,
                          PreHD_pred_LATRLDA5log,HD_pred_LATRLDA5log)
multiROC_LATR_LDA5log<-multi_roc(DF_ROC_LATRLDA5log)
multiROC_LATR_LDA5log_DF<-plot_roc_data(multiROC_LATR_LDA5log)
ggplot(multiROC_LATR_LDA5log_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "5-LDA model of LATR ROC curve: One vs Rest",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       mean(multiROC_LATR_LDA5log_DF$AUC[multiROC_LATR_LDA5log_DF$Group=='Control'])),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                                             round(mean(multiROC_LATR_LDA5log_DF$AUC[multiROC_LATR_LDA5log_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                                             round(mean(multiROC_LATR_LDA5log_DF$AUC[multiROC_LATR_LDA5log_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                                             round(mean(multiROC_LATR_LDA5log_DF$AUC[multiROC_LATR_LDA5log_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                                             round(mean(multiROC_LATR_LDA5log_DF$AUC[multiROC_LATR_LDA5log_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)

## Kappa coefficient
library(irr)
kappa_LATR_LDA5log<-kappam.fleiss(data.frame(predClas_LATRLDA5$class,test$Subgroup))
kappa_LATR_LDA5log
```

```{r ATRavg21.0.11, fig.align='center'}
# Primero, división del dataframe sin transformación logarítmica en los datasets 
# de entrenamiento y testeo
set.seed(123456)
train_index<-createDataPartition(LATR_avg_demo_WoOut_ADRDMD$Subgroup, p=0.8, list=FALSE)
train<-LATR_avg_demo_WoOut_ADRDMD[train_index,]
test<-LATR_avg_demo_WoOut_ADRDMD[-train_index,]
# Segundo, se genera el modelo LDA
LATR_LDA3model<-lda(Subgroup~cbind(lhatr_AD,lhatr_RD,lhatr_MD), data=train)

# Se repiten el primer y segundo paso con el dataframe con transformación logarítmica
set.seed(123456)

train_index<-createDataPartition(LATR_avg_demo_WoOut_ADRDMD_log$Subgroup, p=0.8, list=FALSE)
train<-LATR_avg_demo_WoOut_ADRDMD_log[train_index,]
test<-LATR_avg_demo_WoOut_ADRDMD_log[-train_index,]

LATR_LDAlog3model<-lda(Subgroup~cbind(lhatr_AD,lhatr_RD,lhatr_MD),data=train)
print(LATR_LDAlog3model)

# Se genera el plot
##Define colors for each subgroup
subgroup_colors <- c("Control" = "red", "PreHD" = "green", "HD" = "blue")
## Plot the model with custom colors for species
plot(LATR_LDAlog3model, col = subgroup_colors, 
     main="Visualization of 3log-LDA model of the left ATR")
legend('bottomright',inset=0.05, bty='n', cex=0.5, legend=c('Control','PreHD','HD'),
       fill=c('red','green','blue'))

# Se predicen las clases
predClas_LATRLDA3<-predict(LATR_LDAlog3model, newdata = test, type='class')
test_subgroup<-as.character(test$Subgroup)
test_subgroup<-factor(test_subgroup, levels = levels(predClas_LATRLDA3$class))
table(predClas_LATRLDA3$class, test_subgroup)

LATR_LDA3log_DF<-data.frame(
  predicted_class=predClas_LATRLDA3$class,
  subgroup=test[,'Subgroup'],
  lda=predClas_LATRLDA3$x
)
str(LATR_LDA3log_DF)
ggplot(LATR_LDA3log_DF) +
  geom_text(aes(x=lda.LD1,y=lda.LD2,label=subgroup, color = predicted_class)) +
  theme_classic() + ggtitle('LDA results for 3log-LDA model of the left ATR')

# Evaluación del modelo
## Accuracy
accuracyLATR_LDAlog3<-sum(diag(table(predClas_LATRLDA3$class, test$Subgroup)))/nrow(test)
accuracyLATR_LDAlog3

## Confusion Matrix
confMX_LATR_LDA3log<-confusionMatrix(predClas_LATRLDA3$class, test$Subgroup)
confMX_LATR_LDA3log

## ROC curves one vs the rest by multiROC package 
Control_pred_LATRLDA3log<- predClas_LATRLDA3$posterior[,'Control']
PreHD_pred_LATRLDA3log<- predClas_LATRLDA3$posterior[,'PreHD']
HD_pred_LATRLDA3log<- predClas_LATRLDA3$posterior[,'HD']
Control_true<-ifelse(test$Subgroup=='Control',1,0)
PreHD_true<-ifelse(test$Subgroup=='PreHD',1,0)
HD_true<-ifelse(test$Subgroup=='HD',1,0)
DF_ROC_LATRLDA3log<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LATRLDA3log,
                          PreHD_pred_LATRLDA3log,HD_pred_LATRLDA3log)
multiROC_LATR_LDA3log<-multi_roc(DF_ROC_LATRLDA3log)
multiROC_LATR_LDA3log_DF<-plot_roc_data(multiROC_LATR_LDA3log)
ggplot(multiROC_LATR_LDA3log_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "3-LDA model of LATR ROC curve: One vs Rest",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       mean(multiROC_LATR_LDA3log_DF$AUC[multiROC_LATR_LDA3log_DF$Group=='Control'])),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_LATR_LDA3log_DF$AUC[multiROC_LATR_LDA3log_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_LATR_LDA3log_DF$AUC[multiROC_LATR_LDA3log_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_LATR_LDA3log_DF$AUC[multiROC_LATR_LDA3log_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_LATR_LDA3log_DF$AUC[multiROC_LATR_LDA3log_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)

## Kappa coefficient
library(irr)
kappa_LATR_LDA3log<-kappam.fleiss(data.frame(predClas_LATRLDA3$class,test$Subgroup))
kappa_LATR_LDA3log
```

**Se objetiva un solapamiento entre los tres subgrupos mediante el análisis discriminante lineal, ya sea considerando las 5 métricas (iron, AD, RD, MD, FA) o las 3 métricas de difusividad (AD, RD, MD), tanto en el ATR derecho como en el ATR izquierdo.**

\newpage

## PERMANOVA

Se ha consultado la siguiente fuente de información: [20. PERMANOVA](https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/permanova/), [16. Permutation Tests](https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/permutation-tests/), [25. Controlling Permutations](https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/controlling-permutations/), [26. Restricting Permutations](https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/restricting-permutations/).

**PERMANOVA (PERmutational Multivariate ANalysis of VAriance, análisis multivariante permutacional de la varianza)** es una técnica analítica basada en la permutación (sin suposiciones distribucionales sobre la normalidad multivariante o la homogeneidad de las varianzas) para datos multivariantes. Se decide utilizar también PERMANOVA debido a la multicolinealidad de las variables dependientes, especialmente entre AD, RD y MD, y debido a la pérdida de homocedasticidad en las matrices de covarianza en ambos ATRs con los MANOVA obtenidos a partir de las 3 métricas de difusividad con transformación logarítmica.  

PERMANOVA se basa en el **teorema de Huygens**: la suma de las diferencias al cuadrado entre los puntos y su centroide es igual a la suma de las distancias entre puntos al cuadrado dividida por el número de puntos, por tanto, la variación dentro de un grupo se puede calcular directamente a partir de una matriz de distancia, sin necesidad de conocer la localización de los centroides grupales. Por tanto, si se puede calcular calcular la variación a partir de la matriz de distancia, eso significa que también se puede dividir esa variación entre diferentes fuentes (variables independientes). Dado que se basa en la matriz de distancias, PERMANOVA es una técnica extremadamente potente y flexible, **aplicable a datos de cualquier dimensionalidad** (útil tanto para datos univariantes como para datos multivariantes), puede expresarse a través de cualquier medida de distancia y se puede utilizar para **analizar modelos complejos**, incluidos múltiples factores, covariables (predictores distribuidos continuamente) e interacciones entre términos.  

Como es una técnica basada en permutaciones, **no requiere suposiciones sobre la normalidad y/o la homogeneidad de las varianzas**. La **única suposición** del PERMANOVA (compartida con el resto de pruebas de permutación) es que las **observaciones** sean **intercambiables** bajo la hipótesis nula y la justificación para usar permutaciones para evaluar la significación.

El **estadístico** de PERMANOVA, **pseudo-F**, se modela directamente a partir del estadístico F ANOVA convencional: se calcula como una relación entre la cantidad de variación entre los grupos y dentro de ellos (between group variation/within group variation), con el numerador y el denominador ponderados cada uno por sus grados de libertad. El valor que toma el estadístico es 0 o positivo, correspondiendo los valores más grandes a una mayor importancia proporcional del factor de agrupación. Al igual que con otras técnicas de permutación, la **distribución del estadístico** se evalúa mediante el reetiquetado repetido de las unidades de observación (es decir, la permutación de las identidades de grupo) y el recálculo del estadístico. Remarcar que el estadístico es idéntico al estadístico F convencional cuando se calcula utilizando la distancia euclidiana para una sola variable.

Para aplicar un PERMANOVA, se requieren los siguientes **pasos**: 

- Primero, se calcula la matriz de distancias utilizando una medida de distancia apropiada;
- Segundo, se eleva al cuadrado la matriz de distancias. 
- Tercero, se calcula las tres particiones de la variación:
-- Variación total (*total sum of squres SST*): la suma de las distancias al cuadrado dividido por el número de observaciones.
-- Variación dentro del grupo (*sum of squares within groups SSW*): se calcula igula que SST pero separadamente para cada grupo y se suma el valor de cada grupo para obtener el SSW global;
-- Variación entre grupos (*sum of squares between groups SSB*): se calcula con la substracción entre SST-SSW. 
- Cuarto, se calcula el estadístico: $PseudoF = \frac{SSB/(t-1)}{SSW/(N-1)}$, donde t es el número de grupos y N es el número total de observaciones/sujetos.
- Quinto, se evalúa la significación estadística a través del test de permutación. 
- Sexto, se calcula el p-valor como la proporción de permutaciones con un valor de pseudo-F igual o mayor al de los datos.

Posteriormente, en el caso que el permanova sea significativo, se calcula entre qué grupos se encuentran dichas diferencias mediante un test pareado. 

**Para cada ATR, se va a proceder de la manera siguiente:**

- Generación de las matrices de distancias;
- Generación de los modelos PERMANOVA;
- Valoración de la dispersión de los modelos PERMANOVA; 
- Comparación por pares. 

Para determinar **qué distancia elegir**, se han consultado estas fuentes de información: [Clustering Distance Measures](https://www.datanovia.com/en/lessons/clustering-distance-measures/#distance-matrix-computation), [Distance/similarity measures](https://mark-me.github.io/distance-measures/#gower-distance), [12. Common Distance Measures](https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/common-distance-measures/).

```{r ATRavg21.0.12, out.width='70%', echo=FALSE, fig.align='center'}
knitr::include_graphics('Distancias.png',auto_pdf=FALSE)
```

La matriz de distancias se puede calcular con las funciones `dist`, `daisy` y `vegdist` de los paquetes `stats`, `cluster` y `vegan`. 

Existen diferentes paquetes que ofrecen funciones para ejecutar/calcular PERMANOVA en R. En este caso, se va a utilizar la funcion `adonis2` del paquete `vegan`. Existen **diferentes parámetros a elegir**:

- *Permutations*: número de permutaciones y cómo realizar la permutación (existencia de bloques, dentro de los niveles de un factor...);
- *Method*: elección de la medida de distancia;
- *By*: método de evalución de la significancia de los términos (secuencial, marginal, global);
- *Strata*: grupos en los que se restringen las permutaciones.

A pesar de corresponder a una técnica no paramétrica, se decide generar PERMANOVAS con los dataframes originales (`RATR_avg_demo`, `LATR_avg_demo`) y con la eliminación de los outliers que se ha realizado en la normalidad multivariante (`RATR_avg_demo_WoOut`, `LATR_avg_demo_WoOut`).

En cuanto a la **valoración de la dispersión**, se consulta la siguiente fuente: [21. PERMDISP](https://uw.pressbooks.pub/appliedmultivariatestatistics/chapter/permdisp/). Como ya se comentó previamente, las técnicas de permutación no suponen homogeneidad de varianzas, pero los **patrones de dispersión** (variabilidad entre unidades de la muestra) pueden influir en la interpretación del estadístico debido a que las diferencias significativas entre grupos pueden deberse a diferencias en las medias (centroides) y/o diferencias en la dispersión de las unidades de la muestra alrededor de esos centroides. Esta sensibilidad a la dispersión en los análisis multivariados es idéntica a la sensibilidad a la varianza en los análisis univariados (los grupos en un análisis univariado pueden diferir con respecto a sus valores medios y/o la variación alrededor de esas medias).

La dispersión **se puede examinar** mediante los tests de Levene o Fligner en los análisis univariados y mediante **PERMDISP** que es una extensión multivariada del test de Levene para examinar si los grupos difieren en la variabilidad entre ellos. PERMDISP calcula la distancia de cada punto al centroide de su grupo y luego examina si esas distancias difieren entre los grupos. Como no siempre se puede calcular directamente el centroide (como en el caso de las distancias semimétricas), se aplica un **Análisis de Coordenadas Principales (PCoA)** a la matriz de distancias y los centroides se calculan sobre la base de las coordenadas en el espacio PCoA. 

Un **resultado no significativo** indicaría que los grupos no difieren en dispersión y que, por lo tanto, las diferencias se deben exclusivamente a diferencias de localización, y, un **resultado significativo** indicaría que los grupos pueden diferir exclusivamente en dispersión o tanto en dispersión como en localización. 

Es importante recordar que la dispersión se ve fuertemente **afectada por las transformaciones aplicadas a los datos originales y por la elección de la medida de distancia**, por lo que si PERMDISP se utiliza tras un PERMANOVA, es esencial que se utilicen los mismos ajustes de datos y medidas de distancia en ambos casos, de lo contrario los tests no serían directamente comparables.

El **procedimiento básico** para PERMDISP es el siguiente:

1. Se parte de una matriz de distancias y se ejecuta una ordenación del Análisis de Coordenadas Principales (PCoA) sobre dicha matriz. 
2. Se superpone el factor de agrupación en el PCoA para codificar cada unidad de muestra según el grupo al que pertenece.
3. Se calcula el centroide (puntuación promedio) para cada nivel del factor de agrupación en el espacio de ordenación.
4. Se calcula la distancia entre cada observación y el centroide del grupo al que pertenece.

**Esta técnica no implica un test estadístico, es decir, produce un conjunto de datos univariados** (la distancia desde cada observación al centroide de su grupo) con una distribución relativamente normal, independientemente de las características de los datos multivariados que generaron la matriz de distancia, y que puede analizarse posteriormente mediante otros tests estadísticos como ANOVA, PERMANOVA u otras técnicas basadas en permutación.

El PERMDISP (o análisis de homogeneidad multivariada de dispersiones/varianzas grupales) se va a **ejecutar mediante la función `betadisper` del paquete `vegan`**. Esta función realiza un PCoA de la matriz de distancias, calcula la distancia desde cada unidad de muestra al centroide para su nivel del factor de agrupación y guarda estas distancias en un objeto de la clase 'betadisper'. Se pueden aplicar diferentes funciones a dicho objeto con diferentes objetivos:

- Ver datos gráficamente: funciones `plot` o `boxplot`;
- Realizar tests estadísticos: funciones `anova`, `TukeyHSD` o `permutest`.

### RATR

Se ha procedido a **calcular la matriz de distancias** con la función `daisy` del paquete `cluster` para poder visualizar las similaridades/disimilaridades entre subgrupos mediante MDS y tSNE. Se consulta esta web: [Rtsne: Perplexity is too large](https://stackoverflow.com/questions/51089556/rtsne-perplexity-is-too-large). Las métricas de RM son variables numéricas continuas y no procedentes de especies, por lo que se decide utilizar la **distancia euclídea** en la generación de la matriz de distancias.

```{r ATRavg21.0.13, fig.width=5, fig.height=4, fig.align='center'}
library(cluster)
# Matriz de distancias para las 5 métricas - Sin eliminación de outliers
dist<-daisy(RATR_avg_demo[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

library(factoextra)
fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(RATR_avg_demo, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_AD, rhatr_RD,
                rhatr_MD, rhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
library(ggplot2)
ggplot(df_mds_dist2,aes(x, y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

library(Rtsne)
my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(RATR_avg_demo) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
#fit_tsne<-Rtsne(dist,is_distance=TRUE,check_duplicates=FALSE,pca=FALSE,dims=2)
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, check_duplicates = FALSE,
                pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(RATR_avg_demo,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_AD, rhatr_RD,
                rhatr_MD, rhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne,aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y con la matriz de distancias calculada con las 5 métricas de RM**, los subgrupos no parecen separarse con dicha matriz de distancias. 

```{r ATRavg21.0.13.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 5 métricas - Con eliminación de outliers
dist<-daisy(RATR_avg_demo_WoOut[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(RATR_avg_demo_WoOut, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_AD, rhatr_RD,
                rhatr_MD, rhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x, y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable)

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(RATR_avg_demo_WoOut) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, 
                check_duplicates = FALSE, pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(RATR_avg_demo_WoOut,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_AD, rhatr_RD,
                rhatr_MD, rhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y con las matriz de distancias calculada con las 5 métricas de RM**, los subgrupos tampoco parecen separarse con dicha matriz de distancias. 

```{r ATRavg21.0.14, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 3 métricas de difusividad
dist<-daisy(RATR_avg_demo_ADRDMD[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(RATR_avg_demo_ADRDMD, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_AD, rhatr_RD, rhatr_MD) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(RATR_avg_demo_ADRDMD) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = my_Rtsne$perplexity, is_distance = TRUE, check_duplicates = FALSE,
                pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(RATR_avg_demo_ADRDMD,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_AD, rhatr_RD, rhatr_MD) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y con la matriz de distancias obtenida con las 3 métricas de difusividad**, los subgrupos HD y preHD vs controles parecen separarse con dicha matriz de distancias, pero existe gran solapamiento entre los tres subgrupos. 

```{r ATRavg21.0.14.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 3 métricas de difusividad
dist<-daisy(RATR_avg_demo_WoOut_ADRDMD[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(RATR_avg_demo_WoOut_ADRDMD, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_AD, rhatr_RD, rhatr_MD) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity=floor((nrow(RATR_avg_demo_WoOut_ADRDMD)-1)/3),dims=2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = my_Rtsne$perplexity, is_distance = TRUE, check_duplicates = FALSE,
                pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(RATR_avg_demo_WoOut_ADRDMD,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_AD, rhatr_RD, rhatr_MD) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y con la matriz de distancias obtenida con las 3 métricas de difusividad**, los subgrupos HD y preHD vs controles también parecen separarse con dicha matriz de distancias, pero existe gran solapamiento entre los tres subgrupos.

```{r ATRavg21.0.15, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las métricas de iron y FA
dist<-daisy(RATR_avg_demo_IronFA[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(RATR_avg_demo_IronFA, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(RATR_avg_demo_IronFA) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, 
                check_duplicates = FALSE, pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars<-as_tibble(cbind(RATR_avg_demo_IronFA,x=fit_tsne$Y[,1],y=fit_tsne$Y[,2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y la matriz de distancias obtenida de las métricas de iron y FA**, los subgrupos no parecen separarse con dicha matriz de distancias.

```{r ATRavg21.0.15.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las métricas de iron y FA
dist<-daisy(RATR_avg_demo_WoOut_IronFA[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(RATR_avg_demo_WoOut_IronFA, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(RATR_avg_demo_WoOut_IronFA)-1)/3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, 
                check_duplicates = FALSE, pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars<-as_tibble(cbind(RATR_avg_demo_WoOut_IronFA,x=fit_tsne$Y[,1],
                              y=fit_tsne$Y[,2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, rhatr_Iron, rhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y la matriz de distancias obtenida de las métricas de iron y FA**, los subgrupos no parecen separarse con dicha matriz de distancias.

También **se calculan las matrices de distancia** con la función `vegdist` del paquete `vegan` para la combinación de métricas Iron-FA (por poder correlacionarse con el subgrupo preHD), AD-MD-RD (por poder correlacionarse con el subgrupo HD), y, para las 5 métricas en su conjunto (método euclídeo porque son variables numéricas continuas, no derivadas de especies). Dichas matrices se utilizarán para generar los modelos PERMANOVA. Las variables categóricas no se introducen en la matriz de distancias porque se utilizan como variables independientes en los modelos PERMANOVA.

Como se objetiva a continuación, se han calculado las matrices para ambos supuestos, con y sin eliminación de outliers. Teóricamente, PERMANOVA, al ser una técnica no paramétrica, podría ejecutarse con todos los sujetos ya que no necesita normalidad multivariante ni homocedasticidad de la matriz de covarianzas, pero, al basarse en permutaciones, requiere verificar una betadispersión homogénea entre grupos. Así que se generarán modelos PERMANOVA con y sin eliminación de outliers.  

```{r ATRavg21.0.16}
library(vegan)
# Matriz de distancias para las 5 métricas
distDifIron<-vegdist(RATR_avg_demo[,-c(1:7)],method='euclidean')
distDifIron_WoOut<-vegdist(RATR_avg_demo_WoOut[,-c(1:7)],method='euclidean')

# Matriz de distancias para las 3 métricas de difusividad (AD, RD, MD)
distADMDRD<-vegdist(RATR_avg_demo_ADRDMD[,c('rhatr_AD','rhatr_RD','rhatr_MD')],
                    method='euclidean')
distADMDRD_WoOut<-vegdist(RATR_avg_demo_WoOut_ADRDMD[,c('rhatr_AD','rhatr_RD',
                                                        'rhatr_MD')],
                          method='euclidean')

# Matriz de distancias para las métricas de Iron y FA
distIronFA<-vegdist(RATR_avg_demo_IronFA[,c('rhatr_Iron','rhatr_FA')],
                    method='euclidean')
distIronFA_WoOut<-vegdist(RATR_avg_demo_WoOut_IronFA[,c('rhatr_Iron','rhatr_FA')],
                          method='euclidean')
```

A continuación, **se generan los diferentes modelos PERMANOVA** (remarcar que no se puede añadir el efecto aleatorio). Primero, los modelos se ejecutan con las 3 variables independientes en interacción. Segundo, se eliminan las interacciones no significativas para simplificar los modelos.

```{r ATRavg21.0.17}
library(vegan)
# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

# Modelos para las 5 métricas
permDifIron1<-adonis2(distDifIron~Subgroup*agef2*Gender, data=RATR_avg_demo, 
                      permutations=999, by='terms');permDifIron1[1:5]
permDifIron2<-adonis2(distDifIron~Subgroup+agef2+Gender, data=RATR_avg_demo, 
                      permutations=999, by='terms');permDifIron2[1:5]
permDifIron3<-adonis2(distDifIron~Subgroup, data=RATR_avg_demo, permutations=999,
                      by='terms');permDifIron3[1:5]

permDifIron1_WoOut<-adonis2(distDifIron_WoOut~Subgroup*agef2*Gender, 
                            data=RATR_avg_demo_WoOut, permutations=999,
                            by='terms');permDifIron1_WoOut[1:5]
permDifIron2_WoOut<-adonis2(distDifIron_WoOut~Subgroup+agef2+Gender, 
                            data=RATR_avg_demo_WoOut, permutations=999,
                            by='terms');permDifIron2_WoOut[1:5]
permDifIron3_WoOut<-adonis2(distDifIron_WoOut~Subgroup, data=RATR_avg_demo_WoOut,
                            permutations=999, by='terms');permDifIron3_WoOut[1:5]

# Modelos para las 3 métricas de difusividad (AD, RD, MD)
permADMDRD1<-adonis2(distADMDRD~Subgroup*agef2*Gender, data=RATR_avg_demo_ADRDMD, 
                     permutations=999, by='terms');permADMDRD1[1:5]
permADMDRD2<-adonis2(distADMDRD~Subgroup+agef2+Gender, data=RATR_avg_demo_ADRDMD, 
                     permutations=999, by='terms');permADMDRD2[1:5]
permADMDRD3<-adonis2(distADMDRD~Subgroup, data=RATR_avg_demo_ADRDMD, permutations=999, 
                     by='terms');permADMDRD3[1:5]

permADMDRD1_WoOut<-adonis2(distADMDRD_WoOut~Subgroup*agef2*Gender, 
                           data=RATR_avg_demo_WoOut_ADRDMD,permutations=999, 
                           by='terms');permADMDRD1_WoOut[1:5]
permADMDRD2_WoOut<-adonis2(distADMDRD_WoOut~Subgroup+agef2+Gender, 
                           data=RATR_avg_demo_WoOut_ADRDMD, permutations=999, 
                           by='terms');permADMDRD2_WoOut[1:5]
permADMDRD3_WoOut<-adonis2(distADMDRD_WoOut~Subgroup, data=RATR_avg_demo_WoOut_ADRDMD, 
                           permutations=999, by='terms');permADMDRD3_WoOut[1:5]

# Modelos para las métricas de iron y FA
permIronFA1<-adonis2(distIronFA~Subgroup*agef2*Gender, data=RATR_avg_demo_IronFA, 
                     permutations=999, by='terms');permIronFA1[1:5]
permIronFA2<-adonis2(distIronFA~Subgroup+agef2+Gender, data=RATR_avg_demo_IronFA,
                     permutations=999, by='terms');permIronFA2[1:5]
permIronFA3<-adonis2(distIronFA~Subgroup, data=RATR_avg_demo_IronFA,
                     permutations=999, by='terms');permIronFA3[1:5]

permIronFA1_WoOut<-adonis2(distIronFA_WoOut~Subgroup*agef2*Gender, 
                           data=RATR_avg_demo_WoOut_IronFA, permutations=999, 
                           by='terms');permIronFA1_WoOut[1:5]
permIronFA2_WoOut<-adonis2(distIronFA_WoOut~Subgroup+agef2+Gender, 
                           data=RATR_avg_demo_WoOut_IronFA, permutations=999, 
                           by='terms');permIronFA2_WoOut[1:5]
permIronFA3_WoOut<-adonis2(distIronFA_WoOut~Subgroup, data=RATR_avg_demo_WoOut_IronFA, 
                           permutations=999, by='terms');permIronFA3_WoOut[1:5]
```

```{r ATRavg21.0.17.Bis, echo=FALSE, eval=FALSE}
# Resumen de los modelos PERMANOVA
kable(list(permDifIron1[1:5],permDifIron2[1:5],permDifIron3[1:5]),
      caption='5-metrics PERMANOVA with complete dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permDifIron1_WoOut[1:5],permDifIron2_WoOut[1:5],permDifIron3_WoOut[1:5]),
      caption='5-metrics PERMANOVA with reduced dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD1[1:5],permADMDRD2[1:5],permADMDRD3[1:5]),
      caption='3-metrics PERMANOVA with complete dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD1_WoOut[1:5],permADMDRD2_WoOut[1:5],permADMDRD3_WoOut[1:5]),
      caption='3-metrics PERMANOVA with reduced dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permIronFA1[1:5],permIronFA2[1:5],permIronFA3[1:5]),
      caption='2-metrics PERMANOVA with complete dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permIronFA1_WoOut[1:5],permIronFA2_WoOut[1:5],permIronFA3_WoOut[1:5]),
      caption='2-metrics PERMANOVA with reduced dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Los **modelos PERMANOVA generados con las 5 métricas**, ya sea con el dataframe completo o con el dataframe reducido eliminando los outliers, no evidencian factores significativos.

Los **modelos PERMANOVA generados con las 3 métricas de difusividad**, ya sea con el dataframe completo o con el dataframe reducido eliminando los outliers, evidencian el subgrupo como único factor significativo.

Los **modelos PERMANOVA generados con las métricas de iron y FA**, ya sea con el dataframe completo o con el dataframe reducido eliminando los outliers, no evidencian factores significativos.

**Por tanto, PERMANOVA ha sido menos sensible que MANOVA para detectar significación estadística en la evaluación de las 5 métricas conjuntamente.**

Se calculan las **dispersiones** para cada uno de los modelos que se han generado en el paso anterior y tan sólo se han calculado para el factor subgrupo dado que es el único que ha dado significativo. 

```{r ATRavg21.0.18}
dispersionDifIron<-betadisper(d=distDifIron, group=RATR_avg_demo$Subgroup,
                              type="centroid",bias.adjust=TRUE)
dispersionDifIron_WoOut<-betadisper(d=distDifIron_WoOut, 
                                    group=RATR_avg_demo_WoOut$Subgroup,
                                    type="centroid",bias.adjust=TRUE)

dispersionADMDRD<-betadisper(d=distADMDRD, group=RATR_avg_demo_ADRDMD$Subgroup,
                             type="centroid",bias.adjust=TRUE)
dispersionADMDRD_WoOut<-betadisper(d=distADMDRD_WoOut,
                                   group=RATR_avg_demo_WoOut_ADRDMD$Subgroup,
                                   type="centroid",bias.adjust=TRUE)

dispersionIronFA<-betadisper(d=distIronFA, group=RATR_avg_demo_IronFA$Subgroup,
                             type="centroid",bias.adjust=TRUE)
dispersionIronFA_WoOut<-betadisper(d=distIronFA_WoOut, 
                                   group=RATR_avg_demo_WoOut_IronFA$Subgroup,
                                   type="centroid",bias.adjust=TRUE)
```

Se generan **plots** para cada una de las dispersiones. 

```{r ATRavg21.0.19.1, echo=FALSE}
par(mfrow = c(1, 2))
plot(dispersionDifIron, main=list('Dispersion for 5 metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionDifIron_WoOut, main=list('Dispersion for 5 metrics related to subgroup (reduced dataframe)', cex=0.5))
```

```{r ATRavg21.0.19.2, echo=FALSE}
par(mfrow = c(1, 2))
plot(dispersionADMDRD, main=list('Dispersion for diffusivity metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionADMDRD_WoOut, main=list('Dispersion for diffusivity metrics related to subgroup (reduced dataframe)', cex=0.5))
```

```{r ATRavg21.0.19.3, echo=FALSE}
par(mfrow = c(1, 2))
plot(dispersionIronFA, main=list('Dispersion for iron-FA metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionIronFA_WoOut, main=list('Dispersion for iron-FA metrics related to subgroup (reduced dataframe)', cex=0.5))
```

Cabe mencionar que el subgrupo HD presenta una mayor dispersión respecto a los subgrupos preHD y control, y, el subgrupo preHD presenta una menor dispersión respecto a los subgrupos HD y control.

Se generan **modelos anova** para cada una de las dispersiones. 

```{r ATRavg21.0.20}
summary(aov(dispersionDifIron$distances~RATR_avg_demo$Subgroup))
summary(aov(dispersionDifIron_WoOut$distances~RATR_avg_demo_WoOut$Subgroup))

summary(aov(dispersionADMDRD$distances~RATR_avg_demo_ADRDMD$Subgroup))
summary(aov(dispersionADMDRD_WoOut$distances~RATR_avg_demo_WoOut_ADRDMD$Subgroup))

summary(aov(dispersionIronFA$distances~RATR_avg_demo_IronFA$Subgroup))
summary(aov(dispersionIronFA_WoOut$distances~RATR_avg_demo_WoOut_IronFA$Subgroup))
```

```{r ATRavg21.0.20.1, echo=FALSE, eval=FALSE}
  # Resumen de los modelos ANOVA
RATRaovDispSG<-rbind(summary(aov(dispersionDifIron$distances~RATR_avg_demo$Subgroup))[[1]],
                     summary(aov(dispersionDifIron_WoOut$distances~RATR_avg_demo_WoOut$Subgroup))[[1]],
                     summary(aov(dispersionADMDRD$distances~RATR_avg_demo_ADRDMD$Subgroup))[[1]],
                     summary(aov(dispersionADMDRD_WoOut$distances~RATR_avg_demo_WoOut_ADRDMD$Subgroup))[[1]],
                     summary(aov(dispersionIronFA$distances~RATR_avg_demo_IronFA$Subgroup))[[1]],
                     summary(aov(dispersionIronFA_WoOut$distances~RATR_avg_demo_WoOut_IronFA$Subgroup))[[1]])
kable(RATRaovDispSG, caption='ANOVAs for dispersion distances of the Right ATR', booktabs=TRUE) %>%
  pack_rows(index=c('5-metric model with complete dataframe'=2,'5-metric model with reduced dataframe'=2,
                    '3-metric model with complete dataframe'=2,'3-metric model with reduced dataframe'=2,
                    '2-metric model with complete dataframe'=2,'2-metric model with reduced dataframe'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las dispersiones de las 3 métricas de difusividad presentan significación estadística, con lo que no se puede determinar si las diferencias observadas en PERMANOVA son debidas a diferencias en el posicionamiento de los centroides y/o a las diferencias en dispersión. Como se mencionó más arriba, no se puede determinar cuánta diferencia en el PERMANOVA es debida al posicionamiento de centroides y cuánta debida a la variabilidad en dispersión. 

Se decide intentar la **transformación logarítmica de las 3 métricas de difusividad para determinar si se mejora la dispersión**. A continuación, se exponen los resultados para el **dataframe completo**. 

```{r ATRavg21.0.20.2}
# Se genera la transformación logarítmica
RATR_avg_demo_ADRDMD_log<-cbind(RATR_avg_demo_ADRDMD[,1:7],
                                log(RATR_avg_demo_ADRDMD[,8:10]))

# Se calculan las distancias
distADMDRD_log<-vegdist(RATR_avg_demo_ADRDMD_log[,c('rhatr_AD','rhatr_MD','rhatr_RD')],
                        method='euclidean')

# Se generan los modelos PERMANOVA                    
set.seed(123)
permADMDRD_log1<-adonis2(distADMDRD_log~Subgroup*agef2*Gender,
                         data=RATR_avg_demo_ADRDMD_log, permutations=999, by='terms')
permADMDRD_log1[1:5]
permADMDRD_log2<-adonis2(distADMDRD_log~Subgroup,data=RATR_avg_demo_ADRDMD_log, 
                         permutations=999, by='terms')
permADMDRD_log2[1:5]

# Se determinan las dispersiones
dispersionADMDRD_log<-betadisper(d=distADMDRD_log, group=RATR_avg_demo_ADRDMD_log$Subgroup,
                                 type="centroid",bias.adjust=TRUE)

# Se generan los plots
par(mfrow = c(1, 1))
plot(dispersionADMDRD_log, main=list('Dispersion for log-transform diffusivity metrics 
                                     related to subgroup (complete dataframe)', cex=0.5))

# Modelos ANOVA para las 3 métricas - Dataframe completo con transformación logarítmica
summary(aov(dispersionADMDRD_log$distances~RATR_avg_demo_ADRDMD_log$Subgroup))
```

En el caso de la **transformación logarítmica de las 3 métricas de difusividad para el dataframe completo**, se objetiva que el factor subgrupo es el único término significativo en el PERMANOVA (como ocurría sin la transformación logarítmica). Como se visualiza en el plot, persiste una mayor dispersión para el subgrupo HD y unas dispersiones similares para los subgrupos preHD y control, pero, a nivel de ANOVA, la dispersión no es estadísticamente significativa, por tanto, las diferencias observadas en PERMANOVA son debidas a diferencias en el posicionamiento de los centroides y no a las diferencias en dispersión entre subgrupos. La transformación logarítmica obtiene unos valores F y p-valor de `r round(summary(aov(dispersionADMDRD_log$distances~RATR_avg_demo_ADRDMD_log$Subgroup))[[1]][1,4],3)` y de `r round(summary(aov(dispersionADMDRD_log$distances~RATR_avg_demo_ADRDMD_log$Subgroup))[[1]][1,5],3)` respectivamente comparado con los valores F y p-valor para el PERMANOVA sin transformación logarítmica de `r round (summary(aov(dispersionADMDRD$distances~RATR_avg_demo_ADRDMD$Subgroup))[[1]][1,4],3)` y `r round (summary(aov(dispersionADMDRD$distances~RATR_avg_demo_ADRDMD$Subgroup))[[1]][1,5],3)` respectivamente.

A continuación, se exponen los resultados para el **dataframe reducido** (con eliminación de outliers). 

```{r ATRavg21.0.20.3}
# Se genera la transformación logarítmica
RATR_avg_demo_ADRDMD_WO_log<-cbind(RATR_avg_demo_WoOut_ADRDMD[,1:7],
                                   log(RATR_avg_demo_WoOut_ADRDMD[,8:10]))

# Se calculan las distancias
distADMDRD_WO_log<-vegdist(RATR_avg_demo_ADRDMD_WO_log[,c('rhatr_AD','rhatr_MD','rhatr_RD')],
                           method='euclidean')

# Se generan los modelos PERMANOVA                    
set.seed(123)
permADMDRD_WO_log1<-adonis2(distADMDRD_WO_log~Subgroup*agef2*Gender,
                            data=RATR_avg_demo_ADRDMD_WO_log, permutations=999, by='terms')
permADMDRD_WO_log1[1:5]
permADMDRD_WO_log2<-adonis2(distADMDRD_WO_log~Subgroup,data=RATR_avg_demo_ADRDMD_WO_log,
                            permutations=999, by='terms')
permADMDRD_WO_log2[1:5]

# Se determinan las dispersiones
dispersionADMDRD_WO_log<-betadisper(d=distADMDRD_WO_log, group=RATR_avg_demo_ADRDMD_WO_log$Subgroup,
                                    type="centroid",bias.adjust=TRUE)

# Se generan los plots
par(mfrow = c(1, 1))
plot(dispersionADMDRD_WO_log, main=list('Dispersion for log-transform diffusivity metrics 
                                        related to subgroup (reduced dataframe)',cex=0.5))

# Modelos ANOVA para las 3 métricas - Dataframe reducido con transformación logarítmica
summary(aov(dispersionADMDRD_WO_log$distances~RATR_avg_demo_ADRDMD_WO_log$Subgroup))
```

```{r ATRavg21.0.20.4, echo=FALSE}
# Se generan los plots
par(mfrow = c(1, 2))
plot(dispersionADMDRD_log, main=list('Dispersion for log-transform diffusivity related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionADMDRD_WO_log, main=list('Dispersion for log-transform diffusivity related to subgroup (reduced dataframe)', cex=0.5))
```

```{r ATRavg21.0.20.5, echo=FALSE, eval=FALSE}
# Resumen de los modelos MANOVA
kable(list(permADMDRD_log1[1:5],permADMDRD_log2[1:5]),
      caption='3-log transformed diffusivity metrics PERMANOVA with complete dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD_WO_log1[1:5],permADMDRD_WO_log2[1:5]),
      caption='3-log transformed diffusivity metrics PERMANOVA with reduced dataframe for Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg21.0.20.6, echo=FALSE, eval=FALSE}
  # Resumen de los modelos ANOVA
RATRaovDispLogSG<-rbind(summary(aov(dispersionADMDRD_log$distances~RATR_avg_demo_ADRDMD_log$Subgroup))[[1]],
                        summary(aov(dispersionADMDRD_WO_log$distances~RATR_avg_demo_ADRDMD_WO_log$Subgroup))[[1]])
kable(RATRaovDispLogSG, caption='ANOVAs for dispersion distances of the Right ATR', booktabs=TRUE) %>%
  pack_rows(index=c('3-log transformed metric model with complete dataframe'=2,'3-log transformed metric model with reduced dataframe'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el caso de la **transformación logarítmica de las 3 métricas de difusividad para el dataframe reducido**, se objetiva que el factor subgrupo es el único término significativo en el PERMANOVA (como ocurría sin la transformación logarítmica). Como se visualiza en el plot, persiste una mayor dispersión para el subgrupo HD y unas dispersiones similares para los subgrupos preHD y control, pero, a nivel de ANOVA, la dispersión no es estadísticamente significativa, por tanto, las diferencias observadas en PERMANOVA son debidas a diferencias en el posicionamiento de los centroides y no a las diferencias en dispersión entre subgrupos. La transformación logarítmica obtiene unos valores F y p-valor de `r round(summary(aov(dispersionADMDRD_WO_log$distances~RATR_avg_demo_ADRDMD_WO_log$Subgroup))[[1]][1,4],3)` y de `r round(summary(aov(dispersionADMDRD_WO_log$distances~RATR_avg_demo_ADRDMD_WO_log$Subgroup))[[1]][1,5],3)` respectivamente comparado con los valores F y p-valor para el PERMANOVA sin transformación logarítmica de `r round(summary(aov(dispersionADMDRD_WoOut$distances~RATR_avg_demo_WoOut_ADRDMD$Subgroup))[[1]][1,4],3)` y `r round(summary(aov(dispersionADMDRD_WoOut$distances~RATR_avg_demo_WoOut_ADRDMD$Subgroup))[[1]][1,5],3)` respectivamente.

### LATR

Las métricas de RM son variables numéricas continuas y no procedentes de especies, por lo que se decide utilizar la **distancia euclídea** en la generación de la matriz de distancias. Se ha procedido a **calcular la matriz de distancias** con la función `daisy` del paquete `cluster` para poder visualizar las similaridades/disimilaridades entre subgrupos mediante MDS y tSNE. 

```{r ATRavg21.0.21, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 5 métricas - Sin eliminación de outliers
dist<-daisy(LATR_avg_demo[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(LATR_avg_demo, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_AD, lhatr_RD,
                lhatr_MD, lhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2,aes(x, y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(LATR_avg_demo) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
fit_tsne<-Rtsne(dist,is_distance=TRUE,check_duplicates=FALSE,pca=FALSE,dims=2)
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, check_duplicates = FALSE,
                pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(LATR_avg_demo,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_AD, lhatr_RD,
                lhatr_MD, lhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne,aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y con las matriz de distancias calculada con las 5 métricas de RM**, los subgrupos no parecen separarse con dicha matriz de distancias.

```{r ATRavg21.0.21.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 5 métricas - Con eliminación de outliers
dist<-daisy(LATR_avg_demo_WoOut[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(LATR_avg_demo_WoOut, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_AD, lhatr_RD,
                lhatr_MD, lhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x, y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable)

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(LATR_avg_demo_WoOut) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, 
                check_duplicates = FALSE, pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(LATR_avg_demo_WoOut,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_AD, lhatr_RD,
                lhatr_MD, lhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y con las matriz de distancias calculada con las 5 métricas de RM**, los subgrupos tampoco parecen separarse con dicha matriz de distancias.

```{r ATRavg21.0.22, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 3 métricas de difusividad
dist<-daisy(LATR_avg_demo_ADRDMD[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(LATR_avg_demo_ADRDMD, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_AD, lhatr_RD, lhatr_MD) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(LATR_avg_demo_ADRDMD) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = my_Rtsne$perplexity, is_distance = TRUE, check_duplicates = FALSE,
                pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(LATR_avg_demo_ADRDMD,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_AD, lhatr_RD, lhatr_MD) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y con la matriz de distancias obtenida con las 3 métricas de difusividad**, los subgrupos HD y preHD vs controles parecen separarse con dicha matriz de distancias, pero existe gran solapamiento entre los tres subgrupos. 

```{r ATRavg21.0.22.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 3 métricas de difusividad
dist<-daisy(LATR_avg_demo_WoOut_ADRDMD[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(LATR_avg_demo_WoOut_ADRDMD, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_AD, lhatr_RD, lhatr_MD) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity=floor((nrow(LATR_avg_demo_WoOut_ADRDMD)-1)/3),dims=2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = my_Rtsne$perplexity, is_distance = TRUE, check_duplicates = FALSE,
                pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(LATR_avg_demo_WoOut_ADRDMD,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_AD, lhatr_RD, lhatr_MD) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y con la matriz de distancias obtenida con las 3 métricas de difusividad**, los subgrupos HD y preHD vs controles también parecen separarse con dicha matriz de distancias, pero existe gran solapamiento entre los tres subgrupos.

```{r ATRavg21.0.23, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las métricas de iron y FA
dist<-daisy(LATR_avg_demo_IronFA[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(LATR_avg_demo_IronFA, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(LATR_avg_demo_IronFA) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, 
                check_duplicates = FALSE, pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars<-as_tibble(cbind(LATR_avg_demo_IronFA,x=fit_tsne$Y[,1],y=fit_tsne$Y[,2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y la matriz de distancias obtenida de las métricas de iron y FA**, los subgrupos no parecen separarse con las matrices de distancias.

```{r ATRavg21.0.23.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las métricas de iron y FA
dist<-daisy(LATR_avg_demo_WoOut_IronFA[,-c(1:7)],metric='euclidean')
distmx<-as.matrix(dist)

fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(LATR_avg_demo_WoOut_IronFA, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_FA) %>% 
  tidyr::gather (key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_mds_dist2, aes(x,y)) + geom_jitter(aes(col=Subgroup)) + facet_wrap(~variable) 

my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(LATR_avg_demo_WoOut_IronFA)-1)/3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
set.seed(123)
fit_tsne<-Rtsne(dist,perplexity = 1, is_distance = TRUE, 
                check_duplicates = FALSE, pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars<-as_tibble(cbind(LATR_avg_demo_WoOut_IronFA,x=fit_tsne$Y[,1],
                              y=fit_tsne$Y[,2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, Subgroup, Gender, agef2, lhatr_Iron, lhatr_FA) %>% 
  tidyr::gather(key = "variable",value = "values",-x,-y,-Subgroup,-Gender,-agef2)
ggplot(df_tsne, aes(x, y, col=values)) + geom_point(aes(col=Subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y la matriz de distancias obtenida de las métricas de iron y FA**, los subgrupos tampoco parecen separarse con las matrices de distancias.

También **se calculan las matrices de distancia** con la función `vegdist` del paquete `vegan` para la combinación de métricas Iron-FA (por poder correlacionarse con el subgrupo preHD), AD-MD-RD (por poder correlacionarse con el subgrupo HD), y, para las 5 métricas en su conjunto. Dichas matrices se utilizarán para generar los modelos PERMANOVA. Las variables categóricas no se introducen en la matriz de distancias porque se utilizan como variables independientes en los modelos PERMANOVA.

Como se objetiva a continuación, se han calculado las matrices para ambos supuestos, con y sin eliminación de outliers. Teórciamente, PERMANOVA, al ser una técnica no paramétrica, podría ejecutarse con todos los sujetos ya que no necesita normalidad multivariante ni homocedasticidad de la matriz de covarianzas, pero, al basarse en permutaciones, requiere verificar una betadispersión homogénea entre grupos. Así que se generarán modelos PERMANOVA con y sin eliminación de outliers.  

```{r ATRavg21.0.24}
library(vegan)
# Matriz de distancias para las 5 métricas
distDifIron<-vegdist(LATR_avg_demo[,-c(1:7)],method='euclidean')
distDifIron_WoOut<-vegdist(LATR_avg_demo_WoOut[,-c(1:7)],method='euclidean')

# Matriz de distancias para las 3 métricas de difusividad (AD, RD, MD)
distADMDRD<-vegdist(LATR_avg_demo_ADRDMD[,c('lhatr_AD','lhatr_RD','lhatr_MD')],
                    method='euclidean')
distADMDRD_WoOut<-vegdist(LATR_avg_demo_WoOut_ADRDMD[,c('lhatr_AD','lhatr_RD',
                                                        'lhatr_MD')],
                          method='euclidean')

# Matriz de distancias para las métricas de Iron y FA
distIronFA<-vegdist(LATR_avg_demo_IronFA[,c('lhatr_Iron','lhatr_FA')],
                    method='euclidean')
distIronFA_WoOut<-vegdist(LATR_avg_demo_WoOut_IronFA[,c('lhatr_Iron','lhatr_FA')],
                          method='euclidean')
```

A continuación, **se generan los diferentes modelos PERMANOVA** (remarcar que no se puede añadir el efecto aleatorio). Primero, los modelos se ejecutan con las 3 variables independientes en interacción. Segundo, se eliminan las interacciones no significativas para simplificar los modelos.

```{r ATRavg21.0.25}
# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

library(vegan)
# Modelos para las 5 métricas
permDifIron1<-adonis2(distDifIron~Subgroup*agef2*Gender, data=LATR_avg_demo, 
                      permutations=999, by='terms');permDifIron1[1:5]
permDifIron2<-adonis2(distDifIron~Subgroup+agef2+Gender, data=LATR_avg_demo, 
                      permutations=999, by='terms');permDifIron2[1:5]
permDifIron3<-adonis2(distDifIron~Subgroup, data=LATR_avg_demo, permutations=999,
                      by='terms');permDifIron3[1:5]

permDifIron1_WoOut<-adonis2(distDifIron_WoOut~Subgroup*agef2*Gender, 
                            data=LATR_avg_demo_WoOut, permutations=999,
                            by='terms');permDifIron1_WoOut[1:5]
permDifIron2_WoOut<-adonis2(distDifIron_WoOut~Subgroup+agef2+Gender, 
                            data=LATR_avg_demo_WoOut, permutations=999,
                            by='terms');permDifIron2_WoOut[1:5]
permDifIron3_WoOut<-adonis2(distDifIron_WoOut~Subgroup, data=LATR_avg_demo_WoOut,
                            permutations=999, by='terms');permDifIron3_WoOut[1:5]

# Modelos para las 3 métricas de difusividad (AD, RD, MD)
permADMDRD1<-adonis2(distADMDRD~Subgroup*agef2*Gender, data=LATR_avg_demo_ADRDMD, 
                     permutations=999, by='terms');permADMDRD1[1:5]
permADMDRD2<-adonis2(distADMDRD~Subgroup+agef2+Gender, data=LATR_avg_demo_ADRDMD, 
                     permutations=999, by='terms');permADMDRD2[1:5]
permADMDRD3<-adonis2(distADMDRD~Subgroup, data=LATR_avg_demo_ADRDMD, permutations=999, 
                     by='terms');permADMDRD3[1:5]

permADMDRD1_WoOut<-adonis2(distADMDRD_WoOut~Subgroup*agef2*Gender, 
                           data=LATR_avg_demo_WoOut_ADRDMD,permutations=999, 
                           by='terms');permADMDRD1_WoOut[1:5]
permADMDRD2_WoOut<-adonis2(distADMDRD_WoOut~Subgroup+agef2+Gender, 
                           data=LATR_avg_demo_WoOut_ADRDMD, permutations=999, 
                           by='terms');permADMDRD2_WoOut[1:5]
permADMDRD3_WoOut<-adonis2(distADMDRD_WoOut~Subgroup, data=LATR_avg_demo_WoOut_ADRDMD, 
                           permutations=999, by='terms');permADMDRD3_WoOut[1:5]

# Modelos para las métricas de iron y FA
permIronFA1<-adonis2(distIronFA~Subgroup*agef2*Gender, data=LATR_avg_demo_IronFA, 
                     permutations=999, by='terms');permIronFA1[1:5]
permIronFA2<-adonis2(distIronFA~Subgroup+agef2+Gender, data=LATR_avg_demo_IronFA,
                     permutations=999, by='terms');permIronFA2[1:5]
permIronFA3<-adonis2(distIronFA~Subgroup, data=LATR_avg_demo_IronFA,
                     permutations=999, by='terms');permIronFA3[1:5]

permIronFA1_WoOut<-adonis2(distIronFA_WoOut~Subgroup*agef2*Gender, 
                           data=LATR_avg_demo_WoOut_IronFA, permutations=999, 
                           by='terms');permIronFA1_WoOut[1:5]
permIronFA2_WoOut<-adonis2(distIronFA_WoOut~Subgroup+agef2+Gender, 
                           data=LATR_avg_demo_WoOut_IronFA, permutations=999, 
                           by='terms');permIronFA2_WoOut[1:5]
permIronFA3_WoOut<-adonis2(distIronFA_WoOut~Subgroup, data=LATR_avg_demo_WoOut_IronFA, 
                           permutations=999, by='terms');permIronFA3_WoOut[1:5]
```

Los **modelos PERMANOVA generados con las 5 métricas**, ya sea con el dataframe completo o con el dataframe reducido eliminando los outliers, no evidencian factores significativos, pero, a diferencia del ATR derecho, el subgrupo es casi significativo (con p valores menores 0.10) en los tres modelos (desde el modelo más complejo con los factores en interacción hasta el modelo más simple con subgrupo como único factor).

Los **modelos PERMANOVA generados con las 3 métricas de difusividad**, ya sea con el dataframe completo o con el dataframe reducido eliminando los outliers, evidencian el subgrupo como único factor significativo.

Los **modelos PERMANOVA generados con las métricas de iron y FA**, ya sea con el dataframe completo o con el dataframe reducido eliminando los outliers, no evidencian factores significativos, pero, a diferencia del ATR derecho, el subgrupo es casi significativo (con p valores menores 0.10) en los tres modelos (desde el modelo más complejo con los factores en interacción hasta el modelo más simple con subgrupo como único factor).

**Por tanto, PERMANOVA ha sido menos sensible que MANOVA para detectar significación estadística en la evaluación de las 5 métricas conjuntamente, pero, presenta una casi significación estadística tanto para las 5 métricas conjuntamente como para las métricas iron-FA.**

```{r ATRavg21.0.25.2, echo=FALSE, eval=FALSE}
# Resumen de los modelos PERMANOVA
kable(list(permDifIron1[1:5],permDifIron2[1:5],permDifIron3[1:5]),
      caption='5-metrics PERMANOVA with complete dataframe for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permDifIron1_WoOut[1:5],permDifIron2_WoOut[1:5],permDifIron3_WoOut[1:5]),
      caption='5-metrics PERMANOVA with reduced dataframe for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD1[1:5],permADMDRD2[1:5],permADMDRD3[1:5]),
      caption='3-metrics PERMANOVA with complete dataframe for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD1_WoOut[1:5],permADMDRD2_WoOut[1:5],permADMDRD3_WoOut[1:5]),
      caption='3-metrics PERMANOVA with reduced dataframe for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permIronFA1[1:5],permIronFA2[1:5],permIronFA3[1:5]),
      caption='2-metrics PERMANOVA with complete dataframe for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permIronFA1_WoOut[1:5],permIronFA2_WoOut[1:5],permIronFA3_WoOut[1:5]),
      caption='2-metrics PERMANOVA with reduced dataframe for Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Se calculan las **dispersiones** para cada uno de los modelos que se han generado en el paso anterior y tan sólo se han calculado para el factor subgrupo dado que es el único que ha dado significativo. 

```{r ATRavg21.0.26}
dispersionDifIron<-betadisper(d=distDifIron, group=LATR_avg_demo$Subgroup,
                              type="centroid",bias.adjust=TRUE)
dispersionDifIron_WoOut<-betadisper(d=distDifIron_WoOut, 
                                    group=LATR_avg_demo_WoOut$Subgroup,
                                    type="centroid",bias.adjust=TRUE)

dispersionADMDRD<-betadisper(d=distADMDRD, group=LATR_avg_demo_ADRDMD$Subgroup,
                             type="centroid",bias.adjust=TRUE)
dispersionADMDRD_WoOut<-betadisper(d=distADMDRD_WoOut,
                                   group=LATR_avg_demo_WoOut_ADRDMD$Subgroup,
                                   type="centroid",bias.adjust=TRUE)

dispersionIronFA<-betadisper(d=distIronFA, group=LATR_avg_demo_IronFA$Subgroup,
                             type="centroid",bias.adjust=TRUE)
dispersionIronFA_WoOut<-betadisper(d=distIronFA_WoOut, 
                                   group=LATR_avg_demo_WoOut_IronFA$Subgroup,
                                   type="centroid",bias.adjust=TRUE)
```

Se generan **plots** para cada una de las dispersiones. 

```{r ATRavg21.0.27.1, echo=FALSE}
par(mfrow = c(1, 2))
plot(dispersionDifIron, main=list('Dispersion for 5 metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionDifIron_WoOut, main=list('Dispersion for 5 metrics related to subgroup (reduced dataframe)', cex=0.5))
```

```{r ATRavg21.0.27.2, echo=FALSE}
par(mfrow = c(1, 2))
plot(dispersionADMDRD, main=list('Dispersion for diffusivity metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionADMDRD_WoOut, main=list('Dispersion for diffusivity metrics related to subgroup (reduced dataframe)', cex=0.5))
```

```{r ATRavg21.0.27.3, echo=FALSE}
par(mfrow = c(1, 2))
plot(dispersionIronFA, main=list('Dispersion for iron-FA metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionIronFA_WoOut, main=list('Dispersion for iron-FA metrics related to subgroup (reduced dataframe)', cex=0.5))
```

Cabe mencionar que el subgrupo preHD presenta una menor dispersión respecto a los subgrupos HD y control, y, que el subgrupo HD presenta una dispersión similar respecto al subgrupo control.

Se generan **modelos anova** para cada una de las dispersiones. 

```{r ATRavg21.0.28}
summary(aov(dispersionDifIron$distances~LATR_avg_demo$Subgroup))
summary(aov(dispersionDifIron_WoOut$distances~LATR_avg_demo_WoOut$Subgroup))

summary(aov(dispersionADMDRD$distances~LATR_avg_demo_ADRDMD$Subgroup))
summary(aov(dispersionADMDRD_WoOut$distances~LATR_avg_demo_WoOut_ADRDMD$Subgroup))

summary(aov(dispersionIronFA$distances~LATR_avg_demo_IronFA$Subgroup))
summary(aov(dispersionIronFA_WoOut$distances~LATR_avg_demo_WoOut_IronFA$Subgroup))
```

Ningua de las dispersiones presentan significación estadística, con lo que las diferencias observadas en PERMANOVA son debidas a diferencias en el posicionamiento de los centroides. 

```{r ATRavg21.0.28.1, echo=FALSE, eval=FALSE}
  # Resumen de los modelos ANOVA
LATRaovDispSG<-rbind(summary(aov(dispersionDifIron$distances~LATR_avg_demo$Subgroup))[[1]],
                     summary(aov(dispersionDifIron_WoOut$distances~LATR_avg_demo_WoOut$Subgroup))[[1]],
                     summary(aov(dispersionADMDRD$distances~LATR_avg_demo_ADRDMD$Subgroup))[[1]],
                     summary(aov(dispersionADMDRD_WoOut$distances~LATR_avg_demo_WoOut_ADRDMD$Subgroup))[[1]],
                     summary(aov(dispersionIronFA$distances~LATR_avg_demo_IronFA$Subgroup))[[1]],
                     summary(aov(dispersionIronFA_WoOut$distances~LATR_avg_demo_WoOut_IronFA$Subgroup))[[1]])
kable(LATRaovDispSG, caption='ANOVAs for dispersion distances of the Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('5-metric model with complete dataframe'=2,'5-metric model with reduced dataframe'=2,
                    '3-metric model with complete dataframe'=2,'3-metric model with reduced dataframe'=2,
                    '2-metric model with complete dataframe'=2,'2-metric model with reduced dataframe'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### Comparaciones por pares

Se procede a generar las **comparaciones por pares** de los modelos PERMANOVA que han obtenido significación estadística para subgrupo y cuyas dispersiones no hayan resultado estadísticamente significativas. Por tanto, se van a realizar las comparaciones de los siguientes PERMANOVA: `permADMDRD_log2` y `permADMDRD_WO_log2` (PERMANOVA de las transformaciones logarítmicas de las 3 métricas de difusividad del ATR derecho con el dataframe completo y reducido, respectivamente), y, `permADMDRD3` y `permADMDRD3_WoOut` (PERMANOVA de las 3 métricas de difusividad del ATR izquierdo con el dataframe completo y reducido, respectivamente).

Para la comparación por pares, se utiliza la función `pairwise.adonis2` del paquete `pairwiseAdonis`. Esta función admite los mismos argumentos que la función `adonis2`. En la comparación por pares, tan sólo se ha puesto como variable independiente el subgrupo, dado que el resto de factores no han sido significativos en los PERMANOVA. 

Para el **ATR derecho**, se generan las comparaciones por pares para las transformaciones logarítmicas de las 3 métricas de difusividad, tanto con el dataframe completo (sin eliminación de outliers) como con el dataframe con eliminación de outliers.

```{r ATRavg21.0.29}
# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

# Matriz de distancias para las 3 métricas de difusividad (AD, RD, MD)
distADMDRD_log<-vegdist(RATR_avg_demo_ADRDMD_log[,c('rhatr_AD','rhatr_MD','rhatr_RD')],
                        method='euclidean')
distADMDRD_WO_log<-vegdist(RATR_avg_demo_ADRDMD_WO_log[,c('rhatr_AD','rhatr_MD','rhatr_RD')],
                           method='euclidean')

#Test a posteriori
library(devtools)
install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", force=TRUE)
library(pairwiseAdonis)
pairwise_permanova_RATR_ADMDRD_log<-pairwiseAdonis::pairwise.adonis2(distADMDRD_log~
                                                                       Subgroup,
                                                                     data=RATR_avg_demo_ADRDMD_log,
                                                                     permutations=999, by='terms')
pairwise_permanova_RATR_ADMDRD_WO_log<-pairwiseAdonis::pairwise.adonis2(distADMDRD_WO_log~
                                                                          Subgroup,
                                                                        data=RATR_avg_demo_ADRDMD_WO_log,
                                                                        permutations=999, by='terms')
```

```{r ATRavg21.0.30.1}
pairwise_permanova_RATR_ADMDRD_log
pairwise_permanova_RATR_ADMDRD_WO_log
```

```{r ATRavg21.0.30.2, echo=FALSE, eval=FALSE}
#Pairwise permanova for Right ATR with log-transform 3 diffusivity metrics for the complete dataframe
PWP_3LogDifC<-rbind(pairwise_permanova_RATR_ADMDRD_log[[2]],pairwise_permanova_RATR_ADMDRD_log[[3]],pairwise_permanova_RATR_ADMDRD_log[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_3LogDifC<-cbind(Variable,PWP_3LogDifC)
rownames(PWP_3LogDifC)<-NULL
colnames(PWP_3LogDifC)<-c('',colnames(PWP_3LogDifC)[-1])
kable(PWP_3LogDifC,caption='Pairwise permanova with 3-log-transform-metric for the complete dataframe of the Right ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

#Pairwise permanova for Right ATR with log-transform 3 diffusivity metrics for the reduced dataframe
PWP_3LogDifR<-rbind(pairwise_permanova_RATR_ADMDRD_WO_log[[2]],pairwise_permanova_RATR_ADMDRD_WO_log[[3]],pairwise_permanova_RATR_ADMDRD_WO_log[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_3LogDifR<-cbind(Variable,PWP_3LogDifR)
rownames(PWP_3LogDifR)<-NULL
colnames(PWP_3LogDifR)<-c('',colnames(PWP_3LogDifR)[-1])
kable(PWP_3LogDifR,caption='Pairwise permanova with 3-log-transform-metric for the reduced dataframe of the Right ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las comparaciones por pares ponen de relieve que **las diferencias significativas entre subgrupos en cuanto a las métricas AD-RD-MD se hallan entre HD vs controles y entre HD vs preHD** para ambos dataframes (con y sin eliminación de outliers), con valores de difusividad mayores para los pacientes HD sintomáticos. 

Para el **ATR izquierdo**, se generan las comparaciones por pares para las 5 métricas conjuntas, para las 3 métricas de difusividad, y, para las métricas Iron-FA.

```{r ATRavg21.0.31}
# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

# Matriz de distancias para las 5 métricas
distDifIron<-vegdist(LATR_avg_demo[,-c(1:7)],method='euclidean')
distDifIron_WoOut<-vegdist(LATR_avg_demo_WoOut[,-c(1:7)],method='euclidean')

# Matriz de distancias para las 3 métricas de difusividad (AD, RD, MD)
distADMDRD<-vegdist(LATR_avg_demo_ADRDMD[,c('lhatr_AD','lhatr_RD','lhatr_MD')],
                    method='euclidean')
distADMDRD_WoOut<-vegdist(LATR_avg_demo_WoOut_ADRDMD[,c('lhatr_AD','lhatr_RD',
                                                        'lhatr_MD')],
                          method='euclidean')

# Matriz de distancias para las métricas de Iron y FA
distIronFA<-vegdist(LATR_avg_demo_IronFA[,c('lhatr_Iron','lhatr_FA')],
                    method='euclidean')
distIronFA_WoOut<-vegdist(LATR_avg_demo_WoOut_IronFA[,c('lhatr_Iron','lhatr_FA')],
                          method='euclidean')

#Test a posteriori para DifIron
pairwise_permanova_LATR_DifIron<-pairwiseAdonis::pairwise.adonis2(distDifIron~Subgroup, 
                                                                  data=LATR_avg_demo, 
                                                                  permutations=999, 
                                                                  by='terms')
pairwise_permanova_LATR_DifIron_WoOut<-pairwiseAdonis::pairwise.adonis2(distDifIron_WoOut~
                                                                          Subgroup, 
                                                                        data=LATR_avg_demo_WoOut, 
                                                                        permutations=999, 
                                                                        by='terms')

#Test a posteriori para AD-MD-RD
pairwise_permanova_LATR_ADMDRD<-pairwiseAdonis::pairwise.adonis2(distADMDRD~Subgroup, 
                                                                 data=LATR_avg_demo_ADRDMD, 
                                                                 permutations=999, 
                                                                 by='terms')
pairwise_permanova_LATR_ADMDRD_WoOut<-pairwiseAdonis::pairwise.adonis2(distADMDRD_WoOut~
                                                                         Subgroup, 
                                                                       data=LATR_avg_demo_WoOut_ADRDMD, 
                                                                       permutations=999, 
                                                                       by='terms')

#Test a posteriori para Iron-FA
pairwise_permanova_LATR_IronFA<-pairwiseAdonis::pairwise.adonis2(distIronFA~Subgroup, 
                                                                 data=LATR_avg_demo_IronFA, 
                                                                 permutations=999, 
                                                                 by='terms')
pairwise_permanova_LATR_IronFA_WoOut<-pairwiseAdonis::pairwise.adonis2(distIronFA_WoOut~
                                                                         Subgroup, 
                                                                       data=LATR_avg_demo_WoOut_IronFA, 
                                                                       permutations=999, 
                                                                       by='terms')
```

```{r ATRavg21.0.32.1}
pairwise_permanova_LATR_DifIron
pairwise_permanova_LATR_DifIron_WoOut
```

```{r ATRavg21.0.32.2, echo=FALSE, eval=FALSE}
#Pairwise permanova with 5-metric for the complete dataframe of the Left ATR
PWP_5C<-rbind(pairwise_permanova_LATR_DifIron[[2]],pairwise_permanova_LATR_DifIron[[3]],pairwise_permanova_LATR_DifIron[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_5C<-cbind(Variable,PWP_5C)
rownames(PWP_5C)<-NULL
colnames(PWP_5C)<-c('',colnames(PWP_5C)[-1])
kable(PWP_5C,caption='Pairwise permanova with 5-metric for the complete dataframe of the Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

#Pairwise permanova with 5-metric for the reduced dataframe of the Left ATR
PWP_5R<-rbind(pairwise_permanova_LATR_DifIron_WoOut[[2]],pairwise_permanova_LATR_DifIron_WoOut[[3]],pairwise_permanova_LATR_DifIron_WoOut[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_5R<-cbind(Variable,PWP_5R)
rownames(PWP_5R)<-NULL
colnames(PWP_5R)<-c('',colnames(PWP_5R)[-1])
kable(PWP_5R,caption='Pairwise permanova with 5-metric for the reduced dataframe of the Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las comparaciones por pares ponen de relieve que **las diferencias significativas entre subgrupos en cuanto a las 5 métricas analizadas conjuntamente** se hallan entre **preHD vs controles** para ambos dataframes (con y sin eliminación de outliers).  

```{r ATRavg21.0.33.1}
pairwise_permanova_LATR_ADMDRD
pairwise_permanova_LATR_ADMDRD_WoOut
```

```{r ATRavg21.0.33.2, echo=FALSE, eval=FALSE}
#Pairwise permanova with 3-metric for the complete dataframe of the Left ATR
PWP_3C<-rbind(pairwise_permanova_LATR_ADMDRD[[2]],pairwise_permanova_LATR_ADMDRD[[3]],pairwise_permanova_LATR_ADMDRD[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_3C<-cbind(Variable,PWP_3C)
rownames(PWP_3C)<-NULL
colnames(PWP_3C)<-c('',colnames(PWP_3C)[-1])
kable(PWP_3C,caption='Pairwise permanova with 3-metric for the complete dataframe of the Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

#Pairwise permanova with 3-metric for the reduced dataframe of the Left ATR
PWP_3R<-rbind(pairwise_permanova_LATR_ADMDRD_WoOut[[2]],pairwise_permanova_LATR_ADMDRD_WoOut[[3]],pairwise_permanova_LATR_ADMDRD_WoOut[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_3R<-cbind(Variable,PWP_3R)
rownames(PWP_3R)<-NULL
colnames(PWP_3R)<-c('',colnames(PWP_3R)[-1])
kable(PWP_3R,caption='Pairwise permanova with 3-metric for the reduced dataframe of the Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Al igual que en el ATR derecho, las comparaciones por pares ponen de relieve que **las diferencias significativas entre subgrupos en cuanto a las métricas AD-RD-MD se hallan entre HD vs controles y entre HD vs preHD** para ambos dataframes (con y sin eliminación de outliers), con valores de difusividad mayores para los pacientes HD sintomáticos. 

```{r ATRavg21.0.34.1}
pairwise_permanova_LATR_IronFA
pairwise_permanova_LATR_IronFA_WoOut
```

```{r ATRavg21.0.34.2, echo=FALSE, eval=FALSE}
#Pairwise permanova with 2-metric for the complete dataframe of the Left ATR
PWP_2C<-rbind(pairwise_permanova_LATR_IronFA[[2]],pairwise_permanova_LATR_IronFA[[3]],pairwise_permanova_LATR_IronFA[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_2C<-cbind(Variable,PWP_2C)
rownames(PWP_2C)<-NULL
colnames(PWP_2C)<-c('',colnames(PWP_2C)[-1])
kable(PWP_2C,caption='Pairwise permanova with 2-metric for the complete dataframe of the Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

#Pairwise permanova with 2-metric for the reduced dataframe of the Left ATR
PWP_2R<-rbind(pairwise_permanova_LATR_IronFA_WoOut[[2]],pairwise_permanova_LATR_IronFA_WoOut[[3]],pairwise_permanova_LATR_IronFA_WoOut[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_2R<-cbind(Variable,PWP_2R)
rownames(PWP_2R)<-NULL
colnames(PWP_2R)<-c('',colnames(PWP_2R)[-1])
kable(PWP_2R,caption='Pairwise permanova with 2-metric for the reduced dataframe of the Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las comparaciones por pares para ambos dataframes (con y sin eliminación de outliers) ponen de relieve que **las diferencias significativas entre subgrupos en cuanto a las métricas Iron-FA se hallan entre preHD vs controles**, y, las diferencias son casi significativas con p-valores inferiores a 0.10 entre preHD y HD.

\newpage

## ANOVA

El **ANOVA (ANalysis Of VAriance)** se realiza para determinar qué métricas (individuales) de RM difieren entre subgrupos (variable independiente de interés), controlando por género y edad factorizada (covariables). Por tanto, se generan 5 **anovas**, uno para cada métrica de RM (iron, ad, rd, md, fa), en los que: 

- Las métricas de RM son las variables dependientes; 
- El subgrupo es la variable independiente de interés; y
- El género y la edad factorizada son las covariables a controlar.

Se generan los modelos con la **función `aov`** del paquete `stats`. Se procede a ejecutar **dos comprobaciones sobre los residuos** (siendo el residuo de cada observación la diferencia entre la observación real y la media del grupo al que pertenece):

- Residuos presetan una **distribución normal**? Esto se comprueba mediante gráficos qqplot (la normalidad de los residuos se valora en función de la proximdidad de éstos a la línea diagonal) y mediante el **test estadístico Shapiro-Wilk**. 
- Residuos presentan **homocedasticidad**? Esto se comprueba mediante plots *fitted_values vs Residuals* y mediante el **test de Breusch-Pagan**, el cual genera una regresión de los residuos sobre los valores predichos para determinar si ésta explica la varianza residual (valores de p menores de 0.05 indican heterocedasticidad).

En este caso, métrica por métrica, se determinan qué sujetos son posibles sujetos outliers/influyentes, y, en función del cumplimiento o no de los supuestos de ANOVA, se decide la eliminación o no de los posibles sujetos outliers/influyentes.

### IRON - RATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_RATRavg_iron`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg21.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_RATRavg_iron<-aov(rhatr_Iron~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_RATRavg_iron)
plot(anova1_RATRavg_iron, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_RATRavg_iron))
plot(anova1_RATRavg_iron, which=1, cex.lab=0.8, cex.sub=0.8)
library(lmtest)
bptest(anova1_RATRavg_iron)
```

En este modelo, ningún factor o interacción es significativo; además, se evidencia que los residuos no presentan una distribución normal, pero sí una homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 18, 47 y 51.

Se genera un **segundo modelo** `anova2_RATRavg_iron` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg21.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_RATRavg_iron<-aov(rhatr_Iron~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_RATRavg_iron)
plot(anova2_RATRavg_iron, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_RATRavg_iron))
plot(anova2_RATRavg_iron, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_RATRavg_iron)
```

En este modelo, ningún factor es significativo; además, se evidencia que los residuos no presentan una distribución normal, pero sí una homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 18, 47 y 51.

```{r ATRavg21.3, echo=FALSE}
kable(list(summary(anova1_RATRavg_iron)[[1]],summary(anova2_RATRavg_iron)[[1]]),
      caption='ANOVA Models for Iron of the Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### IRON - LATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_LATRavg_iron`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg22.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_LATRavg_iron<-aov(lhatr_Iron~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_LATRavg_iron)
plot(anova1_LATRavg_iron, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_LATRavg_iron))
plot(anova1_LATRavg_iron, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_LATRavg_iron)
```

En este modelo, ningún factor o interacción es significativo; además, se evidencia que los residuos presentan una distribución normal y heterocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 1, 18 y 52.

Se genera un **segundo modelo** `anova2_LATRavg_iron` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg22.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_LATRavg_iron<-aov(lhatr_Iron~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_LATRavg_iron)
plot(anova2_LATRavg_iron, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_LATRavg_iron))
plot(anova2_LATRavg_iron, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_LATRavg_iron)
```

En este modelo, ningún factor es significativo y los residuos presentan una distribución normal y una homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 18, 29 y 41.

```{r ATRavg22.3, echo=FALSE}
kable(list(summary(anova1_LATRavg_iron)[[1]],summary(anova2_LATRavg_iron)[[1]]),
      caption='ANOVA Models for Iron of the Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### AD - RATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_RATRavg_ad`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg23.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_RATRavg_ad<-aov(rhatr_AD~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_RATRavg_ad)
plot(anova1_RATRavg_ad, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_RATRavg_ad))
plot(anova1_RATRavg_ad, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_RATRavg_ad)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 51, 52 y 55.

Se genera un **segundo modelo** `anova2_RATRavg_ad` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg23.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_RATRavg_ad<-aov(rhatr_AD~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_RATRavg_ad)
plot(anova2_RATRavg_ad, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_RATRavg_ad))
plot(anova2_RATRavg_ad, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_RATRavg_ad)
```

En este modelo, la variable subgrupo es significativa, los residuos presentan una distribución normal y homocedasticidad de varianzas, y los posibles sujetos outliers e influyentes son los individuos con índices 13, 51 y 52.

```{r ATRavg23.3, echo=FALSE}
kable(list(summary(anova1_RATRavg_ad)[[1]],summary(anova2_RATRavg_ad)[[1]]),
      caption='ANOVA Models for AD of the Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### AD - LATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_LATRavg_ad`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg24.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_LATRavg_ad<-aov(lhatr_AD~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_LATRavg_ad)
plot(anova1_LATRavg_ad, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_LATRavg_ad))
plot(anova1_LATRavg_ad, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_LATRavg_ad)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers son los individuos con índices 3, 19 y 30 y los posibles sujetos influyentes son los individuos con índices 3, 19 y 52.

Se genera un **segundo modelo** `anova2_LATRavg_ad` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg24.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_LATRavg_ad<-aov(lhatr_AD~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_LATRavg_ad)
plot(anova2_LATRavg_ad, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_LATRavg_ad))
plot(anova2_LATRavg_ad, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_LATRavg_ad)
```

En este modelo, la variable subgrupo es significativa, los residuos presentan una distribución normal y homocedasticidad de varianzas, y los posibles sujetos outliers e influyentes son los individuos con índices 16, 19 y 32.

```{r ATRavg24.3, echo=FALSE}
kable(list(summary(anova1_LATRavg_ad)[[1]],summary(anova2_LATRavg_ad)[[1]]),
      caption='ANOVA Models for AD of the Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### MD - RATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_RATRavg_md`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg25.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_RATRavg_md<-aov(rhatr_MD~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_RATRavg_md)
plot(anova1_RATRavg_md, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_RATRavg_md))
plot(anova1_RATRavg_md, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_RATRavg_md)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y heterocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 31, 52 y 55.

Se genera un **segundo modelo** `anova2_RATRavg_md` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg25.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_RATRavg_md<-aov(rhatr_MD~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_RATRavg_md)
plot(anova2_RATRavg_md, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_RATRavg_md))
plot(anova2_RATRavg_md, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_RATRavg_md)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 25, 34 y 52.

```{r ATRavg25.3, echo=FALSE}
kable(list(summary(anova1_RATRavg_md)[[1]],summary(anova2_RATRavg_md)[[1]]),
      caption='ANOVA Models for MD of the Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### MD - LATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_LATRavg_md`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg26.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_LATRavg_md<-aov(lhatr_MD~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_LATRavg_md)
plot(anova1_LATRavg_md, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_LATRavg_md))
plot(anova1_LATRavg_md, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_LATRavg_md)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y heterocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 19, 52 y 55.

Se genera un **segundo modelo** `anova2_LATRavg_md` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg26.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_LATRavg_md<-aov(lhatr_MD~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_LATRavg_md)
plot(anova2_LATRavg_md, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_LATRavg_md))
plot(anova2_LATRavg_md, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_LATRavg_md)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 19, 52 y 55.

```{r ATRavg26.3, echo=FALSE}
kable(list(summary(anova1_LATRavg_md)[[1]],summary(anova2_LATRavg_md)[[1]]),
      caption='ANOVA Models for MD of the Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### RD - RATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_RATRavg_rd`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg27.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_RATRavg_rd<-aov(rhatr_RD~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_RATRavg_rd)
plot(anova1_RATRavg_rd, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_RATRavg_rd))
plot(anova1_RATRavg_rd, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_RATRavg_rd)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y heterocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 25, 43 y 52.

Se genera un **segundo modelo** `anova2_RATRavg_rd` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg27.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_RATRavg_rd<-aov(rhatr_RD~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_RATRavg_rd)
plot(anova2_RATRavg_rd, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_RATRavg_rd))
plot(anova2_RATRavg_rd, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_RATRavg_rd)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 25, 34 y 52.

```{r ATRavg27.3, echo=FALSE}
kable(list(summary(anova1_RATRavg_rd)[[1]],summary(anova2_RATRavg_rd)[[1]]),
      caption='ANOVA Models for RD of the Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### RD - LATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_LATRavg_rd`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg28.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_LATRavg_rd<-aov(lhatr_RD~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_LATRavg_rd)
plot(anova1_LATRavg_rd, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_LATRavg_rd))
plot(anova1_LATRavg_rd, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_LATRavg_rd)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y heterocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 19, 52 y 55.

Se genera un **segundo modelo** `anova2_LATRavg_rd` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg28.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_LATRavg_rd<-aov(lhatr_RD~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_LATRavg_rd)
plot(anova2_LATRavg_rd, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_LATRavg_rd))
plot(anova2_LATRavg_rd, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_LATRavg_rd)
```

En este modelo, la variable subgrupo es significativa y los residuos presentan una distribución normal y heterocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 19, 52 y 55.

```{r ATRavg28.3, echo=FALSE}
kable(list(summary(anova1_LATRavg_rd)[[1]],summary(anova2_LATRavg_rd)[[1]]),
      caption='ANOVA Models for RD of the Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### FA - RATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_RATRavg_fa`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg29.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_RATRavg_fa<-aov(rhatr_FA~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_RATRavg_fa)
plot(anova1_RATRavg_fa, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_RATRavg_fa))
plot(anova1_RATRavg_fa, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_RATRavg_fa)
```

En este modelo, ningún factor o interacción es significativo y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers son los individuos con índices 25, 34 y 48, y, los posibles sujetos influyentes son los individuos con índices 19, 25 y 48.

Se genera un **segundo modelo** `anova2_RATRavg_fa` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg29.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_RATRavg_fa<-aov(rhatr_FA~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_RATRavg_fa)
plot(anova2_RATRavg_fa, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_RATRavg_fa))
plot(anova2_RATRavg_fa, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_RATRavg_fa)
```

En este modelo, ningún factor es significativo y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con índices 19, 25 y 34.

```{r ATRavg29.3, echo=FALSE}
kable(list(summary(anova1_RATRavg_fa)[[1]],summary(anova2_RATRavg_fa)[[1]]),
      caption='ANOVA Models for FA of the Right ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### FA - LATR

Se procede a generar los modelos ANOVA. En el **primer modelo** generado `anova1_LATRavg_fa`, se introducen las **3 variables independientes con interacción**. 

```{r ATRavg30.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_LATRavg_fa<-aov(lhatr_FA~Subgroup*agef2*Gender, data=ATR_avg_demo)
summary(anova1_LATRavg_fa)
plot(anova1_LATRavg_fa, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova1_LATRavg_fa))
plot(anova1_LATRavg_fa, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova1_LATRavg_fa)
```

En este modelo, ningún factor o interacción es significativo y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers son los individuos con índices 32, 34 y 35, y, los sujetos influyentes los individuos con índices 10, 25 y 55.

Se genera un **segundo modelo** `anova2_LATRavg_fa` con las **3 variables independientes sin interacción** dado que las interacciones no han sido significativas.

```{r ATRavg30.2, fig.width=4, fig.height=3, fig.align='center'}
anova2_LATRavg_fa<-aov(lhatr_FA~Subgroup+agef2+Gender, data=ATR_avg_demo)
summary(anova2_LATRavg_fa)
plot(anova2_LATRavg_fa, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova2_LATRavg_fa))
plot(anova2_LATRavg_fa, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova2_LATRavg_fa)
```

En este modelo, ningún factor es significativo y los residuos presentan una distribución normal y homocedasticidad de varianzas. Los posibles sujetos outliers son los individuos con índices 16, 32 y 34, y, los posibles sujetos influyentes son los individuos con índices 16, 25 y 32.

```{r ATRavg30.3, echo=FALSE}
kable(list(summary(anova1_LATRavg_fa)[[1]],summary(anova2_LATRavg_fa)[[1]]),
      caption='ANOVA Models for FA of the Left ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**En resumen, los modelos anova de interés están formados por las variables independientes sin interacción.** 

Se presenta una **tabla resumen** para objetivar la significancia o no de la variable subgrupo, de la normalidad y homocedasticidad/heterocedasticidad de los residuos. 

```{r ATRavg31, error=TRUE, echo=FALSE}
Fsubgrupo<-rbind(round(summary(anova2_RATRavg_iron)[[1]][1,4],3),
                 round(summary(anova2_LATRavg_iron)[[1]][1,4],3),
                 round(summary(anova2_RATRavg_ad)[[1]][1,4],3),
                 round(summary(anova2_LATRavg_ad)[[1]][1,4],3),
                 round(summary(anova2_RATRavg_md)[[1]][1,4],3),
                 round(summary(anova2_LATRavg_md)[[1]][1,4],3),
                 round(summary(anova2_RATRavg_rd)[[1]][1,4],3),
                 round(summary(anova2_LATRavg_rd)[[1]][1,4],3),
                 round(summary(anova2_RATRavg_fa)[[1]][1,4],3),
                 round(summary(anova2_LATRavg_fa)[[1]][1,4],3))
         
pSubgrupo<-rbind(round(summary(anova2_RATRavg_iron)[[1]][1,5],3),
                 round(summary(anova2_LATRavg_iron)[[1]][1,5],3),
                 round(summary(anova2_RATRavg_ad)[[1]][1,5],3),
                 round(summary(anova2_LATRavg_ad)[[1]][1,5],3),
                 round(summary(anova2_RATRavg_md)[[1]][1,5],3),
                 round(summary(anova2_LATRavg_md)[[1]][1,5],3),
                 round(summary(anova2_RATRavg_rd)[[1]][1,5],3),
                 round(summary(anova2_LATRavg_rd)[[1]][1,5],3),
                 round(summary(anova2_RATRavg_fa)[[1]][1,5],3),
                 round(summary(anova2_LATRavg_fa)[[1]][1,5],3))

wShapiro<-rbind(round(shapiro.test(residuals(anova2_RATRavg_iron))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_LATRavg_iron))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_RATRavg_ad))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_LATRavg_ad))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_RATRavg_md))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_LATRavg_md))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_RATRavg_rd))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_LATRavg_rd))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_RATRavg_fa))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_LATRavg_fa))[[1]][[1]],3))

pShapiro<-rbind(round(shapiro.test(residuals(anova2_RATRavg_iron))[[2]],3),
                round(shapiro.test(residuals(anova2_LATRavg_iron))[[2]],3),
                round(shapiro.test(residuals(anova2_RATRavg_ad))[[2]],3),
                round(shapiro.test(residuals(anova2_LATRavg_ad))[[2]],3),
                round(shapiro.test(residuals(anova2_RATRavg_md))[[2]],3),
                round(shapiro.test(residuals(anova2_LATRavg_md))[[2]],3),
                round(shapiro.test(residuals(anova2_RATRavg_rd))[[2]],3),
                round(shapiro.test(residuals(anova2_LATRavg_rd))[[2]],3),
                round(shapiro.test(residuals(anova2_RATRavg_fa))[[2]],3),
                round(shapiro.test(residuals(anova2_LATRavg_fa))[[2]],3))

BPBptest<-rbind(round(bptest(anova2_RATRavg_iron)[[1]][[1]],3),
                round(bptest(anova2_LATRavg_iron)[[1]][[1]],3),
                round(bptest(anova2_RATRavg_ad)[[1]][[1]],3),
                round(bptest(anova2_LATRavg_ad)[[1]][[1]],3),
                round(bptest(anova2_RATRavg_md)[[1]][[1]],3),
                round(bptest(anova2_LATRavg_md)[[1]][[1]],3),
                round(bptest(anova2_RATRavg_rd)[[1]][[1]],3),
                round(bptest(anova2_LATRavg_rd)[[1]][[1]],3),
                round(bptest(anova2_RATRavg_fa)[[1]][[1]],3),
                round(bptest(anova2_LATRavg_fa)[[1]][[1]],3))

dfBptest<-rbind(round(bptest(anova2_RATRavg_iron)[[2]][[1]],3),
                round(bptest(anova2_LATRavg_iron)[[2]][[1]],3),
                round(bptest(anova2_RATRavg_ad)[[2]][[1]],3),
                round(bptest(anova2_LATRavg_ad)[[2]][[1]],3),
                round(bptest(anova2_RATRavg_md)[[2]][[1]],3),
                round(bptest(anova2_LATRavg_md)[[2]][[1]],3),
                round(bptest(anova2_RATRavg_rd)[[2]][[1]],3),
                round(bptest(anova2_LATRavg_rd)[[2]][[1]],3),
                round(bptest(anova2_RATRavg_fa)[[2]][[1]],3),
                round(bptest(anova2_LATRavg_fa)[[2]][[1]],3))

pBptest<-rbind(round(bptest(anova2_RATRavg_iron)[[4]][[1]],3),
               round(bptest(anova2_LATRavg_iron)[[4]][[1]],3),
               round(bptest(anova2_RATRavg_ad)[[4]][[1]],3),
               round(bptest(anova2_LATRavg_ad)[[4]][[1]],3),
               round(bptest(anova2_RATRavg_md)[[4]][[1]],3),
               round(bptest(anova2_LATRavg_md)[[4]][[1]],3),
               round(bptest(anova2_RATRavg_rd)[[4]][[1]],3),
               round(bptest(anova2_LATRavg_rd)[[4]][[1]],3),
               round(bptest(anova2_RATRavg_fa)[[4]][[1]],3),
               round(bptest(anova2_LATRavg_fa)[[4]][[1]],3))

ATR<-rep(c('RATR','LATR'),5)
Df_aov_avg<-cbind(ATR,Fsubgrupo,pSubgrupo,wShapiro,pShapiro,BPBptest,dfBptest,pBptest)
Df_aov_avg<-as.data.frame(Df_aov_avg)
colnames(Df_aov_avg)<-c('ATR-Metrics', 'F', 'p-value', 'W statistic', 'p-value', 
                        'BP statistic', 'df', 'p-value')

library(kableExtra)
kableExtra::kable(Df_aov_avg, caption = 'Modelos Anova para valores Average', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Subgroup' = 2, 'Normality' = 2, 'Homoscedasticity'=3)) %>%
  pack_rows(index=c('Iron'=2, 'AD'=2, 'MD'=2, 'RD'=2, 'FA'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Como se observa en la tabla: 

- La variable *rhatr_iron* no tiene normalidad; 
- La variable *lhatr_rd* no tiene homocedasticidad.

### Eliminación de outliers - Nuevos ANOVAS

Se procede a la eliminación de outliers en dichas variables para poder generar nuevos modelos anova y así determinar si se cumplen los criterios requeridos por ANOVA. 

A continuación, para la variable  **_rhatr-iron_**: primero, se procede a la **eliminación de outliers**.

```{r ATRavg32.1}
# Extracción de outlier considerando todos los sujetos de la muestra en conjunto
ATR_avg_demo_out<-ATR_avg_demo
resumen<-data.frame()
resumen<-ATR_avg_demo_out |>
  dplyr::summarize(across(rhatr_Iron,list(iqr= ~ IQR(.), q1= ~quantile(.,probs = .25),
                                          q3= ~quantile(.,probs = .75))))

index<-which(ATR_avg_demo_out$rhatr_Iron<(resumen[[2]]-1.5*resumen[[1]]) |
             ATR_avg_demo_out$rhatr_Iron>(resumen[[3]]+1.5*resumen[[1]]))
index

ATR_avg_demo_out$rhatr_Iron<-replace(ATR_avg_demo_out$rhatr_Iron, index, NA)

# Normalidad y homocedasticidad entre subgrupos, géneros y edad factorizada
stats::shapiro.test(ATR_avg_demo_out$rhatr_Iron)
fligner.test(rhatr_Iron~Subgroup, data=ATR_avg_demo_out)
fligner.test(rhatr_Iron~agef, data=ATR_avg_demo_out)
fligner.test(rhatr_Iron~agef2, data=ATR_avg_demo_out)
fligner.test(rhatr_Iron~Gender, data=ATR_avg_demo_out)
```

Con la eliminación del outlier, los valores de la variable *rhatr_iron* presentan una distribución normal y homocedasticidad de varianzas entre los niveles de las variables categóricas de interés (subgrupo, edad_factorizada, género).

Se generan nuevamente los modelos anova, el **primer modelo** `anova3_RATRavg_iron` con las **3 variables independientes en interacción** y el **segundo modelo** `anova4_RATRavg_iron` con las **3 variables independientes sin interacción**.

```{r ATRavg32.2, fig.width=4, fig.height=3, fig.align='center'}
anova3_RATRavg_iron<-aov(rhatr_Iron~Subgroup*agef2*Gender, data=ATR_avg_demo_out)
summary(anova3_RATRavg_iron)

anova4_RATRavg_iron<-aov(rhatr_Iron~Subgroup+agef2+Gender, data=ATR_avg_demo_out)
summary(anova4_RATRavg_iron)
plot(anova4_RATRavg_iron, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova4_RATRavg_iron))
plot(anova4_RATRavg_iron, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova4_RATRavg_iron)
```

Como el modelo anova con interacción no presenta ningún factor o interacción significativo, se genera el modelo sin interacción y éste tampoco muestra ningún factor significativo, pero los residuos siguen una distribución normal con homocedasticidad de varianzas. 

```{r ATRavg32.3, echo=FALSE}
kable(list(summary(anova3_RATRavg_iron)[[1]],summary(anova4_RATRavg_iron)[[1]]),
      caption='New ANOVA Models for Iron of the Right ATR after elimination of outlier (index 51)', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

A continuación, para la variable  **_lhatr-rd_**: primero, se procede a la **eliminación de outliers**.

```{r ATRavg33.1}
# Extracción de outlier considerando todos los sujetos de la muestra en conjunto
ATR_avg_demo_out<-ATR_avg_demo
resumen<-data.frame()
resumen<-ATR_avg_demo_out |>
  dplyr::summarize(across(lhatr_RD,list(iqr= ~ IQR(.), q1= ~quantile(.,probs = .25),
                                        q3= ~quantile(.,probs = .75))))

index<-which(ATR_avg_demo_out$lhatr_RD<(resumen[[2]]-1.5*resumen[[1]]) |
             ATR_avg_demo_out$lhatr_RD>(resumen[[3]]+1.5*resumen[[1]]))
index

ATR_avg_demo_out$lhatr_RD<-replace(ATR_avg_demo_out$lhatr_RD, index, NA)

# Normalidad y homocedasticidad entre subgrupos, géneros y edad factorizada
stats::shapiro.test(ATR_avg_demo_out$lhatr_RD)
fligner.test(lhatr_RD~Subgroup, data=ATR_avg_demo_out)
fligner.test(lhatr_RD~agef, data=ATR_avg_demo_out)
fligner.test(lhatr_RD~agef2, data=ATR_avg_demo_out)
fligner.test(lhatr_RD~Gender, data=ATR_avg_demo_out)
```

Con la eliminación del outlier, los valores de la variable *lhatr_rd* presentan una distribución normal y homocedasticidad de varianzas para subgrupo y edad factorizada pero no para género.

Se generan nuevamente los modelos anova, el **primer modelo** `anova3_LATRavg_rd` con las **3 variables independientes en interacción** y el **segundo modelo** `anova4_LATRavg_rd` con las **3 variables independientes sin interacción**.

```{r ATRavg33.2, fig.width=4, fig.height=3, fig.align='center'}
anova3_LATRavg_rd<-aov(lhatr_RD~Subgroup*agef2*Gender, data=ATR_avg_demo_out)
summary(anova3_LATRavg_rd)

anova4_LATRavg_rd<-aov(lhatr_RD~Subgroup+agef2+Gender, data=ATR_avg_demo_out)
summary(anova4_LATRavg_rd)
plot(anova4_LATRavg_rd, which=2, cex.lab=0.8, cex.sub=0.8)
shapiro.test(residuals(anova4_LATRavg_rd))
plot(anova4_LATRavg_rd, which=1, cex.lab=0.8, cex.sub=0.8)
bptest(anova4_LATRavg_rd)
```

Como el modelo con interacción no presenta ninguna interacción significativa, se genera el modelo sin interacción y éste muestra el subgrupo como variable significativa y los residuos del modelo siguen una distribución normal con homocedasticidad de varianzas. 

```{r ATRavg33.3, echo=FALSE}
kable(list(summary(anova3_LATRavg_rd)[[1]],summary(anova4_LATRavg_rd)[[1]]),
      caption='New ANOVA Models for Radial Diffusivity of the Left ATR after elimination of outlier (index 34)', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg33.4, error=TRUE, echo=FALSE}
Fsubgrupo<-rbind(round(summary(anova4_RATRavg_iron)[[1]][1,4],3),
                 round(summary(anova4_LATRavg_rd)[[1]][1,4],3))
         
pSubgrupo<-rbind(round(summary(anova4_RATRavg_iron)[[1]][1,5],3),
                 round(summary(anova4_LATRavg_rd)[[1]][1,5],3))

wShapiro<-rbind(round(shapiro.test(residuals(anova4_RATRavg_iron))[[1]][[1]],3),
                round(shapiro.test(residuals(anova4_LATRavg_rd))[[1]][[1]],3))

pShapiro<-rbind(round(shapiro.test(residuals(anova4_RATRavg_iron))[[2]],3),
                round(shapiro.test(residuals(anova4_LATRavg_rd))[[2]],3))

BPBptest<-rbind(round(bptest(anova4_RATRavg_iron)[[1]][[1]],3),
                round(bptest(anova4_LATRavg_rd)[[1]][[1]],3))

dfBptest<-rbind(round(bptest(anova4_RATRavg_iron)[[2]][[1]],3),
                round(bptest(anova4_LATRavg_rd)[[2]][[1]],3))

pBptest<-rbind(round(bptest(anova4_RATRavg_iron)[[4]][[1]],3),
               round(bptest(anova4_LATRavg_rd)[[4]][[1]],3))

ATR<-c('Iron-RATR','RD-LATR')
Df_aov_avg<-cbind(ATR,Fsubgrupo,pSubgrupo,wShapiro,pShapiro,BPBptest,dfBptest,pBptest)
Df_aov_avg<-as.data.frame(Df_aov_avg)
colnames(Df_aov_avg)<-c('ATR-Metrics', 'F', 'p-value', 'W statistic', 'p-value', 
                        'BP statistic', 'df', 'p-value')

library(kableExtra)
kableExtra::kable(Df_aov_avg, caption = 'Nuevos Modelos Anova para valores Average tras eliminación de outliers', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Subgroup' = 2, 'Normality' = 2, 'Homoscedasticity'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### Comparaciones pareadas por subgrupos

Con las funciones `HSD.test` y `TukeyHSD` de los paquetes `agricolae` y `stats` respectivamente, se generan comparaciones pareadas por subgrupos (post-hoc Tukey tests) en los modelos ANOVA (`anova2_RATRavg_ad`, `anova2_LATRavg_ad`, `anova2_RATRavg_md`, `anova2_LATRavg_md`, `anova2_RATRavg_rd` y `anova4_LATRavg_rd`) que han detectado significancia entre la variable dependiente (métrica de RM) y la variable independiente subgrupo (las dos covariables no han mostrado significación).

Fórmula del Tukey HSD test: 

$$\frac{max(\overline{y_{i}}-\mu_{i})-min(\overline{y_{j}}-\mu_{j})}{\sqrt{\frac{\hat{S_{E}^{2}}}{n}}}=q_{t,N-t}$$
$$HSD = q_{t,N-t} (\alpha) * \sqrt{\frac{\hat{S_{E}^{2}}}{n}}$$
$|\overline{y_{i}} - \overline{y_{j}} | > HSD \to$ stastitical significant difference, being

  N = total  number of observations 
  
  t = number of levels of the factor 
  
  n = sample size of each level of the factor 
  
  $\hat{S_{E}^{2}} =$ estimate of the error or residual variance 
  
  $\overline{y_{i}}, \overline{y_{j}} =$ sample means of the levels/populations i and j
  
  $q_{t,N-t} (\alpha) =$ distribution of the studentized range with the following parameters: t groups, N-t degrees of freedom and $\alpha$ level of significance 


$$ n_h=\frac{2}{\sum_{i=1}^{2}\frac{1}{n_i}} $$

```{r ATRavg34.1, echo=FALSE}
library(agricolae)
library(rstatix)
posthocHSD_RATRad<-HSD.test(anova2_RATRavg_ad,"Subgroup")
posthoctukey_RATRad<-tukey_hsd(anova2_RATRavg_ad,"Subgroup")
posthoctukey_RATRad2<-TukeyHSD(anova2_RATRavg_ad,"Subgroup")

posthocHSD_LATRad<-HSD.test(anova2_LATRavg_ad,"Subgroup")
posthoctukey_LATRad<-tukey_hsd(anova2_LATRavg_ad,"Subgroup")
posthoctukey_LATRad2<-TukeyHSD(anova2_LATRavg_ad,"Subgroup")

posthocHSD_RATRmd<-HSD.test(anova2_RATRavg_md,"Subgroup")
posthoctukey_RATRmd<-tukey_hsd(anova2_RATRavg_md,"Subgroup")
posthoctukey_RATRmd2<-TukeyHSD(anova2_RATRavg_md,"Subgroup")

posthocHSD_LATRmd<-HSD.test(anova2_LATRavg_md,"Subgroup")
posthoctukey_LATRmd<-tukey_hsd(anova2_LATRavg_md,"Subgroup")
posthoctukey_LATRmd2<-TukeyHSD(anova2_LATRavg_md,"Subgroup")

posthocHSD_RATRrd<-HSD.test(anova2_RATRavg_rd,"Subgroup")
posthoctukey_RATRrd<-tukey_hsd(anova2_RATRavg_rd,"Subgroup")
posthoctukey_RATRrd2<-TukeyHSD(anova2_RATRavg_rd,"Subgroup")

posthocHSD_LATRrd<-HSD.test(anova4_LATRavg_rd,"Subgroup")
posthoctukey_LATRrd<-tukey_hsd(anova4_LATRavg_rd,"Subgroup")
posthoctukey_LATRrd2<-TukeyHSD(anova4_LATRavg_rd,"Subgroup")
```

```{r ATRavg34.2, echo=FALSE}
#Grupos
groupsRad<-posthocHSD_RATRad$groups
colnames(groupsRad)<-c('Media', 'Grupos')
rownames(groupsRad)<-NULL

groupsLad<-posthocHSD_LATRad$groups
colnames(groupsLad)<-c('Media', 'Grupos')
rownames(groupsLad)<-NULL

groupsRmd<-posthocHSD_RATRmd$groups
colnames(groupsRmd)<-c('Media', 'Grupos')
rownames(groupsRmd)<-NULL

groupsLmd<-posthocHSD_LATRmd$groups
colnames(groupsLmd)<-c('Media', 'Grupos')
rownames(groupsLmd)<-NULL

groupsRrd<-posthocHSD_RATRrd$groups
colnames(groupsRrd)<-c('Media', 'Grupos')
rownames(groupsRrd)<-NULL

groupsLrd<-posthocHSD_LATRrd$groups
colnames(groupsLrd)<-c('Media', 'Grupos')
rownames(groupsLrd)<-NULL

groups<-rbind(groupsRad,groupsLad,groupsRmd,groupsLmd,groupsRrd,groupsLrd)
Variables<-c('HD', 'Control', 'PreHD', 
             'HD', 'PreHD', 'Control',
             rep(c('HD', 'Control', 'PreHD'),4))
groups<-cbind(Variables,groups)

#Diferencias y p-valores
difpRad<-posthoctukey_RATRad2$Subgroup[,c(1,4)]
difpLad<-posthoctukey_LATRad2$Subgroup[,c(1,4)]
difpRmd<-posthoctukey_RATRmd2$Subgroup[,c(1,4)]
difpLmd<-posthoctukey_LATRmd2$Subgroup[,c(1,4)]
difpRrd<-posthoctukey_RATRrd2$Subgroup[,c(1,4)]
difpLrd<-posthoctukey_LATRrd2$Subgroup[,c(1,4)]

difp<-rbind(difpRad,difpLad,difpRmd,difpLmd,difpRrd,difpLrd)
comparativa<-rownames(difp)

global<-cbind(groups,comparativa,difp)
rownames(global)<-NULL
colnames(global)<-c('', 'Mean', 'Groups', 'Comparison',
                    'Difference of means', 'Adjusted p-value')
```

```{r ATRavg34.3, echo=FALSE}
kableExtra::kable(global, caption = 'HSD Tukey test para las métricas AD, MD, RD de ambos ATR en relación a la variable subgrupo', booktabs = TRUE) %>%
  pack_rows(index=c('AD-RATR'=3, 'AD-LATR'=3, 'MD-RATR'=3, 'MD-LATR'=3, 'RD-RATR'=3, 'RD-LATR'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el caso de la **difusividad axial en ATR derecho**, existen diferencias significativas entre controles-HD y preHD-HD con unos valores aumentados de difusividad axial en HD respecto a preHD y controles. 

En el caso de la **difusividad axial en ATR izquierdo**, existen diferencias significativas entre controles-HD con unos valores aumentados de difusividad axial en HD respecto a controles. 

En el caso de la **difusividad media para ambos ATR**, existen diferencias significativas entre controles-HD y preHD-HD con unos valores aumentados de difusividad media en HD respecto a preHD y controles. 

En el caso de la **difusividad radial para ambos ATR**, existen diferencias significativas entre controles-HD y preHD-HD con unos valores aumentados de difusividad radial en HD respecto a preHD y controles. 

\newpage

# ATR Average: ambos ATR conjuntamente

## Creación de DATAFRAMES

```{r ATRavg35}
RATR_metrics<-cbind(ATR_avg_demo[,c(1,8,10:13)])
LATR_metrics<-cbind(ATR_avg_demo[,c(1,9,14:17)])
ATR_metrics<-cbind(ATR_avg_demo[,c(1,8:17)])

ATR_Iron<-c(ATR_metrics$rhatr_Iron, ATR_metrics$lhatr_Iron)
ATR_AD<-c(ATR_metrics$rhatr_AD, ATR_metrics$lhatr_AD)
ATR_RD<-c(ATR_metrics$rhatr_RD, ATR_metrics$lhatr_RD)
ATR_MD<-c(ATR_metrics$rhatr_MD, ATR_metrics$lhatr_MD)
ATR_FA<-c(ATR_metrics$rhatr_FA, ATR_metrics$lhatr_FA)

ATR_codi<-c(ATR_metrics$codi, ATR_metrics$codi)
ATR_subgroup<-c(ATR_avg_demo$Subgroup, ATR_avg_demo$Subgroup)
ATR_Gender<-c(ATR_avg_demo$Gender, ATR_avg_demo$Gender)
ATR_agef<-c(ATR_avg_demo$agef, ATR_avg_demo$agef)
ATR_agef2<-c(ATR_avg_demo$agef2, ATR_avg_demo$agef2)
ATR_hemisphere<-c(rep("right",nrow(ATR_avg_demo)), rep("left",nrow(ATR_avg_demo)))

ATR_DifIron<-cbind(ATR_codi, ATR_hemisphere, ATR_subgroup, ATR_Gender,
                   ATR_agef, ATR_agef2, ATR_Iron, ATR_AD, ATR_RD, ATR_MD, ATR_FA)
ATR_DifIron_Df<-as.data.frame(ATR_DifIron)
ATR_DifIron_Df$ATR_hemisphere<-as.factor(ATR_DifIron_Df$ATR_hemisphere)
ATR_DifIron_Df$ATR_subgroup<-as.factor(ATR_DifIron_Df$ATR_subgroup)
ATR_DifIron_Df$ATR_Gender<-as.factor(ATR_DifIron_Df$ATR_Gender)
ATR_DifIron_Df$ATR_agef<-as.factor(ATR_DifIron_Df$ATR_agef)
ATR_DifIron_Df$ATR_agef2<-as.factor(ATR_DifIron_Df$ATR_agef2)
ATR_DifIron_Df[,7:11]<-as.numeric(unlist(ATR_DifIron_Df[,7:11]))

# Summary statistics del dataframe
sumATR_DifIron_Df<-summary(ATR_DifIron_Df[,-c(1,5)])
kable(list(sumATR_DifIron_Df[,1:4], sumATR_DifIron_Df[,5:9]), 
      caption='Summary statistics for both ATR conjointly', booktabs=TRUE)
```

\newpage

## Automated Exploratory Data Analysis 

```{r ATREDA.1, eval=FALSE}
library(DataExplorer)
library(dplyr)
ATR_DifIron_EDA<-ATR_DifIron_Df[,-c(1,5)]
ATR_DifIron_EDA %>%
    create_report(
        output_file = paste("Report"),
        report_title = "EDA Report - ATR",
        y = "ATR_subgroup"
    )
```

Se generan los diferentes plots que se consideran necesarios con las funciones del paquete `DataExplorer`.

```{r ATREDA.2.1, echo=FALSE}
library(DataExplorer)
library(dplyr)
ATR_DifIron_EDA<-ATR_DifIron_Df[,-c(1,5)]
# La estructura del dataframe
plot_str(ATR_DifIron_EDA)
# Barplots de cada variable categórica
plot_bar(ATR_DifIron_EDA)
# Barplots de cada variable categórica en función del subgrupo
plot_bar(ATR_DifIron_EDA, by="ATR_subgroup")
# QQ-plots de cada variable numérica en función del subgrupo
plot_qq(ATR_DifIron_EDA, by="ATR_subgroup")
# Plots de densidad de las variables numéricas (global)
plot_density(ATR_DifIron_EDA)
```

```{r ATREDA.2.2, echo=FALSE}
# Plots de densidad de las variables numéricas en función del subgrupo
plotiron<-ggplot(ATR_DifIron_EDA, aes(x = ATR_Iron, color = ATR_subgroup)) + geom_density(linewidth = 0.75)
plotad<-ggplot(ATR_DifIron_EDA, aes(x = ATR_AD, color = ATR_subgroup)) + geom_density(linewidth = 0.75)
plotmd<-ggplot(ATR_DifIron_EDA, aes(x = ATR_MD, color = ATR_subgroup)) + geom_density(linewidth = 0.75)
plotrd<-ggplot(ATR_DifIron_EDA, aes(x = ATR_RD, color = ATR_subgroup)) + geom_density(linewidth = 0.75)
plotfa<-ggplot(ATR_DifIron_EDA, aes(x = ATR_FA, color = ATR_subgroup)) + geom_density(linewidth = 0.75)

grid.arrange(plotiron,plotad,plotmd,plotrd,plotfa,ncol=2)
```

```{r ATREDA.2.3,echo=FALSE}
# Boxplots de las variables numéricas en función del subgrupo
plot_boxplot(ATR_DifIron_EDA, by="ATR_subgroup")
# Boxplots de las variables numéricas en función de la edad factorizada
plot_boxplot(ATR_DifIron_EDA, by="ATR_agef2")
# Boxplots de las variables numéricas en función del género
plot_boxplot(ATR_DifIron_EDA, by="ATR_Gender")
# Plot de correlaciones entre todas las variables de interés
#plot_correlation(ATR_DifIron_EDA, geom_text_args = list(size=1.5))
```

```{r ATREDA.2.4,echo=FALSE}
# Plot de componentes principales entre todas las variables de interés
plot_prcomp(ATR_DifIron_EDA)
# Plot de componentes principales entre todas las variables de interés (sin subgroup)
ATR_DifIron_EDA2<-ATR_DifIron_EDA[,-c(2)]
plot_prcomp(ATR_DifIron_EDA2)
```

Se genera un plot con la función `ggpairs` del paquete `GGally`.

```{r ATREDA.2.5}
library(GGally)
ATR_DifIron_EDA %>%
  ggpairs(mapping = aes(color=ATR_DifIron_EDA$ATR_subgroup, alpha=0.5))
```

Se genera una tabla mediante la función `ExpCatStat` del paquete `SmartEDA` para determinar la importancia de las variables en función de su información. Esta función combina resultados de la ponderación de la evidencia, el valor de la información y las estadísticas resumidas. La función discretiza las variables numéricas y que el número de bins modifica el valor informativo de las variables y los IV values.

```{r ATREDA.3, echo=FALSE}
library(SmartEDA)
ResExpCatSat<-ExpCatStat(data=ATR_DifIron_EDA, Target = 'ATR_subgroup', Pclass='1', bin=20, result='Stat', plot=TRUE)
kableExtra::kable(ResExpCatSat, caption = 'Asociaciones y Poder predictivo de las variables respecto a Subgrupo', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 7, latex_options='hold_position')
```

\newpage

## Estadística descriptiva gráfica

### BARPLOTS

```{r ATRavg36.1, echo=FALSE}
#http://www.sthda.com/english/wiki/ggplot2-barplots-quick-start-guide-r-software-and-data-visualization
data_summary <- function(data, varname, groupnames){
  require(plyr)
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
 return(data_sum)
}

hemisphere<-as.factor(rep(c("Left", "Right"), each=3))
subgroup<-as.factor(rep(c("1Control", "2PreHD", "3HD"), 2))

condition_SUBG_HEM<-c(with(ATR_DifIron_Df, interaction(ATR_subgroup, ATR_hemisphere)))
ATR_DifIron_Df<-cbind(ATR_DifIron_Df, condition_SUBG_HEM)

DataSum_AtrIronAvg <- data_summary(ATR_DifIron_Df, varname="ATR_Iron",
                                   groupnames=c("condition_SUBG_HEM"))
names(DataSum_AtrIronAvg)[2]<-"mean"
DataSum_AtrIronAvg_Df<-cbind(subgroup, hemisphere, DataSum_AtrIronAvg)

DataSum_AtrADAvg <- data_summary(ATR_DifIron_Df, varname="ATR_AD",
                                 groupnames=c("condition_SUBG_HEM"))
names(DataSum_AtrADAvg)[2]<-"mean"
DataSum_AtrADAvg_Df<-cbind(subgroup, hemisphere, DataSum_AtrADAvg)

DataSum_AtrRDAvg <- data_summary(ATR_DifIron_Df, varname="ATR_RD",
                                 groupnames=c("condition_SUBG_HEM"))
names(DataSum_AtrRDAvg)[2]<-"mean"
DataSum_AtrRDAvg_Df<-cbind(subgroup, hemisphere, DataSum_AtrRDAvg)

DataSum_AtrMDAvg <- data_summary(ATR_DifIron_Df, varname="ATR_MD",
                                 groupnames=c("condition_SUBG_HEM"))
names(DataSum_AtrMDAvg)[2]<-"mean"
DataSum_AtrMDAvg_Df<-cbind(subgroup, hemisphere, DataSum_AtrMDAvg)

DataSum_AtrFAAvg <- data_summary(ATR_DifIron_Df, varname="ATR_FA",
                                 groupnames=c("condition_SUBG_HEM"))
names(DataSum_AtrFAAvg)[2]<-"mean"
DataSum_AtrFAAvg_Df<-cbind(subgroup, hemisphere, DataSum_AtrFAAvg)
```

#### IRON

```{r ATRavg36.2, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
library("ggplot2")
barplot_AtrIronAvg <- ggplot(DataSum_AtrIronAvg_Df, aes(x=hemisphere, y=mean, fill=subgroup)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('blue', 'red','green')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg Iron of both ATR", x="ATR", y = "Avg_Iron") +
  theme_classic() 
barplot_AtrIronAvg

barplot_AtrIronAvg2 <- ggplot(DataSum_AtrIronAvg_Df, aes(x=subgroup, y=mean, fill=hemisphere)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('pink', 'lightblue')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg Iron of 3 Subgroups for both ATRs", x="Subgroups", y = "Avg_Iron") +
  theme_classic() 
barplot_AtrIronAvg2
```

\newpage

#### AD

```{r ATRavg36.3, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_AtrADAvg <- ggplot(DataSum_AtrADAvg_Df, aes(x=hemisphere, y=mean, fill=subgroup)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('blue', 'red','green')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg AD of both ATR", x="ATR", y = "Avg_AD") +
  theme_classic() 
barplot_AtrADAvg

barplot_AtrADAvg2 <- ggplot(DataSum_AtrADAvg_Df, aes(x=subgroup, y=mean, fill=hemisphere)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('pink', 'lightblue')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg AD of 3 Subgroups for both ATRs", x="Subgroups", y = "Avg_AD") +
  theme_classic() 
barplot_AtrADAvg2
```

\newpage

#### MD

```{r ATRavg36.4, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_AtrMDAvg <- ggplot(DataSum_AtrMDAvg_Df, aes(x=hemisphere, y=mean, fill=subgroup)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('blue', 'red','green')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg MD of both ATR", x="ATR", y = "Avg_MD") +
  theme_classic() 
barplot_AtrMDAvg

barplot_AtrMDAvg2 <- ggplot(DataSum_AtrMDAvg_Df, aes(x=subgroup, y=mean, fill=hemisphere)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('pink', 'lightblue')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg MD of 3 Subgroups for both ATRs", x="Subgroups", y = "Avg_MD") +
  theme_classic() 
barplot_AtrMDAvg2
```

\newpage

#### RD

```{r ATRavg36.5, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_AtrRDAvg <- ggplot(DataSum_AtrRDAvg_Df, aes(x=hemisphere, y=mean, fill=subgroup)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('blue', 'red','green')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg RD of both ATR", x="ATR", y = "Avg_RD") +
  theme_classic() 
barplot_AtrRDAvg

barplot_AtrRDAvg2 <- ggplot(DataSum_AtrRDAvg_Df, aes(x=subgroup, y=mean, fill=hemisphere)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('pink', 'lightblue')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg RD of 3 Subgroups for both ATRs", x="Subgroups", y = "Avg_RD") +
  theme_classic() 
barplot_AtrRDAvg2
```

\newpage

#### FA

```{r ATRavg36.6, echo=FALSE, fig.width=4, fig.height=3, fig.align='center'}
barplot_AtrFAAvg <- ggplot(DataSum_AtrFAAvg_Df, aes(x=hemisphere, y=mean, fill=subgroup)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('blue', 'red','green')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg FA of both ATR", x="ATR", y = "Avg_FA") +
  theme_classic() 
barplot_AtrFAAvg

barplot_AtrFAAvg2 <- ggplot(DataSum_AtrFAAvg_Df, aes(x=subgroup, y=mean, fill=hemisphere)) + 
  geom_bar(stat="identity", position=position_dodge()) + theme(legend.position = "right") + 
  scale_fill_manual(values=c('pink', 'lightblue')) + 
  geom_errorbar(aes(ymin=mean-sd, ymax=mean+sd), width=.2, position=position_dodge(.9)) + 
  theme_minimal() + labs(title="Avg FA of 3 Subgroups for both ATRs", x="Subgroups", y = "Avg_FA") +
  theme_classic() 
barplot_AtrFAAvg2
```

```{r ATRavg36.7, echo=FALSE, eval=FALSE}
grid.arrange(barplot_AtrADAvg2,barplot_AtrMDAvg2,barplot_AtrRDAvg2,
             barplot_AtrIronAvg2,barplot_AtrFAAvg2, ncol=3)
```

### HISTOGRAMAS y QQ-PLOTS

Para obtener una idea de la **normalidad de los datos y de la presencia/ausencia de outliers**, para cada métrica de RM, se genera un histograma, un plot y cuatro qq-plots (un qqplot sin distinción entre subgrupos y un qqplot para cada subgrupo). No se genera un qqplot para cada hemisferio dado que ya se ha realizado dicho gráfico en el apartado de análisis de los ATRs derecho e izquierdo por separado.

Para valorar posibles **diferencias en variabilidad de las métricas de RM en los niveles de los diferentes factores de interés** subgrupo, hemisferio, género y edad factorizada, también se generan plots de las métricas de RM para cada subgrupo, hemisferio, género y grupo de edad (tanto para la edad factorizada de 7 niveles como la edad factorizada de 3 niveles).

\newpage

#### IRON

```{r ATRavg37.1, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_DifIron_Df$ATR_Iron, xlab='Average Iron in both ATR', main='Histogram of ATR Average Iron',cex.main=1)
plot(ATR_DifIron_Df$ATR_Iron, ylab='Average Iron in both ATR')
```

```{r ATRavg37.2, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
library(car)
qqPlot(ATR_DifIron_Df$ATR_Iron, ylab='Average Iron in both ATR')
```

```{r ATRavg37.3, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='1')$ATR_Iron, ylab='Average Iron in both ATR in Controls')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='2')$ATR_Iron, ylab='Average Iron in both ATR in PreHD')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='3')$ATR_Iron, ylab='Average Iron in both ATR in HD')
par(mfrow = c(1,2))
plot(ATR_DifIron_Df$ATR_Iron~ATR_DifIron_Df$ATR_subgroup, xlab='Subgroup', ylab='Average Iron in both ATR')
plot(ATR_DifIron_Df$ATR_Iron~ATR_DifIron_Df$ATR_hemisphere, xlab='Hemisphere', ylab='Average Iron in both ATR')
par(mfrow = c(1,3))
plot(ATR_DifIron_Df$ATR_Iron~ATR_DifIron_Df$ATR_Gender, xlab='Gender', ylab='Average Iron in both ATR')
plot(ATR_DifIron_Df$ATR_Iron~ATR_DifIron_Df$ATR_agef, xlab='Factorized Age - 7 levels', ylab='Average Iron in both ATR')
plot(ATR_DifIron_Df$ATR_Iron~ATR_DifIron_Df$ATR_agef2, xlab='Factorized Age - 3 levels', ylab='Average Iron in both ATR')
```

#### AD

```{r ATRavg37.4, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_DifIron_Df$ATR_AD, xlab='Average AD in both ATR', main='Histogram of ATR Average AD',cex.main=1)
plot(ATR_DifIron_Df$ATR_AD, ylab='Average AD in both ATR')
```

```{r ATRavg37.5, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
library(car)
qqPlot(ATR_DifIron_Df$ATR_AD, ylab='Average AD in both ATR')
```

```{r ATRavg37.6, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='1')$ATR_AD, ylab='Average AD in both ATR in Controls')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='2')$ATR_AD, ylab='Average AD in both ATR in PreHD')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='3')$ATR_AD, ylab='Average AD in both ATR in HD')
par(mfrow = c(1,2))
plot(ATR_DifIron_Df$ATR_AD~ATR_DifIron_Df$ATR_subgroup, xlab='Subgroup', ylab='Average AD in both ATR')
plot(ATR_DifIron_Df$ATR_AD~ATR_DifIron_Df$ATR_hemisphere, xlab='Hemisphere', ylab='Average AD in both ATR')
par(mfrow = c(1,3))
plot(ATR_DifIron_Df$ATR_AD~ATR_DifIron_Df$ATR_Gender, xlab='Gender', ylab='Average AD in both ATR')
plot(ATR_DifIron_Df$ATR_AD~ATR_DifIron_Df$ATR_agef, xlab='Factorized Age - 7 levels', ylab='Average AD in both ATR')
plot(ATR_DifIron_Df$ATR_AD~ATR_DifIron_Df$ATR_agef2, xlab='Factorized Age - 3 levels', ylab='Average AD in both ATR')
```

#### MD

```{r ATRavg37.7, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_DifIron_Df$ATR_MD, xlab='Average MD in both ATR', main='Histogram of ATR Average MD',cex.main=1)
plot(ATR_DifIron_Df$ATR_MD, ylab='Average MD in both ATR')
```

```{r ATRavg37.8, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
library(car)
qqPlot(ATR_DifIron_Df$ATR_MD, ylab='Average MD in both ATR')
```

```{r ATRavg37.9, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='1')$ATR_MD, ylab='Average MD in both ATR in Controls')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='2')$ATR_MD, ylab='Average MD in both ATR in PreHD')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='3')$ATR_MD, ylab='Average MD in both ATR in HD')
par(mfrow = c(1,2))
plot(ATR_DifIron_Df$ATR_MD~ATR_DifIron_Df$ATR_subgroup, xlab='Subgroup', ylab='Average MD in both ATR')
plot(ATR_DifIron_Df$ATR_MD~ATR_DifIron_Df$ATR_hemisphere, xlab='Hemisphere', ylab='Average MD in both ATR')
par(mfrow = c(1,3))
plot(ATR_DifIron_Df$ATR_MD~ATR_DifIron_Df$ATR_Gender, xlab='Gender', ylab='Average MD in both ATR')
plot(ATR_DifIron_Df$ATR_MD~ATR_DifIron_Df$ATR_agef, xlab='Factorized Age - 7 levels', ylab='Average MD in both ATR')
plot(ATR_DifIron_Df$ATR_MD~ATR_DifIron_Df$ATR_agef2, xlab='Factorized Age - 3 levels', ylab='Average MD in both ATR')
```

#### RD

```{r ATRavg37.10, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_DifIron_Df$ATR_RD, xlab='Average RD in both ATR', main='Histogram of ATR Average RD',cex.main=1)
plot(ATR_DifIron_Df$ATR_RD, ylab='Average RD in both ATR')
```

```{r ATRavg37.11, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
library(car)
qqPlot(ATR_DifIron_Df$ATR_RD, ylab='Average RD in both ATR')
```

```{r ATRavg37.12, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='1')$ATR_RD, ylab='Average RD in both ATR in Controls')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='2')$ATR_RD, ylab='Average RD in both ATR in PreHD')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='3')$ATR_RD, ylab='Average RD in both ATR in HD')
par(mfrow = c(1,2))
plot(ATR_DifIron_Df$ATR_RD~ATR_DifIron_Df$ATR_subgroup, xlab='Subgroup', ylab='Average RD in both ATR')
plot(ATR_DifIron_Df$ATR_RD~ATR_DifIron_Df$ATR_hemisphere, xlab='Hemisphere', ylab='Average RD in both ATR')
par(mfrow = c(1,3))
plot(ATR_DifIron_Df$ATR_RD~ATR_DifIron_Df$ATR_Gender, xlab='Gender', ylab='Average RD in both ATR')
plot(ATR_DifIron_Df$ATR_RD~ATR_DifIron_Df$ATR_agef, xlab='Factorized Age - 7 levels', ylab='Average RD in both ATR')
plot(ATR_DifIron_Df$ATR_RD~ATR_DifIron_Df$ATR_agef2, xlab='Factorized Age - 3 levels', ylab='Average RD in both ATR')
```

#### FA

```{r ATRavg37.13, echo=FALSE, fig.align='center'}
par(mfrow = c(1,2))
hist(ATR_DifIron_Df$ATR_FA, xlab='Average FA in both ATR', main='Histogram of ATR Average FA',cex.main=1)
plot(ATR_DifIron_Df$ATR_FA, ylab='Average FA in both ATR')
```

```{r ATRavg37.14, echo=FALSE, fig.width=5, fig.height=4, fig.align='center'}
par(mfrow = c(1,1))
library(car)
qqPlot(ATR_DifIron_Df$ATR_FA, ylab='Average FA in both ATR')
```

```{r ATRavg37.15, echo=FALSE, fig.align='center'}
par(mfrow = c(1,3))
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='1')$ATR_FA, ylab='Average FA in both ATR in Controls')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='2')$ATR_FA, ylab='Average FA in both ATR in PreHD')
qqPlot(subset(ATR_DifIron_Df, ATR_subgroup=='3')$ATR_FA, ylab='Average FA in both ATR in HD')
par(mfrow = c(1,2))
plot(ATR_DifIron_Df$ATR_FA~ATR_DifIron_Df$ATR_subgroup, xlab='Subgroup', ylab='Average FA in both ATR')
plot(ATR_DifIron_Df$ATR_FA~ATR_DifIron_Df$ATR_hemisphere, xlab='Hemisphere', ylab='Average FA in both ATR')
par(mfrow = c(1,3))
plot(ATR_DifIron_Df$ATR_FA~ATR_DifIron_Df$ATR_Gender, xlab='Gender', ylab='Average FA in both ATR')
plot(ATR_DifIron_Df$ATR_FA~ATR_DifIron_Df$ATR_agef, xlab='Factorized Age - 7 levels', ylab='Average FA in both ATR')
plot(ATR_DifIron_Df$ATR_FA~ATR_DifIron_Df$ATR_agef2, xlab='Factorized Age - 3 levels', ylab='Average FA in both ATR')
```

### PLOT de CORRELACIONES

Previamente, a generar los diferentes modelos estadísticos, se genera un plot de correlaciones entre todas las variables. 

```{r ATRavg37.16,echo=FALSE,fig.align='center'}
library(DataExplorer)
plot_correlation(ATR_DifIron_EDA, geom_text_args = list(size=2.5))
```

En este plot, se objetivan los siguientes fenómenos:

- Las métricas AD, RD y MD están altamente correlacionadas entre sí;
- El ATR derecho se correlaciona con las métricas AD, RD y MD; 
- El ATR izquierdo se correlaciona con la métrica de hierrro;
- El subgrupo control se correlaciona con el género masculino, con los grupos de edad 1 y 3 (de los 3 niveles) y 1, 5 y 6 (de los 7 niveles);
- El subgrupo preHD se correlaciona con las métricas de hierro y FA, género femenino, con los grupos de edad 1 (de los 3 niveles) y 1 y 3 (de los 7 niveles);
- El subgrupo HD se correlaciona con las métricas AD, RD y MD, con los grupos de edad 2 (de los 3 niveles) y 4 y 7 (de los 7 niveles);

Habiendo expuesto lo anterior, se objetiva que tanto género como edad son covariables o factores confusores en la relación entre las métricas y los subgrupos, por tanto dichas variables se van a introducir en los modelos para controlar su efecto. Se utilizará la edad factorizada de 3 niveles dado que presenta una `n` por nivel más comparable entre niveles.

En relación a la lateralidad (ATR derecho e izquierdo), la correlación entre ATR derecho y métricas de difusividad y entre ATR izquierdo y métrica de hierro puede ser debido a que los pacientes HD sintomáticos tengan mayor afectación del ATR derecho y que los sujetos preHD presintomáticos tengar mayor acúmulo de hierro en el ATR izquierdo, pero, también puede ser debido a una fisiología diferencial entre ambos ATRs. Por tanto, es una relación que se debe de valorar detalladamente, tanto como factor independiente (hemisferio) como en interacción con subgrupo. 

\newpage

## Estadística descriptiva matemática

### Media, mediana, desviación estándar, kurtosis y skewness

Se procede a determinar la **media**, la **mediana**, la **desviación estándar**, la **kurtosis** y el **skewness** (se ha consultado la siguiente web para su interpretación [Skewness and Kurtosis in Statistics](https://www.r-bloggers.com/2020/11/skewness-and-kurtosis-in-statistics/)).

En función de los valores de *skewnness*, una distribución puede ser:

- **Simétrica**, con valores de *skewnness* entre -0.5 y 0.5, con la media y la mediana siendo similares entre sí;
- **Asimétrica positiva** (*right-skewed* o *right-tailed*), cuyo histograma muestra una cola derecha más larga concentrándose la mayoría de las observaciones en la cola izquierda y con una media mayor que la mediana. 
- **Asimétrica negativa** (*left-skewed* o *left-tailed*), cuyo histograma muestra una cola izquierda más larga concentrándose la mayoría de las observaciones en la cola derecha y con una mediana mayor que la media.

La asimetría se gradará en función de los valores de *skewnness* como moderada con valores entre 0.5 y 1 o -0.5 y -1 y como alta/severa con valores mayores a 1 o inferiores a -1. 

En función de los valores de *kurtosis*, una distribución puede ser:

- **Mesokúrtica**, en el caso de la distribución normal, con valores de kurtosis próximos a 3;
- **Leptokúrtica** (*kurtosis* positiva con valores mayores de 3), con una distribución concentrada de valores generando colas gruesas y pico afilado; 
- **Platikúrtica** (*kurtosis* negativa con valores menores de 3), con una distribución que muestra un pico más bajo y ancho y colas más delgadas. 

```{r ATRavg38.1, echo=FALSE}
# Media, mediana, varianza, desviación estándar, Kurtosis, Skewness 
#IRON 
library(e1071)
Iron<-rbind(mean(ATR_DifIron_Df$ATR_Iron), median(ATR_DifIron_Df$ATR_Iron),
            sd(ATR_DifIron_Df$ATR_Iron),
            e1071::skewness(ATR_DifIron_Df$ATR_Iron, type = 3),
            e1071::kurtosis(ATR_DifIron_Df$ATR_Iron, type = 3))
Iron<-round(Iron,5)

#AD 
AD<-rbind(mean(ATR_DifIron_Df$ATR_AD),median(ATR_DifIron_Df$ATR_AD),
          sd(ATR_DifIron_Df$ATR_AD),
          e1071::skewness(ATR_DifIron_Df$ATR_AD, type = 3),
          e1071::kurtosis(ATR_DifIron_Df$ATR_AD, type = 3))
AD<-round(AD,5)

#MD 
MD<-rbind(mean(ATR_DifIron_Df$ATR_MD),median(ATR_DifIron_Df$ATR_MD),
          sd(ATR_DifIron_Df$ATR_MD),
          e1071::skewness(ATR_DifIron_Df$ATR_MD, type = 3),
          e1071::kurtosis(ATR_DifIron_Df$ATR_MD, type = 3))
MD<-round(MD,5)

#RD 
RD<-rbind(mean(ATR_DifIron_Df$ATR_RD),median(ATR_DifIron_Df$ATR_RD),
          sd(ATR_DifIron_Df$ATR_RD),
          e1071::skewness(ATR_DifIron_Df$ATR_RD, type = 3),
          e1071::kurtosis(ATR_DifIron_Df$ATR_RD, type = 3))
RD<-round(RD,5)

#FA 
FA<-rbind(mean(ATR_DifIron_Df$ATR_FA),median(ATR_DifIron_Df$ATR_FA),
          sd(ATR_DifIron_Df$ATR_FA),
          e1071::skewness(ATR_DifIron_Df$ATR_FA, type = 3),
          e1071::kurtosis(ATR_DifIron_Df$ATR_FA, type = 3))
FA<-round(FA,5)

Variables<-c('Mean','Median','Standard Deviation','Skewness','Kurtosis')

MeasuresATR<-cbind(Variables,Iron,AD,MD,RD,FA)
MeasuresATR_Df<-as.data.frame(MeasuresATR)
colnames(MeasuresATR_Df)<-c('Variables','Iron','AD','MD','RD','FA')
```

```{r ATRavg38.2, echo=FALSE}
kableExtra::kable(MeasuresATR_Df, caption = 'Media, mediana, desviación estándar, skewness y kurtosis', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Remarcar que los valores medios y desviaciones estándar de las 3 métricas de difusividad presentan valores cercanos a cero (unidad de medida $mm^2/s$) y esto puede conllevar problemas con algunos de los métodos de análisis estadístico.

Los valores de **hierro** presentan una asimetría moderada positiva con valores de *skewness* entorno a 0.5 (exactamente valor de `r round(e1071::skewness(ATR_DifIron_Df$ATR_Iron, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores de inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_DifIron_Df$ATR_Iron, type = 3),2)`).

Los valores de **difusividad axial** presenta una simetría con valores de *skewness* entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_DifIron_Df$ATR_AD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores de inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_DifIron_Df$ATR_AD, type = 3),2)`).

Los valores de **difusividad media** presenta una simetría con valores de *skewness* entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_DifIron_Df$ATR_MD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores de inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_DifIron_Df$ATR_MD, type = 3),2)`).

Los valores de **difusividad radial** presenta una asimetría moderada positiva con valores de *skewness* entorno a 0.5 (exactamente valor de `r round(e1071::skewness(ATR_DifIron_Df$ATR_RD, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores de inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_DifIron_Df$ATR_RD, type = 3),2)`).

Los valores de **anisotropía fraccional** presenta una simetría con valores de *skewness* entre -0.5 y 0.5 (exactamente valor de `r round(e1071::skewness(ATR_DifIron_Df$ATR_FA, type = 3),2)`) y son platikúrticos (*kurtosis* negativa con valores de inferiores a 3, exactamente valor de `r round(e1071::kurtosis(ATR_DifIron_Df$ATR_FA, type = 3),2)`).

### Normalidad Univariante - Homocedasticidad de cada métrica para cada factor

Se procede a **valorar la normalidad** de los valores de las diferentes métricas de RM **y la homocedasticidad** de dichas métricas en los niveles de las variables categóricas de intéres (subgrupo, hemisferio, edad_factorizada, género).

La normalidad se puede obtener de una de las dos funciones siguientes: `shapiro.test` del paquete `stats` o `shapiro_test` del paquete `rstatix`. Los resultados son coincidentes. 

La homocedasticidad se obtiene de la función `fligner.test` del paquete `stats`. 

```{r ATRavg38.3, echo=FALSE}
library(stats)
# IRON 
normalidad_Iron<-rbind(stats::shapiro.test(ATR_DifIron_Df$ATR_Iron)[[1]][[1]],
                       stats::shapiro.test(ATR_DifIron_Df$ATR_Iron)[[2]][[1]])
homo_subgrupos_Iron<-rbind(fligner.test(ATR_Iron~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                            fligner.test(ATR_Iron~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                            fligner.test(ATR_Iron~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferio_Iron<-rbind(fligner.test(ATR_Iron~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                            fligner.test(ATR_Iron~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                            fligner.test(ATR_Iron~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef_Iron<-rbind(fligner.test(ATR_Iron~ATR_agef, data=ATR_DifIron_Df)[[1]][[1]],
                       fligner.test(ATR_Iron~ATR_agef, data=ATR_DifIron_Df)[[2]][[1]],
                       fligner.test(ATR_Iron~ATR_agef, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef2_Iron<-rbind(fligner.test(ATR_Iron~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                        fligner.test(ATR_Iron~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                        fligner.test(ATR_Iron~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_gender_Iron<-rbind(fligner.test(ATR_Iron~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                        fligner.test(ATR_Iron~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                        fligner.test(ATR_Iron~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])

# AD 
normalidad_AD<-rbind(stats::shapiro.test(ATR_DifIron_Df$ATR_AD)[[1]][[1]],
                     stats::shapiro.test(ATR_DifIron_Df$ATR_AD)[[2]][[1]])
homo_subgrupos_AD<-rbind(fligner.test(ATR_AD~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_AD~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_AD~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferio_AD<-rbind(fligner.test(ATR_AD~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                          fligner.test(ATR_AD~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                          fligner.test(ATR_AD~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef_AD<-rbind(fligner.test(ATR_AD~ATR_agef, data=ATR_DifIron_Df)[[1]][[1]],
                    fligner.test(ATR_AD~ATR_agef, data=ATR_DifIron_Df)[[2]][[1]],
                    fligner.test(ATR_AD~ATR_agef, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef2_AD<-rbind(fligner.test(ATR_AD~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_AD~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_AD~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_gender_AD<-rbind(fligner.test(ATR_AD~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                      fligner.test(ATR_AD~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                      fligner.test(ATR_AD~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])

# MD 
normalidad_MD<-rbind(stats::shapiro.test(ATR_DifIron_Df$ATR_MD)[[1]][[1]],
                     stats::shapiro.test(ATR_DifIron_Df$ATR_MD)[[2]][[1]])
homo_subgrupos_MD<-rbind(fligner.test(ATR_MD~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_MD~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_MD~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferio_MD<-rbind(fligner.test(ATR_MD~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                          fligner.test(ATR_MD~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                          fligner.test(ATR_MD~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef_MD<-rbind(fligner.test(ATR_MD~ATR_agef, data=ATR_DifIron_Df)[[1]][[1]],
                    fligner.test(ATR_MD~ATR_agef, data=ATR_DifIron_Df)[[2]][[1]],
                    fligner.test(ATR_MD~ATR_agef, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef2_MD<-rbind(fligner.test(ATR_MD~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_MD~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_MD~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_gender_MD<-rbind(fligner.test(ATR_MD~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                      fligner.test(ATR_MD~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                      fligner.test(ATR_MD~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])

# RD 
normalidad_RD<-rbind(stats::shapiro.test(ATR_DifIron_Df$ATR_RD)[[1]][[1]],
                     stats::shapiro.test(ATR_DifIron_Df$ATR_RD)[[2]][[1]])
homo_subgrupos_RD<-rbind(fligner.test(ATR_RD~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_RD~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_RD~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferio_RD<-rbind(fligner.test(ATR_RD~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                          fligner.test(ATR_RD~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                          fligner.test(ATR_RD~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef_RD<-rbind(fligner.test(ATR_RD~ATR_agef, data=ATR_DifIron_Df)[[1]][[1]],
                    fligner.test(ATR_RD~ATR_agef, data=ATR_DifIron_Df)[[2]][[1]],
                    fligner.test(ATR_RD~ATR_agef, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef2_RD<-rbind(fligner.test(ATR_RD~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_RD~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_RD~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_gender_RD<-rbind(fligner.test(ATR_RD~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                      fligner.test(ATR_RD~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                      fligner.test(ATR_RD~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])

# FA
normalidad_FA<-rbind(stats::shapiro.test(ATR_DifIron_Df$ATR_FA)[[1]][[1]],
                     stats::shapiro.test(ATR_DifIron_Df$ATR_FA)[[2]][[1]])
homo_subgrupos_FA<-rbind(fligner.test(ATR_FA~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_FA~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_FA~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferio_FA<-rbind(fligner.test(ATR_FA~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                          fligner.test(ATR_FA~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                          fligner.test(ATR_FA~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef_FA<-rbind(fligner.test(ATR_FA~ATR_agef, data=ATR_DifIron_Df)[[1]][[1]],
                    fligner.test(ATR_FA~ATR_agef, data=ATR_DifIron_Df)[[2]][[1]],
                    fligner.test(ATR_FA~ATR_agef, data=ATR_DifIron_Df)[[3]][[1]])
homo_agef2_FA<-rbind(fligner.test(ATR_FA~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_FA~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_FA~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_gender_FA<-rbind(fligner.test(ATR_FA~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                      fligner.test(ATR_FA~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                      fligner.test(ATR_FA~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])

normalidad<-cbind(normalidad_Iron, normalidad_AD, normalidad_MD, normalidad_RD, normalidad_FA)
normalidad<-round(normalidad,4)
normalidad_df<-as.data.frame(normalidad)
rownames(normalidad_df)<-c('W-Statistic','p-value')
colnames(normalidad_df)<-c('Iron','AD','MD','RD','FA')

homocedasticidad_subgrupo<-cbind(homo_subgrupos_Iron, homo_subgrupos_AD, homo_subgrupos_MD, 
                                 homo_subgrupos_RD, homo_subgrupos_FA)
homocedasticidad_subgrupo<-round(homocedasticidad_subgrupo,4)
homocedasticidad_subgrupo_df<-as.data.frame(homocedasticidad_subgrupo)
rownames(homocedasticidad_subgrupo_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_subgrupo_df)<-c('Iron','AD','MD','RD','FA')

homocedasticidad_hemisferio<-cbind(homo_hemisferio_Iron, homo_hemisferio_AD, homo_hemisferio_MD,
                                   homo_hemisferio_RD, homo_hemisferio_FA)
homocedasticidad_hemisferio<-round(homocedasticidad_hemisferio,4)
homocedasticidad_hemisferio_df<-as.data.frame(homocedasticidad_hemisferio)
rownames(homocedasticidad_hemisferio_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_hemisferio_df)<-c('Iron','AD','MD','RD','FA')

homocedasticidad_genero<-cbind(homo_gender_Iron, homo_gender_AD, homo_gender_MD, 
                               homo_gender_RD, homo_gender_FA)
homocedasticidad_genero<-round(homocedasticidad_genero,4)
homocedasticidad_genero_df<-as.data.frame(homocedasticidad_genero)
rownames(homocedasticidad_genero_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_genero_df)<-c('Iron','AD','MD','RD','FA')

homocedasticidad_agef<-cbind(homo_agef_Iron, homo_agef_AD, homo_agef_MD,
                             homo_agef_RD, homo_agef_FA)
homocedasticidad_agef<-round(homocedasticidad_agef,4)
homocedasticidad_agef_df<-as.data.frame(homocedasticidad_agef)
rownames(homocedasticidad_agef_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_agef_df)<-c('Iron','AD','MD','RD','FA')

homocedasticidad_agef2<-cbind(homo_agef2_Iron, homo_agef2_AD, homo_agef2_MD,
                              homo_agef2_RD, homo_agef2_FA)
homocedasticidad_agef2<-round(homocedasticidad_agef2,4)
homocedasticidad_agef2_df<-as.data.frame(homocedasticidad_agef2)
rownames(homocedasticidad_agef2_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_agef2_df)<-c('Iron','AD','MD','RD','FA')

homocedasticidad_df<-rbind(homocedasticidad_subgrupo_df, homocedasticidad_hemisferio_df,
                           homocedasticidad_genero_df, homocedasticidad_agef_df, homocedasticidad_agef2_df)
rownames(homocedasticidad_df)<-NULL
Variables<-rep(c('Statistic','df','p-value'),5)
homocedasticidad_df<-cbind(Variables,homocedasticidad_df)

homocedasticidad_df_bis<-rbind(homocedasticidad_subgrupo_df, homocedasticidad_hemisferio_df,
                           homocedasticidad_genero_df, homocedasticidad_agef2_df)
rownames(homocedasticidad_df_bis)<-NULL
Variables<-rep(c('Statistic','df','p-value'),4)
homocedasticidad_df_bis<-cbind(Variables,homocedasticidad_df_bis)
```

```{r ATRavg38.4, echo=FALSE}
kableExtra::kable(normalidad_df, caption = 'Valoración de la normalidad de las métricas de RM con la función shapiro test', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.5.1, echo=FALSE}
kableExtra::kable(homocedasticidad_df_bis, caption = 'Valoración de la homocedasticidad de las métricas de RM para las variables independientes', booktabs = TRUE) %>%
  pack_rows(index=c('Subgroup'=3,'Hemisphere'=3,'Gender'=3,'Factorized age'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.5, echo=FALSE}
kableExtra::kable(homocedasticidad_df, caption = 'Valoración de la homocedasticidad de las métricas de RM para las variables independientes', booktabs = TRUE) %>%
  pack_rows(index=c('Subgrupo'=3,'Hemisferio'=3,'Género'=3,'Edad factorizada (7 niveles)'=3,'Edad factorizada (3 niveles)'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Los valores de **hierro** no son normales, pero presentan homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, edad factorizada, género), a excepción del hemisferio. 

Los valores de **difusividad axial** son normales, pero presentan homocedasticidad de varianza entre los niveles de las variables categóricas de interés (hemisferio, edad factorizada, género), a excepción del subgrupo.

Los valores de **difusividad media** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas hemisferio y edad factorizada y con heterocedasticidad de varianza entre los niveles de las variables categóricas subgrupo y género.

Los valores de **difusividad radial** no son normales, pero presentan homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, hemisferio, edad factorizada), a excepción del género.

Los valores de **anisotropía fraccional** son normales, con homocedasticidad de varianza entre los niveles de las variables categóricas de interés (subgrupo, hemisferio, edad factorizada, género).

**Por tanto, de todas las métricas, el hierro y la difusividad radial no siguen una distribución normal, y, todas las métricas, a excepción de la anisotropía fraccional, presentan heterocedasticidad para alguna de las variables categóricas independientes de interés.** Posteriormente, en la generación de los modelos, se valorará el comportamiento de los residuos para decidir sobre la eliminación de outliers. 

Se intentará trabajar con todos los sujetos en los diferentes modelos porque mi interés es tener muestras homogéneas entre las diferentes métricas. En el caso que no se cumplan los criterios para aplicar métodos paramétricos, se procederá a generar métodos no paramétricos. De todas formas, se generarán ambos métodos para todas las métricas dado que también es de mi interés que los métodos sean homogéneos entre todas las métricas. 

### Normalidad multivariante

Siguiendo el patrón del análisis de normalidad multivariante aplicado para cada ATR por separado, se va a utilizar la función `mvn` del paquete `MVN` para generar los tests de normalidad multivariante. Se va testear la normalidad multivariante en 3 supuestos:

- Las 5 métricas de RM conjuntamente;
- Las 3 métricas de RM (AD, RD, MD) que parecen correlacionarse con el subgrupo HD;
- Las 2 métricas de RM (iron, FA) que parecen correlacionarse con el subgrupo preHD.

```{r ATRavg38.6, fig.width=5, fig.height=4, fig.align='center'}
# Para las 5 métricas de RM conjuntamente
library(MVN)
par(mfrow = c(1, 2))
ATR_avg<-ATR_DifIron_Df[,c('ATR_subgroup','ATR_hemisphere','ATR_Gender','ATR_agef2',
                           'ATR_Iron','ATR_AD','ATR_RD','ATR_MD','ATR_FA')]
# Valoración de la normalidad multivariante con todos los sujetos
ATR_mvn<-mvn(ATR_avg[-c(1:4)], mvnTest = 'royston', covariance = TRUE, desc = TRUE,
             univariateTest = 'SW', univariatePlot = 'qq',
             multivariatePlot = 'qq', multivariateOutlierMethod = 'quan',
             showOutliers = TRUE, showNewData = TRUE)
index<-rownames(ATR_mvn$newData)
ATR_avg_WoOut<-ATR_avg[c(index),]
table(ATR_avg$ATR_subgroup)
table(ATR_avg_WoOut$ATR_subgroup)
```

```{r ATRavg38.7, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación de los dos outliers
# más extremos, con distancias de Mahalanobis mayores de 30
par(mfrow = c(1, 2))
print(ATR_mvn$multivariateOutliers,max = 6)
newATR_avg<-ATR_avg[-c(34,89),]
ATR_avg[c(34,89),]
newATR_mvn<-mvn(newATR_avg[-c(1:4)], mvnTest = 'royston', covariance = TRUE,
                desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq',
                multivariatePlot = 'qq', multivariateOutlierMethod = 'quan',
                showOutliers = TRUE, showNewData = TRUE)
ATR_DifIron_Df_WoOut<-ATR_DifIron_Df[-c(34,89),]
```

```{r ATRavg38.8, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
ATRmultiNorm<-rbind(ATR_mvn$multivariateNormality, newATR_mvn$multivariateNormality)
rownames(ATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
ATRuniNorm<-cbind(ATR_mvn$univariateNormality, newATR_mvn$univariateNormality)
rownames(ATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
ATRuniDes<-rbind(ATR_mvn$Descriptives, newATR_mvn$Descriptives)
Variables<-rep(rownames(ATR_mvn$Descriptives),2)
ATRuniDes<-cbind(Variables, ATRuniDes)
rownames(ATRuniDes)<-NULL
```

```{r ATRavg38.9, echo=FALSE}
kableExtra::kable(ATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers habiendo considerado las 5 métricas conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.10, echo=FALSE}
kableExtra::kable(ATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las 5 métricas', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.11, echo=FALSE}
kableExtra::kable(ATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las 5 métricas', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=5, 'With elimination of outliers'=5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las 5 métricas conjuntamente**, se observa que no existe normalidad multivariante ni normalidad univariante para el hierro y la difusividad radial. Si se eliminaran todos los outliers detectados por la función `mvn`, se eliminarían 2 controles, 2 preHD y 10 HD, siendo más de un 10% de las observaciones. Decido eliminar exclusivamente los dos sujetos (dos HD, el mismo sujeto con su medida para cada ATR) con mayor distancia de Mahalanobis (mayor de 30), y, con ello, se consigue una normalidad multivariante y una normalidad univariante para todas las métricas a excepción del hierro.

```{r ATRavg38.12, fig.width=5, fig.height=4, fig.align='center'}
# Para las 3 métricas de RM correlacionadas con HD: AD, RD, MD
par(mfrow = c(1, 2))
ATR_avg<-ATR_DifIron_Df[,c('ATR_subgroup','ATR_hemisphere','ATR_Gender','ATR_agef2',
                           'ATR_Iron','ATR_AD','ATR_RD','ATR_MD','ATR_FA')]
# Valoración de la normalidad multivariante con todos los sujetos
ATR_mvn<-mvn(ATR_avg[-c(1:5,9)], mvnTest = 'royston', covariance = TRUE, desc = TRUE, 
             univariateTest = 'SW', univariatePlot = 'qq', 
             multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
             showOutliers = TRUE, showNewData = TRUE)
index<-rownames(ATR_mvn$newData)
ATR_avg_WoOut<-ATR_avg[c(index),]
table(ATR_avg$ATR_subgroup)
table(ATR_avg_WoOut$ATR_subgroup)
```

```{r ATRavg38.13, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación del outlier más
# extremo, con distancia de Mahalanobis mayor de 20 
par(mfrow = c(1, 2))
print(ATR_mvn$multivariateOutliers,max = 6)
newATR_avg<-ATR_avg[-c(34),]
ATR_avg[c(34),]
newATR_mvn<-mvn(newATR_avg[-c(1:5,9)], mvnTest = 'royston', covariance = TRUE,
                desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq',
                multivariatePlot = 'qq', multivariateOutlierMethod = 'quan',
                showOutliers = TRUE, showNewData = TRUE)
ATR_DifIron_Df_WoOut_ADRDMD<-ATR_DifIron_Df[-c(34),-c(7,11,12)]
ATR_DifIron_Df_ADRDMD<-ATR_DifIron_Df[,-c(7,11,12)]
```

```{r ATRavg38.14, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
ATRmultiNorm<-rbind(ATR_mvn$multivariateNormality, newATR_mvn$multivariateNormality)
rownames(ATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
ATRuniNorm<-cbind(ATR_mvn$univariateNormality, newATR_mvn$univariateNormality)
rownames(ATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
ATRuniDes<-rbind(ATR_mvn$Descriptives, newATR_mvn$Descriptives)
Variables<-rep(rownames(ATR_mvn$Descriptives),2)
ATRuniDes<-cbind(Variables, ATRuniDes)
rownames(ATRuniDes)<-NULL
```

\newpage

```{r ATRavg38.15, echo=FALSE}
kableExtra::kable(ATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers habiendo considerado las métricas AD, RD, MD conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.16, echo=FALSE}
kableExtra::kable(ATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las métricas AD, RD, MD', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.17, echo=FALSE}
kableExtra::kable(ATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las métricas AD, RD, MD', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=3, 'With elimination of outliers'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las métricas AD, RD y MD conjuntamente**, con todos los sujetos se observa que existe normalidad multivariante y normalidad univariante para las difusividades axial y media (no así para la difusividad radial), y, si se eliminaran todos los outliers detectados por la función `mvn`, se eliminarían 4 pacientes HD. 
Para generar una similitud con el análisis anterior (considerando las 5 métricas conjuntamente), se procede a eliminar el outlier con mayor distancia de Mahalanobis (sujeto 34, un HD, con una distancia mayor de 20), y, con ello, se conserva la normalidad multivariante y se consigue normalidad univariante para todas las métricas.

```{r ATRavg38.18, fig.width=5, fig.height=4, fig.align='center'}
# Para las 2 métricas de RM correlacionadas con preHD: Iron, FA
par(mfrow = c(1, 2))
ATR_avg<-ATR_DifIron_Df[,c('ATR_subgroup','ATR_hemisphere','ATR_Gender','ATR_agef2',
                           'ATR_Iron','ATR_AD','ATR_RD','ATR_MD','ATR_FA')]
# Valoración de la normalidad multivariante con todos los sujetos
ATR_mvn<-mvn(ATR_avg[-c(1:4,6:8)], mvnTest = 'royston', covariance = TRUE, desc = TRUE,
             univariateTest = 'SW', univariatePlot = 'qq',
             multivariatePlot = 'qq', multivariateOutlierMethod = 'quan',
             showOutliers = TRUE, showNewData = TRUE)
index<-rownames(ATR_mvn$newData)
ATR_avg_WoOut<-ATR_avg[c(index),]
table(ATR_avg$ATR_subgroup)
table(ATR_avg_WoOut$ATR_subgroup)
```

```{r ATRavg38.19, fig.width=5, fig.height=4, fig.align='center'}
# Valoración de la normalidad multivariante con eliminación de los 3 outliers más
# extremos, con distancias de Mahalanobis mayores de 20
par(mfrow = c(1, 2))
print(ATR_mvn$multivariateOutliers,max = 9)
newATR_avg<-ATR_avg[-c(88,73,51),]
ATR_avg[c(88,73,51),]
newATR_mvn<-mvn(newATR_avg[-c(1:4,6:8)], mvnTest = 'royston', covariance = TRUE,
                desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq',
                multivariatePlot = 'qq', multivariateOutlierMethod = 'quan',
                showOutliers = TRUE, showNewData = TRUE)
ATR_DifIron_Df_WoOut_IronFA<-ATR_DifIron_Df[-c(88,73,51),-c(8:10,12)]
ATR_DifIron_Df_IronFA<-ATR_DifIron_Df[,-c(8:10,12)]
```

```{r ATRavg38.20, echo=FALSE}
# Comparación de la normalidad multivariante sin y con eliminación de outliers
ATRmultiNorm<-rbind(ATR_mvn$multivariateNormality, newATR_mvn$multivariateNormality)
rownames(ATRmultiNorm)<-c('Without elimination of outliers', 'With elimination of outliers')

# Comparación de la normalidad univariante sin y con eliminación de outliers
ATRuniNorm<-cbind(ATR_mvn$univariateNormality, newATR_mvn$univariateNormality)
rownames(ATRuniNorm)<-NULL

# Estadísticos descriptivos sin y con eliminación de outliers para cada métrica
ATRuniDes<-rbind(ATR_mvn$Descriptives, newATR_mvn$Descriptives)
Variables<-rep(rownames(ATR_mvn$Descriptives),2)
ATRuniDes<-cbind(Variables, ATRuniDes)
rownames(ATRuniDes)<-NULL
```

```{r ATRavg38.21, echo=FALSE}
kableExtra::kable(ATRmultiNorm, caption = 'Comparación de la normalidad multivariante sin y con eliminación de outliers habiendo considerado las métricas Iron y FA conjuntamente', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.22, echo=FALSE}
kableExtra::kable(ATRuniNorm, caption = 'Comparación de la normalidad univariante sin y con eliminación de outliers para las métricas Iron y FA', booktabs = TRUE) %>%
  add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.23, echo=FALSE}
kableExtra::kable(ATRuniDes, caption = 'Comparación de los estadísticos descriptivos sin y con eliminación de outliers para las métricas Iron y FA', booktabs = TRUE) %>%
  pack_rows(index=c('Without elimination of outliers'=2, 'With elimination of outliers'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**Considerando las métricas iron y FA conjuntamente**, se observa que no existe normalidad multivariante ni normalidad univariante para el hierro. Si se eliminaran todos los outliers detectados por la función `mvn`, se eliminarían 4 controles, 3 preHD y 10 HD, siendo más de un 15% de las observaciones.
Para generar una similitud con los dos análisis anteriores, se procede a eliminar los outliers con mayor distancia de Mahalanobis (dos sujetos preHD 51 y 88, y, un sujeto control 73, los tres con distancias mayores a 20), y, con ello, se consigue la normalidad multivariante y la normalidad univariante para ambas métricas.

### Homocedasticidad de la matriz de varianza-covarianza

El **test de homogeneidad de las matrices de covarianza o suposición de homocedasticidad** es una suposición que debe cumplirse en el análisis multivariante, y, consiste en que múltiples grupos en un diseño experimental o test estadístico tengan matrices de covarianza iguales, es decir, las matrices de covarianza poblacional para las variables dependientes de cada grupo deben ser iguales. 

Las variables pueden no ser homocedásticas por dos razones principales:

- Una variable puede ser no normal;
- Una variable puede tener una relación con la transformación de otra variable.

El **test M de Box** (o test de Box para la equivalencia de matrices de covarianza que utiliza la distribución F) es un test paramétrico que se utiliza para comparar la variación en muestras multivariadas, es decir, determina si dos o más matrices de covarianza son iguales (homogéneas).

Un **inconveniente** de dicho test es su extremada sensibilidad a las desviaciones de la normalidad, es decir, los datos deben tener una distribución normal multivariada. Además, tiene muy poca potencia para tamaños de muestra pequeños (resultados no significativos en el contexto de muestras pequeñas no indican necesariamente que las matrices de covarianza sean iguales) y es demasiado sensible para muestras de gran tamaño (resultados falsamente significativos en muestras de gran tamaño, por lo que en este contexto se recomienda un alfa más pequeño).

La **hipótesis nula** p-valor superior a 0.05 es que las matrices de covarianza observadas para las variables dependientes son iguales en todos los grupos: un estadístico M de Box no significativo indica que las matrices de covarianza son iguales. 

La **hipótesis alternativa** con p-valor inferior a 0.05 indica que las matrices de covarianza son significativamente diferentes. El incumplimiento de la suposición de homogeneidad de las matrices de covarianza no siempre significa que no se puede ejecutar un análisis estadístico paramétrico. En MANOVA, aparecen `n` desiguales a medida que disminuyen los tamaños de muestra, violando la suposición de homogeneidad de covarianza; en estos casos, se debe utilizar la traza de Pillai por ser más robusta que otros tests como la traza de Hotelling o la Lambda de Wilks. 

Como se hizo en el caso de los tests de homocedasticidad univariante, se procede a calcular la homocedasticidad multivariante (para las 5 métricas, para las métricas AD-RD-MD y para las métricas Iron-FA) mediante los test M de Box para las variables independientes subgrupo, hemisferio, género y edad factorizada, con los dataframes sin y con la eliminación de outliers.

```{r ATRavg38.24, echo=FALSE}
library(heplots)
# Para las 5 métricas, sin eliminación de outliers
ATR_MBox_SG5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_subgroup,
                   data=ATR_DifIron_Df, cov=TRUE)
ATR_MBox_HEM5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_hemisphere,
                    data=ATR_DifIron_Df, cov=TRUE)
ATR_MBox_G5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_Gender,
                  data=ATR_DifIron_Df, cov=TRUE)
ATR_MBox_AGE5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_agef2,
                    data=ATR_DifIron_Df, cov=TRUE)
# Para las 5 métricas, con eliminación de outliers
ATR_MBoxWoOut_SG5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_subgroup,
                        data=ATR_DifIron_Df_WoOut, cov=TRUE)
ATR_MBoxWoOut_HEM5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_hemisphere,
                         data=ATR_DifIron_Df_WoOut, cov=TRUE)
ATR_MBoxWoOut_G5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_Gender,
                        data=ATR_DifIron_Df_WoOut, cov=TRUE)
ATR_MBoxWoOut_AGE5<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_agef2,
                          data=ATR_DifIron_Df_WoOut, cov=TRUE)

# Para las 3 métricas AD-RD-MD, sin eliminación de outliers
ATR_MBox_SG3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup,
                   data=ATR_DifIron_Df_ADRDMD, cov=TRUE)
ATR_MBox_HEM3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_hemisphere,
                    data=ATR_DifIron_Df_ADRDMD, cov=TRUE)
ATR_MBox_G3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_Gender,
                  data=ATR_DifIron_Df_ADRDMD, cov=TRUE)
ATR_MBox_AGE3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_agef2,
                    data=ATR_DifIron_Df_ADRDMD, cov=TRUE)
# Para las 3 métricas AD-RD-MD, con eliminación de outliers
ATR_MBoxWoOut_SG3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup,
                         data=ATR_DifIron_Df_WoOut_ADRDMD, cov=TRUE)
ATR_MBoxWoOut_HEM3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_hemisphere,
                         data=ATR_DifIron_Df_WoOut_ADRDMD, cov=TRUE)
ATR_MBoxWoOut_G3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_Gender,
                       data=ATR_DifIron_Df_WoOut_ADRDMD, cov=TRUE)
ATR_MBoxWoOut_AGE3<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_agef2,
                         data=ATR_DifIron_Df_WoOut_ADRDMD, cov=TRUE)

# Para las 2 métricas Iron-FA, sin eliminación de outliers
ATR_MBox_SG2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_subgroup,
                   data=ATR_DifIron_Df_IronFA, cov=TRUE)
ATR_MBox_HEM2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_hemisphere,
                    data=ATR_DifIron_Df_IronFA, cov=TRUE)
ATR_MBox_G2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_Gender,
                  data=ATR_DifIron_Df_IronFA, cov=TRUE)
ATR_MBox_AGE2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_agef2,
                    data=ATR_DifIron_Df_IronFA, cov=TRUE)
# Para las 2 métricas Iron-FA, con eliminación de outliers
ATR_MBoxWoOut_SG2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_subgroup,
                        data=ATR_DifIron_Df_WoOut_IronFA, cov=TRUE)
ATR_MBoxWoOut_HEM2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_hemisphere,
                         data=ATR_DifIron_Df_WoOut_IronFA, cov=TRUE)
ATR_MBoxWoOut_G2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_Gender,
                       data=ATR_DifIron_Df_WoOut_IronFA, cov=TRUE)
ATR_MBoxWoOut_AGE2<-boxM(cbind(ATR_Iron,ATR_FA)~ATR_agef2,
                         data=ATR_DifIron_Df_WoOut_IronFA, cov=TRUE)
```

```{r ATRavg38.25, echo=FALSE}
# Homocedasticidad para los dataframes SIN eliminación de outliers
Subgroup5<-round(c(ATR_MBox_SG5[[1]][[1]],ATR_MBox_SG5[[2]][[1]],ATR_MBox_SG5[[3]][[1]]),3)
Hemisphere5<-round(c(ATR_MBox_HEM5[[1]][[1]],ATR_MBox_HEM5[[2]][[1]],ATR_MBox_HEM5[[3]][[1]]),3)
Gender5<-round(c(ATR_MBox_G5[[1]][[1]],ATR_MBox_G5[[2]][[1]],ATR_MBox_G5[[3]][[1]]),3)
Age5<-round(c(ATR_MBox_AGE5[[1]][[1]],ATR_MBox_AGE5[[2]][[1]],ATR_MBox_AGE5[[3]][[1]]),3)

Subgroup3<-round(c(ATR_MBox_SG3[[1]][[1]],ATR_MBox_SG3[[2]][[1]],ATR_MBox_SG3[[3]][[1]]),3)
Hemisphere3<-round(c(ATR_MBox_HEM3[[1]][[1]],ATR_MBox_HEM3[[2]][[1]],ATR_MBox_HEM3[[3]][[1]]),3)
Gender3<-round(c(ATR_MBox_G3[[1]][[1]],ATR_MBox_G3[[2]][[1]],ATR_MBox_G3[[3]][[1]]),3)
Age3<-round(c(ATR_MBox_AGE3[[1]][[1]],ATR_MBox_AGE3[[2]][[1]],ATR_MBox_AGE3[[3]][[1]]),3)

Subgroup2<-round(c(ATR_MBox_SG2[[1]][[1]],ATR_MBox_SG2[[2]][[1]],ATR_MBox_SG2[[3]][[1]]),3)
Hemisphere2<-round(c(ATR_MBox_HEM2[[1]][[1]],ATR_MBox_HEM2[[2]][[1]],ATR_MBox_HEM2[[3]][[1]]),3)
Gender2<-round(c(ATR_MBox_G2[[1]][[1]],ATR_MBox_G2[[2]][[1]],ATR_MBox_G2[[3]][[1]]),3)
Age2<-round(c(ATR_MBox_AGE2[[1]][[1]],ATR_MBox_AGE2[[2]][[1]],ATR_MBox_AGE2[[3]][[1]]),3)

Variables<-rep(c('Chi-square','Df','P-value'),3)
ATR_HomoCov5<-cbind(Subgroup5,Hemisphere5,Gender5,Age5)
ATR_HomoCov3<-cbind(Subgroup3,Hemisphere3,Gender3,Age3)
ATR_HomoCov2<-cbind(Subgroup2,Hemisphere2,Gender2,Age2)
ATR_HomoCov<-rbind(ATR_HomoCov5,ATR_HomoCov3,ATR_HomoCov2)
ATR_HomoCov<-cbind(Variables,ATR_HomoCov)
ATR_HomoCov<-as.data.frame(ATR_HomoCov)
colnames(ATR_HomoCov)<-c('Variables','Subgrupo','Hemisferio','Género','Edad')

# Homocedasticidad para los dataframes CON eliminación de outliers
Subgroup5Wo<-round(c(ATR_MBoxWoOut_SG5[[1]][[1]],ATR_MBoxWoOut_SG5[[2]][[1]],ATR_MBoxWoOut_SG5[[3]][[1]]),3)
Hemisphere5Wo<-round(c(ATR_MBoxWoOut_HEM5[[1]][[1]],ATR_MBoxWoOut_HEM5[[2]][[1]],ATR_MBoxWoOut_HEM5[[3]][[1]]),3)
Gender5Wo<-round(c(ATR_MBoxWoOut_G5[[1]][[1]],ATR_MBoxWoOut_G5[[2]][[1]],ATR_MBoxWoOut_G5[[3]][[1]]),3)
Age5Wo<-round(c(ATR_MBoxWoOut_AGE5[[1]][[1]],ATR_MBoxWoOut_AGE5[[2]][[1]],ATR_MBoxWoOut_AGE5[[3]][[1]]),3)

Subgroup3Wo<-round(c(ATR_MBoxWoOut_SG3[[1]][[1]],ATR_MBoxWoOut_SG3[[2]][[1]],ATR_MBoxWoOut_SG3[[3]][[1]]),3)
Hemisphere3Wo<-round(c(ATR_MBoxWoOut_HEM3[[1]][[1]],ATR_MBoxWoOut_HEM3[[2]][[1]],ATR_MBoxWoOut_HEM3[[3]][[1]]),3)
Gender3Wo<-round(c(ATR_MBoxWoOut_G3[[1]][[1]],ATR_MBoxWoOut_G3[[2]][[1]],ATR_MBoxWoOut_G3[[3]][[1]]),3)
Age3Wo<-round(c(ATR_MBoxWoOut_AGE3[[1]][[1]],ATR_MBoxWoOut_AGE3[[2]][[1]],ATR_MBoxWoOut_AGE3[[3]][[1]]),3)

Subgroup2Wo<-round(c(ATR_MBoxWoOut_SG2[[1]][[1]],ATR_MBoxWoOut_SG2[[2]][[1]],ATR_MBoxWoOut_SG2[[3]][[1]]),3)
Hemisphere2Wo<-round(c(ATR_MBoxWoOut_HEM2[[1]][[1]],ATR_MBoxWoOut_HEM2[[2]][[1]],ATR_MBoxWoOut_HEM2[[3]][[1]]),3)
Gender2Wo<-round(c(ATR_MBoxWoOut_G2[[1]][[1]],ATR_MBoxWoOut_G2[[2]][[1]],ATR_MBoxWoOut_G2[[3]][[1]]),3)
Age2Wo<-round(c(ATR_MBoxWoOut_AGE2[[1]][[1]],ATR_MBoxWoOut_AGE2[[2]][[1]],ATR_MBoxWoOut_AGE2[[3]][[1]]),3)

ATR_HomoCovWo5<-cbind(Subgroup5Wo,Hemisphere5Wo,Gender5Wo,Age5Wo)
ATR_HomoCovWo3<-cbind(Subgroup3Wo,Hemisphere3Wo,Gender3Wo,Age3Wo)
ATR_HomoCovWo2<-cbind(Subgroup2Wo,Hemisphere2Wo,Gender2Wo,Age2Wo)
ATR_HomoCovWo<-rbind(ATR_HomoCovWo5,ATR_HomoCovWo3,ATR_HomoCovWo2)
ATR_HomoCovWo<-cbind(Variables,ATR_HomoCovWo)
ATR_HomoCovWo<-as.data.frame(ATR_HomoCovWo)
colnames(ATR_HomoCovWo)<-c('Variables','Subgrupo','Hemisferio','Género','Edad')
```

```{r ATRavg38.26, echo=FALSE}
kableExtra::kable(ATR_HomoCov, caption = 'Homocedasticidad de las matrices de covarianza, SIN eliminación de outliers', booktabs = TRUE) %>%
  pack_rows(index=c('Para las 5 métricas'=3, 'Para las métricas AD-RD-MD'=3, 'Para las métricas Iron-FA'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.27, echo=FALSE}
kableExtra::kable(ATR_HomoCovWo, caption = 'Homocedasticidad de las matrices de covarianza, CON eliminación de outliers', booktabs = TRUE) %>%
  pack_rows(index=c('Para las 5 métricas'=3, 'Para las métricas AD-RD-MD'=3, 'Para las métricas Iron-FA'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg38.25.1, echo=FALSE}
ATR_HomoCov_Wo<-cbind(ATR_HomoCov,ATR_HomoCovWo)
colnames(ATR_HomoCov_Wo)<-c(rep(c('Variables','Subgroup','Hemisphere','Gender','Age'),2))
kableExtra::kable(ATR_HomoCov_Wo, caption = 'Homocedasticidad de las matrices de covarianza, CON eliminación de outliers', booktabs = TRUE) %>%
  pack_rows(index=c('For 5 metrics'=3, 'For diffusivity metrics'=3, 'For Iron-FA metrics'=3)) %>%
    add_header_above(header=c('Without elimination of outliers' = 5, 'With elimination of outliers' = 5)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el caso de las **5 métricas conjuntas**, tanto sin como con eliminación de outliers, se objetiva una falta de homocedasticidad multivariante para subgrupo, género y edad factorizada. 

En el caso de las **3 métricas de difusividad**, con el dataframe completo (sin eliminación de outliers), se objetiva una falta de homocedasticidad multivariante para subgrupo y género, y, con la eliminación de outliers, se objetiva una falta de homocedasticidad multivariante exclusivamente para género. 

En el caso de las **métricas de hierro y FA**, con el dataframe completo (sin eliminación de outliers), se objetiva homocedasticidad multivariante para las 4 variables independientes (subgrupo, hemisferio, género y edad factorizada), y, con la eliminación de outliers, se objetiva una falta de homocedasticidad multivariante exclusivamente para hemisferio.

\newpage

# ANÁLISIS del average: ambos ATR conjuntamente

El interés de este análisis radica en dos puntos:

- Determinar la existencia o la ausencia de diferencias entre hemisferios (la lateralidad derecha/izquierda puede ser un factor confusor en la relación de las métricas de RM con el efecto de la enfermedad, ó, en relación a la fisiopatología de la enfermedad con una afectación diferencial temporo-espaial de los ATRs);
- Valorar conjuntamente ambos ATR con el objetivo de ganar potencia estadística dado que se ha observado una correlación entre los valores de AD-RD-MD con el grupo HD y entre los valores iron-FA con el grupo preHD.

## MANOVA 

MANOVA (*Multivariate ANOVA* o *Multivariate ANalysis Of VAriance*, análisis multivariante de la varianz) es una extensión del ANOVA, pero MANOVA incluye al menos dos variables dependientes para analizar diferencias de las matrices de covarianzas procedentes de las variables dependientes entre múltiples grupos (factores). MANOVA en R utiliza por defecto el **test de Pillai**, que es el de mayor poder estadístico, para los cálculos, aunque se pueden utilizar otros tests (lambda de Wilk, raíz mayor de Roy o test de Hotelling-Lawley), y, luego se convierte en un estadístico F para determinar la significancia de las diferencias de medias grupales. 

El ANOVA suele sufrir de errores de tipo I que se producen con la realización de múltiples ANOVA para cada variable dependiente. En cambio, MANOVA determina la exsitencia de diferencias de grupo basándose en la información combinada de múltiples variables dependientes. Debido a que MANOVA utiliza más de una variable dependiente, las hipótesis nula y alternativa cambian ligeramente:

- **H0**: Los vectores medios de grupo son los mismos para todos los grupos o no difieren significativamente;
- **H1**: Al menos uno de los vectores medios del grupo es diferente del resto.

MANOVA es una técnica paramétrica que implica ciertos **supuestos** sobre los parámetros de la población de la que se toman las muestras y dichas suposiciones son más restrictivas que en el caso del ANOVA:

- **Normalidad multivariada**: cada combinación de variables independientes o dependientes debe tener una distribución normal multivariada. Los errores también deben ajustarse a la **normalidad multivariada** (es decir, se distribuyen normalmente en todas las dimensiones);
- Toda la **matriz de varianza-covarianza es homogénea/homocedástica** (es decir, las varianzas de todas las variables y las covarianzas entre todos los pares de variables son iguales en todos los grupos);
- **Sin multicolinealidad**: las variables dependientes no deben tener correlaciones muy altas.
- **Sin valores atípicos**: no debería haber valores atípicos en las variables dependientes.
- **Linealidad**: las variables dependientes deben tener una relación lineal con cada grupo de la variable independiente (factor).
- **Independencia de las observaciones**: las unidades son intercambiables entre sí.

El supuesto de normalidad multivariada se ha comprobado en los pasos anteriores y se cumple. 

El supuesto de homocedasticidad de las matrices de varianza no se cumple para todas las variables independientes (factores), pero, como se comentó en el paso anterior, el incumplimiento de esta suposición no siempre significa que no se puedan ejecutar análisis estadísticos paramétricos, sobretodo cuando aparecen `n` desiguales a medida que disminuyen los tamaños de muestra (siendo este el caso para la variable género en el subgrupo preHD), y, en estos casos, se debe utilizar la traza de Pillai por ser más robusta que otros tests como la traza de Hotelling o la Lambda de Wilks, siendo la traza de Pillai la de defecto en MANOVA. 

El supuesto de multicolinealidad tampoco se cumple entre las métricas de difusión, con una alta correlación entre las métricas de difusividad (AD-RD-MD) y entre la difusividad radial (RD) y la anisotropía fraccional (FA). 

```{r ATRavg39.1}
# Correlación entre las métricas de ambos ATR
cor(ATR_DifIron_Df[,7:11])
```

La existencia de outliers se ha solucionado en el paso de evaluación de normalidad multivariante, pero he sido conservadora a la hora de eliminar los outliers, es decir, no he eliminado todos los sujetos detectados por la función `mvn` como outliers. 

La linealidad de las variables dependientes con cada grupo de cada factor se ha comprobado gráficamente mediante qqplots. 

Y, por último, las observaciones son independientes entre sí. 

Para aplicar MANOVA en R, se debe cumplir una **condición crítica**: el número de observaciones (filas) por grupo de la variable independiente debe ser mayor al número de variables dependientes. Este punto puede ser conflictivo en el género masculino para el subgrupo preHD, donde sólo existe un varón. 

Si el MANOVA es significativo, se puede medir el **tamaño del efecto** mediante la métrica `Eta cuadrado parcial`, la cual mide el efecto que tiene la variable independiente sobre las variables dependientes: si el valor es 0,14 o mayor, se puede afirmar que el tamaño del efecto es grande. 

Para ejecutar MANOVA, se utiliza la función `manova` del paquete `stats`. Se utilizan los dataframes con eliminación de outliers dado que son los que presentan normalidad multivariante. Se generan MANOVAs para las 5 métricas conjuntas, para las 3 métricas de difusividad (AD, RD, MD) y para las métricas de hierro y anistropía fraccional. El primer modelo generado consiste en las 4 variables independientes en interacción y los modelos subsiguientes con simplificación de las interacciones y/o del número de factores en función de los resultados del primer modelo. 

### 5 Métricas

```{r ATRavg39.2}
# Para las 5 métricas conjuntamente 
# Generar los MANOVAS
ATR_manova5_1<-manova(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~
                        ATR_subgroup*ATR_hemisphere*ATR_Gender*ATR_agef2, 
                      data=ATR_DifIron_Df_WoOut)
summary(ATR_manova5_1)

ATR_manova5_2<-manova(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_subgroup+
                        ATR_hemisphere+ATR_agef2+ATR_subgroup:ATR_agef2+
                        ATR_Gender:ATR_agef2, data=ATR_DifIron_Df_WoOut)
summary(ATR_manova5_2)

# Generar effect size
library(effectsize)
ATR_SizeMan5_2<-effectsize::eta_squared(ATR_manova5_2);ATR_SizeMan5_2
```

En el caso de las **5 métricas conjuntas**, se objetiva que los factores subgrupo y edad factorizada, y, las interacciones subgrupo-edad factorizada, edad-factorizada-género son los términos significativos, destacando un *size effect* de `r round(ATR_SizeMan5_2[1,2],2)` para subgrupo y de `r round(ATR_SizeMan5_2[3,2],2)` para la edad factorizada. Remarcar que la interacción subgrupo-hemisferio no ha resultado significativa y que el factor hemisferio es casi significativo (con un pvalor de `r round(summary(ATR_manova5_1)[[4]][2,6],3)`). 

### 3 Métricas de difusividad 

Como se verá a continuación, los modelos MANOVA generados con las 3 métricas de difusividad especifican que los residuos son rango-deficientes y se ha de especificar el argumento `tol=0` para poder ver el resultado/resumen del modelo. El problema de especificar tolerancia 0 es que los resultados pueden ser inexactos, con lo que transformar las respuestas/variables dependientes para eliminar la alta correlación es mejor opción. Además, cuando los residuos son rango-deficientes, no se permite calcular el *effect size*.

```{r ATRavg39.3}
# Para las 3 métricas AD-RD-MD - Sin transformación de variables
# Generar los MANOVAS
ATR_manova3_1<-manova(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup*
                        ATR_hemisphere*ATR_Gender*ATR_agef2,  
                       data=ATR_DifIron_Df_WoOut_ADRDMD)
summary(ATR_manova3_1)
summary(ATR_manova3_1,tol=0)

ATR_manova3_2<-manova(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup+
                        ATR_hemisphere+ATR_Gender+ATR_agef2,
                       data=ATR_DifIron_Df_WoOut_ADRDMD)
summary(ATR_manova3_2)
summary(ATR_manova3_2,tol=0)

ATR_manova3_3<-manova(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup+ATR_hemisphere,
                       data=ATR_DifIron_Df_WoOut_ADRDMD)
summary(ATR_manova3_3)
summary(ATR_manova3_3,tol=0)

# Generar effect size
ATR_SizeMan3_3<-effectsize::eta_squared(ATR_manova3_3);ATR_SizeMan3_3
```

En el caso de las **3 métricas AD-RD-MD sin transformación logarítmica**, se objetiva que subgrupo es el único término significativo y que hemisferio es casi significativo (con un p-valor de `r round(summary(ATR_manova3_2,tol=0)[[4]][2,6],2)`); debido a que los residuos son rango deficientes, no se permite obtener el *effect size*. 

Las difusividades media, axial y radial (las 3 métricas con la misma unidad de medida $mm^2/s$, con valores muy próximos a cero dado que los valores se hallan en el rango de $10^{-4}-10^{-5}$) son las variables con mayor correlación entre sí. Se procede a la transformación logarítmica con la función `log`, por seguir un paralelismo con la transformación realizada en el análisis MANOVA de cada ATR por separado. 

```{r ATRavg39.4, fig.width=5, fig.height=4, fig.align='center'}
# Para las 3 métricas AD-RD-MD - Con transformación logarítmica de las métricas 
# Primero transformación de las variables
ATR_DifIron_Df_WoOut_ADRDMD_log<-cbind(ATR_DifIron_Df_WoOut_ADRDMD[,1:6],
                                      log(cbind(ATR_DifIron_Df_WoOut_ADRDMD[,7:9])))

# Comprobar normalidad multivariante
par(mfrow = c(1, 2))
ATR_mvnlog3<-mvn(ATR_DifIron_Df_WoOut_ADRDMD_log[-c(1:6)], mvnTest = 'royston',
                 covariance = TRUE, desc = TRUE, univariateTest = 'SW',
                 univariatePlot = 'qq', multivariatePlot = 'qq',
                 multivariateOutlierMethod = 'quan', showOutliers = TRUE,
                 showNewData = TRUE)
ATR_mvnlog3$multivariateNormality
ATR_mvnlog3$univariateNormality

# Comprobar homocedasticidad de la matriz de covarianzas
ATR_MBox_SG3log<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup,
                      data=ATR_DifIron_Df_WoOut_ADRDMD_log, cov=TRUE);ATR_MBox_SG3log
ATR_MBox_HEM3log<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_hemisphere,
                       data=ATR_DifIron_Df_WoOut_ADRDMD_log, cov=TRUE);ATR_MBox_HEM3log
ATR_MBox_G3log<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_Gender,
                     data=ATR_DifIron_Df_WoOut_ADRDMD_log, cov=TRUE);ATR_MBox_G3log
ATR_MBox_AGE3log<-boxM(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_agef2,
                       data=ATR_DifIron_Df_WoOut_ADRDMD_log, cov=TRUE);ATR_MBox_AGE3log

# Generar los MANOVAS
ATR_manova3_1log<-manova(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup*ATR_hemisphere*
                           ATR_Gender*ATR_agef2,data=ATR_DifIron_Df_WoOut_ADRDMD_log)
summary(ATR_manova3_1log)

ATR_manova3_2log<-manova(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup+ATR_hemisphere+
                           ATR_Gender+ATR_agef2,data=ATR_DifIron_Df_WoOut_ADRDMD_log)
summary(ATR_manova3_2log)

ATR_manova3_3log<-manova(cbind(ATR_AD,ATR_RD,ATR_MD)~ATR_subgroup+ATR_hemisphere,
                         data=ATR_DifIron_Df_WoOut_ADRDMD_log)
summary(ATR_manova3_3log)

# Generar effect size
ATR_SizeMan3_3log<-effectsize::eta_squared(ATR_manova3_3log);ATR_SizeMan3_3log
```

En el caso de las **3 métricas AD-RD-MD con transformación logarítmica**, se objetiva que subgrupo es el único factor significativo con un *effect size* de `r round(ATR_SizeMan3_3log[1,2],2)`, y, que hemisferio es casi significativo (con un p-valor de `r round(summary(ATR_manova3_3log)[[4]][2,6],2)`) pero con *effect size* no significativo. Cabe destacar que la normalidad multivariante y la homocedasticidad de la matriz de covarianzas para hemisferio y edad factorizada se mantienen, pero se pierde la homocedasticidad de la matriz de covarianzas para subgrupo, hecho que puede sesgar el test de MANOVA, y, la heterocedasticidad de la matriz de covarianzas persiste para género.

### 2 Métricas Iron-FA

```{r ATRavg39.5}
# Para las 2 métricas Iron-FA
# Generar los MANOVAS
ATR_manova2_1<-manova(cbind(ATR_Iron,ATR_FA)~ATR_subgroup*ATR_hemisphere*
                        ATR_Gender*ATR_agef2,data=ATR_DifIron_Df_WoOut_IronFA)
summary(ATR_manova2_1)

ATR_manova2_2<-manova(cbind(ATR_Iron,ATR_FA)~ATR_subgroup+ATR_hemisphere+
                        ATR_Gender:ATR_agef2,data=ATR_DifIron_Df_WoOut_IronFA)
summary(ATR_manova2_2)

# Generar effect size
library(effectsize)
ATR_SizeMan2_2<-effectsize::eta_squared(ATR_manova2_2);ATR_SizeMan2_2
```

En el caso de las **2 métricas Iron-FA**, el hemisferio y la interacción género-edad factorizada son los dos términos significativos, y, el subgrupo es casi significativo con p-valor de `r round(summary(ATR_manova2_2)[[4]][1,6],2)`, destacando tan sólo el *effect size* para hemisferio (`r round(ATR_SizeMan2_2[2,2],2)`). Remarcar que la interacción subgrupo-hemisferio no ha resultado significativa. 

**En resumen, la interacción subgrupo-hemisferio no es significativa en ninguna de las combinaciones métricas. Los términos significativos han sido los siguientes:** 

- **Con las 5 métricas conjuntas, subgrupo, edad factorizada y las interacciones subgrupo-edad y edad-género;**
- **Con las 3 métricas de difusividad, subgrupo;**
- **Con las métricas de iron y FA, hemisferio y la interacción género-edad.**

**También es importante remarcar que tanto el análisis conjunto de ambos ATRs como el análisis de cada ATR por separado detectan el subgrupo como factor significativo con la evalución de las 5 métricas conjuntamente y con las 3 métricas de difusividad, y, el análisis conjunto de ambos ATRs no aumenta la sensibilidad para detectar diferencias entre subgrupos en el análisis conjunto de las métricas iron-FA.** 

```{r ATRavg39.5.1, echo=FALSE, eval=FALSE}
# **Resumen de los modelos MANOVA**
kable(list(summary(ATR_manova5_1)$stats,summary(ATR_manova5_2)$stats),
      caption='5-metrics MANOVA without logarithmic transformation for both ATR', booktabs=TRUE) %>%
    kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(ATR_manova3_1,tol=0)$stats,summary(ATR_manova3_2,tol=0)$stats,summary(ATR_manova3_3,tol=0)$stats),
      caption='3-metrics MANOVA without logarithmic transformation for both ATR', booktabs=TRUE) %>%
    kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(ATR_manova3_1log)$stats,summary(ATR_manova3_2log)$stats,summary(ATR_manova3_3log)$stats),
      caption='3-metrics MANOVA with logarithmic transformation for both ATR', booktabs=TRUE) %>%
    kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(summary(ATR_manova2_1)$stats,summary(ATR_manova2_2)$stats),
      caption='2-metrics MANOVA without logarithmic transformation for both ATR', booktabs=TRUE) %>%
    kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### Comparaciones pareadas

Para determinar qué subgrupo difiere del resto, se genera un test post hoc mediante el **Análisis Discriminante Lineal (LDA)**, el cual encuentra una combinación lineal de las variables dependientes (*features*) que mejor separa dos o más grupos. Se utiliza la función `lda` del paquete `MASS`.

Se van a analizar aquellos MANOVA que han detectado el subgrupo como factor significativo y se van a utilizar los dataframes con transformaciones logarítmicas dado que sin dichas transformaciones la función `lda` expone que las variables de difusividad media, radial y axial son constantes (probablemente debido a sus valores muy próximos a cero), como se verá a continuación. En el caso de las 5 métricas evaluadas conjuntamente, se realiza la transformación logarítmica de las 3 métricas de difusividad y se comprueba la normalidad multivariante como la homocedasticidad de la matriz de covarianzas, dado que no se había ejecutado en el MANOVA anterior (no se ejecutó porque los residuos no eran rango-deficientes).

```{r ATRavg39.6.1, fig.align='center'}
library(MASS)
# Para las 5 métricas

# Primero, división del dataframe sin transformación logarítmica en los datasets 
# de entrenamiento y testeo
set.seed(123456)
train_index<-createDataPartition(ATR_DifIron_Df_WoOut$ATR_subgroup, p=0.8, list=FALSE)
train<-ATR_DifIron_Df_WoOut[train_index,]
test<-ATR_DifIron_Df_WoOut[-train_index,]
# Segundo, se genera el modelo LDA
ATR_LDA5model<-lda(ATR_subgroup~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA), data=train)

# Segundo, con el dataframe con transformación logarítmica
## Primero transformación de las variables
ATR_DifIron_Df_WoOut_log<-cbind(ATR_DifIron_Df_WoOut[,1:7],log(cbind(ATR_DifIron_Df_WoOut[,8:10])),
                                ATR_DifIron_Df_WoOut[,11])
colnames(ATR_DifIron_Df_WoOut_log)<-colnames(ATR_DifIron_Df_WoOut[-12])
## Comprobar normalidad multivariante
par(mfrow = c(1, 2))
ATR_mvnlog5<-mvn(ATR_DifIron_Df_WoOut_log[-c(1:6)], mvnTest = 'royston', covariance = TRUE, 
             desc = TRUE, univariateTest = 'SW', univariatePlot = 'qq', 
             multivariatePlot = 'qq', multivariateOutlierMethod = 'quan', 
             showOutliers = TRUE, showNewData = TRUE)
ATR_mvnlog5$multivariateNormality
ATR_mvnlog5$univariateNormality
## Comprobar homocedasticidad de la matriz de covarianzas
ATR_MBox_SG5log<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_subgroup,
                      data=ATR_DifIron_Df_WoOut_log, cov=TRUE);ATR_MBox_SG5log
ATR_MBox_HEM5log<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_hemisphere,
                      data=ATR_DifIron_Df_WoOut_log, cov=TRUE);ATR_MBox_HEM5log
ATR_MBox_G5log<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_Gender,
                     data=ATR_DifIron_Df_WoOut_log, cov=TRUE);ATR_MBox_G5log
ATR_MBox_AGE5log<-boxM(cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA)~ATR_agef2,
                       data=ATR_DifIron_Df_WoOut_log, cov=TRUE);ATR_MBox_AGE5log
```

```{r ATRavg39.6.2, echo=FALSE, eval=FALSE}
ATRmultiNorm<-rbind(ATR_mvnlog5$multivariateNormality, ATR_mvnlog3$multivariateNormality)
rownames(ATRmultiNorm)<-c('Log Transformation of Diffusivity metrics for 5-metric model of both ATR', 'Log Transformation of Diffusivity metrics for 3-metric model of both ATR')

kableExtra::kable(ATRmultiNorm, caption = 'Multivariate normality assessment for the 3-diffusivity metric model with logarithmic transformation in case of both ATR', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg39.6.3, echo=FALSE, eval=FALSE}
Subgroup5log<-round(c(ATR_MBox_SG5log[[1]][[1]],ATR_MBox_SG5log[[2]][[1]],ATR_MBox_SG5log[[3]][[1]]),3)
Hemisphere5log<-round(c(ATR_MBox_HEM5log[[1]][[1]],ATR_MBox_HEM5log[[2]][[1]],ATR_MBox_HEM5log[[3]][[1]]),3)
Gender5log<-round(c(ATR_MBox_G5log[[1]][[1]],ATR_MBox_G5log[[2]][[1]],ATR_MBox_G5log[[3]][[1]]),3)
Age5log<-round(c(ATR_MBox_AGE5log[[1]][[1]],ATR_MBox_AGE5log[[2]][[1]],ATR_MBox_AGE5log[[3]][[1]]),3)

Subgroup3log<-round(c(ATR_MBox_SG3log[[1]][[1]],ATR_MBox_SG3log[[2]][[1]],ATR_MBox_SG3log[[3]][[1]]),3)
Hemisphere3log<-round(c(ATR_MBox_HEM3log[[1]][[1]],ATR_MBox_HEM3log[[2]][[1]],ATR_MBox_HEM3log[[3]][[1]]),3)
Gender3log<-round(c(ATR_MBox_G3log[[1]][[1]],ATR_MBox_G3log[[2]][[1]],ATR_MBox_G3log[[3]][[1]]),3)
Age3log<-round(c(ATR_MBox_AGE3log[[1]][[1]],ATR_MBox_AGE3log[[2]][[1]],ATR_MBox_AGE3log[[3]][[1]]),3)

Variables<-c('Chi-square','Df','P-value')
ATR_HomoCov5log<-cbind(Variables,Subgroup5log,Hemisphere5log,Gender5log,Age5log)
ATR_HomoCov3log<-cbind(Variables,Subgroup3log,Hemisphere3log,Gender3log,Age3log)
ATR_HomoCovlog<-rbind(ATR_HomoCov5log,ATR_HomoCov3log)
ATR_HomoCovlog<-as.data.frame(ATR_HomoCovlog)
colnames(ATR_HomoCovlog)<-c('Variables','Subgroup','Hemisphere','Gender','Age')

kableExtra::kable(ATR_HomoCovlog, caption = 'Covariance-Variance Matrix Homoscedasticity assessment for the 5-metric and 3-metric models with logarithmic transformation in case of both ATR', booktabs = TRUE) %>%
  pack_rows(index=c('Both ATR'=6)) %>%
  pack_rows(index=c('5-metric model'=3, '3-metric model'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg39.6.4, echo=FALSE, eval=FALSE}
MultiNormLog<-rbind(RATRmultiNormLog,LATRmultiNormLog,ATRmultiNorm)
kableExtra::kable(MultiNormLog, caption = 'Multivariate normality assessment for log transformation of diffusivity metrics in 5-metric and 3-metric models', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Con la transformación logarítmica, se mantiene la variabilidad multivariante, persiste la heterocedasticidad de la matriz de covarianzas para los factores subgrupo, género y edad factorizada y se mantiene la homocedasticidad de la matriz de covarianzas para el factor hemisferio. Las heterocedasticidades podrían sesgar los resultados en la ejecución de un MANOVA (no se ha ejecutado dado que en el paso anterior el modelo no generaba residuos rango-deficientes).

```{r ATRavg39.7, fig.align='center'}
# Se repiten el primer y segundo paso con el dataframe con transformación logarítmica

## Se generan los dos datasets 
set.seed(123456)

train_index<-createDataPartition(ATR_DifIron_Df_WoOut_log$ATR_subgroup, p=0.8, list=FALSE)
train<-ATR_DifIron_Df_WoOut_log[train_index,]
test<-ATR_DifIron_Df_WoOut_log[-train_index,]

## Se genera el LDA
ATR_LDAlog5model<-lda(ATR_subgroup~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),data=train)
print(ATR_LDAlog5model)

# Se genera el plot
##Define colors for each subgroup
subgroup_colors <- c("1" = "red", "2" = "green", "3" = "blue")
## Plot the model with custom colors for species
plot(ATR_LDAlog5model, col = subgroup_colors, 
     main="Visualization of 5log-LDA model of both ATR")
legend('bottomright',inset=0.05, bty='n', cex=0.5, legend=c('1.Control','2.PreHD','3.HD'),
       fill=c('red','green','blue'))

# Se predicen las clases
predClas_ATRLDA5<-predict(ATR_LDAlog5model, newdata = test, type='class')
test_subgroup<-as.character(test$ATR_subgroup)
test_subgroup<-factor(test_subgroup, levels = levels(predClas_ATRLDA5$class))
table(predClas_ATRLDA5$class, test_subgroup)

ATR_LDA5log_DF<-data.frame(
  predicted_class=predClas_ATRLDA5$class,
  subgroup=test[,'ATR_subgroup'],
  lda=predClas_ATRLDA5$x
)
str(ATR_LDA5log_DF)
ggplot(ATR_LDA5log_DF) +
  geom_text(aes(x=lda.LD1,y=lda.LD2,label=subgroup, color = predicted_class)) +
  theme_classic() + ggtitle('LDA results for 5log-LDA model of both ATR')

# Evaluación del modelo
## Accuracy
accuracyATR_LDAlog5<-sum(diag(table(predClas_ATRLDA5$class, test$ATR_subgroup)))/nrow(test)
accuracyATR_LDAlog5

## Confusion Matrix
confMX_ATR_LDA5log<-confusionMatrix(predClas_ATRLDA5$class, test$ATR_subgroup)
confMX_ATR_LDA5log

## ROC curves one vs the rest by multiROC package 
Control_pred_ATRLDA5log<- predClas_ATRLDA5$posterior[,'1']
PreHD_pred_ATRLDA5log<- predClas_ATRLDA5$posterior[,'2']
HD_pred_ATRLDA5log<- predClas_ATRLDA5$posterior[,'3']
Control_true<-ifelse(test$ATR_subgroup=='1',1,0)
PreHD_true<-ifelse(test$ATR_subgroup=='2',1,0)
HD_true<-ifelse(test$ATR_subgroup=='3',1,0)
DF_ROC_ATRLDA5log<-cbind(Control_true,PreHD_true,HD_true,Control_pred_ATRLDA5log,
                         PreHD_pred_ATRLDA5log,HD_pred_ATRLDA5log)
multiROC_ATR_LDA5log<-multi_roc(DF_ROC_ATRLDA5log)
multiROC_ATR_LDA5log_DF<-plot_roc_data(multiROC_ATR_LDA5log)
ggplot(multiROC_ATR_LDA5log_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "5-LDA model of both ATR ROC curve: One vs Rest",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_ATR_LDA5log_DF$AUC[multiROC_ATR_LDA5log_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_ATR_LDA5log_DF$AUC[multiROC_ATR_LDA5log_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_ATR_LDA5log_DF$AUC[multiROC_ATR_LDA5log_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_ATR_LDA5log_DF$AUC[multiROC_ATR_LDA5log_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_ATR_LDA5log_DF$AUC[multiROC_ATR_LDA5log_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)

## Kappa coefficient
library(irr)
kappa_ATR_LDA5log<-kappam.fleiss(data.frame(predClas_ATRLDA5$class,test$ATR_subgroup))
kappa_ATR_LDA5log
```

```{r ATRavg39.8, fig.align='center'}
library(MASS)
# Para las 3 métricas con el dataframe sin transformación logarítmica
## Primero, se generan los dos datasets (entrenamiento y testeo)
set.seed(123456)
train_index<-createDataPartition(ATR_DifIron_Df_WoOut_ADRDMD$ATR_subgroup, p=0.8, list=FALSE)
train<-ATR_DifIron_Df_WoOut_ADRDMD[train_index,]
test<-ATR_DifIron_Df_WoOut_ADRDMD[-train_index,]
## Se genera el LDA
ATR_LDA3model<-lda(ATR_subgroup~cbind(ATR_AD,ATR_RD,ATR_MD),data=train)

# Para las 3 métricas con el dataframe con transformación logarítmica
## Primero, se generan los dos datasets (entrenamiento y testeo)
set.seed(123456)
train_index<-createDataPartition(ATR_DifIron_Df_WoOut_ADRDMD_log$ATR_subgroup, p=0.8, list=FALSE)
train<-ATR_DifIron_Df_WoOut_ADRDMD_log[train_index,]
test<-ATR_DifIron_Df_WoOut_ADRDMD_log[-train_index,]
## Se genera el LDA
ATR_LDAlog3model<-lda(ATR_subgroup~cbind(ATR_AD,ATR_RD,ATR_MD),data=train)
print(ATR_LDAlog3model)

# Se genera el plot del modelo
##Define colors for each subgroup
subgroup_colors <- c("1" = "red", "2" = "green", "3" = "blue")
## Plot the model with custom colors for species
plot(ATR_LDAlog3model, col = subgroup_colors, 
     main="Visualization of 3log-LDA model of both ATR")
legend('bottomright',inset=0.05, bty='n', cex=0.5, legend=c('1.Control','2.PreHD','3.HD'),
       fill=c('red','green','blue'))

# Se predicen las clases
predClas_ATRLDA3<-predict(ATR_LDAlog3model, newdata = test, type='class')
test_subgroup<-as.character(test$ATR_subgroup)
test_subgroup<-factor(test_subgroup, levels = levels(predClas_ATRLDA3$class))
table(predClas_ATRLDA3$class, test_subgroup)
# Se predicen las clases
predClas_ATRLDA3<-predict(ATR_LDAlog3model, newdata = test, type='class')
test_subgroup<-as.character(test$ATR_subgroup)
test_subgroup<-factor(test_subgroup, levels = levels(predClas_ATRLDA3$class))
table(predClas_ATRLDA3$class, test_subgroup)

ATR_LDA3log_DF<-data.frame(
  predicted_class=predClas_ATRLDA3$class,
  subgroup=test[,'ATR_subgroup'],
  lda=predClas_ATRLDA3$x
)
str(ATR_LDA3log_DF)
ggplot(ATR_LDA3log_DF) + 
  geom_text(aes(x=lda.LD1,y=lda.LD2,label=subgroup, color = predicted_class)) +
  theme_classic() + ggtitle('LDA results for 3log-LDA model of both ATR')

# Evaluación del modelo
## Accuracy
accuracyATR_LDAlog3<-sum(diag(table(predClas_ATRLDA3$class, test$ATR_subgroup)))/nrow(test)
accuracyATR_LDAlog3

## Confusion Matrix
confMX_ATR_LDA3log<-confusionMatrix(predClas_ATRLDA3$class, test$ATR_subgroup)
confMX_ATR_LDA3log

## ROC curves one vs the rest by multiROC package 
Control_pred_ATRLDA3log<- predClas_ATRLDA3$posterior[,'1']
PreHD_pred_ATRLDA3log<- predClas_ATRLDA3$posterior[,'2']
HD_pred_ATRLDA3log<- predClas_ATRLDA3$posterior[,'3']
Control_true<-ifelse(test$ATR_subgroup=='1',1,0)
PreHD_true<-ifelse(test$ATR_subgroup=='2',1,0)
HD_true<-ifelse(test$ATR_subgroup=='3',1,0)
DF_ROC_ATRLDA3log<-cbind(Control_true,PreHD_true,HD_true,Control_pred_ATRLDA3log,
                         PreHD_pred_ATRLDA3log,HD_pred_ATRLDA3log)
multiROC_ATR_LDA3log<-multi_roc(DF_ROC_ATRLDA3log)
multiROC_ATR_LDA3log_DF<-plot_roc_data(multiROC_ATR_LDA3log)
ggplot(multiROC_ATR_LDA3log_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "3-LDA model of both ATR ROC curve: One vs Rest",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_ATR_LDA3log_DF$AUC[multiROC_ATR_LDA3log_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_ATR_LDA3log_DF$AUC[multiROC_ATR_LDA3log_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_ATR_LDA3log_DF$AUC[multiROC_ATR_LDA3log_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_ATR_LDA3log_DF$AUC[multiROC_ATR_LDA3log_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_ATR_LDA3log_DF$AUC[multiROC_ATR_LDA3log_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)

## Kappa coefficient
library(irr)
kappa_ATR_LDA3log<-kappam.fleiss(data.frame(predClas_ATRLDA3$class,test$ATR_subgroup))
kappa_ATR_LDA3log
```

**A diferencia del análisis realizado con los ATRs derecho e izquierdo por separado, los subgrupos logran diferenciarse entre sí, especialmente con el uso de las 5 métricas, a pesar de que existe solapamiento entre los 3 subgrupos.**

```{r ATRavg39.9, echo=FALSE}
# Summary Table
overallConfMx<-cbind(confMX_RATR_LDA5log$overall,confMX_RATR_LDA3log$overall,
                     confMX_LATR_LDA5log$overall,confMX_LATR_LDA3log$overall,
                     confMX_ATR_LDA5log$overall,confMX_ATR_LDA3log$overall)
FleissKappa<-cbind(kappa_RATR_LDA5log$value,kappa_RATR_LDA3log$value,
                   kappa_LATR_LDA5log$value,kappa_LATR_LDA3log$value,
                   kappa_ATR_LDA5log$value,kappa_ATR_LDA3log$value)
overallConfMx<-rbind(overallConfMx,FleissKappa)
overallConfMx<-round(overallConfMx,3)
rownames(overallConfMx)<-c(rownames(overallConfMx)[-8],'Fleiss_Kappa')
colnames(overallConfMx)<-c('LDA-5log-RATR','LDA-3log-RATR',
                           'LDA-5log-LATR','LDA-3log-LATR',
                           'LDA-5log-both ATR','LDA-3log-both ATR')
kable(overallConfMx,caption = 'Overall Statistics of Confusion Matrices', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

byclassConfMx<-rbind(confMX_RATR_LDA5log$byClass,confMX_RATR_LDA3log$byClass,
                     confMX_LATR_LDA5log$byClass,confMX_LATR_LDA3log$byClass,
                     confMX_ATR_LDA5log$byClass,confMX_ATR_LDA3log$byClass)
rownames(byclassConfMx)<-rep(c('Class: Control','Class: PreHD','Class: HD'),6)
byclassConfMx<-round(byclassConfMx,3)
kable(byclassConfMx[,1:7],caption = 'Statistics by Class of Confusion Matrices - Table 1', booktabs = TRUE) %>%
  pack_rows(index=c('LDA-5log for RATR'=3,'LDA-3log for RATR'=3,
                    'LDA-5log for LATR'=3,'LDA-3log for LATR'=3,
                    'LDA-5log for both ATR'=3,'LDA-3log for both ATR'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(byclassConfMx[,8:11],caption = 'Statistics by Class of Confusion Matrices - Table 2', booktabs = TRUE) %>%
  pack_rows(index=c('LDA-5log for RATR'=3,'LDA-3log for RATR'=3,
                    'LDA-5log for LATR'=3,'LDA-3log for LATR'=3,
                    'LDA-5log for both ATR'=3,'LDA-3log for both ATR'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

## PERMANOVA 

Como en el caso de los PERMANOVAS generados para los ATR derecho e izquierdo por separado, a pesar que PERMANOVA corresponde a una técnica no paramétrica, se decide generar PERMANOVAS con los dataframes originales (ATR_DifIron_Df, ATR_DifIron_ADRDMD, ATR_DifIron_IronFA) y con los dataframes generados con la eliminación de los outliers que se ha realizado en la normalidad multivariante (ATR_DifIron_Df_WoOut, ATR_DifIron_WoOut_ADRDMD, ATR_DifIron_WoOut_IronFA).

### Matriz de distancias

Se ha procedido a **calcular la matriz de distancias** con la función `daisy` del paquete `cluster` para poder visualizar las similaridades/disimilaridades entre subgrupos mediante MDS y tSNE. La **medida de distancia utilizada** ha sido **_euclidean_** dado que las variables dependientes (métricas de RM) son numéricas y no procedentes de especies. 

```{r ATRavg40.1, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 5 métricas - Sin eliminación de outliers
library(cluster)
dist<-daisy(ATR_DifIron_Df[,-c(1:6,12)],metric='euclidean')
distmx<-as.matrix(dist)

library(factoextra)
fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(ATR_DifIron_Df, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_Iron, ATR_AD, ATR_RD, ATR_MD, ATR_FA) %>% 
  tidyr::gather (key='variable', value='values', -x, -y, -ATR_subgroup, 
                 -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
library(ggplot2)
ggplot(df_mds_dist2,aes(x,y)) + geom_jitter(aes(col=ATR_subgroup)) + facet_wrap(~variable) 

library(Rtsne)
my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(ATR_DifIron_Df) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
fit_tsne <- Rtsne(dist,is_distance = TRUE, perplexity=1, check_duplicates = FALSE, 
                  pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(ATR_DifIron_Df,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_Iron, ATR_AD, ATR_RD, ATR_MD, ATR_FA) %>% 
  tidyr::gather(key = "variable", value = "values", -x, -y, -ATR_subgroup, 
                -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
ggplot(df_tsne,aes(x, y, col=values)) +   geom_point(aes(col=ATR_subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y con las matriz de distancias calculada con las 5 métricas de RM**, no se consigue una separación entre subgrupos.  

```{r ATRavg40.1.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 5 métricas - Con eliminación de outliers
library(cluster)
dist<-daisy(ATR_DifIron_Df_WoOut[,-c(1:6,12)],metric='euclidean')
distmx<-as.matrix(dist)

library(factoextra)
fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(ATR_DifIron_Df_WoOut, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_Iron, ATR_AD, ATR_RD, ATR_MD, ATR_FA) %>% 
  tidyr::gather (key='variable', value='values', -x, -y, -ATR_subgroup, 
                 -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
library(ggplot2)
ggplot(df_mds_dist2,aes(x,y)) + geom_jitter(aes(col=ATR_subgroup)) + facet_wrap(~variable) 

library(Rtsne)
my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(ATR_DifIron_Df_WoOut) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
fit_tsne <- Rtsne(dist,is_distance = TRUE, perplexity=1, check_duplicates = FALSE, 
                  pca = FALSE, dims = 2, initial_dims = 50)
df_tsne_vars <- as_tibble(cbind(ATR_DifIron_Df_WoOut,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_Iron, ATR_AD, ATR_RD, ATR_MD, ATR_FA) %>% 
  tidyr::gather(key = "variable", value = "values", -x, -y, -ATR_subgroup, 
                -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
ggplot(df_tsne,aes(x, y, col=values)) + geom_point(aes(col=ATR_subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y con las matriz de distancias calculada con las 5 métricas de RM**, tampoco se consigue una separación entre subgrupos.  

Se procederá de la misma forma para las 3 métricas de difusividad y las métricas iron-FA.

```{r ATRavg40.2, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 3 métricas - Sin eliminación de outliers
library(cluster)
dist<-daisy(ATR_DifIron_Df_ADRDMD[,-c(1:6,12)],metric='euclidean')
distmx<-as.matrix(dist)

library(factoextra)
fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(ATR_DifIron_Df_ADRDMD, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
               ATR_AD, ATR_RD, ATR_MD) %>% 
  tidyr::gather (key='variable', value='values', -x, -y, -ATR_subgroup, 
                 -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
library(ggplot2)
ggplot(df_mds_dist2,aes(x,y)) + geom_jitter(aes(col=ATR_subgroup)) + facet_wrap(~variable) 

library(Rtsne)
my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(ATR_DifIron_Df_ADRDMD) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
fit_tsne <- Rtsne(dist,is_distance = TRUE,check_duplicates = FALSE,pca = FALSE,dims = 2)
df_tsne_vars <- as_tibble(cbind(ATR_DifIron_Df_ADRDMD,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_AD, ATR_RD, ATR_MD) %>% 
  tidyr::gather(key = "variable", value = "values", -x, -y, -ATR_subgroup, 
                -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
ggplot(df_tsne,aes(x, y, col=values)) + geom_point(aes(col=ATR_subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y con las matriz de distancias calculada con las 3 métricas de difusividad**, se consigue una separación entre el subgrupo de pacientes sintomático (HD) y los otros dos subgrupos (controles y sujetos presintomáticos preHD).

```{r ATRavg40.2.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las 3 métricas - Con eliminación de outliers
library(cluster)
dist<-daisy(ATR_DifIron_Df_WoOut_ADRDMD[,-c(1:6,12)],metric='euclidean')
distmx<-as.matrix(dist)

library(factoextra)
fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(ATR_DifIron_Df_WoOut_ADRDMD, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
               ATR_AD, ATR_RD, ATR_MD) %>% 
  tidyr::gather (key='variable', value='values', -x, -y, -ATR_subgroup, 
                 -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
library(ggplot2)
ggplot(df_mds_dist2,aes(x,y)) + geom_jitter(aes(col=ATR_subgroup)) + facet_wrap(~variable) 

library(Rtsne)
my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(ATR_DifIron_Df_WoOut_ADRDMD) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
fit_tsne <- Rtsne(dist,is_distance = TRUE,check_duplicates = FALSE,pca = FALSE,dims = 2)
df_tsne_vars <- as_tibble(cbind(ATR_DifIron_Df_WoOut_ADRDMD,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_AD, ATR_RD, ATR_MD) %>% 
  tidyr::gather(key = "variable", value = "values", -x, -y, -ATR_subgroup, 
                -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
ggplot(df_tsne,aes(x, y, col=values)) + geom_point(aes(col=ATR_subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con eliminación de outliers y con las matriz de distancias calculada con las 3 métricas de difusividad**, también se consigue una separación entre el subgrupo de pacientes sintomático (HD) y los otros dos subgrupos (controles y sujetos presintomáticos preHD), pero el uso del dataframe reducido (eliminando los outliers) no mejora la separación. 

```{r ATRavg40.3, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las métricas de iron y FA - Sin eliminación de outliers
library(cluster)
dist<-daisy(ATR_DifIron_Df_IronFA[,-c(1:6,12)],metric='euclidean')
distmx<-as.matrix(dist)

library(factoextra)
fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(ATR_DifIron_Df_IronFA, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
               ATR_Iron, ATR_FA) %>% 
  tidyr::gather (key='variable', value='values', -x, -y, -ATR_subgroup, 
                 -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
library(ggplot2)
ggplot(df_mds_dist2,aes(x,y)) + geom_jitter(aes(col=ATR_subgroup)) + facet_wrap(~variable) 

library(Rtsne)
my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(ATR_DifIron_Df_IronFA) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
fit_tsne <- Rtsne(dist,is_distance = TRUE, perplexity=1, check_duplicates = FALSE,
                  pca = FALSE,dims = 2, initial_dims=50)
df_tsne_vars <- as_tibble(cbind(ATR_DifIron_Df_IronFA,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_Iron, ATR_FA) %>% 
  tidyr::gather(key = "variable", value = "values", -x, -y, -ATR_subgroup, 
                -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
ggplot(df_tsne,aes(x, y, col=values)) + geom_point(aes(col=ATR_subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con todos los sujetos (sin eliminación de outliers) y con las matriz de distancias calculada con las métricas de iron y FA**, no se consigue una separación entre subgrupos.

```{r ATRavg40.3.Bis, fig.width=5, fig.height=4, fig.align='center'}
# Matriz de distancias para las métricas de iron y FA - Con eliminación de outliers
library(cluster)
dist<-daisy(ATR_DifIron_Df_WoOut_IronFA[,-c(1:6,12)],metric='euclidean')
distmx<-as.matrix(dist)

library(factoextra)
fviz_dist(dist)
clust<-hclust(dist, method = "centroid", members = NULL)
plot(clust)

mds_dist<-cmdscale(distmx, eig=TRUE, k=2)
df_mds_dist<-data.frame(ATR_DifIron_Df_WoOut_IronFA, x=mds_dist$points[,1], 
                        y=mds_dist$points[,2])
df_mds_dist2<-df_mds_dist %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
               ATR_Iron, ATR_FA) %>% 
  tidyr::gather (key='variable', value='values', -x, -y, -ATR_subgroup, 
                 -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
library(ggplot2)
ggplot(df_mds_dist2,aes(x,y)) + geom_jitter(aes(col=ATR_subgroup)) + facet_wrap(~variable) 

library(Rtsne)
my_Rtsne<-Rtsne(X= distmx,perplexity= floor((nrow(ATR_DifIron_Df_WoOut_IronFA) - 1) / 3),dims = 2)
# Maximum perplexity
my_Rtsne$perplexity
fit_tsne <- Rtsne(dist,is_distance = TRUE, perplexity=1, check_duplicates = FALSE,
                  pca = FALSE,dims = 2, initial_dims=50)
df_tsne_vars <- as_tibble(cbind(ATR_DifIron_Df_WoOut_IronFA,
                                x = fit_tsne$Y[, 1], y = fit_tsne$Y[, 2]))
df_tsne <- df_tsne_vars %>% 
  dplyr::select(x, y, ATR_subgroup, ATR_hemisphere, ATR_Gender, ATR_agef2, 
                ATR_Iron, ATR_FA) %>% 
  tidyr::gather(key = "variable", value = "values", -x, -y, -ATR_subgroup, 
                -ATR_hemisphere, -ATR_Gender, -ATR_agef2)
ggplot(df_tsne,aes(x, y, col=values)) + geom_point(aes(col=ATR_subgroup)) + facet_wrap(~variable)
```

Según los **gráficos obtenidos con el dataframe con eliminación de outliers y con las matriz de distancias calculada con las métricas de iron y FA**, tampoco se consigue una separación entre subgrupos. 

También **se calculan las matrices de distancia** con la función `vegdist` del paquete `vegan` para la combinación de métricas Iron-FA (por poder correlacionarse con el subgrupo preHD), AD-MD-RD (por poder correlacionarse con el subgrupo HD), y, para las 5 métricas en su conjunto, utilizando la distancia `euclidean` en el argumento `method` porque son variables numéricas continuas, no derivadas de especies. Dichas matrices se utilizarán para generar los modelos PERMANOVA. 

Como se objetiva a continuación, se han calculado las matrices para ambos supuestos, con y sin eliminación de outliers. Teóricamente, PERMANOVA, al ser una técnica no paramétrica, podría ejecutarse con todos los sujetos ya que no necesita normalidad multivariante ni homocedasticidad de la matriz de covarianzas, pero, al basarse en permutaciones, requiere verificar una betadispersión homogénea entre grupos. Así que se generarán modelos PERMANOVA con y sin eliminación de outliers para determinar si la eliminación de outliers mejora la dispersión.  

```{r ATRavg41}
# Matriz de distancias para el dataframe completo
distDifIron<-vegdist(ATR_DifIron_Df[,-c(1:6,12)],method='euclidean')
distADMDRD<-vegdist(ATR_DifIron_Df_ADRDMD[,c('ATR_AD','ATR_MD','ATR_RD')],
                    method='euclidean')
distIronFA<-vegdist(ATR_DifIron_Df_IronFA[,c('ATR_Iron','ATR_FA')],method='euclidean')

# Matriz de distancias para el dataframe con eliminación de outliers
distDifIron_WO<-vegdist(ATR_DifIron_Df_WoOut[,-c(1:6,12)],method='euclidean')
distADMDRD_WO<-vegdist(ATR_DifIron_Df_WoOut_ADRDMD[,c('ATR_AD','ATR_MD','ATR_RD')],
                    method='euclidean')
distIronFA_WO<-vegdist(ATR_DifIron_Df_WoOut_IronFA[,c('ATR_Iron','ATR_FA')],method='euclidean')
```

### Modelos

A continuación, **se generan los diferentes modelos PERMANOVA** (remarcar que no se puede añadir el efecto aleatorio). Primero, los modelos se ejecutan con las 4 variables independientes en interacción. Segundo, se eliminan los términos (interacciones y/o factores) no significativos para simplificar los modelos.

```{r ATRavg42}
# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

# Modelos para el dataframe completo
## Difusión-Iron
permDifIron1<-adonis2(distDifIron~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                      data=ATR_DifIron_Df, permutations=999, by='terms')
permDifIron1[1:5]
permDifIron2<-adonis2(distDifIron~ATR_subgroup+ATR_agef2:ATR_Gender,
                      data=ATR_DifIron_Df, permutations=999, by='terms')
permDifIron2[1:5]
permDifIron3<-adonis2(distDifIron~ATR_subgroup,data=ATR_DifIron_Df, 
                      permutations=999, by='terms'); permDifIron3[1:5]

## AD-RD-MD
permADMDRD1<-adonis2(distADMDRD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender, 
                     data=ATR_DifIron_Df_ADRDMD, permutations=999, by='terms')
permADMDRD1[1:5]
permADMDRD2<-adonis2(distADMDRD~ATR_subgroup+ATR_hemisphere+ATR_agef2, 
                     data=ATR_DifIron_Df_ADRDMD, permutations=999, by='terms')
permADMDRD2[1:5]

## Iron-FA
permIronFA1<-adonis2(distIronFA~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender, 
                     data=ATR_DifIron_Df_IronFA, permutations=999, by='terms')
permIronFA1[1:5]
permIronFA2<-adonis2(distIronFA~ATR_subgroup+ATR_agef2:ATR_Gender, 
                     data=ATR_DifIron_Df_IronFA, permutations=999, by='terms')
permIronFA2[1:5]
permIronFA3<-adonis2(distIronFA~ATR_subgroup, data=ATR_DifIron_Df_IronFA, 
                     permutations=999, by='terms')
permIronFA3[1:5]
```

```{r ATRavg43}
# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

# Modelos para el dataframe generado con la eliminación de outliers
## Difusión-Iron
permDifIron1_WoOut<-adonis2(distDifIron_WO~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                            data=ATR_DifIron_Df_WoOut, permutations=999, by='terms')
permDifIron1_WoOut[1:5]
permDifIron2_WoOut<-adonis2(distDifIron_WO~ATR_subgroup+ATR_agef2:ATR_Gender,
                            data=ATR_DifIron_Df_WoOut, permutations=999, by='terms')
permDifIron2_WoOut[1:5]
permDifIron3_WoOut<-adonis2(distDifIron_WO~ATR_subgroup,data=ATR_DifIron_Df_WoOut, 
                      permutations=999, by='terms'); permDifIron3_WoOut[1:5]

## AD-RD-MD
permADMDRD1_WoOut<-adonis2(distADMDRD_WO~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                           data=ATR_DifIron_Df_WoOut_ADRDMD, permutations=999, by='terms')
permADMDRD1_WoOut[1:5]
permADMDRD2_WoOut<-adonis2(distADMDRD_WO~ATR_subgroup+ATR_hemisphere,
                           data=ATR_DifIron_Df_WoOut_ADRDMD, permutations=999, by='terms')
permADMDRD2_WoOut[1:5]

## Iron-FA
permIronFA1_WoOut<-adonis2(distIronFA_WO~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender, 
                     data=ATR_DifIron_Df_WoOut_IronFA, permutations=999, by='terms')
permIronFA1_WoOut[1:5]
permIronFA2_WoOut<-adonis2(distIronFA_WO~ATR_subgroup+ATR_subgroup:ATR_agef2:ATR_Gender, 
                     data=ATR_DifIron_Df_WoOut_IronFA, permutations=999, by='terms')
permIronFA2_WoOut[1:5]
permIronFA3_WoOut<-adonis2(distIronFA_WO~ATR_subgroup, data=ATR_DifIron_Df_WoOut_IronFA, 
                     permutations=999, by='terms')
permIronFA3_WoOut[1:5]
```

```{r ATRavg43.1, echo=FALSE, eval=FALSE}
# Resumen de los modelos PERMANOVA
kable(list(permDifIron1[1:5],permDifIron2[1:5],permDifIron3[1:5]),
      caption='5-metrics PERMANOVA with complete dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permDifIron1_WoOut[1:5],permDifIron2_WoOut[1:5],permDifIron3_WoOut[1:5]),
      caption='5-metrics PERMANOVA with reduced dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD1[1:5],permADMDRD2[1:5]),
      caption='3-metrics PERMANOVA with complete dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD1_WoOut[1:5],permADMDRD2_WoOut[1:5]),
      caption='3-metrics PERMANOVA with reduced dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permIronFA1[1:5],permIronFA2[1:5],permIronFA3[1:5]),
      caption='2-metrics PERMANOVA with complete dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permIronFA1_WoOut[1:5],permIronFA2_WoOut[1:5],permIronFA3_WoOut[1:5]),
      caption='2-metrics PERMANOVA with reduced dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

A diferencia de los PERMANOVA de los ATR derecho e izquierdo por separado que no evidenciaban factores significativos, en el **modelo PERMANOVA generado con las 5 métricas** con el dataframe completo, se detecta subgrupo como el único término significativo. Remarcar que PERMANOVA es menos sensible que MANOVA para detectar significación para el resto de factores (MANOVA detectó significación estadística para los factores subgrupo, hemisferio y edad factorizada y para las interacciones subgrupo-edad factorizada y edad factorizada-género). 

En el **modelo PERMANOVA de las 3 métricas de difusividad con el dataframe completo**, los términos significativos son el subgrupo, el hemisferio y la edad factorizada, y, en el **modelo PERMANOVA de las 3 métricas de difusividad con el dataframe reducido eliminando los outliers**, los términos significativos son el subgrupo y el hemisferio. Remarcar que PERMANOVA es más sensible que MANOVA para detectar significación para el resto de factores (MANOVA detectó significación estadística exclusivamente para el factor subgrupo). 

A diferencia de los PERMANOVA de los ATR derecho e izquierdo por separado que no evidenciaban factores significativos, en los **modelos PERMANOVA generados con las métricas iron-FA**, ya sea con el dataframe completo o con el dataframe reducido eliminando los outliers, el único término significativo es el subgrupo. Remarcar que PERMANOVA ha conseguido detectar significación para subgrupo a diferencia del MANOVA que sólo detectó significación para el factor hemisferio y la interacción edad factorizada-género. 

**En ninguno de los modelos, se objetiva una interacción subgrupo-hemisferio significativa.** 

Recordar que los resultados son idénticos tanto si se utilizada la matriz de distancias calculada en el paso anterior, como si se utiliza la fórmula con la variable dependiente de interés ~ variables/factores independientes y se especifica el término `method` del tipo de distancia a calcular. De todas formas, el tener las distancias calculadas es de relevancia para poder calcular posteriormente las dispersiones.

### Valoración de la dispersión

Se calculan las **dispersiones** para los factores signfiicativos de cada uno de los modelos que se han generado en el paso anterior. 

```{r ATRavg44.1}
# Dispersiones para el dataframe completo
dispersionDifIron<-betadisper(d=distDifIron, group=ATR_DifIron_Df$ATR_subgroup,
                              type="centroid",bias.adjust=TRUE)
dispersionADMDRD1<-betadisper(d=distADMDRD, group=ATR_DifIron_Df_ADRDMD$ATR_subgroup,
                              type="centroid",bias.adjust=TRUE)
dispersionADMDRD2<-betadisper(d=distADMDRD, group=ATR_DifIron_Df_ADRDMD$ATR_hemisphere,
                              type="centroid",bias.adjust=TRUE)
dispersionADMDRD3<-betadisper(d=distADMDRD, group=ATR_DifIron_Df_ADRDMD$ATR_agef2,
                              type="centroid",bias.adjust=TRUE)
dispersionIronFA<-betadisper(d=distIronFA, group=ATR_DifIron_Df_IronFA$ATR_subgroup,
                             type="centroid",bias.adjust=TRUE)

# Dispersiones para el dataframe reducido
dispersionDifIron_WO<-betadisper(d=distDifIron_WO, 
                                 group=ATR_DifIron_Df_WoOut$ATR_subgroup,
                                 type="centroid",bias.adjust=TRUE)
dispersionADMDRD_WO1<-betadisper(d=distADMDRD_WO,
                                 group=ATR_DifIron_Df_WoOut_ADRDMD$ATR_subgroup,
                                 type="centroid",bias.adjust=TRUE)
dispersionADMDRD_WO2<-betadisper(d=distADMDRD_WO, 
                                 group=ATR_DifIron_Df_WoOut_ADRDMD$ATR_hemisphere,
                                 type="centroid",bias.adjust=TRUE)
dispersionIronFA_WO<-betadisper(d=distIronFA_WO, 
                                group=ATR_DifIron_Df_WoOut_IronFA$ATR_subgroup,
                                type="centroid",bias.adjust=TRUE)
```

No se ha requerido utilizar el argumento `add` que sirve para añadir una constante a las disimilaridades no diagnonales con el fin de que todos los eigenvalues sean no-negativos en el análisis de coordenadas principales (PCoA), ya que si existe algún eigenvalue negativo R emite un mensaje de aviso `Warning message: some squared distances are negative and changed to zero`. 

Se generan **plots** para cada una de las dispersiones. 

```{r ATRavg44.2, echo=FALSE}
par(mfrow = c(1, 2))
plot(dispersionDifIron, main=list('Dispersion for 5 metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionDifIron_WO, main=list('Dispersion for 5 metrics related to subgroup (reduced dataframe)', cex=0.5))

par(mfrow = c(1, 3))
plot(dispersionADMDRD1, main=list('Dispersion for diffusivity metrics related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionADMDRD2, main=list('Dispersion for diffusivity metrics related to hemisphere (complete dataframe)', cex=0.5))
plot(dispersionADMDRD3, main=list('Dispersion for diffusivity metrics related to factorized age (complete dataframe)', cex=0.5))

par(mfrow = c(1, 2))
plot(dispersionADMDRD_WO1, main=list('Dispersion for diffusivity metrics related to subgroup (reduced dataframe)', cex=0.5))
plot(dispersionADMDRD_WO2, main=list('Dispersion for diffusivity metrics related to hemisphere (reduced dataframe)', cex=0.5))

par(mfrow = c(1, 2))
plot(dispersionIronFA, main=list('Dispersion for iron-FA metrics related to subgroup (reduced dataframe)', cex=0.5))
plot(dispersionIronFA_WO, main=list('Dispersion for iron-FA metrics related to subgroup (reduced dataframe)', cex=0.5))
```

Cabe mencionar que el subgrupo HD presenta una mayor dispersión respecto a los subgrupos preHD y control, y, el subgrupo preHD presenta una menor dispersión respecto a los subgrupos HD y control, y este comportamiento se da en las 5 métricas, en las 3 métricas de difusividad y en las métricas iron-FA.

En las 3 métricas de difusividad, también es importante remarcar que ambos ATR presentan una dispersión similar, y, en cuanto a la edad factorizada, el nivel 1 (menores de 45) tiene menor dispersión que los otros dos niveles y el nivel 3 (mayores de 55) presenta mayor dispersión que los otros dos niveles.

Se generan **modelos anova** para cada una de las dispersiones. 

```{r ATRavg44.3}
# Modelos ANOVA para las 5 métricas 
summary(aov(dispersionDifIron$distances~ATR_DifIron_Df$ATR_subgroup))
summary(aov(dispersionDifIron_WO$distances~ATR_DifIron_Df_WoOut$ATR_subgroup))

# Modelos ANOVA para las 3 métricas - Dataframe completo
summary(aov(dispersionADMDRD1$distances~ATR_DifIron_Df_ADRDMD$ATR_subgroup))
summary(aov(dispersionADMDRD2$distances~ATR_DifIron_Df_ADRDMD$ATR_hemisphere))
summary(aov(dispersionADMDRD3$distances~ATR_DifIron_Df_ADRDMD$ATR_agef2))

# Modelos ANOVA para las 3 métricas - Dataframe reducido
summary(aov(dispersionADMDRD_WO1$distances~ATR_DifIron_Df_WoOut_ADRDMD$ATR_subgroup))
summary(aov(dispersionADMDRD_WO2$distances~ATR_DifIron_Df_WoOut_ADRDMD$ATR_hemisphere))

# Modelos ANOVA para las métricas Iron-FA
summary(aov(dispersionIronFA$distances~ATR_DifIron_Df_IronFA$ATR_subgroup))
summary(aov(dispersionIronFA_WO$distances~ATR_DifIron_Df_WoOut_IronFA$ATR_subgroup))
```

```{r ATRavg44.3.1, echo=FALSE, eval=FALSE}
  # Resumen de los modelos ANOVA
ATRaovDispSG<-rbind(summary(aov(dispersionDifIron$distances~ATR_DifIron_Df$ATR_subgroup))[[1]],
                    summary(aov(dispersionDifIron_WO$distances~ATR_DifIron_Df_WoOut$ATR_subgroup))[[1]],
                    summary(aov(dispersionADMDRD1$distances~ATR_DifIron_Df_ADRDMD$ATR_subgroup))[[1]],
                    summary(aov(dispersionADMDRD2$distances~ATR_DifIron_Df_ADRDMD$ATR_hemisphere))[[1]],
                    summary(aov(dispersionADMDRD3$distances~ATR_DifIron_Df_ADRDMD$ATR_agef2))[[1]],
                    summary(aov(dispersionADMDRD_WO1$distances~ATR_DifIron_Df_WoOut_ADRDMD$ATR_subgroup))[[1]],
                    summary(aov(dispersionADMDRD_WO2$distances~ATR_DifIron_Df_WoOut_ADRDMD$ATR_hemisphere))[[1]],
                    summary(aov(dispersionIronFA$distances~ATR_DifIron_Df_IronFA$ATR_subgroup))[[1]],
                    summary(aov(dispersionIronFA_WO$distances~ATR_DifIron_Df_WoOut_IronFA$ATR_subgroup))[[1]])
kable(ATRaovDispSG, caption='ANOVAs for dispersion distances of Both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('5-metric model for subgroup (complete dataframe)'=2,'5-metric model for subgroup (reduced dataframe)'=2,
                    '3-metric model for subgroup (complete dataframe)'=2,'3-metric model for hemisphere (complete dataframe)'=2,'3-metric model for factorized age (complete dataframe)'=2,
                    '3-metric model for subgroup (reduced dataframe)'=2,'3-metric model for hemisphere (reduced dataframe)'=2,
                    '2-metric model for subgroup (complete dataframe)'=2,'2-metric model for subgroup (reduced dataframe)'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las dispersiones para subgrupo de las 3 métricas de difusividad presentan significación estadística, con lo que no se puede determinar si las diferencias observadas en PERMANOVA son debidas a diferencias en el posicionamiento de los centroides y/o a las diferencias en dispersión. Como se mencionó más arriba, no se puede determinar cuánta diferencia en el PERMANOVA es debida al posicionamiento de centroides y cuánta debida a la variabilidad en dispersión. El resto de dispersiones no son significativas.

Se decide intentar la **transformación logarítmica de las 3 métricas de difusividad para determinar si se mejora la dispersión**. A continuación, se exponen los resultados para el **dataframe completo**. 

```{r ATRavg44.4}
# Se genera la transformación logarítmica
ATR_DifIron_Df_ADRDMD_log<-cbind(ATR_DifIron_Df_ADRDMD[,1:6], 
                                 log(ATR_DifIron_Df_ADRDMD[,7:9]))

# Se calculan las distancias
distADMDRD_log<-vegdist(ATR_DifIron_Df_ADRDMD_log[,c('ATR_AD','ATR_MD','ATR_RD')],
                        method='euclidean')

# Se generan los modelos PERMANOVA                    
set.seed(123)
permADMDRD_log1<-adonis2(distADMDRD_log~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender, 
                     data=ATR_DifIron_Df_ADRDMD_log, permutations=999, by='terms')
permADMDRD_log1[1:5]
permADMDRD_log2<-adonis2(distADMDRD_log~ATR_subgroup+ATR_hemisphere+ATR_agef2, 
                     data=ATR_DifIron_Df_ADRDMD_log, permutations=999, by='terms')
permADMDRD_log2[1:5]

# Se determinan las dispersiones
dispersionADMDRD_log1<-betadisper(d=distADMDRD_log, group=ATR_DifIron_Df_ADRDMD_log$ATR_subgroup,
                              type="centroid",bias.adjust=TRUE)
dispersionADMDRD_log2<-betadisper(d=distADMDRD_log, group=ATR_DifIron_Df_ADRDMD_log$ATR_hemisphere,
                              type="centroid",bias.adjust=TRUE)
dispersionADMDRD_log3<-betadisper(d=distADMDRD_log, group=ATR_DifIron_Df_ADRDMD_log$ATR_agef2,
                              type="centroid",bias.adjust=TRUE)

# Se generan los plots
par(mfrow = c(1, 3))
plot(dispersionADMDRD_log1, main=list('Dispersion for log-diffusivities related to subgroup (complete dataframe)', cex=0.5))
plot(dispersionADMDRD_log2, main=list('Dispersion for log-diffusivities related to hemisphere (complete dataframe)', cex=0.5))
plot(dispersionADMDRD_log3, main=list('Dispersion for log-diffusivities related to factorized age (complete dataframe)', cex=0.5))

# Modelos ANOVA para las 3 métricas - Dataframe completo con transformación logarítmica
summary(aov(dispersionADMDRD_log1$distances~ATR_DifIron_Df_ADRDMD_log$ATR_subgroup))
summary(aov(dispersionADMDRD_log2$distances~ATR_DifIron_Df_ADRDMD_log$ATR_hemisphere))
summary(aov(dispersionADMDRD_log3$distances~ATR_DifIron_Df_ADRDMD_log$ATR_agef2))
```

En el caso de la **transformación logarítmica de las 3 métricas de difusividad para el dataframe completo**, se objetiva que los factores subgrupo, hemisferio y edad factorizada son los términos significativos en el PERMANOVA (como ocurría sin la transformación logarítmica). Persiste una mayor dispersión para el subgrupo HD y una menor dispersión para el subgrupo preHD visualizada en el plot y significativa en el anova. La transformación logarítmica disminuye el valor de F y aumenta el valor de p, pero no lo suficiente; así, los valores F y p-valor para el PERMANOVA con transformación logarítmica son de `r round(summary(aov(dispersionADMDRD_log1$distances~ATR_DifIron_Df_ADRDMD_log$ATR_subgroup))[[1]][1,4],3)` y de `r round(summary(aov(dispersionADMDRD_log1$distances~ATR_DifIron_Df_ADRDMD_log$ATR_subgroup))[[1]][1,5],3)` respectivamente comparado con los valores F y p-valor para el PERMANOVA sin transformación logarítmica de `r round (summary(aov(dispersionADMDRD1$distances~ATR_DifIron_Df_ADRDMD$ATR_subgroup))[[1]][1,4],3)` y `r round (summary(aov(dispersionADMDRD1$distances~ATR_DifIron_Df_ADRDMD$ATR_subgroup))[[1]][1,5],3)` respectivamente.

A continuación, se exponen los resultados para el **dataframe reducido** (con eliminación de outliers). 

```{r ATRavg44.5}
# Se genera la transformación logarítmica
ATR_DifIron_Df_ADRDMD_WO_log<-cbind(ATR_DifIron_Df_WoOut_ADRDMD[,1:6],
                                    log(ATR_DifIron_Df_WoOut_ADRDMD[,7:9]))

# Se calculan las distancias
distADMDRD_WO_log<-vegdist(ATR_DifIron_Df_ADRDMD_WO_log[,c('ATR_AD','ATR_MD','ATR_RD')],
                           method='euclidean')

# Se generan los modelos PERMANOVA                    
set.seed(123)
permADMDRD_WO_log1<-adonis2(distADMDRD_WO_log~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender, 
                     data=ATR_DifIron_Df_ADRDMD_WO_log, permutations=999, by='terms')
permADMDRD_WO_log1[1:5]
permADMDRD_WO_log2<-adonis2(distADMDRD_WO_log~ATR_subgroup+ATR_hemisphere+ATR_agef2, 
                     data=ATR_DifIron_Df_ADRDMD_WO_log, permutations=999, by='terms')
permADMDRD_WO_log2[1:5]

# Se determinan las dispersiones
dispersionADMDRD_WO_log1<-betadisper(d=distADMDRD_WO_log, 
                                     group=ATR_DifIron_Df_ADRDMD_WO_log$ATR_subgroup,
                                     type="centroid",bias.adjust=TRUE)
dispersionADMDRD_WO_log2<-betadisper(d=distADMDRD_WO_log, 
                                     group=ATR_DifIron_Df_ADRDMD_WO_log$ATR_hemisphere,
                                     type="centroid",bias.adjust=TRUE)
dispersionADMDRD_WO_log3<-betadisper(d=distADMDRD_WO_log, 
                                     group=ATR_DifIron_Df_ADRDMD_WO_log$ATR_agef2,
                                     type="centroid",bias.adjust=TRUE)

# Se generan los plots
par(mfrow = c(1, 3))
plot(dispersionADMDRD_WO_log1, main=list('Dispersion for log-diffusivities related to subgroup (reduced dataframe)', cex=0.5))
plot(dispersionADMDRD_WO_log2, main=list('Dispersion for log-diffusivities related to hemisphere (reduced dataframe)', cex=0.5))
plot(dispersionADMDRD_WO_log3, main=list('Dispersion for log-diffusivities related to factorized age (reduced dataframe)', cex=0.5))

# Modelos ANOVA para las 3 métricas - Dataframe completo con transformación logarítmica
summary(aov(dispersionADMDRD_WO_log1$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_subgroup))
summary(aov(dispersionADMDRD_WO_log2$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_hemisphere))
summary(aov(dispersionADMDRD_WO_log3$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_agef2))
```

En el caso de la **transformación logarítmica de las 3 métricas de difusividad para el dataframe reducido**, se objetiva que los factores subgrupo, hemisferio y edad factorizada son los términos significativos en el PERMANOVA (a diferencia del PERMANOVA obtenido sin transformación logarítmica, en el que sólo subgrupo y hemisferio son significativos). Persiste una mayor dispersión para el subgrupo HD y una menor dispersión para el subgrupo preHD visualizada en el plot, pero sin significación estadística en el anova. La transformación logarítmica disminuye el valor de F y aumenta el valor de p lo suficiente como para perder la significación estadística; así, los valores F y p-valor para el PERMANOVA con transformación logarítmica son de `r round(summary(aov(dispersionADMDRD_WO_log1$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_subgroup))[[1]][1,4],3)` y de `r round(summary(aov(dispersionADMDRD_WO_log1$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_subgroup))[[1]][1,5],3)` respectivamente comparado con los valores F y p-valor para el PERMANOVA sin transformación logarítmica de `r round (summary(aov(dispersionADMDRD_WO1$distances~ATR_DifIron_Df_WoOut_ADRDMD$ATR_subgroup))[[1]][1,4],3)` y `r round (summary(aov(dispersionADMDRD_WO1$distances~ATR_DifIron_Df_WoOut_ADRDMD$ATR_subgroup))[[1]][1,5],3)` respectivamente.

```{r ATRavg44.6, echo=FALSE, eval=FALSE}
# Resumen de los modelos PERMANOVA con transformación logarítmica
kable(list(permADMDRD_log1[1:5],permADMDRD_log2[1:5]),
      caption='3-log-transform diffusivity metrics PERMANOVA with complete dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
kable(list(permADMDRD_WO_log1[1:5],permADMDRD_WO_log2[1:5]),
      caption='3-log-transform diffusivity metrics PERMANOVA with reduced dataframe for Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

```{r ATRavg44.7, echo=FALSE, eval=FALSE}
# Resumen de los modelos ANOVA
ATRaovDispLogSG<-rbind(summary(aov(dispersionADMDRD_log1$distances~ATR_DifIron_Df_ADRDMD_log$ATR_subgroup))[[1]],
                       summary(aov(dispersionADMDRD_log2$distances~ATR_DifIron_Df_ADRDMD_log$ATR_hemisphere))[[1]],
                       summary(aov(dispersionADMDRD_log3$distances~ATR_DifIron_Df_ADRDMD_log$ATR_agef2))[[1]],
                       summary(aov(dispersionADMDRD_WO_log1$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_subgroup))[[1]],
                       summary(aov(dispersionADMDRD_WO_log2$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_hemisphere))[[1]],
                       summary(aov(dispersionADMDRD_WO_log3$distances~ATR_DifIron_Df_ADRDMD_WO_log$ATR_agef2))[[1]])
kable(ATRaovDispLogSG, caption='ANOVAs for dispersion distances of Both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('3-log-transform diffusivity-metric model for subgroup (complete dataframe)'=2,
                    '3-log-transform diffusivity-metric model for hemisphere (complete dataframe)'=2,
                    '3-log-transform diffusivity-metric model for factorized age (complete dataframe)'=2,
                    '3-log-transform diffusivity-metric model for subgroup (reduced dataframe)'=2,
                    '3-log-transform diffusivity-metric model for hemisphere (reduced dataframe)'=2,
                    '3-log-transform diffusivity-metric model for factorized age (reduced dataframe)'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**En resumen, la interacción subgrupo-hemisferio no es significativa en ninguna de las combinaciones métricas, pero los PERMANOVA obtenidos con las métricas de ambos ATR han permitido aumentar la sensibilidad para detectar diferencias entre subgrupos, especialmente en la evaluación de las 5 métricas conjuntas y de las métricas Iron-FA.** 

### Comparaciones por pares

Se procede a generar las comparaciones por pares de los PERMANOVA que han obtenido significación estadística para subgrupo y cuyas dispersiones no hayan resultados estadísticamente significativas. Por tanto, se van a realizar las comparaciones de los siguientes PERMANOVA: `permDifIron3` (PERMANOVA de las 5 métricas con el dataframe completo), `permADMDRD_log2` y `permADMDRD_WO_log2` (PERMANOVA de la transformación logarítmica de las 3 métricas de difusividad con los dataframes completo y reducido, respectivamente), y,  `permIronFA3` y `permIronFA3_WoOut`  (PERMANOVA de métricas iron-FA con el dataframe completo y reducido, respectivamente).

Para la comparación por pares, se utiliza la función `pairwise.adonis2` del paquete `pairwiseAdonis`. Esta función admite los mismos argumentos que la función `adonis2`. No se realiza la comparación por pares de los factores hemisferio ni edad factorizada para el PERMANOVA de las 3 métricas de difusividad dado que no es de interés para el estudio. 

```{r ATRavg45.1}
# Se carga la librería
library(devtools)
install_github("pmartinezarbizu/pairwiseAdonis/pairwiseAdonis", force=TRUE)
library(pairwiseAdonis)

# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

# Test a posteriori para las 5 métricas 
pairwise_permanova_DifIron<-pairwiseAdonis::pairwise.adonis2(distIronFA~ATR_subgroup,
                                                             data=ATR_DifIron_Df,
                                                             permutations=999, by='terms')
pairwise_permanova_DifIron_WO<-pairwiseAdonis::pairwise.adonis2(distDifIron_WO~ATR_subgroup,
                                                                data=ATR_DifIron_Df_WoOut,
                                                                permutations=999, by='terms')

# Test a posteriori para las 3 métricas de difusividad 
pairwise_permanova_ADMDRD_log<-pairwiseAdonis::pairwise.adonis2(distADMDRD_log~
                                                                  ATR_subgroup,
                                                                data=ATR_DifIron_Df_ADRDMD_log,
                                                                permutations=999, by='terms')

pairwise_permanova_ADMDRD_WO_log<-pairwiseAdonis::pairwise.adonis2(distADMDRD_WO_log~
                                                                     ATR_subgroup,
                                                                   data=ATR_DifIron_Df_ADRDMD_WO_log, 
                                                                   permutations=999, by='terms')

# Test a posteriori para las métricas de Iron y FA 
pairwise_permanova_IronFA<-pairwiseAdonis::pairwise.adonis2(distIronFA~ATR_subgroup, 
                                                            data=ATR_DifIron_Df_IronFA,
                                                            permutations=999, by='terms')
pairwise_permanova_IronFA_WO<-pairwiseAdonis::pairwise.adonis2(distIronFA_WO~ATR_subgroup, 
                                                               data=ATR_DifIron_Df_WoOut_IronFA,
                                                               permutations=999, by='terms')
```

```{r ATRavg45.2.1}
pairwise_permanova_DifIron
pairwise_permanova_DifIron_WO
```

```{r ATRavg45.2.2, echo=FALSE, eval=FALSE}
#Pairwise permanova with 5-metric for the complete dataframe of both ATR
PWP_5C<-rbind(pairwise_permanova_DifIron[[2]],pairwise_permanova_DifIron[[3]],pairwise_permanova_DifIron[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_5C<-cbind(Variable,PWP_5C)
rownames(PWP_5C)<-NULL
colnames(PWP_5C)<-c('',colnames(PWP_5C)[-1])
kable(PWP_5C,caption='Pairwise permanova with 5-metric for the complete dataframe of both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las comparaciones por pares ponen de relieve que **las diferencias significativas entre subgrupos en cuanto a las 5 métricas se hallan entre preHD vs controles y entre preHD vs HD** para ambos dataframes (completo y reducido, sin y con eliminación de outliers, respectivamente). 

```{r ATRavg45.3.1}
pairwise_permanova_ADMDRD_log
pairwise_permanova_ADMDRD_WO_log
```

```{r ATRavg45.3.2, echo=FALSE, eval=FALSE}
#Pairwise permanova with 3-log-diffusivity metric for the complete dataframe of both ATR
PWP_3C<-rbind(pairwise_permanova_ADMDRD_log[[2]],pairwise_permanova_ADMDRD_log[[3]],pairwise_permanova_ADMDRD_log[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_3C<-cbind(Variable,PWP_3C)
rownames(PWP_3C)<-NULL
colnames(PWP_3C)<-c('',colnames(PWP_3C)[-1])
kable(PWP_3C,caption='Pairwise permanova with 3-log-diffusivity metric for the complete dataframe of both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

#Pairwise permanova with 3-log-diffusivity metric for the reduced dataframe of both ATR
PWP_3R<-rbind(pairwise_permanova_ADMDRD_WO_log[[2]],pairwise_permanova_ADMDRD_WO_log[[3]],pairwise_permanova_ADMDRD_WO_log[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_3R<-cbind(Variable,PWP_3R)
rownames(PWP_3R)<-NULL
colnames(PWP_3R)<-c('',colnames(PWP_3R)[-1])
kable(PWP_3R,caption='Pairwise permanova with 3-log-diffusivity metric for the reduced dataframe of both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las comparaciones por pares ponen de relieve que **las diferencias significativas entre subgrupos en cuanto a las 3 métricas de difusividad se hallan entre HD vs controles y entre HD vs preHD** para el dataframes reducido (con eliminación de outliers) con la transformación logarítmica de las 3 métricas de difusividad. 

```{r ATRavg45.4.1}
pairwise_permanova_IronFA
pairwise_permanova_IronFA_WO
```

```{r ATRavg45.4.2, echo=FALSE, eval=FALSE}
#Pairwise permanova with 2-metric for the complete dataframe of both ATR
PWP_2C<-rbind(pairwise_permanova_IronFA[[2]],pairwise_permanova_IronFA[[3]],pairwise_permanova_IronFA[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_2C<-cbind(Variable,PWP_2C)
rownames(PWP_2C)<-NULL
colnames(PWP_2C)<-c('',colnames(PWP_2C)[-1])
kable(PWP_2C,caption='Pairwise permanova with 2-metric for the complete dataframe of both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

#Pairwise permanova with 2-metric for the reduced dataframe of both ATR
PWP_2R<-rbind(pairwise_permanova_IronFA_WO[[2]],pairwise_permanova_IronFA_WO[[3]],pairwise_permanova_IronFA_WO[[4]])
Variable<-rep(c('Subgroup','Residual','Total'),3)
PWP_2R<-cbind(Variable,PWP_2R)
rownames(PWP_2R)<-NULL
colnames(PWP_2R)<-c('',colnames(PWP_2R)[-1])
kable(PWP_2R,caption='Pairwise permanova with 2-metric for the reduced dataframe of both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Control_vs_HD'=3,'Control_vs_PreHD'=3,'HD_vs_PreHD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las comparaciones por pares ponen de relieve que **las diferencias significativas entre subgrupos en cuanto a las métricas Iron-FA se hallan entre preHD vs controles y entre preHD vs HD** para ambos dataframes (completo y reducido, sin y con eliminación de outliers, respectivamente). 

## ANOVA

Como los modelos MANOVA y PERMANOVA han detectado diferencias entre subgrupos en relación a las 5 métricas de RM, se procede a generar los ANOVA para valorar cada métrica por separado. En este caso, los ANOVA se van a generar con 4 factores: subgrupo, hemisferio, edad factorizada y género. Se empezará con un modelo con interacción de los 4 factores, posteriormente se irán eliminando los términos (interacciones) hasta llegar al modelo más simple. Remarcar que tanto el hemisferio, la edad como el género son covariables que me interesa mantener en el modelo final aunque no sean significativas para eliminar su influencia en la relación entre métricas-subgrupos.

### IRON

```{r ATRavg46.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_ATRavg_iron<-aov(ATR_Iron~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender, 
                        data=ATR_DifIron_Df)
summary(anova1_ATRavg_iron)

anova2_ATRavg_iron<-aov(ATR_Iron~ATR_subgroup+ATR_hemisphere+ATR_agef2*ATR_Gender, 
                        data=ATR_DifIron_Df)
summary(anova2_ATRavg_iron)

shapiro.test(residuals(anova2_ATRavg_iron))
plot(anova2_ATRavg_iron, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova2_ATRavg_iron)
plot(anova2_ATRavg_iron, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg46.2, echo=FALSE, eval=FALSE}
kable(list(summary(anova1_ATRavg_iron)[[1]],summary(anova2_ATRavg_iron)[[1]]),
      caption='ANOVA Models for Iron of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el modelo con interacción `anova1_ATRavg_iron`, se objetiva interacción significativa entre edad factorizada y género y el factor significativo es el hemisferio, por lo que se genera el modelo `anova2_ATRavg_iron` con la eliminación de las interacciones no significativas. Los residuos del modelo `anova2_ATRavg_iron` no siguen una distribución normal, pero presentan homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con los índices 18, 51 y 73. 

Se procede a eliminar los outliers con la fórmula `q1-1.5*IQR` y `q3+1.5*IQR`.

```{r ATRavg46.3, fig.width=4, fig.height=3, fig.align='center'}
ATR_DifIron_Df_out<-ATR_DifIron_Df
resumen<-data.frame()
resumen<-ATR_DifIron_Df_out |>
   dplyr::summarize(across(ATR_Iron,list(iqr= ~ IQR(.), q1= ~quantile(.,probs = .25),
                                         q3= ~quantile(.,probs = .75))))
index<-which(ATR_DifIron_Df_out$ATR_Iron<(resumen[[2]]-1.5*resumen[[1]]) |
             ATR_DifIron_Df_out$ATR_Iron>(resumen[[3]]+1.5*resumen[[1]]))
index

ATR_DifIron_Df_out$ATR_Iron<-replace(ATR_DifIron_Df_out$ATR_Iron, index, NA)

anova3_ATRavg_iron<-aov(ATR_Iron~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                        data=ATR_DifIron_Df_out)
summary(anova3_ATRavg_iron)

anova4_ATRavg_iron<-aov(ATR_Iron~ATR_subgroup+ATR_hemisphere+ATR_agef2*ATR_Gender,
                        data=ATR_DifIron_Df_out)
summary(anova4_ATRavg_iron)

shapiro.test(residuals(anova4_ATRavg_iron))
plot(anova4_ATRavg_iron, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova4_ATRavg_iron)
plot(anova4_ATRavg_iron, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg46.4, echo=FALSE, eval=FALSE}
kable(list(summary(anova3_ATRavg_iron)[[1]],summary(anova4_ATRavg_iron)[[1]]),
      caption='ANOVA Models for Iron of Both ATR after elimination of outliers', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Una vez eliminado los outliers (individuos con índices `r index`), los residuos del modelo `anova4_ATRavg_iron` presentan una distribución normal y una homocedasticidad de varianzas.  Los términos significativos son la interacción entre edad factorizada y género y el factor hemisferio. 

### AD

```{r ATRavg47.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_ATRavg_ad<-aov(ATR_AD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova1_ATRavg_ad)

anova2_ATRavg_ad<-aov(ATR_AD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova2_ATRavg_ad)

shapiro.test(residuals(anova2_ATRavg_ad))
plot(anova2_ATRavg_ad, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova2_ATRavg_ad)
plot(anova2_ATRavg_ad, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg47.2, echo=FALSE, eval=FALSE}
kable(list(summary(anova1_ATRavg_ad)[[1]],summary(anova2_ATRavg_ad)[[1]]),
      caption='ANOVA Models for AD of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el modelo con interacción `anova1_ATRavg_ad`, no se objetiva interacción significativa y los factores significativos son el subgrupo y el hemisferio, por lo que se genera el modelo `anova2_ATRavg_ad` con eliminación de las interacciones. Los residuos del modelo `anova2_ATRavg_ad` no siguen una distribución normal, pero presentan homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con los índices 52, 71 y 74. 

Se procede a la eliminación de outliers. 

```{r ATRavg47.3}
ATR_DifIron_Df_out<-ATR_DifIron_Df
resumen<-data.frame()
resumen<-ATR_DifIron_Df_out |>
  dplyr::summarize(across(ATR_AD,list(iqr= ~ IQR(.), q1= ~quantile(.,probs = .25),
                                      q3= ~quantile(.,probs = .75))))

index <-which(ATR_DifIron_Df_out$ATR_AD<(resumen[[2]]-1.5*resumen[[1]]) |
              ATR_DifIron_Df_out$ATR_AD>(resumen[[3]]+1.5*resumen[[1]]))
index
```

No se detectan outliers. Por tanto, en este caso, no se pueden generar nuevos modelos.

### MD

```{r ATRavg48.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_ATRavg_md<-aov(ATR_MD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova1_ATRavg_md)

anova2_ATRavg_md<-aov(ATR_MD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova2_ATRavg_md)

shapiro.test(residuals(anova2_ATRavg_md))
plot(anova2_ATRavg_md, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova2_ATRavg_md)
plot(anova2_ATRavg_md, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg48.2, echo=FALSE, eval=FALSE}
kable(list(summary(anova1_ATRavg_md)[[1]],summary(anova2_ATRavg_md)[[1]]),
      caption='ANOVA Models for MD of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el modelo con interacción `anova1_ATRavg_md`, no se objetiva interacción significativa, por lo que se genera el modelo `anova2_ATRavg_md` con eliminación de las interacciones. 

En el modelo `anova2_ATRavg_md`, los factores significativos son el subgrupo, el hemisferio y la edad factorizada. Los residuos del modelo `anova2_ATRavg_md` siguen una distribución normal, pero no presentan homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con los índices 34, 52 y 74. 

Se procede a la eliminación de outliers. 

```{r ATRavg48.3, fig.width=4, fig.height=3, fig.align='center'}
ATR_DifIron_Df_out<-ATR_DifIron_Df
resumen<-data.frame()
resumen<-ATR_DifIron_Df_out |>
  dplyr::summarize(across(ATR_MD,list(iqr= ~ IQR(.), q1= ~quantile(.,probs = .25),
                                      q3= ~quantile(.,probs = .75))))

index <-which(ATR_DifIron_Df_out$ATR_MD<(resumen[[2]]-1.5*resumen[[1]]) |
              ATR_DifIron_Df_out$ATR_MD>(resumen[[3]]+1.5*resumen[[1]]))
index

ATR_DifIron_Df_out$ATR_MD<-replace(ATR_DifIron_Df_out$ATR_MD, index, NA)

anova3_ATRavg_md<-aov(ATR_MD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                      data=ATR_DifIron_Df_out)
summary(anova3_ATRavg_md)

anova4_ATRavg_md<-aov(ATR_MD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                      data=ATR_DifIron_Df_out)
summary(anova4_ATRavg_md)

shapiro.test(residuals(anova4_ATRavg_md))
plot(anova4_ATRavg_md, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova4_ATRavg_md)
plot(anova4_ATRavg_md, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg48.4, echo=FALSE, eval=FALSE}
kable(list(summary(anova3_ATRavg_md)[[1]],summary(anova4_ATRavg_md)[[1]]),
      caption='ANOVA Models for MD of Both ATR after elimination of outliers', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Con la eliminación de outliers (individuos con índices `r index`), no se ha mejorado la homocedasticidad de varianzas. Los residuos del modelo `anova4_ATRavg_md` siguen presentando una distribución normal y los elementos significativos son el subgrupo, el hemisferio y la edad factorizada.

### RD

```{r ATRavg49.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_ATRavg_rd<-aov(ATR_RD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova1_ATRavg_rd)

anova2_ATRavg_rd<-aov(ATR_RD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova2_ATRavg_rd)

shapiro.test(residuals(anova2_ATRavg_rd))
plot(anova2_ATRavg_rd, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova2_ATRavg_rd)
plot(anova2_ATRavg_rd, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg49.2, echo=FALSE, eval=FALSE}
kable(list(summary(anova1_ATRavg_rd)[[1]],summary(anova2_ATRavg_rd)[[1]]),
      caption='ANOVA Models for RD of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el modelo con interacción `anova1_ATRavg_rd`, no se objetiva interacción significativa, por lo que se genera el modelo `anova2_ATRavg_rd` con eliminación de las interacciones. 

En el modelo `anova2_ATRavg_rd`, los factores significativos son el subgrupo, el hemisferio y la edad factorizada. Los residuos del modelo `anova2_ATRavg_rd` siguen una distribución normal, pero no presentan homocedasticidad de varianzas. Los posibles sujetos outliers e influyentes son los individuos con los índices 25, 34 y 52. 

Se procede a la eliminación de outliers. 

```{r ATRavg49.3, fig.width=4, fig.height=3, fig.align='center'}
ATR_DifIron_Df_out<-ATR_DifIron_Df
resumen<-data.frame()
resumen<-ATR_DifIron_Df_out |>
  dplyr::summarize(across(ATR_RD,list(iqr= ~ IQR(.), q1= ~quantile(.,probs = .25),
                                      q3= ~quantile(.,probs = .75))))

index <-which(ATR_DifIron_Df_out$ATR_RD<(resumen[[2]]-1.5*resumen[[1]]) |
              ATR_DifIron_Df_out$ATR_RD>(resumen[[3]]+1.5*resumen[[1]]))
index

ATR_DifIron_Df_out$ATR_RD<-replace(ATR_DifIron_Df_out$ATR_RD, index, NA)

anova3_ATRavg_rd<-aov(ATR_RD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                      data=ATR_DifIron_Df_out)
summary(anova3_ATRavg_rd)

anova4_ATRavg_rd<-aov(ATR_RD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                      data=ATR_DifIron_Df_out)
summary(anova4_ATRavg_rd)

shapiro.test(residuals(anova4_ATRavg_rd))
plot(anova4_ATRavg_rd, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova4_ATRavg_rd)
plot(anova4_ATRavg_rd, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg49.4, echo=FALSE, eval=FALSE}
kable(list(summary(anova3_ATRavg_rd)[[1]],summary(anova4_ATRavg_rd)[[1]]),
      caption='ANOVA Models for RD of Both ATR after elimination of outliers', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Con la eliminación del outlier (individuo con índice `r index`), no se ha mejorado la homocedasticidad de varianzas. Los residuos del modelo `anova4_ATRavg_rd` siguen presentando una distribución normal y los elementos significativos son el subgrupo, el hemisferio y la edad factorizada.

### FA

```{r ATRavg50.1, fig.width=4, fig.height=3, fig.align='center'}
anova1_ATRavg_fa<-aov(ATR_FA~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova1_ATRavg_fa)

anova2_ATRavg_fa<-aov(ATR_FA~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                      data=ATR_DifIron_Df)
summary(anova2_ATRavg_fa)

shapiro.test(residuals(anova2_ATRavg_fa))
plot(anova2_ATRavg_fa, which=2, cex.lab=0.7, cex.sub=0.7)
bptest(anova2_ATRavg_fa)
plot(anova2_ATRavg_fa, which=1, cex.lab=0.7, cex.sub=0.7)
```

```{r ATRavg50.2, echo=FALSE, eval=FALSE}
kable(list(summary(anova1_ATRavg_fa)[[1]],summary(anova2_ATRavg_fa)[[1]]),
      caption='ANOVA Models for FA of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

En el modelo con interacción `anova1_ATRavg_fa`, no se objetiva interacción significativa, por lo que se genera el modelo `anova2_ATRavg_fa` con eliminación de las interacciones. 

En el modelo `anova2_ATRavg_fa`, el factor significativo es el subgrupo. Los residuos del modelo `anova2_ATRavg_fa` siguen una distribución normal y presentan homocedasticidad de varianzas.

**En resumen:**

- El **modelo de hierro** presenta unos residuos con normalidad y homocedasticidad de varianzas, pero el factor subgrupo no es significativo;
- El **modelo de AD** presenta unos residuos sin normalidad y con homocedasticidad de varianzas, y, los factores subgrupo y hemisferio son significativos;
- Los **modelos de MD y RD** presentan unos residuos con normalidad y sin homocedasticidad de varianzas, y, los factores subgrupo, hemisferio y edad factorizada son significativos;
- El **modelo de FA** presenta unos residuos con normalidad y homocedasticidad de varianzas, y, el factor subgrupo es significativo.

**También remarcar que los modelos anova de interés están formados por las variables independientes sin interacción.** 

Se presenta una **tabla resumen** para objetivar la significancia o no de la variable subgrupo, de la normalidad y homocedasticidad/heterocedasticidad de los residuos antes y después de la eliminación de outliers. 

```{r ATRavg50.3, error=TRUE, echo=FALSE}
Fsubgrupo<-rbind(round(summary(anova2_ATRavg_iron)[[1]][1,4],3),
                 round(summary(anova4_ATRavg_iron)[[1]][1,4],3),
                 round(summary(anova2_ATRavg_ad)[[1]][1,4],3),
                 round(summary(anova2_ATRavg_md)[[1]][1,4],3),
                 round(summary(anova4_ATRavg_md)[[1]][1,4],3),
                 round(summary(anova2_ATRavg_rd)[[1]][1,4],3),
                 round(summary(anova4_ATRavg_rd)[[1]][1,4],3),
                 round(summary(anova2_ATRavg_fa)[[1]][1,4],3))
         
pSubgrupo<-rbind(round(summary(anova2_ATRavg_iron)[[1]][1,5],3),
                 round(summary(anova4_ATRavg_iron)[[1]][1,5],3),
                 round(summary(anova2_ATRavg_ad)[[1]][1,5],3),
                 round(summary(anova2_ATRavg_md)[[1]][1,5],3),
                 round(summary(anova4_ATRavg_md)[[1]][1,5],3),
                 round(summary(anova2_ATRavg_rd)[[1]][1,5],3),
                 round(summary(anova4_ATRavg_rd)[[1]][1,5],3),
                 round(summary(anova2_ATRavg_fa)[[1]][1,5],3))

wShapiro<-rbind(round(shapiro.test(residuals(anova2_ATRavg_iron))[[1]][[1]],3),
                round(shapiro.test(residuals(anova4_ATRavg_iron))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_ATRavg_ad))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_ATRavg_md))[[1]][[1]],3),
                round(shapiro.test(residuals(anova4_ATRavg_md))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_ATRavg_rd))[[1]][[1]],3),
                round(shapiro.test(residuals(anova4_ATRavg_rd))[[1]][[1]],3),
                round(shapiro.test(residuals(anova2_ATRavg_fa))[[1]][[1]],3))

pShapiro<-rbind(round(shapiro.test(residuals(anova2_ATRavg_iron))[[2]],3),
                round(shapiro.test(residuals(anova4_ATRavg_iron))[[2]],3),
                round(shapiro.test(residuals(anova2_ATRavg_ad))[[2]],3),
                round(shapiro.test(residuals(anova2_ATRavg_md))[[2]],3),
                round(shapiro.test(residuals(anova4_ATRavg_md))[[2]],3),
                round(shapiro.test(residuals(anova2_ATRavg_rd))[[2]],3),
                round(shapiro.test(residuals(anova4_ATRavg_rd))[[2]],3),
                round(shapiro.test(residuals(anova2_ATRavg_fa))[[2]],3))

BPBptest<-rbind(round(bptest(anova2_ATRavg_iron)[[1]][[1]],3),
                round(bptest(anova4_ATRavg_iron)[[1]][[1]],3),
                round(bptest(anova2_ATRavg_ad)[[1]][[1]],3),
                round(bptest(anova2_ATRavg_md)[[1]][[1]],3),
                round(bptest(anova4_ATRavg_md)[[1]][[1]],3),
                round(bptest(anova2_ATRavg_rd)[[1]][[1]],3),
                round(bptest(anova4_ATRavg_rd)[[1]][[1]],3),
                round(bptest(anova2_ATRavg_fa)[[1]][[1]],3))

dfBptest<-rbind(round(bptest(anova2_ATRavg_iron)[[2]][[1]],3),
                round(bptest(anova4_ATRavg_iron)[[2]][[1]],3),
                round(bptest(anova2_ATRavg_ad)[[2]][[1]],3),
                round(bptest(anova2_ATRavg_md)[[2]][[1]],3),
                round(bptest(anova4_ATRavg_md)[[2]][[1]],3),
                round(bptest(anova2_ATRavg_rd)[[2]][[1]],3),
                round(bptest(anova4_ATRavg_rd)[[2]][[1]],3),
                round(bptest(anova2_ATRavg_fa)[[2]][[1]],3))

pBptest<-rbind(round(bptest(anova2_ATRavg_iron)[[4]][[1]],3),
               round(bptest(anova4_ATRavg_iron)[[4]][[1]],3),
               round(bptest(anova2_ATRavg_ad)[[4]][[1]],3),
               round(bptest(anova2_ATRavg_md)[[4]][[1]],3),
               round(bptest(anova4_ATRavg_md)[[4]][[1]],3),
               round(bptest(anova2_ATRavg_rd)[[4]][[1]],3),
               round(bptest(anova4_ATRavg_rd)[[4]][[1]],3),
               round(bptest(anova2_ATRavg_fa)[[4]][[1]],3))

Metric<-c('Iron','Iron-Without Outliers','AD','MD','MD-Without Outliers',
          'RD','RD-Without Outliers','FA')
Df_aov_avg<-cbind(Metric,Fsubgrupo,pSubgrupo,wShapiro,pShapiro,BPBptest,dfBptest,pBptest)
Df_aov_avg<-as.data.frame(Df_aov_avg)
colnames(Df_aov_avg)<-c('ATR-Metrics', 'F', 'p-value', 'W statistic', 'p-value', 
                        'BP statistic', 'df', 'p-value')

library(kableExtra)
kableExtra::kable(Df_aov_avg, caption = 'Modelos Anova para valores Average', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Subgroup' = 2, 'Normality' = 2, 'Homoscedasticity'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Dada esta variabilidad de resultados entre métricas y que la eliminación de outliers en cada métrica corresponde a diferentes individuos, se decide probar con métodos no paramétricos. 

De todas formas, dado que para la métrica de FA no se ha tenido que eliminar ningún sujeto y que el factor de interés (subgrupo) ha resultado significativo, se genera para esta métrica la comparación por pares. 

### Comparaciones pareadas por subgrupos 

Como se ha mencionado, sólo se realizará para la métrica FA. 

```{r ATRavg50.4, echo=FALSE}
library(agricolae)
library(rstatix)
#Generación de los posthoc
posthocHSD_ATRfa<-HSD.test(anova2_ATRavg_fa,"ATR_subgroup")
posthoctukey_ATRfa<-tukey_hsd(anova2_ATRavg_fa,"ATR_subgroup")
posthoctukey_ATRfa2<-TukeyHSD(anova2_ATRavg_fa,"ATR_subgroup")

#Grupos
groupsATRfa<-posthocHSD_ATRfa$groups
colnames(groupsATRfa)<-c('FA(mean)', 'Groups')
Variables<-c('PreHD','Control','HD')
groupsATRfa<-cbind(Variables,groupsATRfa)

#Diferencias y p-valores
difpATRfa<-posthoctukey_ATRfa2$ATR_subgroup[,c(1,4)]
comparativa<-rownames(difpATRfa)

#Global
globalATRfa<-cbind(groupsATRfa,comparativa,difpATRfa)
colnames(globalATRfa)<-c(colnames(groupsATRfa),'Comparison','Difference of means',
                         'Adjusted p-value')
```

```{r ATRavg50.5, echo=FALSE}
kableExtra::kable(globalATRfa, caption = 'HSD Tukey test para la métrica FA en relación a la variable subgrupo', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Como se observa, las **diferencias entre subgrupos en la métrica FA de ambos ATRs radica en la comparativa entre HD vs preHD**, con un valor aumentado de FA para preHD en relación a HD. 

## KRUSKAL WALLIS TEST

El **test de Kruskal Wallis** (generalización de la prueba U de Mann-Whitney para `k` muestras independientes) es un test no paramétrico (alternativa no paramétrica del ANOVA) para evaluar diferencias estadísticamente significativas entre `k` grupos independientes con respecto a sus medianas utilizando rangos.  

Los **supuestos** que deben cumplirse son los siguientes ([Test de Kruskal Wallis (H test) en R](https://r-coder.com/test-kruskal-wallis-r/)): 

- **Independencia**: las observaciones dentro de los grupos y entre ellos son independientes;
- **Datos ordinales o continuos**: la variable objeto de estudio debe medirse en una escala ordinal o continua;
- **Homogeneidad de varianzas**: la varianza de la variable dependiente debe ser aproximadamente igual en todos los grupos.
- **Muestreo aleatorio**: los datos deben obtenerse a partir de una muestra aleatoria de la población;
- **No se requiere normalidad**.

Las observaciones (sujetos) son independientes entre sí. Las variables dependientes (métricas de RM) son continuas. El muestreo no es aleatorio ya que es un estudio de casos y controles, con lo que este supuesto no se cumpliría. Respecto a la **homocedasticidad de varianzas**, se procede a su comprobación.

```{r ATRavg51.1, echo=FALSE}
# Homocedasticidad entre subgrupos
homo_subgrupos_Iron<-rbind(fligner.test(ATR_Iron~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                           fligner.test(ATR_Iron~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                           fligner.test(ATR_Iron~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_subgrupos_AD<-rbind(fligner.test(ATR_AD~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_AD~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_AD~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_subgrupos_MD<-rbind(fligner.test(ATR_MD~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_MD~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_MD~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_subgrupos_RD<-rbind(fligner.test(ATR_RD~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_RD~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_RD~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])
homo_subgrupos_FA<-rbind(fligner.test(ATR_FA~ATR_subgroup, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_FA~ATR_subgroup, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_FA~ATR_subgroup, data=ATR_DifIron_Df)[[3]][[1]])

homocedasticidad_subgrupo<-cbind(homo_subgrupos_Iron, homo_subgrupos_AD,
                                 homo_subgrupos_MD, homo_subgrupos_RD,
                                 homo_subgrupos_FA)
homocedasticidad_subgrupo<-round(homocedasticidad_subgrupo,4)
homocedasticidad_subgrupo_df<-as.data.frame(homocedasticidad_subgrupo)
rownames(homocedasticidad_subgrupo_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_subgrupo_df)<-c('Iron','AD','MD','RD','FA')
homocedasticidad_subgrupo_df<-t(homocedasticidad_subgrupo_df)

# Homocedasticidad entre hemisferios
homo_hemisferios_Iron<-rbind(fligner.test(ATR_Iron~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                             fligner.test(ATR_Iron~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                             fligner.test(ATR_Iron~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferios_AD<-rbind(fligner.test(ATR_AD~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                           fligner.test(ATR_AD~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                           fligner.test(ATR_AD~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferios_MD<-rbind(fligner.test(ATR_MD~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                           fligner.test(ATR_MD~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                           fligner.test(ATR_MD~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferios_RD<-rbind(fligner.test(ATR_RD~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                           fligner.test(ATR_RD~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                           fligner.test(ATR_RD~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])
homo_hemisferios_FA<-rbind(fligner.test(ATR_FA~ATR_hemisphere, data=ATR_DifIron_Df)[[1]][[1]],
                           fligner.test(ATR_FA~ATR_hemisphere, data=ATR_DifIron_Df)[[2]][[1]],
                           fligner.test(ATR_FA~ATR_hemisphere, data=ATR_DifIron_Df)[[3]][[1]])

homocedasticidad_hemisferio<-cbind(homo_hemisferios_Iron, homo_hemisferios_AD,
                                   homo_hemisferios_MD, homo_hemisferios_RD,
                                   homo_hemisferios_FA)
homocedasticidad_hemisferio<-round(homocedasticidad_hemisferio,4)
homocedasticidad_hemisferio_df<-as.data.frame(homocedasticidad_hemisferio)
rownames(homocedasticidad_hemisferio_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_hemisferio_df)<-c('Iron','AD','MD','RD','FA')
homocedasticidad_hemisferio_df<-t(homocedasticidad_hemisferio_df)

# Homocedasticidad entre géneros 
homo_generos_Iron<-rbind(fligner.test(ATR_Iron~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                         fligner.test(ATR_Iron~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                         fligner.test(ATR_Iron~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])
homo_generos_AD<-rbind(fligner.test(ATR_AD~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                       fligner.test(ATR_AD~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                       fligner.test(ATR_AD~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])
homo_generos_MD<-rbind(fligner.test(ATR_MD~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                       fligner.test(ATR_MD~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                       fligner.test(ATR_MD~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])
homo_generos_RD<-rbind(fligner.test(ATR_RD~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                       fligner.test(ATR_RD~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                       fligner.test(ATR_RD~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])
homo_generos_FA<-rbind(fligner.test(ATR_FA~ATR_Gender, data=ATR_DifIron_Df)[[1]][[1]],
                       fligner.test(ATR_FA~ATR_Gender, data=ATR_DifIron_Df)[[2]][[1]],
                       fligner.test(ATR_FA~ATR_Gender, data=ATR_DifIron_Df)[[3]][[1]])

homocedasticidad_genero<-cbind(homo_generos_Iron, homo_generos_AD,
                               homo_generos_MD, homo_generos_RD,
                               homo_generos_FA)
homocedasticidad_genero<-round(homocedasticidad_genero,4)
homocedasticidad_genero_df<-as.data.frame(homocedasticidad_genero)
rownames(homocedasticidad_genero_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_genero_df)<-c('Iron','AD','MD','RD','FA')
homocedasticidad_genero_df<-t(homocedasticidad_genero_df)

# Homocedasticidad entre los niveles de edad factorizada
homo_edadf_Iron<-rbind(fligner.test(ATR_Iron~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                       fligner.test(ATR_Iron~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                       fligner.test(ATR_Iron~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_edadf_AD<-rbind(fligner.test(ATR_AD~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_AD~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_AD~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_edadf_MD<-rbind(fligner.test(ATR_MD~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_MD~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_MD~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_edadf_RD<-rbind(fligner.test(ATR_RD~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_RD~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_RD~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])
homo_edadf_FA<-rbind(fligner.test(ATR_FA~ATR_agef2, data=ATR_DifIron_Df)[[1]][[1]],
                     fligner.test(ATR_FA~ATR_agef2, data=ATR_DifIron_Df)[[2]][[1]],
                     fligner.test(ATR_FA~ATR_agef2, data=ATR_DifIron_Df)[[3]][[1]])

homocedasticidad_edad<-cbind(homo_edadf_Iron, homo_edadf_AD, homo_edadf_MD, 
                             homo_edadf_RD, homo_edadf_FA)
homocedasticidad_edad<-round(homocedasticidad_edad,4)
homocedasticidad_edad_df<-as.data.frame(homocedasticidad_edad)
rownames(homocedasticidad_edad_df)<-c('Statistic','df','p-value')
colnames(homocedasticidad_edad_df)<-c('Iron','AD','MD','RD','FA')
homocedasticidad_edad_df<-t(homocedasticidad_edad_df)

homocedasticidad_df<-cbind(homocedasticidad_subgrupo_df,homocedasticidad_hemisferio_df,
                           homocedasticidad_genero_df,homocedasticidad_edad_df)
```

```{r ATRavg51.2, echo=FALSE}
kableExtra::kable(homocedasticidad_df, caption = 'Valoración de la homocedasticidad de las métricas de RM con la función fligner test', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Subgroup' = 3, 'Hemisphere' = 3, 'Gender' = 3, 'Factorized Age' = 3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='HOLD_position')
```

En relación a los **subgrupos**, las métricas de hierro, difusividad radial y anistropía fraccional presentan homocedasticidad de varianzas, y, las métricas de difusividad axial y difusividad media presentan heterocedasticidad de varianzas. 

En relación a los **hemisferios**, las métricas de difusividad axial, difusividad media, difusividad radial y anistropía fraccional presentan homocedasticidad de varianzas, y, la métrica de hierro presenta heterocedasticidad de varianzas. 

En relación a los **géneros**, las métricas de hierro, difusividad axial y anistropía fraccional presentan homocedasticidad de varianzas, y, las métricas de difusividad media y difusividad radial presentan heterocedasticidad de varianzas. 

En relación a la **edad factorizada**, todas las métricas presentan homocedasticidad de varianzas. 

La homocedasticidad o heterocedasticidad de varianzas de las diferentes métricas en relación a las diferentes variables categóricas independientes varía en función de cada combinación (métrica-variable categórica). La variable categórica subgrupo es el factor de interés primario en este estudio, y, las **métricas de hierro, difusividad radial y de anisotropía fraccional cumplen el criterio de homocedasticidad de varianzas para subgrupo**, así que decido realizar el test de Kruskal Wallis para dichas métricas a pesar de que no se cumple el criterio de aleatoriedad. Para las métricas de difusividad axial y difusividad media, no se generan los tests de Kruskal Wallis dado que presentan heterocedasticidad de varianzas para subgrupo. Si uno decidiera ser estadísticamente estricto, **no se deberían generar los tests de Kruskal Wallis dado que no se cumplen los criterios de aleatoriedad.**

La función `kruskal.test` del paquete `stats` se utiliza para realizar el test de Kruskal-Wallis, el cual evalúa si existen diferencias entre grupos en las distribuciones en función de los parámetros de localización ([Cómo realizar fácilmente una prueba de Kruskal-Wallis en R](https://statologos.com/prueba-de-kruskal-wallis-r/)). 

- *$H_0$: las medianas de todos los grupos son iguales;
- *$H_1$: desigualdad entre las medianas (al menos la mediana de un grupo es diferente de las demás).

```{r ATRavg51.3}
kw_iron<-kruskal.test(ATR_Iron~ATR_subgroup, data=ATR_DifIron_Df);kw_iron
kw_rd<-kruskal.test(ATR_RD~ATR_subgroup, data=ATR_DifIron_Df);kw_rd
kw_fa<-kruskal.test(ATR_FA~ATR_subgroup, data=ATR_DifIron_Df);kw_fa
```

```{r ATRavg51.4, echo=FALSE}
IRON<-round(rbind(kw_iron[[1]][[1]],kw_iron[[2]][[1]],kw_iron[[3]][[1]]),3)
RD<-rbind(round(kw_rd[[1]][[1]],3), round(kw_rd[[2]][[1]],3),round(kw_rd[[3]][[1]],7))
FA<-round(rbind(kw_fa[[1]][[1]],kw_fa[[2]][[1]],kw_fa[[3]][[1]]),3)
Variables<-c('Kruskal-Wallis chi-squared', 'df', 'p-value')
KW_metrics<-cbind(Variables,IRON,RD,FA)
KW_metrics_DF<-as.data.frame(KW_metrics)
colnames(KW_metrics_DF)<-c('', 'Iron', 'Radial Diffusivity', 'Fractional Anisotropy')
```

```{r ATRavg51.5, echo=FALSE}
kableExtra::kable(KW_metrics_DF, caption = 'Tests de Kruskal Wallis para las métricas de hierro, difusividad radial y anisotropía fraccional en relación a la variable independiente subgrupo', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='HOLD_position')
```

Como se evidencia en la tabla, **existen diferencias estadísticamente signficativas entre subgrupos para las métricas de difusividad radial y anisotropía fraccional.** 

Se ejecuta un test post-hoc con la función `pairwise.wilcox.test` del paquete `stats` para determinar entre qué pares de subgrupos radican las diferencias observadas para difusividad radial y anisotropía fraccional. Se especifica `p.adjust.method='fdr'` como método de ajuste de los p-valores por comparaciones múltiples. 

```{r ATRavg51.6}
PW_RD<-pairwise.wilcox.test(x=ATR_DifIron_Df$ATR_RD,
                            g=ATR_DifIron_Df$ATR_subgroup,
                            p.adjust.method = "fdr")
PW_FA<-pairwise.wilcox.test(x=ATR_DifIron_Df$ATR_FA,
                            g=ATR_DifIron_Df$ATR_subgroup,
                            p.adjust.method = "fdr")
```

```{r ATRavg51.7, echo=FALSE}
Comparativas_RD<-round(c(PW_RD$p.value[1,1],PW_RD$p.value[2,1],PW_RD$p.value[2,2]),5)
Comparativas_FA<-round(c(PW_FA$p.value[1,1],PW_FA$p.value[2,1],PW_FA$p.value[2,2]),5)
Comparación<-c('1-2','1-3','2-3')
Comparativas_PW<-cbind(Comparación, Comparativas_RD, Comparativas_FA)
Comparativas_PW_DF<-as.data.frame(Comparativas_PW)
rownames(Comparativas_PW_DF)<-NULL
colnames(Comparativas_PW_DF)<-c('Comparison','Radial Diffusivity', 'Fractional Anisotropy')
```

```{r ATRavg51.8, echo=FALSE}
kableExtra::kable(Comparativas_PW_DF, caption = 'Comparaciones Post-hoc con los p-valores ajustados mediante fdr para las métricas de difusividad radial y anisotropía fraccional en relación a la variable independiente subgrupo', booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='HOLD_position')
```

Las **diferencias entre subgrupos en la métrica RD de ambos ATRs radica en la comparativa entre HD vs controles y entre HD vs preHD** (con un valor aumentado de RD para HD en relación a preHD y controles).  

Las **diferencias entre subgrupos en la métrica FA de ambos ATRs radica en la comparativa entre preHD vs controles y entre preHD vs HD** (con un valor aumentado de FA para preHD en relación a HD y controles), a diferencia de los resultados obtenidos con ANOVA-post hoc Tukey en que sólo se detectaron diferencias para FA entre preHD vs HD.  

## ANOVA PERMUTACIONAL

Se consultan las siguientes webs: [aovp: Fitting and testing ANOVA using permutation tests](https://rdocumentation.org/packages/lmPerm/versions/2.1.0/topics/aovp), [lmp: Fitting and testing linear models with permutation tests.](https://rdocumentation.org/packages/lmPerm/versions/2.1.0/topics/lmp), [Permutation tests in R](https://www.r-bloggers.com/2012/05/permutation-tests-in-r/).

Los **tests de permutación** (también llamadas **tests de aleatorización o de re-aleatorización**) pueden resultar especialmente útiles con datos obtenidos a partir de distribuciones desconocidas (especialmente no normales), con tamaños muestrales pequeños (que no permiten confiar en resultados asintóticos) o con la existencia de valores atípicos. R tiene dos paquetes potentes para generar tests de permutación, el paquete `coin` y el paquete `lmPerm`. El **paquete `lmPerm`**, particularmente fácil de implementar, proporciona tests de permutación para modelos lineales, pudiéndose utilizar para todo tipo de diseños ANOVA/ANCOVA, así como para regresión simple, polinómica y múltiple, gracias a las funciones `aovp()` y `lmp()`, respectivamente. 

La función `aovp` del paquete `lmPerm` ([Package‘lmPerm’](https://cran.r-project.org/web/packages/lmPerm/lmPerm.pdf)) es una extensión del modelo ANOVA tradicional, cuyo objetivo principal es ajustar y testear modelos ANOVA utilizando tests de permutación en lugar de tests normales/paramétricos habituales y así las pruebas de hipótesis están basadas en permutaciones, siendo una buena alternativa al ANOVA con la violación de los supuestos de normalidad u homocedasticidad. La función `aovp` ajusta el modelo ANOVA llamando a `lmp` (*linear model permutation based*, modelo lineal basado en tests de permutación) para cada estrato del factor independiente. 

El **uso de dicha función** es el siguiente:

$aovp(formula, data = NULL, perm = "Exact", seqs = FALSE, center = TRUE, projections = FALSE, qr = TRUE, contrasts = NULL, ...)$

Los argumentos de la función son los siguientes: 

- `formula`: especificación de la fórmula del modelo;
- `data`: el dataframe que contiene las variables especificadas en la fórmula;
- `perm`: 'Exact', 'Prob' o 'SPR' para calcular las probabilidades de permutación, o, ' ' para producir probabilidades de F-test.
- `seqs`: TRUE para calcular SS (*Sum of Squares*) secuencial (type I SS), FALSE para calcular un único SS (type III SS); 
- `center`: TRUE para centrar las variables numéricas;
- `projections`: valor lógico (TRUE/FALSE) para determinar si se obtienen o no las proyecciones;
- `qr`: valor lógico (TRUE/FALSE) para determinar si se obtiene o no la descomposición QR; 
- `contrasts`: lista de contrastes para algunos de los factores de la fórmula (no se utilizan para términos de error ya que si se proporcionan contrastes para factores presentes sólo en el término de error, R generará un *warning*).
- `...`: argumentos adicionales a pasar a la función `aovp`, siendo iguales que para la función `lmp`. 

Importante saber qué tipo de cálculo se va a utilizar para el SS: el tipo I es secuencial por lo que el orden de los factores (variables independientes) es importante (primero se calcula el SS del primer factor, segundo se calcula el SS del segundo factor y así sucesivamente), y, el tipo III es único por lo que el orden de los factores no es importante (cada efecto se ajusta a todos los demás efectos). 

El **resultado de `aovp`** es similar al de `aov`, pero con p-valores basados en permutación en lugar de p-valores derivados de la teoría normal.

El **modelo asumido por `aovp`** es $Y = Xb + Zg + e$, donde `X` es la matriz de incidencia de efectos fijos y `Z` es la matriz de incidencia de efectos aleatorios (estratos de error) con columnas que representan los distintos estratos de error. El **algoritmo `aovp()`** proyecta Y en estratos de modo que cada estrato definido por bloques completos tenga un único término de error. X también se proyecta de modo que el modelo en este estrato sea $P(Y)=P(X)bi+ei$. El vector $b_i$ se divide en fuentes con `dfj` grados de libertad para la j-ésima fuente, y `summary(aovp())` producirá una tabla ANOVA para estas fuentes en el i-ésimo estrato. Se generarán los p-valores del test permutación o del test F en función de la especificación en el argumento `perm`. 

Sobre el tipo de SS a elegir, se consulta la web [Anova – Type I/II/III SS explained](https://www.r-bloggers.com/2011/03/anova-%e2%80%93-type-iiiiii-ss-explained/). Con **datos desbalanceados**, existen **3 formas diferentes de calcular las sumas de cuadrados** para ANOVA (tipo I, II y III) en función de las hipótesis a testear: 

- El **tipo I** testea el efecto principal del primer factor (A) sin controlar por el resto de factores, seguido del efecto principal del segundo factor (B) después del efecto principal de A (también sin controlar por el resto de factores), seguido del efecto de interacción AB después de los efectos principales. Debido a la naturaleza secuencial y al hecho de que los dos factores principales se testean en un orden particular, este tipo de sumas de cuadrados dará resultados diferentes para datos no balanceados dependiendo de qué efecto principal se considere primero. Así pues, para datos no balanceados, este enfoque testea una diferencia en las medias marginales ponderadas. En términos prácticos, esto significa que los resultados dependen de los tamaños de muestra obtenidos, es decir, de las proporciones en el conjunto de datos particular. Por tanto, este tipo de SS no suele ser la hipótesis que interesa cuando se trabaja con datos desequilibrados.
- El **tipo II** testea cada efecto principal después de controlar por el resto de efectos principales, suponiendo que ninguna interacción es significativa, por tanto, primero se debe testear que las interacciones no sean significativas para poder continuar con el análisis de los efectos principales. Si realmente no hay interacción, el tipo II es estadísticamente más poderoso que el tipo III. Computacionalmente, esto equivale a ejecutar un análisis de tipo I con diferentes órdenes de los factores y obtener el resultado apropiado.
- El **tipo III** testea la presencia de un efecto principal después de controlar por el otro efecto principal e interacción, por tanto, este enfoque es válido en presencia de interacciones significativas. Si las interacciones no son significativas, el tipo II ofrece un test más potente. Importante destacar que no es interesante interpretar un efecto principal si hay interacciones presentes (en términos generales, si hay una interacción significativa, los efectos principales no deberían analizarse). 

Por último, si los **datos están balanceados**, los factores son ortogonales y los tipos I, II y III dan todos los mismos resultados. 

**Por lo general, la hipótesis de interés trata sobre la importancia de un factor mientras se controla el nivel de los otros factores** y esto equivale a utilizar SS de tipo II o III. En general, si no hay un efecto de interacción significativo, entonces el tipo II es más potente y sigue el principio de marginalidad. Si hay interacción, entonces el tipo II es inapropiado, mientras que el tipo III aún puede usarse, pero los resultados deben interpretarse con precaución (en presencia de interacciones, los efectos principales rara vez son interpretables).

Como se hizo en el apartado del ANOVA, dado que los modelos MANOVA y PERMANOVA han detectado diferencias entre subgrupos en relación a las 5 métricas de RM, **se procede a generar los ANOVA permutacionales para valorar cada métrica por separado**. En este caso, los ANOVA permutacionales también se van a generar con 4 factores: subgrupo, hemisferio, edad factorizada y género. Se empezará con un **modelo con interacción de los 4 factores evaluado con un SS del tipo III**; posteriormente se irán eliminando los términos (interacciones) hasta llegar al **modelo más simple evaluado con un SS del tipo I**. Remarcar que tanto el hemisferio, la edad como el género son covariables que me interesa mantener en el modelo final aunque no sean significativas para eliminar su influencia en la relación entre métricas-subgrupos.

### IRON

```{r ATRavg52.1}
# Establecer seed para que el resultado de las permutaciones sea siempre el mismo
set.seed(123)

library(lmPerm)
anovaP_iron1<-aovp(ATR_Iron~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender, 
                   data=ATR_DifIron_Df, perm="", seqs=F)
summary(anovaP_iron1)
```

En el modelo `anovaP_iron1` generado con interacciones y con SS del tipo III, se evidencia que la interacción edad factorizada-género es significativa. En el siguiente modelo, se mantiene dicha interacción y se calcula la SS de tipo I para cada factor.  

```{r ATRavg52.2}
set.seed(123)
anovaP_iron2<-aovp(ATR_Iron~ATR_subgroup+ATR_hemisphere+ATR_agef2*ATR_Gender, 
                   data=ATR_DifIron_Df, perm="", seqs=T)
summary(anovaP_iron2)
```

Con este modelo `anovaP_iron2`, los términos significativos son el factor hemisferio y la interacción edad factorizada-género.  

```{r ATRavg52.2.bis, echo=FALSE, eval=FALSE}
kable(list(summary(anovaP_iron1)[[1]],summary(anovaP_iron2)[[1]]),
      caption='ANOVA Permutational Models for Iron of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### AD

```{r ATRavg52.3}
set.seed(123)
anovaP_ad1<-aovp(ATR_AD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=F)
summary(anovaP_ad1)
```

En el modelo `anovaP_ad1` generado con interacciones y con SS del tipo III, no se evidencia ninguna interacción significativa (la interacción edad factorizada-género es casi significativa con un p-valor de `r round(summary(anovaP_ad1)[[1]][12,5],3)`). En el siguiente modelo, se eliminan todas las interacciones y se calcula la SS de tipo I para cada factor. 

```{r ATRavg52.4}
set.seed(123)
anovaP_ad2<-aovp(ATR_AD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=T)
summary(anovaP_ad2)
```

Con este modelo `anovaP_ad2`, los términos significativos son los factores subgrupo y hemisferio.  

```{r ATRavg52.4.bis, echo=FALSE, eval=FALSE}
kable(list(summary(anovaP_ad1)[[1]],summary(anovaP_ad2)[[1]]),
      caption='ANOVA Permutational Models for AD of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### MD

```{r ATRavg52.5}
set.seed(123)
anovaP_md1<-aovp(ATR_MD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=F)
summary(anovaP_md1)
```

En el modelo `anovaP_md1` generado con interacciones y con SS del tipo III, no se evidencia ninguna interacción significativa. En el siguiente modelo, se eliminan todas las interacciones y se calcula la SS de tipo I para cada factor. 

```{r ATRavg52.6}
set.seed(123)
anovaP_md2<-aovp(ATR_MD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=T)
summary(anovaP_md2)
```

Con este modelo `anovaP_md2`, los términos significativos son los factores subgrupo, hemisferio y edad factorizada.  

```{r ATRavg52.6.bis, echo=FALSE, eval=FALSE}
kable(list(summary(anovaP_md1)[[1]],summary(anovaP_md2)[[1]]),
      caption='ANOVA Permutational Models for MD of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### RD

```{r ATRavg52.7}
set.seed(123)
anovaP_rd1<-aovp(ATR_RD~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=F)
summary(anovaP_rd1)
```

En el modelo `anovaP_rd1` generado con interacciones y con SS del tipo III, no se evidencia ninguna interacción significativa. En el siguiente modelo, se eliminan todas las interacciones y se calcula la SS de tipo I para cada factor. 

```{r ATRavg52.8}
set.seed(123)
anovaP_rd2<-aovp(ATR_RD~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=T)
summary(anovaP_rd2)
```

Con este modelo `anovaP_rd2`, los términos significativos son los factores subgrupo, hemisferio y edad factorizada.  

```{r ATRavg52.8.bis, echo=FALSE, eval=FALSE}
kable(list(summary(anovaP_rd1)[[1]],summary(anovaP_rd2)[[1]]),
      caption='ANOVA Permutational Models for RD of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

### FA

```{r ATRavg52.9}
set.seed(123)
anovaP_fa1<-aovp(ATR_FA~ATR_subgroup*ATR_hemisphere*ATR_agef2*ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=F)
summary(anovaP_fa1)
```

En el modelo `anovaP_fa1` generado con interacciones y con SS del tipo III, no se evidencia ninguna interacción significativa. En el siguiente modelo, se eliminan todas las interacciones y se calcula la SS de tipo I para cada factor. 

```{r ATRavg52.10}
set.seed(123)
anovaP_fa2<-aovp(ATR_FA~ATR_subgroup+ATR_hemisphere+ATR_agef2+ATR_Gender,
                 data=ATR_DifIron_Df, perm="", seqs=T)
summary(anovaP_fa2)
```

Con este modelo `anovaP_fa2`, el término significativo es el factor subgrupo. 

```{r ATRavg52.10.bis, echo=FALSE, eval=FALSE}
kable(list(summary(anovaP_fa1)[[1]],summary(anovaP_fa2)[[1]]),
      caption='ANOVA Permutational Models for FA of Both ATR', booktabs=TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

**En resumen:**

- El **modelo de hierro** presenta el factor hemisferio y la interacción edad factorizada-género como términos significativos;
- El **modelo de difusividad axial** presenta los factores subgrupo y hemisferio como términos significativos;
- Los **modelo de difusividad media y difusividad radial** presentan los factores subgrupo, hemisferio y edad factorizada como términos significativos;
- El **modelo de anistropía fraccional** presenta el factor subgrupo como término significativo.

Remarcar que, **a pesar de utilizar un test de permutaciones, no se consigue poder estadístico para detectar diferencias entre subgrupos para la métrica de hierro.** 

Es importante destacar que **la interacción subgrupo-hemisferio no es significativa**, por tanto, **no se puede concluir que la enfermedad de Huntington condicione una mayor degeneración de un ATR que de otro ATR, es decir, no se puede concluir una mayor vulnerabilidad de un hemisferio a la enfermedad de Huntington**. Así, las diferencias entre hemisferios detectadas para el hierro y para las difusividades axial y media puede considerarse inherentes a la fisiología diferencial de los hemisferios (diferentes funciones ejecutadas por cada hemisferio pueden condicionar diferencias en la estructura).  

### Comparaciones pareadas por subgrupos - Pairwise permutation test 

A continuación se generan las comparaciones pareadas por subgrupos para las métricas de difusvidad (axial, media y radial) y de anistropía fraccional.

Se va a utilizar la función `pairwisePermutationTest` del paquete `rcompanion`, habiendo consultado la web [pairwisePermutationTest: Pairwise two-sample independence tests](https://www.rdocumentation.org/packages/rcompanion/versions/2.4.35/topics/pairwisePermutationTest). Dicha función genera tests de independencia por pares entre grupos.

El **uso de dicha función** es el siguiente:

$pairwisePermutationTest(formula = NULL,data = NULL, x = NULL, g = NULL, method = "fdr", ...)$

Los argumentos de la función son los siguientes: 

- `formula`: una fórmula indicando la variable de medida y la variable de agrupamiento (ejemplo, y~grupo);
- `data`: el dataframe a utilizar; 
- `x`: la variable respuesta introducida como vector;
- `g`: la variable de agrupamiento introducida como vector; 
- `method`: el método de ajuste de los p-valores por tests múltiples; 
- `...`: argumentos adicionales utilizados en la función `coin:independence_test`.

En este caso, el **método de ajuste por múltiples comparaciones** que se va a utilizar es el **`fdr`.**

El **resultado de `pairwisePermutationTest`** es un dataframe que contiene los siguientes ítems: 

- `Comparison`: las comparaciones realizadas entre los pares de grupos;
- `Stat`: el estadístico calculado por permutación; 
- `p.value`: el p-valor sin ajustar, 
- `p.adjust`: el p-valor ajustado por comparaciones múltiples. 

```{r ATRavg52.11, warning=TRUE}
library(rcompanion)
# Comparaciones pareadas por subgrupos para AD
PairPerm_ad<-pairwisePermutationTest(ATR_AD~ATR_subgroup,
                                     data=ATR_DifIron_Df, method='fdr')

# Comparaciones pareadas por subgrupos para MD
PairPerm_md<-pairwisePermutationTest(ATR_MD~ATR_subgroup,
                                     data=ATR_DifIron_Df, method='fdr')

# Comparaciones pareadas por subgrupos para RD
PairPerm_rd<-pairwisePermutationTest(ATR_RD~ATR_subgroup,
                                     data=ATR_DifIron_Df, method='fdr')

# Comparaciones pareadas por subgrupos para FA
PairPerm_fa<-pairwisePermutationTest(ATR_FA~ATR_subgroup,
                                     data=ATR_DifIron_Df, method='fdr')
```

Para las métricas de difusividad radial y difusividad media se evidencia el mensaje `warning` especificando `The conditional covariance matrix has zero diagonal elements`, por lo que se decide trabajar con la transformación logarítmica de dichas métricas, misma transformación que la utilizada en la ejecución del MANOVA.

```{r ATRavg52.12}
ATR_DifIron_Log_DF<-cbind(ATR_DifIron_Df[1:11],log(ATR_DifIron_Df[,(8:10)]))
colnames(ATR_DifIron_Log_DF)<-c(colnames(ATR_DifIron_Df[1:11]),paste('Log',c(colnames(ATR_DifIron_Df[8:10])), sep='_'))

# Comparaciones pareadas por subgrupos para MD con transformación logarítmica 
PairPerm_mdLog<-pairwisePermutationTest(Log_ATR_MD~ATR_subgroup,
                                        data=ATR_DifIron_Log_DF, method='fdr')

# Comparaciones pareadas por subgrupos para RD
PairPerm_rdLog<-pairwisePermutationTest(Log_ATR_RD~ATR_subgroup,
                                        data=ATR_DifIron_Log_DF, method='fdr')
```

```{r ATRavg52.13, echo=FALSE}
PairPerm<-rbind(PairPerm_ad, PairPerm_mdLog, PairPerm_rdLog, PairPerm_fa)

kableExtra::kable(PairPerm, caption = 'Pairwise Permutation Test Results', 
                  booktabs = TRUE) %>%
    pack_rows(index=c('AD'=3, 'LogMD'=3, 'LogRD'=3, FA=3)) %>%
    kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

Las **diferencias entre subgrupos en la métricas de difusividad axial, media (con transformación logarítmica) y radial (con transformación logarítmica) de ambos ATRs radica en la comparativa entre HD vs controles y entre HD vs preHD** (con un valor aumentado de AD, RD y MD para HD en relación a preHD y controles).  

Las **diferencias entre subgrupos en la métrica FA de ambos ATRs radica en la comparativa entre preHD vs controles y entre preHD vs HD** (con un valor aumentado de FA para preHD en relación a HD y controles), resultado superponible al obtenido con Kruskal-Wallis y diferenciando del obtenido con ANOVA-post hoc Tukey en el que tan sólo se detectaron diferencias para FA entre preHD vs HD.  

\newpage

# Regresión logística

## ONE vs REST

En la regresión logística, se van a utilizar los dataframes con todos los sujetos dado que se quiere observar el poder de clasificación de los biomarcadores (métricas de RM) en poblaciones heterogéneas para así poder extrapolar los resultados a la clínica diaria. 

Se utiliza la función `multipleROC` del paquete `multipleROC`.

### RATR

```{r ATRavg53.1}
# ROC curves one vs the rest by multipleROC function from multipleROC package 
library(multipleROC)
#multipleROC(Subgroup=='Control'~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
#            data=RATR_avg_demo, plot=TRUE)
#multipleROC(Subgroup=='PreHD'~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
#            data=RATR_avg_demo, plot=TRUE)
#multipleROC(Subgroup=='HD'~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
#            data=RATR_avg_demo, plot=TRUE)
#Global_ROC_RATR5<-multipleROC(Subgroup~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
#                              data=RATR_avg_demo, plot=TRUE)

Global_ROC_RATR5<-multipleROC(Subgroup~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
                              data=RATR_avg_demo, plot=FALSE)
CT_ROC_RATR5<-multipleROC(Subgroup=='Control'~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,
                                                    rhatr_FA),
                          data=RATR_avg_demo, plot=FALSE)
PH_ROC_RATR5<-multipleROC(Subgroup=='PreHD'~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,
                                                  rhatr_FA),data=RATR_avg_demo, plot=FALSE)
HD_ROC_RATR5<-multipleROC(Subgroup=='HD'~cbind(rhatr_Iron,rhatr_AD,rhatr_RD,rhatr_MD,rhatr_FA),
                          data=RATR_avg_demo, plot=FALSE)
plot_ROC(list(CT_ROC_RATR5,PH_ROC_RATR5,HD_ROC_RATR5),show.eta = TRUE,show.sens = FALSE) + 
  labs(title= "Log Regression of RATR")
#plot_ROC(list(CT_ROC_RATR5,PH_ROC_RATR5,HD_ROC_RATR5),show.eta = TRUE,show.sens = TRUE)+ 
#  facet_grid(no~.) + labs(title= "Log Regression of RATR")
cutoff_RATR5<-rbind(CT_ROC_RATR5$cutoff[1,1],PH_ROC_RATR5$cutoff[1,1],HD_ROC_RATR5$cutoff[1,1])
rownames(cutoff_RATR5)<-c('Control','PreHD','HD')
kableExtra::kable(cutoff_RATR5, 
                  caption = 'Cutoff values of MRI metrics for subgroups in the 5-metrics LOGISTIC REGRESSION model of RATR', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

# STEP ROC curves one vs the rest by step_ROC function from multipleROC package 
## CONTROLS
RATR_avg_demo$Control<-ifelse(RATR_avg_demo$Subgroup=='Control',1,0)
step_ROC(Control~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA,data=RATR_avg_demo)+ 
  labs(title= "Step Log Regression of RATR for Controls")
step_ROC(Control~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA,data=RATR_avg_demo, 
         plot=FALSE)
### This has the same results
fitLogRegRATR_CT<-glm(Control~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA, 
                      data=RATR_avg_demo, family=binomial)
summary(fitLogRegRATR_CT)
finalLogRegRATR_CT=step(fitLogRegRATR_CT, trace=0)
summary(finalLogRegRATR_CT)
anova(finalLogRegRATR_CT,fitLogRegRATR_CT, test='Chisq')

## PREHD
RATR_avg_demo$PreHD<-ifelse(RATR_avg_demo$Subgroup=='PreHD',1,0)
step_ROC(PreHD~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA,data=RATR_avg_demo)+ 
  labs(title= "Step Log Regression of RATR for PreHD")
step_ROC(PreHD~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA,data=RATR_avg_demo, plot=FALSE)
### This has the same results
fitLogRegRATR_PH<-glm(PreHD~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA, data=RATR_avg_demo, family=binomial)
summary(fitLogRegRATR_PH)
finalLogRegRATR_PH=step(fitLogRegRATR_PH, trace=0)
summary(finalLogRegRATR_PH)
anova(finalLogRegRATR_PH,fitLogRegRATR_PH, test='Chisq')

## HD
RATR_avg_demo$HD<-ifelse(RATR_avg_demo$Subgroup=='HD',1,0)
step_ROC(HD~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA,data=RATR_avg_demo)+ 
  labs(title= "Step Log Regression of RATR for HD")
step_ROC(HD~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA,data=RATR_avg_demo, plot=FALSE)
### This has the same results
fitLogRegRATR_HD<-glm(HD~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA, 
                      data=RATR_avg_demo, family=binomial)
summary(fitLogRegRATR_HD)
finalLogRegRATR_HD=step(fitLogRegRATR_HD, trace=0)
summary(finalLogRegRATR_HD)
anova(finalLogRegRATR_HD,fitLogRegRATR_HD, test='Chisq')
```

```{r ATRavg53.1.bis, echo=FALSE}
# CT
sum_fitLogRegRATR_CT<-summary(fitLogRegRATR_CT)
sum_finalLogRegRATR_CT<-summary(finalLogRegRATR_CT)

sum_CT_LRRATR<-rbind(sum_fitLogRegRATR_CT$coefficients,
                     sum_finalLogRegRATR_CT$coefficients)
colnames(sum_CT_LRRATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_CT_LRRATR, caption='Binomial Logistic Regression for Controls vs Rest in Right ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: Control ~ rhatr_Iron + rhatr_AD + rhatr_RD + rhatr_MD + rhatr_FA'=6, 'Model 1: Control ~ rhatr_MD'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegRATR_CT<-anova(finalLogRegRATR_CT,fitLogRegRATR_CT, test='Chisq')
rownames(aov_LogRegRATR_CT)<-c('Model 1: Control ~ rhatr_MD','Model 2: Control ~ rhatr_Iron + rhatr_AD + rhatr_RD + rhatr_MD + rhatr_FA')
kable(aov_LogRegRATR_CT,caption='Comparison of two Binomial Logistic Regressions for Controls vs Rest in Right ATR')

# PHD
sum_fitLogRegRATR_PH<-summary(fitLogRegRATR_PH)
sum_finalLogRegRATR_PH<-summary(finalLogRegRATR_PH)

sum_PH_LRRATR<-rbind(sum_fitLogRegRATR_PH$coefficients,
                     sum_finalLogRegRATR_PH$coefficients)
colnames(sum_PH_LRRATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_PH_LRRATR, caption='Binomial Logistic Regression for PreHD vs Rest in Right ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: PreHD ~ rhatr_Iron + rhatr_AD + rhatr_RD + rhatr_MD + rhatr_FA'=6, 'Model 1: PreHD ~ rhatr_RD'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegRATR_PH<-anova(finalLogRegRATR_PH,fitLogRegRATR_PH, test='Chisq')
rownames(aov_LogRegRATR_PH)<-c('Model 1: PreHD ~ rhatr_RD','Model 2: PreHD ~ rhatr_Iron + rhatr_AD + rhatr_RD + rhatr_MD + rhatr_FA')
kable(aov_LogRegRATR_PH,caption='Comparison of two Binomial Logistic Regressions for PreHD vs Rest in Right ATR')

# HD
sum_fitLogRegRATR_HD<-summary(fitLogRegRATR_HD)
sum_finalLogRegRATR_HD<-summary(finalLogRegRATR_HD)

sum_HD_LRRATR<-rbind(sum_fitLogRegRATR_HD$coefficients,
                     sum_finalLogRegRATR_HD$coefficients)
colnames(sum_HD_LRRATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_HD_LRRATR, caption='Binomial Logistic Regression for HD vs Rest in Right ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: HD ~ rhatr_Iron + rhatr_AD + rhatr_RD + rhatr_MD + rhatr_FA'=6, 'Model 1: HD ~ rhatr_MD'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegRATR_HD<-anova(finalLogRegRATR_HD,fitLogRegRATR_HD, test='Chisq')
rownames(aov_LogRegRATR_HD)<-c('Model 1: HD ~ rhatr_MD','Model 2: HD ~ rhatr_Iron + rhatr_AD + rhatr_RD + rhatr_MD + rhatr_FA')
kable(aov_LogRegRATR_HD,caption='Comparison of two Binomial Logistic Regressions for HD vs Rest in Right ATR')
```

### LATR

```{r ATRavg53.2}
# ROC curves one vs the rest by multipleROC function from multipleROC package 
library(multipleROC)
#multipleROC(Subgroup=='Control'~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA),
#            data=LATR_avg_demo, plot=TRUE)
#multipleROC(Subgroup=='PreHD'~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA),
#            data=LATR_avg_demo, plot=TRUE)
#multipleROC(Subgroup=='HD'~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,lhatr_FA),
#            data=LATR_avg_demo, plot=TRUE)
#Global_ROC_LATR5<-multipleROC(Subgroup~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,
#                                             lhatr_FA),data=LATR_avg_demo, plot=TRUE)

Global_ROC_LATR5<-multipleROC(Subgroup~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,lhatr_MD,
                                             lhatr_FA),data=LATR_avg_demo, plot=FALSE)
CT_ROC_LATR5<-multipleROC(Subgroup=='Control'~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,
                                                    lhatr_MD,lhatr_FA),
                          data=LATR_avg_demo, plot=FALSE)
PH_ROC_LATR5<-multipleROC(Subgroup=='PreHD'~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,
                                                  lhatr_MD,lhatr_FA),
                          data=LATR_avg_demo, plot=FALSE)
HD_ROC_LATR5<-multipleROC(Subgroup=='HD'~cbind(lhatr_Iron,lhatr_AD,lhatr_RD,
                                               lhatr_MD,lhatr_FA),
                          data=LATR_avg_demo, plot=FALSE)
plot_ROC(list(CT_ROC_LATR5,PH_ROC_LATR5,HD_ROC_LATR5),show.eta = TRUE,
         show.sens = FALSE) + labs(title= "Log Regression of LATR")
#plot_ROC(list(CT_ROC_LATR5,PH_ROC_LATR5,HD_ROC_LATR5),show.eta = TRUE,
#         show.sens = TRUE)+ facet_grid(no~.) + labs(title= "Log Regression of LATR")
cutoff_LATR5<-rbind(CT_ROC_LATR5$cutoff[1,1],PH_ROC_LATR5$cutoff[1,1],
                    HD_ROC_LATR5$cutoff[1,1])
rownames(cutoff_LATR5)<-c('Control','PreHD','HD')
kableExtra::kable(cutoff_LATR5, 
                  caption = 'Cutoff values of MRI metrics for subgroups in the 5-metrics LOGISTIC REGRESSION model of LATR', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

# STEP ROC curves one vs the rest by step_ROC function from multipleROC package 
## CONTROLS
LATR_avg_demo$Control<-ifelse(LATR_avg_demo$Subgroup=='Control',1,0)
step_ROC(Control~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA,data=LATR_avg_demo)+ 
  labs(title= "Step Log Regression of LATR for Controls")
step_ROC(Control~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA,data=LATR_avg_demo, 
         plot=FALSE)
### This has the same results
fitLogRegLATR_CT<-glm(Control~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA, 
                      data=LATR_avg_demo, family=binomial)
summary(fitLogRegLATR_CT)
finalLogRegLATR_CT=step(fitLogRegLATR_CT, trace=0)
summary(finalLogRegLATR_CT)
anova(finalLogRegLATR_CT,fitLogRegLATR_CT, test='Chisq')

## PREHD
LATR_avg_demo$PreHD<-ifelse(LATR_avg_demo$Subgroup=='PreHD',1,0)
step_ROC(PreHD~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA,data=LATR_avg_demo)+ 
  labs(title= "Step Log Regression of LATR for PreHD")
step_ROC(PreHD~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA,data=LATR_avg_demo, 
         plot=FALSE)
### This has the same results
fitLogRegLATR_PH<-glm(PreHD~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA, 
                      data=LATR_avg_demo, family=binomial)
summary(fitLogRegLATR_PH)
finalLogRegLATR_PH=step(fitLogRegLATR_PH, trace=0)
summary(finalLogRegLATR_PH)
anova(finalLogRegLATR_PH,fitLogRegLATR_PH, test='Chisq')

## HD
LATR_avg_demo$HD<-ifelse(LATR_avg_demo$Subgroup=='HD',1,0)
step_ROC(HD~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA,data=LATR_avg_demo)+ 
  labs(title= "Step Log Regression of LATR for HD")
step_ROC(HD~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA,data=LATR_avg_demo, 
         plot=FALSE)
### This has the same results
fitLogRegLATR_HD<-glm(HD~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA, 
                      data=LATR_avg_demo, family=binomial)
summary(fitLogRegLATR_HD)
finalLogRegLATR_HD=step(fitLogRegLATR_HD, trace=0)
summary(finalLogRegLATR_HD)
anova(finalLogRegLATR_HD,fitLogRegLATR_HD, test='Chisq')
```

```{r ATRavg53.2.bis, echo=FALSE}
# CT
sum_fitLogRegLATR_CT<-summary(fitLogRegLATR_CT)
sum_finalLogRegLATR_CT<-summary(finalLogRegLATR_CT)

sum_CT_LRLATR<-rbind(sum_fitLogRegLATR_CT$coefficients,
                     sum_finalLogRegLATR_CT$coefficients)
colnames(sum_CT_LRLATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_CT_LRLATR, caption='Binomial Logistic Regression for Controls vs Rest in Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: Control ~ lhatr_Iron + lhatr_AD + lhatr_RD + lhatr_MD + lhatr_FA'=6, 'Model 1: Control ~ lhatr_Iron + lhatr_RD + lhatr_FA'=4)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegLATR_CT<-anova(finalLogRegLATR_CT,fitLogRegLATR_CT, test='Chisq')
rownames(aov_LogRegLATR_CT)<-c('Model 1: Control ~ lhatr_Iron + lhatr_RD + lhatr_FA','Model 2: Control ~ lhatr_Iron + lhatr_AD + lhatr_RD + lhatr_MD + lhatr_FA')
kable(aov_LogRegLATR_CT,caption='Comparison of two Binomial Logistic Regressions for Controls vs Rest in Left ATR')

# PHD
sum_fitLogRegLATR_PH<-summary(fitLogRegLATR_PH)
sum_finalLogRegLATR_PH<-summary(finalLogRegLATR_PH)

sum_PH_LRLATR<-rbind(sum_fitLogRegLATR_PH$coefficients,
                     sum_finalLogRegLATR_PH$coefficients)
colnames(sum_PH_LRLATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_PH_LRLATR, caption='Binomial Logistic Regression for PreHD vs Rest in Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: PreHD ~ lhatr_Iron + lhatr_AD + lhatr_RD + lhatr_MD + lhatr_FA'=6, 'Model 1: PreHD ~ lhatr_RD + lhatr_MD'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegLATR_PH<-anova(finalLogRegLATR_PH,fitLogRegLATR_PH, test='Chisq')
rownames(aov_LogRegLATR_PH)<-c('Model 1: PreHD ~ lhatr_RD + lhatr_MD','Model 2: PreHD ~ lhatr_Iron + lhatr_AD + lhatr_RD + lhatr_MD + lhatr_FA')
kable(aov_LogRegLATR_PH,caption='Comparison of two Binomial Logistic Regressions for PreHD vs Rest in Left ATR')

# HD
sum_fitLogRegLATR_HD<-summary(fitLogRegLATR_HD)
sum_finalLogRegLATR_HD<-summary(finalLogRegLATR_HD)

sum_HD_LRLATR<-rbind(sum_fitLogRegLATR_HD$coefficients,
                     sum_finalLogRegLATR_HD$coefficients)
colnames(sum_HD_LRLATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_HD_LRLATR, caption='Binomial Logistic Regression for HD vs Rest in Left ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: HD ~ lhatr_Iron + lhatr_AD + lhatr_RD + lhatr_MD + lhatr_FA'=6, 'Model 1: HD ~ lhatr_RD + lhatr_FA'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegLATR_HD<-anova(finalLogRegLATR_HD,fitLogRegLATR_HD, test='Chisq')
rownames(aov_LogRegLATR_HD)<-c('Model 1: HD ~ lhatr_RD + lhatr_FA','Model 2: HD ~ lhatr_Iron + lhatr_AD + lhatr_RD + lhatr_MD + lhatr_FA')
kable(aov_LogRegLATR_HD,caption='Comparison of two Binomial Logistic Regressions for HD vs Rest in Left ATR')
```

### Ambos ATR

```{r ATRavg53.3}
# ROC curves one vs the rest by multipleROC function from multipleROC package 
library(multipleROC)
#multipleROC(ATR_subgroup=='1'~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
#            data=ATR_avg, plot=TRUE)
#multipleROC(ATR_subgroup=='2'~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
#            data=ATR_avg, plot=TRUE)
#multipleROC(ATR_subgroup=='3'~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
#            data=ATR_avg, plot=TRUE)
#Global_ROC_ATR5<-multipleROC(ATR_subgroup~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
#                             data=ATR_avg, plot=TRUE)

Global_ROC_ATR5<-multipleROC(ATR_subgroup~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
                             data=ATR_avg, plot=FALSE)
CT_ROC_ATR5<-multipleROC(ATR_subgroup=='1'~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
                         data=ATR_avg, plot=FALSE)
PH_ROC_ATR5<-multipleROC(ATR_subgroup=='2'~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
                         data=ATR_avg, plot=FALSE)
HD_ROC_ATR5<-multipleROC(ATR_subgroup=='3'~cbind(ATR_Iron,ATR_AD,ATR_RD,ATR_MD,ATR_FA),
                         data=ATR_avg, plot=FALSE)
plot_ROC(list(CT_ROC_ATR5,PH_ROC_ATR5,HD_ROC_ATR5),show.eta = TRUE,show.sens = FALSE) + 
  labs(title= "Log Regression of Both ATR")
#plot_ROC(list(CT_ROC_ATR5,PH_ROC_ATR5,HD_ROC_ATR5),show.eta = TRUE,show.sens = TRUE)+ 
#  facet_grid(no~.) + labs(title= "Log Regression of Both ATR")
cutoff_ATR5<-rbind(CT_ROC_ATR5$cutoff[1,1],PH_ROC_ATR5$cutoff[1,1],HD_ROC_ATR5$cutoff[1,1])
rownames(cutoff_ATR5)<-c('Control','PreHD','HD')
kableExtra::kable(cutoff_ATR5, 
                  caption = 'Cutoff values of MRI metrics for subgroups in the 5-metrics LOGISTIC REGRESSION model of Both ATR', 
                  booktabs = TRUE) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

# STEP ROC curves one vs the rest by step_ROC function from multipleROC package 
## CONTROLS
ATR_avg$Control<-ifelse(ATR_avg$ATR_subgroup=='1',1,0)
step_ROC(Control~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg)+ 
  labs(title= "Step Log Regression of Both ATR for Controls")
step_ROC(Control~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg, plot=FALSE)
### This has the same results
fitLogRegATR_CT<-glm(Control~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg, 
                     family=binomial)
summary(fitLogRegATR_CT)
finalLogRegATR_CT=step(fitLogRegATR_CT, trace=0)
summary(finalLogRegATR_CT)
anova(finalLogRegATR_CT,fitLogRegATR_CT, test='Chisq')

## PREHD
ATR_avg$PreHD<-ifelse(ATR_avg$ATR_subgroup=='2',1,0)
step_ROC(PreHD~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg)+ 
  labs(title= "Step Log Regression of Both ATR for PreHD")
step_ROC(PreHD~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg, plot=FALSE)
### This has the same results
fitLogRegATR_PH<-glm(PreHD~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg, 
                     family=binomial)
summary(fitLogRegATR_PH)
finalLogRegATR_PH=step(fitLogRegATR_PH, trace=0)
summary(finalLogRegATR_PH)
anova(finalLogRegATR_PH,fitLogRegATR_PH, test='Chisq')

## HD
ATR_avg$HD<-ifelse(ATR_avg$ATR_subgroup=='3',1,0)
step_ROC(HD~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg)+ 
  labs(title= "Step Log Regression of Both ATR for HD")
step_ROC(HD~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg, plot=FALSE)
### This has the same results
fitLogRegATR_HD<-glm(HD~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,data=ATR_avg, 
                     family=binomial)
summary(fitLogRegATR_HD)
finalLogRegATR_HD=step(fitLogRegATR_HD, trace=0)
summary(finalLogRegATR_HD)
anova(finalLogRegATR_HD,fitLogRegATR_HD, test='Chisq')
```

```{r ATRavg53.3.bis, echo=FALSE}
# CT
sum_fitLogRegATR_CT<-summary(fitLogRegATR_CT)
sum_finalLogRegATR_CT<-summary(finalLogRegATR_CT)

sum_CT_LRATR<-rbind(sum_fitLogRegATR_CT$coefficients,
                    sum_finalLogRegATR_CT$coefficients)
colnames(sum_CT_LRATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_CT_LRATR, caption='Binomial Logistic Regression for Controls vs Rest in Both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: Control ~ ATR_Iron + ATR_AD + ATR_RD + ATR_MD + ATR_FA'=6, 'Model 1: Control ~ ATR_Iron + ATR_MD + ATR_FA'=4)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegATR_CT<-anova(finalLogRegATR_CT,fitLogRegATR_CT, test='Chisq')
rownames(aov_LogRegATR_CT)<-c('Model 1: Control ~ ATR_Iron + ATR_MD + ATR_FA','Model 2: Control ~ ATR_Iron + ATR_AD + ATR_RD + ATR_MD + ATR_FA')
kable(aov_LogRegATR_CT,caption='Comparison of two Binomial Logistic Regressions for Controls vs Rest in Both ATR')

# PHD
sum_fitLogRegATR_PH<-summary(fitLogRegATR_PH)
sum_finalLogRegATR_PH<-summary(finalLogRegATR_PH)

sum_PH_LRATR<-rbind(sum_fitLogRegATR_PH$coefficients,
                    sum_finalLogRegATR_PH$coefficients)
colnames(sum_PH_LRATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_PH_LRATR, caption='Binomial Logistic Regression for PreHD vs Rest in Both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: PreHD ~ ATR_Iron + ATR_AD + ATR_RD + ATR_MD + ATR_FA'=6, 'Model 1: PreHD ~ ATR_Iron + ATR_RD + ATR_MD'=4)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegATR_PH<-anova(finalLogRegATR_PH,fitLogRegATR_PH, test='Chisq')
rownames(aov_LogRegATR_PH)<-c('Model 1: PreHD ~ ATR_Iron + ATR_RD + ATR_MD','Model 2: PreHD ~ ATR_Iron + ATR_AD + ATR_RD + ATR_MD + ATR_FA')
kable(aov_LogRegATR_PH,caption='Comparison of two Binomial Logistic Regressions for PreHD vs Rest in Both ATR')

# HD
sum_fitLogRegATR_HD<-summary(fitLogRegATR_HD)
sum_finalLogRegATR_HD<-summary(finalLogRegATR_HD)

sum_HD_LRATR<-rbind(sum_fitLogRegATR_HD$coefficients,
                     sum_finalLogRegATR_HD$coefficients)
colnames(sum_HD_LRATR)<-c('Estimate','Std.Error','z value','p value')

kableExtra::kable(sum_HD_LRATR, caption='Binomial Logistic Regression for HD vs Rest in Both ATR', booktabs=TRUE) %>%
  pack_rows(index=c('Model 2: HD ~ ATR_Iron + ATR_AD + ATR_RD + ATR_MD + ATR_FA'=6, 'Model 1: HD ~ ATR_RD + ATR_FA'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

aov_LogRegATR_HD<-anova(finalLogRegATR_HD,fitLogRegATR_HD, test='Chisq')
rownames(aov_LogRegATR_HD)<-c('Model 1: HD ~ ATR_RD + ATR_FA','Model 2: HD ~ ATR_Iron + ATR_AD + ATR_RD + ATR_MD + ATR_FA')
kable(aov_LogRegATR_HD,caption='Comparison of two Binomial Logistic Regressions for HD vs Rest in Both ATR')
```

## ONE vs ONE

### RATR

Primero, sin transformación logarítmica de AD, RD y MD

```{r ATRavg53.4}
library(nnet)
# Level of reference in the outcome variable
RATR_avg_demo$Subgroup2<-relevel(RATR_avg_demo$Subgroup, ref = 'Control')
# Fit the model
fitMultinomialLogRegRATR<-multinom(Subgroup2~rhatr_Iron+rhatr_AD+rhatr_RD+rhatr_MD+rhatr_FA, 
                                   data=RATR_avg_demo)
summary(fitMultinomialLogRegRATR)
# Wald test (z-test) 
z_fitMultinomialLogRegRATR<-summary(fitMultinomialLogRegRATR)$coefficients/summary(fitMultinomialLogRegRATR)$standard.errors
round(z_fitMultinomialLogRegRATR,4)
# p-value 
p_fitMultinomialLogRegRATR<-(1-pnorm(abs(z_fitMultinomialLogRegRATR),0,1))*2
round(p_fitMultinomialLogRegRATR,4)
# Tabla
sum_fitMultinomialLogRegRATR<-summary(fitMultinomialLogRegRATR)
tbl_fitMultinomialLogRegRATR<-rbind(sum_fitMultinomialLogRegRATR$coefficients,
                                    sum_fitMultinomialLogRegRATR$standard.errors,
                                    round(z_fitMultinomialLogRegRATR,4),
                                    round(p_fitMultinomialLogRegRATR,4))
kableExtra::kable(tbl_fitMultinomialLogRegRATR, caption='Multinomial Logistic Regression for Right ATR (controls as a reference)', booktabs=TRUE) %>%
  pack_rows(index=c('Coefficients'=2, 'Standard Errors'=2, 'Z-test'=2, 'p-value'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
# Evaluación del modelo
## Predicted probabilities
PP_MultinomialLogRegRATR<-fitMultinomialLogRegRATR$fitted.values
PP_MultinomialLogRegRATR_DF<-as.data.frame(PP_MultinomialLogRegRATR)
## Predicted classes
PC_LogRegRATR<-matrix(ncol=ncol(PP_MultinomialLogRegRATR_DF),
                      nrow=nrow(PP_MultinomialLogRegRATR_DF))
for (i in 1:nrow(PP_MultinomialLogRegRATR_DF)){
  PC_LogRegRATR[i,]<-ifelse(PP_MultinomialLogRegRATR_DF[i,]==max(PP_MultinomialLogRegRATR_DF[i,]),1,0)
}
colnames(PC_LogRegRATR)<-colnames(PP_MultinomialLogRegRATR_DF)
## ROC curves one vs the rest by multiROC package 
Control_pred_LogRegRATR<- PP_MultinomialLogRegRATR_DF$Control
PreHD_pred_LogRegRATR<- PP_MultinomialLogRegRATR_DF$PreHD
HD_pred_LogRegRATR<- PP_MultinomialLogRegRATR_DF$HD
Control_true<-ifelse(RATR_avg_demo$Subgroup=='Control',1,0)
PreHD_true<-ifelse(RATR_avg_demo$Subgroup=='PreHD',1,0)
HD_true<-ifelse(RATR_avg_demo$Subgroup=='HD',1,0)
DF_ROC_LogRegRATR<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LogRegRATR,
                         PreHD_pred_LogRegRATR,HD_pred_LogRegRATR)
multiROC_LogRegRATR<-multiROC::multi_roc(DF_ROC_LogRegRATR)
multiROC_LogRegRATR_DF<-plot_roc_data(multiROC_LogRegRATR)
ggplot(multiROC_LogRegRATR_DF, aes(x=1-Specificity, y=Sensitivity, 
                                   color = Group)) + 
  geom_step() + geom_point() + labs(title= "ROC curve for Logistic Regression model of Right ATR: One vs One",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, 
                                                          slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_LogRegRATR_DF$AUC[multiROC_LogRegRATR_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_LogRegRATR_DF$AUC[multiROC_LogRegRATR_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_LogRegRATR_DF$AUC[multiROC_LogRegRATR_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_LogRegRATR_DF$AUC[multiROC_LogRegRATR_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_LogRegRATR_DF$AUC[multiROC_LogRegRATR_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)
```

Segundo, con transformación logarítmica de AD, RD, MD

```{r ATRavg53.5}
library(nnet)
# Fit the model
fitMultinomialLogRegRATRLog<-multinom(Subgroup2~rhatr_Iron+log(rhatr_AD)+log(rhatr_RD)+log(rhatr_MD)+rhatr_FA, 
                                      data=RATR_avg_demo)
summary(fitMultinomialLogRegRATRLog)
# Wald test (z-test) 
z_fitMultinomialLogRegRATRLog<-summary(fitMultinomialLogRegRATRLog)$coefficients/summary(fitMultinomialLogRegRATRLog)$standard.errors
round(z_fitMultinomialLogRegRATRLog,4)
# p-value 
p_fitMultinomialLogRegRATRLog<-(1-pnorm(abs(z_fitMultinomialLogRegRATRLog),0,1))*2
round(p_fitMultinomialLogRegRATRLog,4)
# Tabla
sum_fitMultinomialLogRegRATRLog<-summary(fitMultinomialLogRegRATRLog)
tbl_fitMultinomialLogRegRATRLog<-rbind(sum_fitMultinomialLogRegRATRLog$coefficients,
                                       sum_fitMultinomialLogRegRATRLog$standard.errors,
                                       round(z_fitMultinomialLogRegRATRLog,4),
                                       round(p_fitMultinomialLogRegRATRLog,4))
kableExtra::kable(tbl_fitMultinomialLogRegRATRLog, caption='Multinomial Logistic Regression for Right ATR (controls as a reference) with log transform of diffusivities', booktabs=TRUE) %>%
  pack_rows(index=c('Coefficients'=2, 'Standard Errors'=2, 'Z-test'=2, 'p-value'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
# Evaluación del modelo
## Predicted probabilities
PP_MultinomialLogRegLATR<-fitMultinomialLogRegRATRLog$fitted.values
PP_MultinomialLogRegLATR_DF<-as.data.frame(PP_MultinomialLogRegLATR)
## Predicted classes
PC_LogRegLATR<-matrix(ncol=ncol(PP_MultinomialLogRegLATR_DF),
                      nrow=nrow(PP_MultinomialLogRegLATR_DF))
for (i in 1:nrow(PP_MultinomialLogRegLATR_DF)){
  PC_LogRegLATR[i,]<-ifelse(PP_MultinomialLogRegLATR_DF[i,]==max(PP_MultinomialLogRegLATR_DF[i,]),1,0)
}
colnames(PC_LogRegLATR)<-colnames(PP_MultinomialLogRegLATR_DF)
## ROC curves one vs the rest by multiROC package 
Control_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$Control
PreHD_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$PreHD
HD_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$HD
Control_true<-ifelse(LATR_avg_demo$Subgroup=='Control',1,0)
PreHD_true<-ifelse(LATR_avg_demo$Subgroup=='PreHD',1,0)
HD_true<-ifelse(LATR_avg_demo$Subgroup=='HD',1,0)
DF_ROC_LogRegLATR<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LogRegLATR,
                         PreHD_pred_LogRegLATR,HD_pred_LogRegLATR)
multiROC_LogRegLATR<-multiROC::multi_roc(DF_ROC_LogRegLATR)
multiROC_LogRegLATR_DF<-plot_roc_data(multiROC_LogRegLATR)
ggplot(multiROC_LogRegLATR_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "ROC curve for Logistic Regression model of Right ATR with log-transform of diffusivities: One vs One",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)
```

### LATR

Primero, sin transformación logarítmica de AD, RD y MD

```{r ATRavg53.6}
library(nnet)
# Level of reference in the outcome variable
LATR_avg_demo$Subgroup2<-relevel(LATR_avg_demo$Subgroup, ref = 'Control')
# Fit the model
fitMultinomialLogRegLATR<-multinom(Subgroup2~lhatr_Iron+lhatr_AD+lhatr_RD+lhatr_MD+lhatr_FA,
                                   data=LATR_avg_demo)
summary(fitMultinomialLogRegLATR)
# Wald test (z-test) 
z_fitMultinomialLogRegLATR<-summary(fitMultinomialLogRegLATR)$coefficients/summary(fitMultinomialLogRegLATR)$standard.errors
round(z_fitMultinomialLogRegLATR,4)
# p-value 
p_fitMultinomialLogRegLATR<-(1-pnorm(abs(z_fitMultinomialLogRegLATR),0,1))*2
round(p_fitMultinomialLogRegLATR,4)
# Tabla
sum_fitMultinomialLogRegLATR<-summary(fitMultinomialLogRegLATR)
tbl_fitMultinomialLogRegLATR<-rbind(sum_fitMultinomialLogRegLATR$coefficients,
                                    sum_fitMultinomialLogRegLATR$standard.errors,
                                    round(z_fitMultinomialLogRegLATR,4),
                                    round(p_fitMultinomialLogRegLATR,4))
kableExtra::kable(tbl_fitMultinomialLogRegLATR, caption='Multinomial Logistic Regression for Left ATR (controls as a reference)', booktabs=TRUE) %>%
  pack_rows(index=c('Coefficients'=2, 'Standard Errors'=2, 'Z-test'=2, 'p-value'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
# Evaluación del modelo
## Predicted probabilities
PP_MultinomialLogRegLATR<-fitMultinomialLogRegLATR$fitted.values
PP_MultinomialLogRegLATR_DF<-as.data.frame(PP_MultinomialLogRegLATR)
## Predicted classes
PC_LogRegLATR<-matrix(ncol=ncol(PP_MultinomialLogRegLATR_DF),
                      nrow=nrow(PP_MultinomialLogRegLATR_DF))
for (i in 1:nrow(PP_MultinomialLogRegLATR_DF)){
  PC_LogRegLATR[i,]<-ifelse(PP_MultinomialLogRegLATR_DF[i,]==max(PP_MultinomialLogRegLATR_DF[i,]),1,0)
}
colnames(PC_LogRegLATR)<-colnames(PP_MultinomialLogRegLATR_DF)
## ROC curves one vs the rest by multiROC package 
Control_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$Control
PreHD_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$PreHD
HD_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$HD
Control_true<-ifelse(LATR_avg_demo$Subgroup=='Control',1,0)
PreHD_true<-ifelse(LATR_avg_demo$Subgroup=='PreHD',1,0)
HD_true<-ifelse(LATR_avg_demo$Subgroup=='HD',1,0)
DF_ROC_LogRegLATR<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LogRegLATR,
                         PreHD_pred_LogRegLATR,HD_pred_LogRegLATR)
multiROC_LogRegLATR<-multiROC::multi_roc(DF_ROC_LogRegLATR)
multiROC_LogRegLATR_DF<-plot_roc_data(multiROC_LogRegLATR)
ggplot(multiROC_LogRegLATR_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "ROC curve for Logistic Regression model of Left ATR: One vs One",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)
```

Segundo, con transformación logarítmica de AD, RD, MD

```{r ATRavg53.7}
library(nnet)
# Fit the model
fitMultinomialLogRegLATRLog<-multinom(Subgroup2~lhatr_Iron+log(lhatr_AD)+log(lhatr_RD)+log(lhatr_MD)+lhatr_FA,
                                      data=LATR_avg_demo)
summary(fitMultinomialLogRegLATRLog)
# Wald test (z-test) 
z_fitMultinomialLogRegLATRLog<-summary(fitMultinomialLogRegLATRLog)$coefficients/summary(fitMultinomialLogRegLATRLog)$standard.errors
round(z_fitMultinomialLogRegLATRLog,4)
# p-value 
p_fitMultinomialLogRegLATRLog<-(1-pnorm(abs(z_fitMultinomialLogRegLATRLog),0,1))*2
round(p_fitMultinomialLogRegLATRLog,4)
# Tabla
sum_fitMultinomialLogRegLATRLog<-summary(fitMultinomialLogRegLATRLog)
tbl_fitMultinomialLogRegLATRLog<-rbind(sum_fitMultinomialLogRegLATRLog$coefficients,
                                       sum_fitMultinomialLogRegLATRLog$standard.errors,
                                       round(z_fitMultinomialLogRegLATRLog,4),
                                       round(p_fitMultinomialLogRegLATRLog,4))
kableExtra::kable(tbl_fitMultinomialLogRegLATRLog, caption='Multinomial Logistic Regression for Left ATR (controls as a reference) with log transform of diffusivities', booktabs=TRUE) %>%
  pack_rows(index=c('Coefficients'=2, 'Standard Errors'=2, 'Z-test'=2, 'p-value'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
# Evaluación del modelo
## Predicted probabilities
PP_MultinomialLogRegLATR<-fitMultinomialLogRegLATRLog$fitted.values
PP_MultinomialLogRegLATR_DF<-as.data.frame(PP_MultinomialLogRegLATR)
## Predicted classes
PC_LogRegLATR<-matrix(ncol=ncol(PP_MultinomialLogRegLATR_DF),
                      nrow=nrow(PP_MultinomialLogRegLATR_DF))
for (i in 1:nrow(PP_MultinomialLogRegLATR_DF)){
  PC_LogRegLATR[i,]<-ifelse(PP_MultinomialLogRegLATR_DF[i,]==max(PP_MultinomialLogRegLATR_DF[i,]),1,0)
}
colnames(PC_LogRegLATR)<-colnames(PP_MultinomialLogRegLATR_DF)
## ROC curves one vs the rest by multiROC package 
Control_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$Control
PreHD_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$PreHD
HD_pred_LogRegLATR<- PP_MultinomialLogRegLATR_DF$HD
Control_true<-ifelse(LATR_avg_demo$Subgroup=='Control',1,0)
PreHD_true<-ifelse(LATR_avg_demo$Subgroup=='PreHD',1,0)
HD_true<-ifelse(LATR_avg_demo$Subgroup=='HD',1,0)
DF_ROC_LogRegLATR<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LogRegLATR,
                         PreHD_pred_LogRegLATR,HD_pred_LogRegLATR)
multiROC_LogRegLATR<-multiROC::multi_roc(DF_ROC_LogRegLATR)
multiROC_LogRegLATR_DF<-plot_roc_data(multiROC_LogRegLATR)
ggplot(multiROC_LogRegLATR_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "ROC curve for Logistic Regression model of Left ATR with log-transform of diffusivities: One vs One",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_LogRegLATR_DF$AUC[multiROC_LogRegLATR_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)
```

### Both ATR

Primero, sin transformación logarítmica de AD, RD y MD

```{r ATRavg53.8}
library(nnet)
# Level of reference in the outcome variable
ATR_avg$Subgroup2<-relevel(ATR_avg$ATR_subgroup, ref = '1')
# Fit the model
fitMultinomialLogRegATR<-multinom(Subgroup2~ATR_Iron+ATR_AD+ATR_RD+ATR_MD+ATR_FA,
                                  data=ATR_avg)
summary(fitMultinomialLogRegATR)
# Wald test (z-test) 
z_fitMultinomialLogRegATR<-summary(fitMultinomialLogRegATR)$coefficients/summary(fitMultinomialLogRegATR)$standard.errors
round(z_fitMultinomialLogRegATR,4)
# p-value 
p_fitMultinomialLogRegATR<-(1-pnorm(abs(z_fitMultinomialLogRegATR),0,1))*2
round(p_fitMultinomialLogRegATR,4)
# Tabla
sum_fitMultinomialLogRegATR<-summary(fitMultinomialLogRegATR)
tbl_fitMultinomialLogRegATR<-rbind(sum_fitMultinomialLogRegATR$coefficients,
                                    sum_fitMultinomialLogRegATR$standard.errors,
                                    round(z_fitMultinomialLogRegATR,4),
                                    round(p_fitMultinomialLogRegATR,4))
kableExtra::kable(tbl_fitMultinomialLogRegATR, caption='Multinomial Logistic Regression for Both ATR (controls as a reference)', booktabs=TRUE) %>%
  pack_rows(index=c('Coefficients'=2, 'Standard Errors'=2, 'Z-test'=2, 'p-value'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
# Evaluación del modelo
## Predicted probabilities
PP_MultinomialLogRegATR<-fitMultinomialLogRegATR$fitted.values
PP_MultinomialLogRegATR_DF<-as.data.frame(PP_MultinomialLogRegATR)
## Predicted classes
PC_LogRegATR<-matrix(ncol=ncol(PP_MultinomialLogRegATR_DF),
                     nrow=nrow(PP_MultinomialLogRegATR_DF))
for (i in 1:nrow(PP_MultinomialLogRegATR_DF)){
  PC_LogRegATR[i,]<-ifelse(PP_MultinomialLogRegATR_DF[i,]==max(PP_MultinomialLogRegATR_DF[i,]),1,0)
}
colnames(PC_LogRegATR)<-colnames(PP_MultinomialLogRegATR_DF)
## ROC curves one vs the rest by multiROC package 
Control_pred_LogRegATR<- PP_MultinomialLogRegATR_DF$`1`
PreHD_pred_LogRegATR<- PP_MultinomialLogRegATR_DF$`2`
HD_pred_LogRegATR<- PP_MultinomialLogRegATR_DF$`3`
Control_true<-ifelse(ATR_avg$ATR_subgroup=='1',1,0)
PreHD_true<-ifelse(ATR_avg$ATR_subgroup=='2',1,0)
HD_true<-ifelse(ATR_avg$ATR_subgroup=='3',1,0)
DF_ROC_LogRegATR<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LogRegATR,
                         PreHD_pred_LogRegATR,HD_pred_LogRegATR)
multiROC_LogRegATR<-multiROC::multi_roc(DF_ROC_LogRegATR)
multiROC_LogRegATR_DF<-plot_roc_data(multiROC_LogRegATR)
ggplot(multiROC_LogRegATR_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "ROC curve for Logistic Regression model of Both ATR: One vs One",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)
```

Segundo, con transformación logarítmica de AD, RD, MD

```{r ATRavg53.9}
library(nnet)
# Fit the model
fitMultinomialLogRegATRLog<-multinom(Subgroup2~ATR_Iron+log(ATR_AD)+log(ATR_RD)+log(ATR_MD)+ATR_FA,
                                     data=ATR_avg)
summary(fitMultinomialLogRegATRLog)
# Wald test (z-test) 
z_fitMultinomialLogRegATRLog<-summary(fitMultinomialLogRegATRLog)$coefficients/summary(fitMultinomialLogRegATRLog)$standard.errors
round(z_fitMultinomialLogRegATRLog,4)
# p-value 
p_fitMultinomialLogRegATRLog<-(1-pnorm(abs(z_fitMultinomialLogRegATRLog),0,1))*2
round(p_fitMultinomialLogRegATRLog,4)
# Tabla
sum_fitMultinomialLogRegATRLog<-summary(fitMultinomialLogRegATRLog)
tbl_fitMultinomialLogRegATRLog<-rbind(sum_fitMultinomialLogRegATRLog$coefficients,
                                       sum_fitMultinomialLogRegATRLog$standard.errors,
                                       round(z_fitMultinomialLogRegATRLog,4),
                                       round(p_fitMultinomialLogRegATRLog,4))
kableExtra::kable(tbl_fitMultinomialLogRegATRLog, caption='Multinomial Logistic Regression for Both ATR (controls as a reference) with log transform of diffusivities', booktabs=TRUE) %>%
  pack_rows(index=c('Coefficients'=2, 'Standard Errors'=2, 'Z-test'=2, 'p-value'=2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
# Evaluación del modelo
## Predicted probabilities
PP_MultinomialLogRegATR<-fitMultinomialLogRegATRLog$fitted.values
PP_MultinomialLogRegATR_DF<-as.data.frame(PP_MultinomialLogRegATR)
## Predicted classes
PC_LogRegATR<-matrix(ncol=ncol(PP_MultinomialLogRegATR_DF),nrow=nrow(PP_MultinomialLogRegATR_DF))
for (i in 1:nrow(PP_MultinomialLogRegATR_DF)){
  PC_LogRegATR[i,]<-ifelse(PP_MultinomialLogRegATR_DF[i,]==max(PP_MultinomialLogRegATR_DF[i,]),1,0)
}
colnames(PC_LogRegATR)<-colnames(PP_MultinomialLogRegATR_DF)
## ROC curves one vs the rest by multiROC package 
Control_pred_LogRegATR<- PP_MultinomialLogRegATR_DF$`1`
PreHD_pred_LogRegATR<- PP_MultinomialLogRegATR_DF$`2`
HD_pred_LogRegATR<- PP_MultinomialLogRegATR_DF$`3`
Control_true<-ifelse(ATR_avg$ATR_subgroup=='1',1,0)
PreHD_true<-ifelse(ATR_avg$ATR_subgroup=='2',1,0)
HD_true<-ifelse(ATR_avg$ATR_subgroup=='3',1,0)
DF_ROC_LogRegATR<-cbind(Control_true,PreHD_true,HD_true,Control_pred_LogRegATR,
                         PreHD_pred_LogRegATR,HD_pred_LogRegATR)
multiROC_LogRegATR<-multiROC::multi_roc(DF_ROC_LogRegATR)
multiROC_LogRegATR_DF<-plot_roc_data(multiROC_LogRegATR)
ggplot(multiROC_LogRegATR_DF, aes(x=1-Specificity, y=Sensitivity, color = Group)) + 
  geom_step() + geom_point() + labs(title= "ROC curve for Logistic Regression model of Both ATR with log-transform of diffusivities: One vs One",
    x = "False Positive Rate (1-Specificity)",
    y = "True Positive Rate (Sensitivity)") + geom_abline(intercept = 0, slope=1,linetype = 'dotted') +
  annotate('text',x=0.75, y=0.25,
           label=paste('AUC for Controls ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='Control']),2)),
           color = '#FF9900',size = 8/.pt) +
  annotate('text',x=0.75, y=0.20,
           label=paste('AUC for PreHD ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='PreHD']),2)),
           color = 'violet',size = 8/.pt) +
  annotate('text',x=0.75, y=0.15,
           label=paste('AUC for HD ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='HD']),2)),
           color = '#CCCC33',size = 8/.pt) +
  annotate('text',x=0.75, y=0.10,
           label=paste('AUC for micro-average ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='Micro']),2)),
           color = '#33CCFF',size = 8/.pt)+
  annotate('text',x=0.75, y=0.05,
           label=paste('AUC for macro-average ROC curve = ',
                       round(mean(multiROC_LogRegATR_DF$AUC[multiROC_LogRegATR_DF$Group=='Macro']),2)),
           color = '#00CC66',size = 8/.pt)
```

\newpage

# Correlaciones clínicas

Generación del dataframe

```{r ATRavg54.1}
library(ppcor)
RATR_avg_demo_GC<-RATR_avg_demo[RATR_avg_demo$Group=='Carriers',]
LATR_avg_demo_GC<-LATR_avg_demo[LATR_avg_demo$Group=='Carriers',]
GC_Demo_Clin_MRI<-cbind(demo_atr_PHD_HD[1:5],RATR_avg_demo_GC[6:7],
                        demo_atr_PHD_HD[6:11],clinical_vars_gc[6:17],
                        RATR_avg_demo_GC[8:12],LATR_avg_demo_GC[8:12])
```

## Correlaciones parciales 

### CAP controlado por género

```{r ATRavg54.2, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_CAP_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_CAP_ADAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_CAP_MDAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_CAP_RDAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_CAP_FAAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_CAP_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_CAP_ADAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_CAP_MDAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_CAP_RDAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_CAP_FAAvg <- pcor.test(GC_Demo_Clin_MRI$CAP_BIS, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_CAP_DifIron_Avg<-rbind(RATR_CAP_IRONAvg,RATR_CAP_ADAvg,RATR_CAP_RDAvg,
                                 RATR_CAP_MDAvg,RATR_CAP_FAAvg,
                                 LATR_CAP_IRONAvg,LATR_CAP_ADAvg,LATR_CAP_RDAvg,
                                 LATR_CAP_MDAvg,LATR_CAP_FAAvg)
ATR_CorIC_CAP_DifIron_Avg2<-rbind(paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[1,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[6,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[2,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[7,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[3,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[8,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[4,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[9,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[5,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_CAP_DifIron_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_CAP_DifIron_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_CAP_DifIron_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_CAP_DifIron_Avg2
```

### Age_onset controlado por género

```{r ATRavg54.3, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_AOO_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_AOO_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_AOO_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_AOO_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_AOO_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_AOO_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_AOO_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_AOO_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_AOO_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_AOO_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`Age of onset Langbehn`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_AOO_DifIron_Avg<-rbind(RATR_AOO_IRONAvg,RATR_AOO_ADAvg,RATR_AOO_RDAvg,
                                 RATR_AOO_MDAvg,RATR_AOO_FAAvg,
                                 LATR_AOO_IRONAvg,LATR_AOO_ADAvg,LATR_AOO_RDAvg,
                                 LATR_AOO_MDAvg,LATR_AOO_FAAvg)
ATR_CorIC_AOO_DifIron_Avg2<-rbind(paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[1,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[6,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[2,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[7,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[3,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[8,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[4,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[9,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[5,6][[1]],3)),
                                  paste('rho =',round(ATR_CorIC_AOO_DifIron_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_AOO_DifIron_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_AOO_DifIron_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_AOO_DifIron_Avg2
```

### UHDRS functional score controlado por género y CAP

```{r ATRavg54.4, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_UHF_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_UHF_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_UHF_DifIron_GCAP_Avg<-rbind(RATR_UHF_IRONAvg,RATR_UHF_ADAvg,RATR_UHF_RDAvg,
                                      RATR_UHF_MDAvg,RATR_UHF_FAAvg,
                                      LATR_UHF_IRONAvg,LATR_UHF_ADAvg,LATR_UHF_RDAvg,
                                      LATR_UHF_MDAvg,LATR_UHF_FAAvg)
ATR_CorIC_UHF_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_UHF_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_UHF_DifIron_GCAP_Avg2
```

### UHDRS functional score controlado por género 

```{r ATRavg54.5, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_UHF_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHF_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_UHF_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHF_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-functional score`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_UHF_DifIron_G_Avg<-rbind(RATR_UHF_IRONAvg,RATR_UHF_ADAvg,RATR_UHF_RDAvg,
                                   RATR_UHF_MDAvg,RATR_UHF_FAAvg,
                                   LATR_UHF_IRONAvg,LATR_UHF_ADAvg,LATR_UHF_RDAvg,
                                   LATR_UHF_MDAvg,LATR_UHF_FAAvg)

ATR_CorIC_UHF_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHF_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_UHF_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_UHF_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_UHF_DifIron_G_Avg2
```

### UHDRS cognitive score controlado por género y CAP

```{r ATRavg54.6, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_UHC_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_UHC_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_UHC_DifIron_GCAP_Avg<-rbind(RATR_UHC_IRONAvg,RATR_UHC_ADAvg,RATR_UHC_RDAvg,
                                      RATR_UHC_MDAvg,RATR_UHC_FAAvg,
                                      LATR_UHC_IRONAvg,LATR_UHC_ADAvg,LATR_UHC_RDAvg,
                                      LATR_UHC_MDAvg,LATR_UHC_FAAvg)

ATR_CorIC_UHC_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_UHC_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_UHC_DifIron_GCAP_Avg2
```

### UHDRS cognitive score controlado por género 

```{r ATRavg54.7, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_UHC_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHC_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_UHC_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHC_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-cognitive score`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_UHC_DifIron_G_Avg<-rbind(RATR_UHC_IRONAvg,RATR_UHC_ADAvg,RATR_UHC_RDAvg,
                                   RATR_UHC_MDAvg,RATR_UHC_FAAvg,
                                   LATR_UHC_IRONAvg,LATR_UHC_ADAvg,LATR_UHC_RDAvg,
                                   LATR_UHC_MDAvg,LATR_UHC_FAAvg)

ATR_CorIC_UHC_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHC_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_UHC_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_UHC_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_UHC_DifIron_G_Avg2
```

### UHDRS motor score controlado por género y CAP

```{r ATRavg54.8, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_UHM_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_UHM_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_UHM_DifIron_GCAP_Avg<-rbind(RATR_UHM_IRONAvg,RATR_UHM_ADAvg,RATR_UHM_RDAvg,
                                      RATR_UHM_MDAvg,RATR_UHM_FAAvg,
                                      LATR_UHM_IRONAvg,LATR_UHM_ADAvg,LATR_UHM_RDAvg,
                                      LATR_UHM_MDAvg,LATR_UHM_FAAvg)

ATR_CorIC_UHM_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_UHM_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_UHM_DifIron_GCAP_Avg2
```

### UHDRS motor score controlado por género 

```{r ATRavg54.9, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_UHM_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_UHM_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_UHM_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_UHM_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`UHDRS-motor score`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_UHM_DifIron_G_Avg<-rbind(RATR_UHM_IRONAvg,RATR_UHM_ADAvg,RATR_UHM_RDAvg,
                                   RATR_UHM_MDAvg,RATR_UHM_FAAvg,
                                   LATR_UHM_IRONAvg,LATR_UHM_ADAvg,LATR_UHM_RDAvg,
                                   LATR_UHM_MDAvg,LATR_UHM_FAAvg)

ATR_CorIC_UHM_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_UHM_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_UHM_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_UHM_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_UHM_DifIron_G_Avg2
```

### Stroop_interferences controlado por género y CAP

```{r ATRavg54.10, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_STI_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_STI_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_STI_DifIron_GCAP_Avg<-rbind(RATR_STI_IRONAvg,RATR_STI_ADAvg,RATR_STI_RDAvg,
                                      RATR_STI_MDAvg,RATR_STI_FAAvg,
                                      LATR_STI_IRONAvg,LATR_STI_ADAvg,LATR_STI_RDAvg,
                                      LATR_STI_MDAvg,LATR_STI_FAAvg)

ATR_CorIC_STI_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_STI_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_STI_DifIron_GCAP_Avg2
```

### Stroop_interferences controlado por género 

```{r ATRavg54.11, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_STI_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_STI_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_STI_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_STI_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`Stroop-interferencias`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_STI_DifIron_G_Avg<-rbind(RATR_STI_IRONAvg,RATR_STI_ADAvg,RATR_STI_RDAvg,
                                   RATR_STI_MDAvg,RATR_STI_FAAvg,
                                   LATR_STI_IRONAvg,LATR_STI_ADAvg,LATR_STI_RDAvg,
                                   LATR_STI_MDAvg,LATR_STI_FAAvg)

ATR_CorIC_STI_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_STI_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_STI_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_STI_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_STI_DifIron_G_Avg2
```

### Direct TMT(B-A) controlado por género y CAP

```{r ATRavg54.12, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_TMT_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_TMT_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_TMT_DifIron_GCAP_Avg<-rbind(RATR_TMT_IRONAvg,RATR_TMT_ADAvg,RATR_TMT_RDAvg,
                                      RATR_TMT_MDAvg,RATR_TMT_FAAvg,
                                      LATR_TMT_IRONAvg,LATR_TMT_ADAvg,LATR_TMT_RDAvg,
                                      LATR_TMT_MDAvg,LATR_TMT_FAAvg)

ATR_CorIC_TMT_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_TMT_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_TMT_DifIron_GCAP_Avg2
```

### Direct TMT(B-A) controlado por género 

```{r ATRavg54.13, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_TMT_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_TMT_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_TMT_IRONAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_ADAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_MDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_RDAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_TMT_FAAvg <- pcor.test(GC_Demo_Clin_MRI$`TMT_direct_(B-A)`, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_TMT_DifIron_G_Avg<-rbind(RATR_TMT_IRONAvg,RATR_TMT_ADAvg,RATR_TMT_RDAvg,
                                   RATR_TMT_MDAvg,RATR_TMT_FAAvg,
                                   LATR_TMT_IRONAvg,LATR_TMT_ADAvg,LATR_TMT_RDAvg,
                                   LATR_TMT_MDAvg,LATR_TMT_FAAvg)

ATR_CorIC_TMT_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_TMT_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_TMT_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_TMT_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_TMT_DifIron_G_Avg2
```

### PBA-ENROLL-Depression controlado por género y CAP

```{r ATRavg54.14, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_DEP_IRONAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_ADAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_MDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_RDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_FAAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_DEP_IRONAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_ADAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_MDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_RDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_FAAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_DEP_DifIron_GCAP_Avg<-rbind(RATR_DEP_IRONAvg,RATR_DEP_ADAvg,RATR_DEP_RDAvg,
                                      RATR_DEP_MDAvg,RATR_DEP_FAAvg,
                                      LATR_DEP_IRONAvg,LATR_DEP_ADAvg,LATR_DEP_RDAvg,
                                      LATR_DEP_MDAvg,LATR_DEP_FAAvg)

ATR_CorIC_DEP_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_DEP_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_DEP_DifIron_GCAP_Avg2
```

### PBA-ENROLL-Depression controlado por género 

```{r ATRavg54.15, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_DEP_IRONAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_ADAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_MDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_RDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DEP_FAAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_DEP_IRONAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_ADAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_MDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_RDAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DEP_FAAvg <- pcor.test(pba_enroll_gc$DEPRESION_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_DEP_DifIron_G_Avg<-rbind(RATR_DEP_IRONAvg,RATR_DEP_ADAvg,RATR_DEP_RDAvg,
                                   RATR_DEP_MDAvg,RATR_DEP_FAAvg,
                                   LATR_DEP_IRONAvg,LATR_DEP_ADAvg,LATR_DEP_RDAvg,
                                   LATR_DEP_MDAvg,LATR_DEP_FAAvg)

ATR_CorIC_DEP_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DEP_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_DEP_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_DEP_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_DEP_DifIron_G_Avg2
```

### PBA-ENROLL-Irritability controlado por género y CAP

```{r ATRavg54.16, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_IRR_IRONAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_ADAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_MDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_RDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_FAAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_IRR_IRONAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_ADAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_MDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_RDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_FAAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_IRR_DifIron_GCAP_Avg<-rbind(RATR_IRR_IRONAvg,RATR_IRR_ADAvg,RATR_IRR_RDAvg,
                                      RATR_IRR_MDAvg,RATR_IRR_FAAvg,
                                      LATR_IRR_IRONAvg,LATR_IRR_ADAvg,LATR_IRR_RDAvg,
                                      LATR_IRR_MDAvg,LATR_IRR_FAAvg)

ATR_CorIC_IRR_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_IRR_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_IRR_DifIron_GCAP_Avg2
```

### PBA-ENROLL-Irritability controlado por género 

```{r ATRavg54.17, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_IRR_IRONAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_ADAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_MDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_RDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_IRR_FAAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_IRR_IRONAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_ADAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_MDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_RDAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_IRR_FAAvg <- pcor.test(pba_enroll_gc$IRRITABILIDAD_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_IRR_DifIron_G_Avg<-rbind(RATR_IRR_IRONAvg,RATR_IRR_ADAvg,RATR_IRR_RDAvg,
                                   RATR_IRR_MDAvg,RATR_IRR_FAAvg,
                                   LATR_IRR_IRONAvg,LATR_IRR_ADAvg,LATR_IRR_RDAvg,
                                   LATR_IRR_MDAvg,LATR_IRR_FAAvg)

ATR_CorIC_IRR_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_IRR_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_IRR_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_IRR_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_IRR_DifIron_G_Avg2
```

### PBA-ENROLL-Psychosis controlado por género y CAP

```{r ATRavg54.18, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_PSY_IRONAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_ADAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_MDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_RDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_FAAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_PSY_IRONAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_ADAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_MDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_RDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_FAAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_PSY_DifIron_GCAP_Avg<-rbind(RATR_PSY_IRONAvg,RATR_PSY_ADAvg,RATR_PSY_RDAvg,
                                      RATR_PSY_MDAvg,RATR_PSY_FAAvg,
                                      LATR_PSY_IRONAvg,LATR_PSY_ADAvg,LATR_PSY_RDAvg,
                                      LATR_PSY_MDAvg,LATR_PSY_FAAvg)

ATR_CorIC_PSY_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_PSY_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_PSY_DifIron_GCAP_Avg2
```

### PBA-ENROLL-Psychosis controlado por género 

```{r ATRavg54.19, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_PSY_IRONAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_ADAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_MDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_RDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_PSY_FAAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_PSY_IRONAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_ADAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_MDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_RDAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_PSY_FAAvg <- pcor.test(pba_enroll_gc$PSICOSIS_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_PSY_DifIron_G_Avg<-rbind(RATR_PSY_IRONAvg,RATR_PSY_ADAvg,RATR_PSY_RDAvg,
                                   RATR_PSY_MDAvg,RATR_PSY_FAAvg,
                                   LATR_PSY_IRONAvg,LATR_PSY_ADAvg,LATR_PSY_RDAvg,
                                   LATR_PSY_MDAvg,LATR_PSY_FAAvg)

ATR_CorIC_PSY_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_PSY_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_PSY_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_PSY_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_PSY_DifIron_G_Avg2
```

### PBA-ENROLL-Apathy controlado por género y CAP

```{r ATRavg54.20, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_APA_IRONAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_ADAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_MDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_RDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_FAAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_APA_IRONAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_ADAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_MDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_RDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_FAAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_APA_DifIron_GCAP_Avg<-rbind(RATR_APA_IRONAvg,RATR_APA_ADAvg,RATR_APA_RDAvg,
                                      RATR_APA_MDAvg,RATR_APA_FAAvg,
                                      LATR_APA_IRONAvg,LATR_APA_ADAvg,LATR_APA_RDAvg,
                                      LATR_APA_MDAvg,LATR_APA_FAAvg)

ATR_CorIC_APA_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_APA_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_APA_DifIron_GCAP_Avg2
```

### PBA-ENROLL-Apathy controlado por género 

```{r ATRavg54.21, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_APA_IRONAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_ADAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_MDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_RDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_APA_FAAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_APA_IRONAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_ADAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_MDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_RDAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_APA_FAAvg <- pcor.test(pba_enroll_gc$APATIA_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_APA_DifIron_G_Avg<-rbind(RATR_APA_IRONAvg,RATR_APA_ADAvg,RATR_APA_RDAvg,
                                   RATR_APA_MDAvg,RATR_APA_FAAvg,
                                   LATR_APA_IRONAvg,LATR_APA_ADAvg,LATR_APA_RDAvg,
                                   LATR_APA_MDAvg,LATR_APA_FAAvg)

ATR_CorIC_APA_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_APA_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_APA_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_APA_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_APA_DifIron_G_Avg2
```

### PBA-ENROLL-Dysexecutive controlado por género y CAP

```{r ATRavg54.22, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_DYS_IRONAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_ADAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_MDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_RDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_FAAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_DYS_IRONAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_ADAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_MDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_RDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_FAAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender, GC_Demo_Clin_MRI$CAP_BIS),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_DYS_DifIron_GCAP_Avg<-rbind(RATR_DYS_IRONAvg,RATR_DYS_ADAvg,RATR_DYS_RDAvg,
                                      RATR_DYS_MDAvg,RATR_DYS_FAAvg,
                                      LATR_DYS_IRONAvg,LATR_DYS_ADAvg,LATR_DYS_RDAvg,
                                      LATR_DYS_MDAvg,LATR_DYS_FAAvg)

ATR_CorIC_DYS_DifIron_GCAP_Avg2<-rbind(paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[1,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[6,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[2,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[7,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[3,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[8,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[4,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[9,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[5,6][[1]],3)),
                                       paste('rho =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_GCAP_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_DYS_DifIron_GCAP_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_DYS_DifIron_GCAP_Avg2
```

### PBA-ENROLL-Dysexecutive controlado por género 

```{r ATRavg54.23, echo=FALSE}
set.seed(123)
library(RVAideMemoire)
# PARA RATR
RATR_DYS_IRONAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_ADAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_MDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_RDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
RATR_DYS_FAAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$rhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

# PARA LATR
LATR_DYS_IRONAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_Iron,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_ADAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_AD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_MDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_MD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_RDAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_RD,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")
LATR_DYS_FAAvg <- pcor.test(pba_enroll_gc$DISEJECUTIVO_COMP, GC_Demo_Clin_MRI$lhatr_FA,
                         list(GC_Demo_Clin_MRI$Gender),
                         semi = FALSE, conf.level=0.95, nrep=1000, method = "spearman")

ATR_CorIC_DYS_DifIron_G_Avg<-rbind(RATR_DYS_IRONAvg,RATR_DYS_ADAvg,RATR_DYS_RDAvg,
                                   RATR_DYS_MDAvg,RATR_DYS_FAAvg,
                                   LATR_DYS_IRONAvg,LATR_DYS_ADAvg,LATR_DYS_RDAvg,
                                   LATR_DYS_MDAvg,LATR_DYS_FAAvg)

ATR_CorIC_DYS_DifIron_G_Avg2<-rbind(paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[1,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[1,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[6,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[6,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[2,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[2,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[7,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[7,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[3,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[3,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[8,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[8,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[4,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[4,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[9,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[9,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[5,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[5,6][[1]],3)),
                                    paste('rho =',round(ATR_CorIC_DYS_DifIron_G_Avg[10,7][[1]],3),', p =',round(ATR_CorIC_DYS_DifIron_G_Avg[10,6][[1]],3)))
rownames(ATR_CorIC_DYS_DifIron_G_Avg2)<-c('Iron_RATR','Iron_LATR','AD_RATR','AD_LATR','RD_RATR','RD_LATR','MD_RATR','MD_LATR','FA_RATR','FA_LATR')
ATR_CorIC_DYS_DifIron_G_Avg2
```

\newpage

```{r ATRavg54.24, echo=FALSE}
ATR_COR<-rbind(t(ATR_CorIC_CAP_DifIron_Avg2),t(ATR_CorIC_AOO_DifIron_Avg2),
               t(ATR_CorIC_UHF_DifIron_GCAP_Avg2),t(ATR_CorIC_UHF_DifIron_G_Avg2),
               t(ATR_CorIC_UHC_DifIron_GCAP_Avg2),t(ATR_CorIC_UHC_DifIron_G_Avg2),
               t(ATR_CorIC_UHM_DifIron_GCAP_Avg2),t(ATR_CorIC_UHM_DifIron_G_Avg2),
               t(ATR_CorIC_STI_DifIron_GCAP_Avg2),t(ATR_CorIC_STI_DifIron_G_Avg2),
               t(ATR_CorIC_TMT_DifIron_GCAP_Avg2),t(ATR_CorIC_TMT_DifIron_G_Avg2),
               t(ATR_CorIC_DEP_DifIron_GCAP_Avg2),t(ATR_CorIC_DEP_DifIron_G_Avg2),
               t(ATR_CorIC_IRR_DifIron_GCAP_Avg2),t(ATR_CorIC_IRR_DifIron_G_Avg2),
               t(ATR_CorIC_PSY_DifIron_GCAP_Avg2),t(ATR_CorIC_PSY_DifIron_G_Avg2),
               t(ATR_CorIC_APA_DifIron_GCAP_Avg2),t(ATR_CorIC_APA_DifIron_G_Avg2),
               t(ATR_CorIC_DYS_DifIron_GCAP_Avg2),t(ATR_CorIC_DYS_DifIron_G_Avg2))
ATR_COR<-as.data.frame(ATR_COR)
rownames(ATR_COR)<-c('CAP controlled by Gender','Age_Onset controlled by Gender',
                     'UHDRS-Functional controlled by Gender and CAP','UHDRS-Functional controlled by Gender',
                     'UHDRS-Cognitive controlled by Gender and CAP','UHDRS-Cognitive controlled by Gender',
                     'UHDRS-Motor controlled by Gender and CAP','UHDRS-Motor controlled by Gender',
                     'Stroop-Interferences controlled by Gender and CAP','Stroop-Interferences controlled by Gender',
                     'Direct TMT controlled by Gender and CAP','Direct TMT controlled by Gender',
                     'PBA-Depression controlled by Gender and CAP','PBA-Depression controlled by Gender',
                     'PBA-Irritability controlled by Gender and CAP','PBA-Irritability controlled by Gender',
                     'PBA-Psychosis controlled by Gender and CAP','PBA-Psychosis controlled by Gender',
                     'PBA-Apathy controlled by Gender and CAP','PBA-Apathy controlled by Gender',
                     'PBA-Dysexecutive controlled by Gender and CAP','PBA-Dysexecutive controlled by Gender')
colnames(ATR_COR)<-c(rep(c('RATR','LATR'),5))
```

```{r ATRavg54.25, echo=FALSE}
kableExtra::kable(ATR_COR[1:2], caption = 'Correlations between clinical measurements and Iron', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'Iron' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

kableExtra::kable(ATR_COR[3:4], caption = 'Correlations between clinical measurements and AD', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'AD' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

\newpage
```{r ATRavg54.26, echo=FALSE}
kableExtra::kable(ATR_COR[5:6], caption = 'Correlations between clinical measurements and RD', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'RD' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')

kableExtra::kable(ATR_COR[7:8], caption = 'Correlations between clinical measurements and MD', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'MD' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

\newpage
```{r ATRavg54.27, echo=FALSE}
kableExtra::kable(ATR_COR[9:10], caption = 'Correlations between clinical measurements and FA', booktabs = TRUE) %>%
  add_header_above(header=c(' ' = 1, 'FA' = 2)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options='hold_position')
```

\newpage

```{r ATRavg54.28, echo=FALSE}
# Rho values
RATR_IRON_rho<-c(ATR_CorIC_CAP_DifIron_Avg[1,7][[1]],
                 ATR_CorIC_AOO_DifIron_Avg[1,7][[1]],
                 ATR_CorIC_UHF_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_UHF_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_UHC_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_UHC_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_UHM_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_UHM_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_STI_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_STI_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_TMT_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_TMT_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_DEP_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_DEP_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_IRR_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_IRR_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_PSY_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_PSY_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_APA_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_APA_DifIron_G_Avg[1,7][[1]],
                 ATR_CorIC_DYS_DifIron_GCAP_Avg[1,7][[1]],
                 ATR_CorIC_DYS_DifIron_G_Avg[1,7][[1]])
RATR_IRON_rho<-round(RATR_IRON_rho,3)

LATR_IRON_rho<-c(ATR_CorIC_CAP_DifIron_Avg[6,7][[1]],
                 ATR_CorIC_AOO_DifIron_Avg[6,7][[1]],
                 ATR_CorIC_UHF_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_UHF_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_UHC_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_UHC_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_UHM_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_UHM_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_STI_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_STI_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_TMT_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_TMT_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_DEP_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_DEP_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_IRR_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_IRR_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_PSY_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_PSY_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_APA_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_APA_DifIron_G_Avg[6,7][[1]],
                 ATR_CorIC_DYS_DifIron_GCAP_Avg[6,7][[1]],
                 ATR_CorIC_DYS_DifIron_G_Avg[6,7][[1]])
LATR_IRON_rho<-round(LATR_IRON_rho,3)

RATR_AD_rho<-c(ATR_CorIC_CAP_DifIron_Avg[2,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[2,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[2,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[2,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[2,7][[1]])
RATR_AD_rho<-round(RATR_AD_rho,3)

LATR_AD_rho<-c(ATR_CorIC_CAP_DifIron_Avg[7,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[7,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[7,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[7,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[7,7][[1]])
LATR_AD_rho<-round(LATR_AD_rho,3)

RATR_RD_rho<-c(ATR_CorIC_CAP_DifIron_Avg[3,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[3,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[3,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[3,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[3,7][[1]])
RATR_RD_rho<-round(RATR_RD_rho,3)

LATR_RD_rho<-c(ATR_CorIC_CAP_DifIron_Avg[8,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[8,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[8,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[8,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[8,7][[1]])
LATR_RD_rho<-round(LATR_RD_rho,3)

RATR_MD_rho<-c(ATR_CorIC_CAP_DifIron_Avg[4,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[4,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[4,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[4,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[4,7][[1]])
RATR_MD_rho<-round(RATR_MD_rho,3)

LATR_MD_rho<-c(ATR_CorIC_CAP_DifIron_Avg[9,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[9,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[9,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[9,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[9,7][[1]])
LATR_MD_rho<-round(LATR_MD_rho,3)

RATR_FA_rho<-c(ATR_CorIC_CAP_DifIron_Avg[5,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[5,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[5,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[5,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[5,7][[1]])
RATR_FA_rho<-round(RATR_FA_rho,3)

LATR_FA_rho<-c(ATR_CorIC_CAP_DifIron_Avg[10,7][[1]],
               ATR_CorIC_AOO_DifIron_Avg[10,7][[1]],
               ATR_CorIC_UHF_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_UHF_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_UHC_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_UHC_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_UHM_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_UHM_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_STI_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_STI_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_TMT_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_TMT_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_DEP_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_DEP_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_IRR_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_IRR_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_PSY_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_PSY_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_APA_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_APA_DifIron_G_Avg[10,7][[1]],
               ATR_CorIC_DYS_DifIron_GCAP_Avg[10,7][[1]],
               ATR_CorIC_DYS_DifIron_G_Avg[10,7][[1]])
LATR_FA_rho<-round(LATR_FA_rho,3)

# P-values: non-adjusted and adjusted
RATR_IRON_pval<-c(ATR_CorIC_CAP_DifIron_Avg[1,6][[1]],
                  ATR_CorIC_AOO_DifIron_Avg[1,6][[1]],
                  ATR_CorIC_UHF_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_UHF_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_UHC_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_UHC_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_UHM_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_UHM_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_STI_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_STI_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_TMT_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_TMT_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_DEP_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_DEP_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_IRR_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_IRR_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_PSY_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_PSY_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_APA_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_APA_DifIron_G_Avg[1,6][[1]],
                  ATR_CorIC_DYS_DifIron_GCAP_Avg[1,6][[1]],
                  ATR_CorIC_DYS_DifIron_G_Avg[1,6][[1]])
RATR_IRON_pvalfdr<-p.adjust(RATR_IRON_pval, method = "fdr")
RATR_IRON_pval<-round(RATR_IRON_pval,3)
RATR_IRON_pvalfdr<-round(RATR_IRON_pvalfdr,3)

LATR_IRON_pval<-c(ATR_CorIC_CAP_DifIron_Avg[6,6][[1]],
                  ATR_CorIC_AOO_DifIron_Avg[6,6][[1]],
                  ATR_CorIC_UHF_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_UHF_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_UHC_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_UHC_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_UHM_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_UHM_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_STI_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_STI_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_TMT_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_TMT_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_DEP_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_DEP_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_IRR_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_IRR_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_PSY_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_PSY_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_APA_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_APA_DifIron_G_Avg[6,6][[1]],
                  ATR_CorIC_DYS_DifIron_GCAP_Avg[6,6][[1]],
                  ATR_CorIC_DYS_DifIron_G_Avg[6,6][[1]])
LATR_IRON_pvalfdr<-p.adjust(LATR_IRON_pval, method = "fdr")
LATR_IRON_pval<-round(LATR_IRON_pval,3)
LATR_IRON_pvalfdr<-round(LATR_IRON_pvalfdr,3)

RATR_AD_pval<-c(ATR_CorIC_CAP_DifIron_Avg[2,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[2,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[2,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[2,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[2,6][[1]])
RATR_AD_pvalfdr<-p.adjust(RATR_AD_pval, method = "fdr")
RATR_AD_pval<-round(RATR_AD_pval,3)
RATR_AD_pvalfdr<-round(RATR_AD_pvalfdr,3)

LATR_AD_pval<-c(ATR_CorIC_CAP_DifIron_Avg[7,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[7,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[7,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[7,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[7,6][[1]])
LATR_AD_pvalfdr<-p.adjust(LATR_AD_pval, method = "fdr")
LATR_AD_pval<-round(LATR_AD_pval,3)
LATR_AD_pvalfdr<-round(LATR_AD_pvalfdr,3)

RATR_RD_pval<-c(ATR_CorIC_CAP_DifIron_Avg[3,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[3,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[3,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[3,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[3,6][[1]])
RATR_RD_pvalfdr<-p.adjust(RATR_RD_pval, method = "fdr")
RATR_RD_pval<-round(RATR_RD_pval,3)
RATR_RD_pvalfdr<-round(RATR_RD_pvalfdr,3)

LATR_RD_pval<-c(ATR_CorIC_CAP_DifIron_Avg[8,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[8,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[8,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[8,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[8,6][[1]])
LATR_RD_pvalfdr<-p.adjust(LATR_RD_pval, method = "fdr")
LATR_RD_pval<-round(LATR_RD_pval,3)
LATR_RD_pvalfdr<-round(LATR_RD_pvalfdr,3)

RATR_MD_pval<-c(ATR_CorIC_CAP_DifIron_Avg[4,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[4,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[4,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[4,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[4,6][[1]])
RATR_MD_pvalfdr<-p.adjust(RATR_MD_pval, method = "fdr")
RATR_MD_pval<-round(RATR_MD_pval,3)
RATR_MD_pvalfdr<-round(RATR_MD_pvalfdr,3)

LATR_MD_pval<-c(ATR_CorIC_CAP_DifIron_Avg[9,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[9,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[9,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[9,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[9,6][[1]])
LATR_MD_pvalfdr<-p.adjust(LATR_MD_pval, method = "fdr")
LATR_MD_pval<-round(LATR_MD_pval,3)
LATR_MD_pvalfdr<-round(LATR_MD_pvalfdr,3)


RATR_FA_pval<-c(ATR_CorIC_CAP_DifIron_Avg[5,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[5,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[5,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[5,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[5,6][[1]])
RATR_FA_pvalfdr<-p.adjust(RATR_FA_pval, method = "fdr")
RATR_FA_pval<-round(RATR_FA_pval,3)
RATR_FA_pvalfdr<-round(RATR_FA_pvalfdr,3)

LATR_FA_pval<-c(ATR_CorIC_CAP_DifIron_Avg[10,6][[1]],
                ATR_CorIC_AOO_DifIron_Avg[10,6][[1]],
                ATR_CorIC_UHF_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_UHF_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_UHC_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_UHC_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_UHM_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_UHM_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_STI_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_STI_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_TMT_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_TMT_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_DEP_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_DEP_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_IRR_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_IRR_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_PSY_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_PSY_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_APA_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_APA_DifIron_G_Avg[10,6][[1]],
                ATR_CorIC_DYS_DifIron_GCAP_Avg[10,6][[1]],
                ATR_CorIC_DYS_DifIron_G_Avg[10,6][[1]])
LATR_FA_pvalfdr<-p.adjust(LATR_FA_pval, method = "fdr")
LATR_FA_pval<-round(LATR_FA_pval,3)
LATR_FA_pvalfdr<-round(LATR_FA_pvalfdr,3)

ATR_COR2<-cbind(RATR_IRON_rho,RATR_IRON_pval,RATR_IRON_pvalfdr,
                LATR_IRON_rho,LATR_IRON_pval,LATR_IRON_pvalfdr,
                RATR_AD_rho,RATR_AD_pval,RATR_AD_pvalfdr,
                LATR_AD_rho,LATR_AD_pval,LATR_AD_pvalfdr,
                RATR_RD_rho,RATR_RD_pval,RATR_RD_pvalfdr,
                LATR_RD_rho,LATR_RD_pval,LATR_RD_pvalfdr,
                RATR_MD_rho,RATR_MD_pval,RATR_MD_pvalfdr,
                LATR_MD_rho,LATR_MD_pval,LATR_MD_pvalfdr,
                RATR_FA_rho,RATR_FA_pval,RATR_FA_pvalfdr,
                LATR_FA_rho,LATR_FA_pval,LATR_FA_pvalfdr)
ATR_COR2<-as.data.frame(ATR_COR2)
colnames(ATR_COR2)<-c(rep(c('rho','p','p-adj'),10))
rownames(ATR_COR2)<-c('CAP (Gender)','Age_Onset (Gender)',
                      'UHDRS-Functional (Gender,CAP)','UHDRS-Functional (Gender)',
                      'UHDRS-Cognitive (Gender,CAP)','UHDRS-Cognitive (Gender)',
                      'UHDRS-Motor (Gender,CAP)','UHDRS-Motor (Gender)',
                      'Stroop-Interferences (Gender,CAP)','Stroop-Interferences (Gender)',
                      'Direct TMT (Gender,CAP)','Direct TMT (Gender)',
                      'PBA-Depression (Gender,CAP)','PBA-Depression (Gender)',
                      'PBA-Irritability (Gender,CAP)','PBA-Irritability (Gender)',
                      'PBA-Psychosis (Gender,CAP)','PBA-Psychosis (Gender)',
                      'PBA-Apathy (Gender,CAP)','PBA-Apathy (Gender)',
                      'PBA-Dysexecutive (Gender,CAP)','PBA-Dysexecutive (Gender)')
ATR_COR_IronFA<-ATR_COR2[c(1:6,25:30)]
colnames(ATR_COR_IronFA)<-c(rep(c('rho','p','p-adj'),4))
ATR_COR_DIF<-ATR_COR2[c(7:24)]
colnames(ATR_COR_DIF)<-c(rep(c('rho','p','p-adj'),6))

kableExtra::kable(ATR_COR_IronFA, longtable = TRUE, booktabs = TRUE, caption = 'Correlations between clinical measurements and MRI metrics (Iron, FA)') %>%
  add_header_above(header=c(' '=1,'RATR - IRON'=3,'LATR - IRON'=3,'RATR - FA'=3,'LATR - FA'=3)) %>%
  kable_styling(position = 'center', font_size = 8, latex_options=c('hold_position','repeat_header')) %>%
  landscape()

kableExtra::kable(ATR_COR_DIF, longtable = TRUE, booktabs = TRUE, caption = 'Correlations between clinical measurements and MRI metrics (Diffusivities: AD, RD, MD)') %>%
  add_header_above(header=c(' '=1,'RATR - AD'=3,'LATR - AD'=3,'RATR - RD'=3,'LATR - RD'=3,'RATR - MD'=3,'LATR - MD'=3)) %>%
  kable_styling(position = 'center', font_size = 7, latex_options=c('hold_position','repeat_header')) %>%
  landscape()
```
